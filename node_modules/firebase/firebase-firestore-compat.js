!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(Zf,eg){"use strict";try{!(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,t=e(Zf);function n(t){const n=[];let r=0;for(let s=0;s<t.length;s++){let e=t.charCodeAt(s);e<128?n[r++]=e:(e<2048?n[r++]=e>>6|192:(55296==(64512&e)&&s+1<t.length&&56320==(64512&t.charCodeAt(s+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++s)),n[r++]=e>>18|240,n[r++]=e>>12&63|128):n[r++]=e>>12|224,n[r++]=e>>6&63|128),n[r++]=63&e|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const s=[];for(let h=0;h<n.length;h+=3){var i=n[h],a=h+1<n.length,o=a?n[h+1]:0,u=h+2<n.length,c=u?n[h+2]:0;let e=(15&o)<<2|c>>6,t=63&c;u||(t=64,a||(e=64)),s.push(r[i>>2],r[(3&i)<<4|o>>4],r[e],r[t])}return s.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(n(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var s,i,a=e[n++];a<128?t[r++]=String.fromCharCode(a):191<a&&a<224?(s=e[n++],t[r++]=String.fromCharCode((31&a)<<6|63&s)):239<a&&a<365?(i=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(i>>10)),t[r++]=String.fromCharCode(56320+(1023&i))):(s=e[n++],i=e[n++],t[r++]=String.fromCharCode((15&a)<<12|(63&s)<<6|63&i))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let u=0;u<e.length;){var s=n[e.charAt(u++)],i=u<e.length?n[e.charAt(u)]:0;++u;var a=u<e.length?n[e.charAt(u)]:64;++u;var o=u<e.length?n[e.charAt(u)]:64;if(++u,null==s||null==i||null==a||null==o)throw Error();r.push(s<<2|i>>4),64!==a&&(r.push(i<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},a=function(e){return e=e,t=n(e),r.encodeByteArray(t,!0).replace(/\./g,"");var t};function f(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function s(){return!function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class o extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,o.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,i.prototype.create)}}class i{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,n=t[0]||{},s=`${this.service}/${e}`,i=this.errors[e],i=i?(r=n,i.replace(u,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",i=`${this.serviceName}: ${i} (${s}).`;return new o(s,i,n)}}const u=/\{\$([^}]+)}/g;function m(e){return e&&e._delegate?e._delegate:e}class c{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(nd=l=l||{})[nd.DEBUG=0]="DEBUG",nd[nd.VERBOSE=1]="VERBOSE",nd[nd.INFO=2]="INFO",nd[nd.WARN=3]="WARN",nd[nd.ERROR=4]="ERROR",nd[nd.SILENT=5]="SILENT";const h={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},d=l.INFO,g={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},p=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),s=g[t];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[s](`[${r}]  ${e.name}:`,...n)}};var y,v="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},w={},I=v||self;function b(){}function E(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function T(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var S="closure_uid_"+(1e9*Math.random()>>>0),_=0;function x(e,t,n){return e.call.apply(e.bind,arguments)}function D(t,n,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function A(e,t,n){return(A=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?x:D).apply(null,arguments)}function C(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function N(e,i){function t(){}t.prototype=i.prototype,e.Z=i.prototype,e.prototype=new t,(e.prototype.constructor=e).Vb=function(e,t,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[t].apply(e,r)}}function k(){this.s=this.s,this.o=this.o}var R={};k.prototype.s=!1,k.prototype.na=function(){var e,t;!this.s&&(this.s=!0,this.M(),0)&&(t=this,e=Object.prototype.hasOwnProperty.call(t,S)&&t[S]||(t[S]=++_),delete R[e])},k.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const L=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1},O=Array.prototype.forEach?function(e,t,n){Array.prototype.forEach.call(e,t,n)}:function(e,t,n){var r=e.length,s="string"==typeof e?e.split(""):e;for(let i=0;i<r;i++)i in s&&t.call(n,s[i],i,e)};function M(){return Array.prototype.concat.apply([],arguments)}function V(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function F(e){return/^[\s\xa0]*$/.test(e)}var P,B=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function U(e,t){return-1!=e.indexOf(t)}function q(e,t){return e<t?-1:t<e?1:0}e:{var G=I.navigator;if(G){G=G.userAgent;if(G){P=G;break e}}P=""}function j(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function K(e){const t={};for(const n in e)t[n]=e[n];return t}var $="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Q(t){let n,r;for(let s=1;s<arguments.length;s++){for(n in r=arguments[s])t[n]=r[n];for(let e=0;e<$.length;e++)n=$[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function z(e){return z[" "](e),e}z[" "]=b;var H,W=U(P,"Opera"),Y=U(P,"Trident")||U(P,"MSIE"),X=U(P,"Edge"),J=X||Y,Z=U(P,"Gecko")&&!(U(P.toLowerCase(),"webkit")&&!U(P,"Edge"))&&!(U(P,"Trident")||U(P,"MSIE"))&&!U(P,"Edge"),ee=U(P.toLowerCase(),"webkit")&&!U(P,"Edge");function te(){var e=I.document;return e?e.documentMode:void 0}e:{var ne="",re=(re=P,Z?/rv:([^\);]+)(\)|;)/.exec(re):X?/Edge\/([\d\.]+)/.exec(re):Y?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(re):ee?/WebKit\/(\S+)/.exec(re):W?/(?:Version)[ \/]?(\S+)/.exec(re):void 0);if(re&&(ne=re?re[1]:""),Y){re=te();if(null!=re&&re>parseFloat(ne)){H=String(re);break e}}H=ne}var se={};function ie(){return e=function(){let e=0;var t=B(String(H)).split("."),n=B("9").split("."),r=Math.max(t.length,n.length);for(let a=0;0==e&&a<r;a++)for(var s=t[a]||"",i=n[a]||"";s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],(0!=s[0].length||0!=i[0].length)&&(e=q(0==s[1].length?0:parseInt(s[1],10),0==i[1].length?0:parseInt(i[1],10))||q(0==s[2].length,0==i[2].length)||q(s[2],i[2]),s=s[3],i=i[3],0==e););return 0<=e},t=se,Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=e(9);var e,t}var ae=I.document&&Y&&(te()||parseInt(H,10))||void 0,oe=function(){if(!I.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{I.addEventListener("test",b,t),I.removeEventListener("test",b,t)}catch(e){}return e}();function ue(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}function ce(e,t){if(ue.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(Z){e:{try{z(t.nodeName);var s=!0;break e}catch(e){}s=!1}s||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:he[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&ce.Z.h.call(this)}}ue.prototype.h=function(){this.defaultPrevented=!0},N(ce,ue);var he={2:"touch",3:"pen",4:"mouse"};ce.prototype.h=function(){ce.Z.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var le="closure_listenable_"+(1e6*Math.random()|0),de=0;function fe(e,t,n,r,s){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ia=s,this.key=++de,this.ca=this.fa=!1}function ge(e){e.ca=!0,e.listener=null,e.proxy=null,e.src=null,e.ia=null}function me(e){this.src=e,this.g={},this.h=0}function pe(e,t){var n,r,s,i=t.type;i in e.g&&(n=e.g[i],(s=0<=(r=L(n,t)))&&Array.prototype.splice.call(n,r,1),s&&(ge(t),0==e.g[i].length&&(delete e.g[i],e.h--)))}function ye(e,t,n,r){for(var s=0;s<e.length;++s){var i=e[s];if(!i.ca&&i.listener==t&&i.capture==!!n&&i.ia==r)return s}return-1}me.prototype.add=function(e,t,n,r,s){var i=e.toString();(e=this.g[i])||(e=this.g[i]=[],this.h++);var a=ye(e,t,r,s);return-1<a?(t=e[a],n||(t.fa=!1)):((t=new fe(t,this.src,i,!!r,s)).fa=n,e.push(t)),t};var ve="closure_lm_"+(1e6*Math.random()|0),we={};function Ie(e,t,n,r,s){if(r&&r.once)return function e(t,n,r,s,i){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);return null}r=De(r);return t&&t[le]?t.O(n,r,T(s)?!!s.capture:!!s,i):be(t,n,r,!0,s,i)}(e,t,n,r,s);if(Array.isArray(t)){for(var i=0;i<t.length;i++)Ie(e,t[i],n,r,s);return null}return n=De(n),e&&e[le]?e.N(t,n,T(r)?!!r.capture:!!r,s):be(e,t,n,!1,r,s)}function be(e,t,n,r,s,i){if(!t)throw Error("Invalid event type");var a,o=T(s)?!!s.capture:!!s,u=_e(e);if(u||(e[ve]=u=new me(e)),(n=u.add(t,n,r,o,i)).proxy)return n;if(a=Se,r=function e(t){return a.call(e.src,e.listener,t)},(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(s=!oe?o:s)&&(s=!1),e.addEventListener(t.toString(),r,s);else if(e.attachEvent)e.attachEvent(Te(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function Ee(e){var t,n,r;"number"!=typeof e&&e&&!e.ca&&((t=e.src)&&t[le]?pe(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(Te(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=_e(t))?(pe(n,e),0==n.h&&(n.src=null,t[ve]=null)):ge(e)))}function Te(e){return e in we?we[e]:we[e]="on"+e}function Se(e,t){var n,r;return e=!!e.ca||(t=new ce(t,this),n=e.listener,r=e.ia||e.src,e.fa&&Ee(e),n.call(r,t))}function _e(e){return(e=e[ve])instanceof me?e:null}var xe="__closure_events_fn_"+(1e9*Math.random()>>>0);function De(t){return"function"==typeof t?t:(t[xe]||(t[xe]=function(e){return t.handleEvent(e)}),t[xe])}function Ae(){k.call(this),this.i=new me(this),(this.P=this).I=null}function Ce(e,t){var n,r=e.I;if(r)for(n=[];r;r=r.I)n.push(r);if(e=e.P,r=t.type||t,"string"==typeof t?t=new ue(t,e):t instanceof ue?t.target=t.target||e:(a=t,Q(t=new ue(r,e),a)),a=!0,n)for(var s=n.length-1;0<=s;s--)var i=t.g=n[s],a=Ne(i,r,!0,t)&&a;if(a=Ne(i=t.g=e,r,!0,t)&&a,a=Ne(i,r,!1,t)&&a,n)for(s=0;s<n.length;s++)a=Ne(i=t.g=n[s],r,!1,t)&&a}function Ne(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var s=!0,i=0;i<t.length;++i){var a,o,u=t[i];u&&!u.ca&&u.capture==n&&(a=u.listener,o=u.ia||u.src,u.fa&&pe(e.i,u),s=!1!==a.call(o,r)&&s)}return s&&!r.defaultPrevented}N(Ae,k),Ae.prototype[le]=!0,Ae.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,s,i){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);else s=T(s)?!!s.capture:!!s,r=De(r),t&&t[le]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=ye(a=t.g[n],r,s,i))&&(ge(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&_e(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?ye(n,r,s,i):t)?n[t]:null)&&Ee(r))}(this,e,t,n,r)},Ae.prototype.M=function(){if(Ae.Z.M.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)ge(n[r]);delete t.g[e],t.h--}}this.I=null},Ae.prototype.N=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Ae.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var ke=I.JSON.stringify;var Re,Le=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Oe,e=>e.reset());class Oe{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function Me(e,t){var n;Re||(n=I.Promise.resolve(void 0),Re=function(){n.then(Pe)}),Ve||(Re(),Ve=!0),Fe.add(e,t)}var Ve=!1,Fe=new class{constructor(){this.h=this.g=null}add(e,t){const n=Le.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}};function Pe(){for(var e;e=function(){var e=Fe;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){I.setTimeout(()=>{throw e},0)}(e)}var t=Le;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Ve=!1}function Be(e,t){Ae.call(this),this.h=e||1,this.g=t||I,this.j=A(this.kb,this),this.l=Date.now()}function Ue(e){e.da=!1,e.S&&(e.g.clearTimeout(e.S),e.S=null)}function qe(e,t,n){if("function"==typeof e)n&&(e=A(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=A(e.handleEvent,e)}return 2147483647<Number(t)?-1:I.setTimeout(e,t||0)}N(Be,Ae),(y=Be.prototype).da=!1,y.S=null,y.kb=function(){var e;this.da&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-e):(this.S&&(this.g.clearTimeout(this.S),this.S=null),Ce(this,"tick"),this.da&&(Ue(this),this.start())))},y.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},y.M=function(){Be.Z.M.call(this),Ue(this),delete this.g};class Ge extends k{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=qe(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}M(){super.M(),this.g&&(I.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function je(e){k.call(this),this.h=e,this.g={}}N(je,k);var Ke=[];function $e(e,t,n,r){Array.isArray(n)||(n&&(Ke[0]=n.toString()),n=Ke);for(var s=0;s<n.length;s++){var i=Ie(t,n[s],r||e.handleEvent,!1,e.h||e);if(!i)break;e.g[i.key]=i}}function Qe(e){j(e.g,function(e,t){this.g.hasOwnProperty(t)&&Ee(e)},e),e.g={}}function ze(){this.g=!0}function He(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var a=1;a<s.length;a++)s[a]=""}}}return ke(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}je.prototype.M=function(){je.Z.M.call(this),Qe(this)},je.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ze.prototype.Aa=function(){this.g=!1},ze.prototype.info=function(){};var We={},Ye=null;function Xe(){return Ye=Ye||new Ae}function Je(e){ue.call(this,We.Ma,e)}function Ze(){var e=Xe();Ce(e,new Je(e))}function et(e,t){ue.call(this,We.STAT_EVENT,e),this.stat=t}function tt(e){var t=Xe();Ce(t,new et(t,e))}function nt(e,t){ue.call(this,We.Na,e),this.size=t}function rt(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return I.setTimeout(function(){e()},t)}We.Ma="serverreachability",N(Je,ue),We.STAT_EVENT="statevent",N(et,ue),We.Na="timingevent",N(nt,ue);var st={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},it={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function at(){}function ot(e){return e.h||(e.h=e.i())}function ut(){}at.prototype.h=null;v={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function ct(){ue.call(this,"d")}function ht(){ue.call(this,"c")}function lt(){}function dt(e,t,n,r){this.l=e,this.j=t,this.m=n,this.X=r||1,this.V=new je(this),this.P=mt,this.W=new Be(e=J?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new ft}function ft(){this.i=null,this.g="",this.h=!1}N(ct,ue),N(ht,ue),N(lt,at),lt.prototype.g=function(){return new XMLHttpRequest},lt.prototype.i=function(){return{}};var gt=new lt,mt=45e3,pt={},yt={};function vt(e,t,n){e.K=1,e.v=Ut(Ot(t)),e.s=n,e.U=!0,wt(e,null)}function wt(e,t){e.F=Date.now(),Et(e),e.A=Ot(e.v);var a,o,u,c,h,l,n=e.A,r=e.X;Array.isArray(r)||(r=[String(r)]),Zt(n.h,"t",r),e.C=0,n=e.l.H,e.h=new ft,e.g=er(e.l,n?t:null,!e.s),0<e.O&&(e.L=new Ge(A(e.Ia,e,e.g),e.O)),$e(e.V,e.g,"readystatechange",e.gb),t=e.H?K(e.H):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ea(e.A,e.u,e.s,t)):(e.u="GET",e.g.ea(e.A,e.u,null,t)),Ze(),a=e.j,o=e.u,u=e.A,c=e.m,h=e.X,l=e.s,a.info(function(){if(a.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,s,i=t[n].split("=");1<i.length&&(r=i[0],i=i[1],e=2<=(s=r.split("_")).length&&"type"==s[1]?e+(r+"=")+i+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+c+") [attempt "+h+"]: "+o+"\n"+u+"\n"+e})}function It(e){return e.g&&("GET"==e.u&&2!=e.K&&e.l.Ba)}function bt(e,t,n){let r=!0,s;for(;!e.I&&e.C<n.length;){if(s=(a=n,u=o=void 0,o=(i=e).C,-1==(u=a.indexOf("\n",o))?yt:(o=Number(a.substring(o,u)),isNaN(o)?pt:(u+=1)+o>a.length?yt:(a=a.substr(u,o),i.C=u+o,a))),s==yt){4==t&&(e.o=4,tt(14),r=!1),He(e.j,e.m,null,"[Incomplete Response]");break}if(s==pt){e.o=4,tt(15),He(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}He(e.j,e.m,s,null),Dt(e,s)}var i,a,o,u;It(e)&&s!=yt&&s!=pt&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,tt(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.aa&&(e.aa=!0,(t=e.l).g==e&&t.$&&!t.L&&(t.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),Qn(t),t.L=!0,tt(11))):(He(e.j,e.m,n,"[Invalid Chunked Response]"),xt(e),_t(e))}function Et(e){e.Y=Date.now()+e.P,Tt(e,e.P)}function Tt(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=rt(A(e.eb,e),t)}function St(e){e.B&&(I.clearTimeout(e.B),e.B=null)}function _t(e){0==e.l.G||e.I||Wn(e.l,e)}function xt(e){St(e);var t=e.L;t&&"function"==typeof t.na&&t.na(),e.L=null,Ue(e.W),Qe(e.V),e.g&&(t=e.g,e.g=null,t.abort(),t.na())}function Dt(e,t){try{var n=e.l;if(0!=n.G&&(n.g==e||on(n.i,e)))if(n.I=e.N,!e.J&&on(n.i,e)&&3==n.G){try{var r=n.Ca.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;Hn(n),Fn(n)}$n(n),tt(18)}}else n.ta=s[1],0<n.ta-n.U&&s[2]<37500&&n.N&&0==n.A&&!n.v&&(n.v=rt(A(n.ab,n),6e3));if(an(n.i)<=1&&n.ka){try{n.ka()}catch(e){}n.ka=void 0}}else Xn(n,11)}else if(!e.J&&n.g!=e||Hn(n),!F(t))for(s=n.Ca.g.parse(t),t=0;t<s.length;t++){var i=s[t];if(n.U=i[0],i=i[1],2==n.G)if("c"==i[0]){n.J=i[1],n.la=i[2];var a=i[3];null!=a&&(n.ma=a,n.h.info("VER="+n.ma));var o=i[4];null!=o&&(n.za=o,n.h.info("SVER="+n.za));var u,c,h,l=i[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.K=r,n.h.info("backChannelRequestTimeoutMs_="+r)),r=n;const m=e.g;m&&(!(u=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null)||!(c=r.i).g&&(U(u,"spdy")||U(u,"quic")||U(u,"h2"))&&(c.j=c.l,c.g=new Set,c.h&&(un(c,c.h),c.h=null)),!r.D||(h=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.sa=h,Bt(r.F,r.D,h))),n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-e.F,n.h.info("Handshake RTT: "+n.O+"ms"));var d,f,g=e;(r=n).oa=Zn(r,r.H?r.la:null,r.W),g.J?(cn(r.i,g),d=g,(f=r.K)&&d.setTimeout(f),d.B&&(St(d),Et(d)),r.g=g):Kn(r),0<n.l.length&&Un(n)}else"stop"!=i[0]&&"close"!=i[0]||Xn(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?Xn(n,7):Vn(n):"noop"!=i[0]&&n.j&&n.j.wa(i),n.A=0)}Ze()}catch(e){}}function At(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(E(e)||"string"==typeof e)O(e,t,void 0);else{if(e.T&&"function"==typeof e.T)var n=e.T();else if(e.R&&"function"==typeof e.R)n=void 0;else if(E(e)||"string"==typeof e)for(var n=[],r=e.length,s=0;s<r;s++)n.push(s);else for(s in n=[],r=0,e)n[r++]=s;for(var s=(r=function(e){if(e.R&&"function"==typeof e.R)return e.R();if("string"==typeof e)return e.split("");if(E(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e)).length,i=0;i<s;i++)t.call(void 0,r[i],n&&n[i],e)}}function Ct(e,t){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(e)if(e instanceof Ct)for(n=e.T(),r=0;r<n.length;r++)this.set(n[r],e.get(n[r]));else for(r in e)this.set(r,e[r])}function Nt(e){if(e.i!=e.g.length){for(var t=0,n=0;t<e.g.length;){var r=e.g[t];kt(e.h,r)&&(e.g[n++]=r),t++}e.g.length=n}if(e.i!=e.g.length){for(var s={},n=t=0;t<e.g.length;)kt(s,r=e.g[t])||(s[e.g[n++]=r]=1),t++;e.g.length=n}}function kt(e,t){return Object.prototype.hasOwnProperty.call(e,t)}(y=dt.prototype).setTimeout=function(e){this.P=e},y.gb=function(e){e=e.target;const t=this.L;t&&3==kn(e)?t.l():this.Ia(e)},y.Ia=function(e){try{if(e==this.g)e:{var t=kn(this.g),n=this.g.Da();this.g.ba();if(!(t<3)&&(3!=t||J||this.g&&(this.h.h||this.g.ga()||Rn(this.g)))){this.I||4!=t||7==n||Ze(),St(this);var r=this.g.ba();this.N=r;t:if(It(this)){var s=Rn(this.g);e="";var i=s.length,a=4==kn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){xt(this),_t(this);var o="";break t}this.h.i=new I.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,e+=this.h.i.decode(s[n],{stream:a&&n==i-1});s.splice(0,i),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.ga();if(this.i=200==r,l=this.j,d=this.u,f=this.A,g=this.m,m=this.X,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.$&&!this.J){t:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!F(u)){var h=u;break t}}h=null}if(!(r=h)){this.i=!1,this.o=3,tt(12),xt(this),_t(this);break e}He(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Dt(this,r)}this.U?(bt(this,t,o),J&&this.i&&3==t&&($e(this.V,this.W,"tick",this.fb),this.W.start())):(He(this.j,this.m,o,null),Dt(this,o)),4==t&&xt(this),this.i&&!this.I&&(4==t?Wn(this.l,this):(this.i=!1,Et(this)))}else 400==r&&0<o.indexOf("Unknown SID")?(this.o=3,tt(12)):(this.o=0,tt(13)),xt(this),_t(this)}}}catch(e){}var l,d,f,g,m,p,y},y.fb=function(){var e,t;this.g&&(e=kn(this.g),t=this.g.ga(),this.C<t.length&&(St(this),bt(this,e,t),this.i&&4!=e&&Et(this)))},y.cancel=function(){this.I=!0,xt(this)},y.eb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.K&&(Ze(),tt(17)),xt(this),this.o=2,_t(this)):Tt(this,this.Y-n)},(y=Ct.prototype).R=function(){Nt(this);for(var e=[],t=0;t<this.g.length;t++)e.push(this.h[this.g[t]]);return e},y.T=function(){return Nt(this),this.g.concat()},y.get=function(e,t){return kt(this.h,e)?this.h[e]:t},y.set=function(e,t){kt(this.h,e)||(this.i++,this.g.push(e)),this.h[e]=t},y.forEach=function(e,t){for(var n=this.T(),r=0;r<n.length;r++){var s=n[r],i=this.get(s);e.call(t,i,s,this)}};var Rt=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Lt(e,t){var n;this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,e instanceof Lt?(this.g=void 0!==t?t:e.g,Mt(this,e.j),this.s=e.s,Vt(this,e.i),Ft(this,e.m),this.l=e.l,t=e.h,(n=new Wt).i=t.i,t.g&&(n.g=new Ct(t.g),n.h=t.h),Pt(this,n),this.o=e.o):e&&(n=String(e).match(Rt))?(this.g=!!t,Mt(this,n[1]||"",!0),this.s=qt(n[2]||""),Vt(this,n[3]||"",!0),Ft(this,n[4]),this.l=qt(n[5]||"",!0),Pt(this,n[6]||"",!0),this.o=qt(n[7]||"")):(this.g=!!t,this.h=new Wt(null,this.g))}function Ot(e){return new Lt(e)}function Mt(e,t,n){e.j=n?qt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Vt(e,t,n){e.i=n?qt(t,!0):t}function Ft(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Pt(e,t,n){var r,s;t instanceof Wt?(e.h=t,r=e.h,(s=e.g)&&!r.j&&(Yt(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(Xt(this,t),Zt(this,n,e))},r)),r.j=s):(n||(t=Gt(t,zt)),e.h=new Wt(t,e.g))}function Bt(e,t,n){e.h.set(t,n)}function Ut(e){return Bt(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function qt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Gt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,jt),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function jt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Lt.prototype.toString=function(){var e=[],t=this.j;t&&e.push(Gt(t,Kt,!0),":");var n=this.i;return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Gt(t,Kt,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&e.push("/"),e.push(Gt(n,"/"==n.charAt(0)?Qt:$t,!0))),(n=this.h.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Gt(n,Ht)),e.join("")};var Kt=/[#\/\?@]/g,$t=/[#\?:]/g,Qt=/[#\?]/g,zt=/[#\?@]/g,Ht=/#/g;function Wt(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function Yt(n){n.g||(n.g=new Ct,n.h=0,n.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,s=e[n].indexOf("="),i=null;0<=s?(r=e[n].substring(0,s),i=e[n].substring(s+1)):r=e[n],t(r,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.i,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function Xt(e,t){Yt(e),t=en(e,t),kt(e.g.h,t)&&(e.i=null,e.h-=e.g.get(t).length,kt((e=e.g).h,t)&&(delete e.h[t],e.i--,e.g.length>2*e.i&&Nt(e)))}function Jt(e,t){return Yt(e),t=en(e,t),kt(e.g.h,t)}function Zt(e,t,n){Xt(e,t),0<n.length&&(e.i=null,e.g.set(en(e,t),V(n)),e.h+=n.length)}function en(e,t){return t=String(t),t=e.j?t.toLowerCase():t}(y=Wt.prototype).add=function(e,t){Yt(this),this.i=null,e=en(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},y.forEach=function(n,r){Yt(this),this.g.forEach(function(e,t){O(e,function(e){n.call(r,e,t,this)},this)},this)},y.T=function(){Yt(this);for(var e=this.g.R(),t=this.g.T(),n=[],r=0;r<t.length;r++)for(var s=e[r],i=0;i<s.length;i++)n.push(t[r]);return n},y.R=function(e){Yt(this);var t=[];if("string"==typeof e)Jt(this,e)&&(t=M(t,this.g.get(en(this,e))));else{e=this.g.R();for(var n=0;n<e.length;n++)t=M(t,e[n])}return t},y.set=function(e,t){return Yt(this),this.i=null,Jt(this,e=en(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},y.get=function(e,t){return e&&0<(e=this.R(e)).length?String(e[0]):t},y.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var e=[],t=this.g.T(),n=0;n<t.length;n++)for(var r=t[n],s=encodeURIComponent(String(r)),r=this.R(r),i=0;i<r.length;i++){var a=s;""!==r[i]&&(a+="="+encodeURIComponent(String(r[i]))),e.push(a)}return this.i=e.join("&")};var tn=class{constructor(e,t){this.h=e,this.g=t}};function nn(e){this.l=e||10,e=I.PerformanceNavigationTiming?0<(e=I.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(I.g&&I.g.Ea&&I.g.Ea()&&I.g.Ea().Zb),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var rn;function sn(e){return e.h||e.g&&e.g.size>=e.j}function an(e){return e.h?1:e.g?e.g.size:0}function on(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function un(e,t){e.g?e.g.add(t):e.h=t}function cn(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function hn(t){if(null!=t.h)return t.i.concat(t.h.D);if(null==t.g||0===t.g.size)return V(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}}function ln(){}function dn(){this.g=new ln}function fn(e,t,n,r,s){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,s(r)}catch(e){}}function gn(e){this.l=e.$b||null,this.j=e.ib||!1}function mn(e,t){Ae.call(this),this.D=e,this.u=t,this.m=void 0,this.readyState=pn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}nn.prototype.cancel=function(){if(this.i=hn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}},ln.prototype.stringify=function(e){return I.JSON.stringify(e,void 0)},ln.prototype.parse=function(e){return I.JSON.parse(e,void 0)},N(gn,at),gn.prototype.g=function(){return new mn(this.l,this.j)},gn.prototype.i=(rn={},function(){return rn}),N(mn,Ae);var pn=0;function yn(e){e.j.read().then(e.Sa.bind(e)).catch(e.ha.bind(e))}function vn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,wn(e)}function wn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(y=mn.prototype).open=function(e,t){if(this.readyState!=pn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,wn(this)},y.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||I).fetch(new Request(this.B,t)).then(this.Va.bind(this),this.ha.bind(this))},y.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,vn(this)),this.readyState=pn},y.Va=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,wn(this)),this.g&&(this.readyState=3,wn(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==I.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;yn(this)}else e.text().then(this.Ua.bind(this),this.ha.bind(this))},y.Sa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?vn:wn)(this),3==this.readyState&&yn(this))},y.Ua=function(e){this.g&&(this.response=this.responseText=e,vn(this))},y.Ta=function(e){this.g&&(this.response=e,vn(this))},y.ha=function(){this.g&&vn(this)},y.setRequestHeader=function(e,t){this.v.append(e,t)},y.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},y.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(mn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var In=I.JSON.parse;function bn(e){Ae.call(this),this.headers=new Ct,this.u=e||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=En,this.K=this.L=!1}N(bn,Ae);var En="",Tn=/^https?$/i,Sn=["POST","PUT"];function _n(e){return"content-type"==e.toLowerCase()}function xn(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,Dn(e),Cn(e)}function Dn(e){e.D||(e.D=!0,Ce(e,"complete"),Ce(e,"error"))}function An(e){if(e.h&&void 0!==w&&(!e.C[1]||4!=kn(e)||2!=e.ba()))if(e.v&&4==kn(e))qe(e.Fa,0,e);else if(Ce(e,"readystatechange"),4==kn(e)){e.h=!1;try{var t,n,r,s,i=e.ba();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var a=!0;break e;default:a=!1}if((t=a)||((n=0===i)&&(!(s=String(e.H).match(Rt)[1]||null)&&I.self&&I.self.location&&(s=(r=I.self.location.protocol).substr(0,r.length-1)),n=!Tn.test(s?s.toLowerCase():"")),t=n),t)Ce(e,"complete"),Ce(e,"success");else{e.m=6;try{var o=2<kn(e)?e.g.statusText:""}catch(e){o=""}e.j=o+" ["+e.ba()+"]",Dn(e)}}finally{Cn(e)}}}function Cn(e,t){if(e.g){Nn(e);const n=e.g,r=e.C[0]?b:null;e.g=null,e.C=null,t||Ce(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Nn(e){e.g&&e.K&&(e.g.ontimeout=null),e.A&&(I.clearTimeout(e.A),e.A=null)}function kn(e){return e.g?e.g.readyState:0}function Rn(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.J){case En:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function Ln(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=function(e){let n="";return j(e,function(e,t){n+=t,n+=":",n+=e,n+="\r\n"}),n}(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):Bt(e,t,n))}function On(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Mn(e){this.za=0,this.l=[],this.h=new ze,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=On("failFast",!1,e),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=On("baseRetryDelayMs",5e3,e),this.$a=On("retryDelaySeedMs",1e4,e),this.Ya=On("forwardChannelMaxRetries",2,e),this.ra=On("forwardChannelRequestTimeoutMs",2e4,e),this.qa=e&&e.xmlHttpFactory||void 0,this.Ba=e&&e.Yb||!1,this.K=void 0,this.H=e&&e.supportsCrossDomainXhr||!1,this.J="",this.i=new nn(e&&e.concurrentRequestLimit),this.Ca=new dn,this.ja=e&&e.fastHandshake||!1,this.Ra=e&&e.Wb||!1,e&&e.Aa&&this.h.Aa(),e&&e.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&e&&e.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!e||!1!==e.Xb}function Vn(e){var t,n;Pn(e),3==e.G&&(t=e.V++,Bt(n=Ot(e.F),"SID",e.J),Bt(n,"RID",t),Bt(n,"TYPE","terminate"),Gn(e,n),(t=new dt(e,e.h,t,void 0)).K=2,t.v=Ut(Ot(n)),n=!1,!(n=I.navigator&&I.navigator.sendBeacon?I.navigator.sendBeacon(t.v.toString(),""):n)&&I.Image&&((new Image).src=t.v,n=!0),n||(t.g=er(t.l,null),t.g.ea(t.v)),t.F=Date.now(),Et(t)),Jn(e)}function Fn(e){e.g&&(Qn(e),e.g.cancel(),e.g=null)}function Pn(e){Fn(e),e.u&&(I.clearTimeout(e.u),e.u=null),Hn(e),e.i.cancel(),e.m&&("number"==typeof e.m&&I.clearTimeout(e.m),e.m=null)}function Bn(e,t){e.l.push(new tn(e.Za++,t)),3==e.G&&Un(e)}function Un(e){sn(e.i)||e.m||(e.m=!0,Me(e.Ha,e),e.C=0)}function qn(e,t){var n=t?t.m:e.V++,r=Ot(e.F);Bt(r,"SID",e.J),Bt(r,"RID",n),Bt(r,"AID",e.U),Gn(e,r),e.o&&e.s&&Ln(r,e.o,e.s),n=new dt(e,e.h,n,e.C+1),null===e.o&&(n.H=e.s),t&&(e.l=t.D.concat(e.l)),t=jn(e,n,1e3),n.setTimeout(Math.round(.5*e.ra)+Math.round(.5*e.ra*Math.random())),un(e.i,n),vt(n,r,t)}function Gn(e,n){e.j&&At({},function(e,t){Bt(n,t,e)})}function jn(e,t,r){r=Math.min(e.l.length,r);var s=e.j?A(e.j.Oa,e.j,e):null;e:{var i=e.l;let n=-1;for(;;){const u=["count="+r];-1==n?0<r?(n=i[0].h,u.push("ofs="+n)):n=0:u.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var a=i[t].h,o=i[t].g;if((a-=n)<0)n=Math.max(0,i[t].h-100),e=!1;else try{!function(e,r,t){const s=t||"";try{At(e,function(e,t){let n=e;T(e)&&(n=ke(e)),r.push(s+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(s+"type="+encodeURIComponent("_badmap")),e}}(o,u,"req"+a+"_")}catch(e){s&&s(o)}}if(e){s=u.join("&");break e}}}return e=e.l.splice(0,r),t.D=e,s}function Kn(e){e.g||e.u||(e.Y=1,Me(e.Ga,e),e.A=0)}function $n(e){return!(e.g||e.u||3<=e.A)&&(e.Y++,e.u=rt(A(e.Ga,e),Yn(e,e.A)),e.A++,1)}function Qn(e){null!=e.B&&(I.clearTimeout(e.B),e.B=null)}function zn(e){e.g=new dt(e,e.h,"rpc",e.Y),null===e.o&&(e.g.H=e.s),e.g.O=0;var t=Ot(e.oa);Bt(t,"RID","rpc"),Bt(t,"SID",e.J),Bt(t,"CI",e.N?"0":"1"),Bt(t,"AID",e.U),Gn(e,t),Bt(t,"TYPE","xmlhttp"),e.o&&e.s&&Ln(t,e.o,e.s),e.K&&e.g.setTimeout(e.K);var n=e.g;e=e.la,n.K=1,n.v=Ut(Ot(t)),n.s=null,n.U=!0,wt(n,e)}function Hn(e){null!=e.v&&(I.clearTimeout(e.v),e.v=null)}function Wn(e,t){var n,r,s,i=null;if(e.g==t){Hn(e),Qn(e),e.g=null;var a=2}else{if(!on(e.i,t))return;i=t.D,cn(e.i,t),a=1}if(e.I=t.N,0!=e.G)if(t.i)1==a?(i=t.s?t.s.length:0,t=Date.now()-t.F,n=e.C,Ce(a=Xe(),new nt(a,i)),Un(e)):Kn(e);else if(3==(n=t.o)||0==n&&0<e.I||(1!=a||(s=t,an((r=e).i)>=r.i.j-(r.m?1:0)||(r.m?(r.l=s.D.concat(r.l),0):1==r.G||2==r.G||r.C>=(r.Xa?0:r.Ya)||(r.m=rt(A(r.Ha,r,s),Yn(r,r.C)),r.C++,0))))&&(2!=a||!$n(e)))switch(i&&0<i.length&&(t=e.i,t.i=t.i.concat(i)),n){case 1:Xn(e,5);break;case 4:Xn(e,10);break;case 3:Xn(e,6);break;default:Xn(e,2)}}function Yn(e,t){let n=e.Pa+Math.floor(Math.random()*e.$a);return e.j||(n*=2),n*t}function Xn(e,t){var n,r;e.h.info("Error code "+t),2==t?(n=null,e.j&&(n=null),r=A(e.jb,e),n||(n=new Lt("//www.google.com/images/cleardot.gif"),I.location&&"http"==I.location.protocol||Mt(n,"https"),Ut(n)),function(e,t){var n=new ze;if(I.Image){const r=new Image;r.onload=C(fn,n,r,"TestLoadImage: loaded",!0,t),r.onerror=C(fn,n,r,"TestLoadImage: error",!1,t),r.onabort=C(fn,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=C(fn,n,r,"TestLoadImage: timeout",!1,t),I.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(n.toString(),r)):tt(2),e.G=0,e.j&&e.j.va(t),Jn(e),Pn(e)}function Jn(e){e.G=0,e.I=-1,e.j&&(0==hn(e.i).length&&0==e.l.length||(e.i.i.length=0,V(e.l),e.l.length=0),e.j.ua())}function Zn(e,t,n){let r=(o=n)instanceof Lt?Ot(o):new Lt(o,void 0);var s,i,a,o,u;return""!=r.i?(t&&Vt(r,t+"."+r.i),Ft(r,r.m)):(u=I.location,r=(s=u.protocol,i=t?t+"."+u.hostname:u.hostname,a=+u.port,o=n,u=new Lt(null,void 0),s&&Mt(u,s),i&&Vt(u,i),a&&Ft(u,a),o&&(u.l=o),u)),e.aa&&j(e.aa,function(e,t){Bt(r,t,e)}),t=e.D,n=e.sa,t&&n&&Bt(r,t,n),Bt(r,"VER",e.ma),Gn(e,r),r}function er(e,t,n){if(t&&!e.H)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Ba&&!e.qa?new bn(new gn({ib:!0})):new bn(e.qa)).L=e.H,t}function tr(){}function nr(){if(Y&&!(10<=Number(ae)))throw Error("Environmental error: no available transport.")}function rr(e,t){Ae.call(this),this.g=new Mn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.ya&&(e?e["X-WebChannel-Client-Profile"]=t.ya:e={"X-WebChannel-Client-Profile":t.ya}),this.g.P=e,(e=t&&t.httpHeadersOverwriteParam)&&!F(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!F(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&(t in(e=this.h)&&delete e[t])),this.j=new ar(this)}function sr(e){ct.call(this);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function ir(){ht.call(this),this.status=1}function ar(e){this.g=e}(y=bn.prototype).ea=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+e);t=t?t.toUpperCase():"GET",this.H=e,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||gt).g(),this.C=this.u?ot(this.u):ot(gt),this.g.onreadystatechange=A(this.Fa,this);try{this.F=!0,this.g.open(t,String(e),!0),this.F=!1}catch(e){return void xn(this,e)}e=n||"";const s=new Ct(this.headers);r&&At(r,function(e,t){s.set(t,e)}),r=function(t){e:{var n=_n,r=t.length,s="string"==typeof t?t.split(""):t;for(let e=0;e<r;e++)if(e in s&&n.call(void 0,s[e],e,t)){n=e;break e}n=-1}return n<0?null:"string"==typeof t?t.charAt(n):t[n]}(s.T()),n=I.FormData&&e instanceof I.FormData,0<=L(Sn,t)&&!r&&!n&&s.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),s.forEach(function(e,t){this.g.setRequestHeader(t,e)},this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Nn(this),0<this.B&&((this.K=(i=this.g,Y&&ie()&&"number"==typeof i.timeout&&void 0!==i.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=A(this.pa,this)):this.A=qe(this.pa,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){xn(this,e)}var i},y.pa=function(){void 0!==w&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Ce(this,"timeout"),this.abort(8))},y.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Ce(this,"complete"),Ce(this,"abort"),Cn(this))},y.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Cn(this,!0)),bn.Z.M.call(this)},y.Fa=function(){this.s||(this.F||this.v||this.l?An(this):this.cb())},y.cb=function(){An(this)},y.ba=function(){try{return 2<kn(this)?this.g.status:-1}catch(e){return-1}},y.ga=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},y.Qa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),In(t)}},y.Da=function(){return this.m},y.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(y=Mn.prototype).ma=8,y.G=1,y.hb=function(e){try{this.h.info("Origin Trials invoked: "+e)}catch(e){}},y.Ha=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.V=Math.floor(1e5*Math.random()),t=this.V++;const i=new dt(this,this.h,t,void 0);let e=this.s;if(this.P&&(e?(e=K(e),Q(e,this.P)):e=this.P),null===this.o&&(i.H=e),this.ja)e:{for(var n=0,r=0;r<this.l.length;r++){var s=this.l[r];if("__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s=s.length:s=void 0,void 0===s)break;if(4096<(n+=s)){n=r;break e}if(4096===n||r===this.l.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=jn(this,i,n),Bt(r=Ot(this.F),"RID",t),Bt(r,"CVER",22),this.D&&Bt(r,"X-HTTP-Session-Id",this.D),Gn(this,r),this.o&&e&&Ln(r,this.o,e),un(this.i,i),this.Ra&&Bt(r,"TYPE","init"),this.ja?(Bt(r,"$req",n),Bt(r,"SID","null"),i.$=!0,vt(i,r,null)):vt(i,r,n),this.G=2}}else 3==this.G&&(t?qn(this,t):0==this.l.length||sn(this.i)||qn(this))},y.Ga=function(){var e;this.u=null,zn(this),this.$&&!(this.L||null==this.g||this.O<=0)&&(e=2*this.O,this.h.info("BP detection timer enabled: "+e),this.B=rt(A(this.bb,this),e))},y.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,tt(10),Fn(this),zn(this))},y.ab=function(){null!=this.v&&(this.v=null,Fn(this),$n(this),tt(19))},y.jb=function(e){e?(this.h.info("Successfully pinged google.com"),tt(2)):(this.h.info("Failed to ping google.com"),tt(1))},(y=tr.prototype).xa=function(){},y.wa=function(){},y.va=function(){},y.ua=function(){},y.Oa=function(){},nr.prototype.g=function(e,t){return new rr(e,t)},N(rr,Ae),rr.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var e=this.g,t=this.l,n=this.h||void 0;e.Wa&&(e.h.info("Origin Trials enabled."),Me(A(e.hb,e,t))),tt(0),e.W=t,e.aa=n||{},e.N=e.X,e.F=Zn(e,null,e.W),Un(e)},rr.prototype.close=function(){Vn(this.g)},rr.prototype.u=function(e){var t;"string"==typeof e?((t={}).__data__=e,Bn(this.g,t)):this.v?((t={}).__data__=ke(e),Bn(this.g,t)):Bn(this.g,e)},rr.prototype.M=function(){this.g.j=null,delete this.j,Vn(this.g),delete this.g,rr.Z.M.call(this)},N(sr,ct),N(ir,ht),N(ar,tr),ar.prototype.xa=function(){Ce(this.g,"a")},ar.prototype.wa=function(e){Ce(this.g,new sr(e))},ar.prototype.va=function(e){Ce(this.g,new ir)},ar.prototype.ua=function(){Ce(this.g,"b")},nr.prototype.createWebChannel=nr.prototype.g,rr.prototype.send=rr.prototype.u,rr.prototype.open=rr.prototype.m,st.NO_ERROR=0,st.TIMEOUT=8,st.HTTP_ERROR=6,it.COMPLETE="complete",(ut.EventType=v).OPEN="a",v.CLOSE="b",v.ERROR="c",v.MESSAGE="d",Ae.prototype.listen=Ae.prototype.N,bn.prototype.listenOnce=bn.prototype.O,bn.prototype.getLastError=bn.prototype.La,bn.prototype.getLastErrorCode=bn.prototype.Da,bn.prototype.getStatus=bn.prototype.ba,bn.prototype.getResponseJson=bn.prototype.Qa,bn.prototype.getResponseText=bn.prototype.ga,bn.prototype.send=bn.prototype.ea;var or,ur=Xe,cr=st,hr=it,lr=We,dr=10,fr=11,gr=gn,mr=ut,pr=bn;const yr="@firebase/firestore";class vr{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}vr.UNAUTHENTICATED=new vr(null),vr.GOOGLE_CREDENTIALS=new vr("google-credentials-uid"),vr.FIRST_PARTY=new vr("first-party-uid"),vr.MOCK_USER=new vr("mock-user");let wr="9.9.3";const Ir=new class{constructor(e){this.name=e,this._logLevel=d,this._logHandler=p,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?h[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function br(){return Ir.logLevel}function Er(e,...t){var n;Ir.logLevel<=l.DEBUG&&(n=t.map(_r),Ir.debug(`Firestore (${wr}): ${e}`,...n))}function Tr(e,...t){var n;Ir.logLevel<=l.ERROR&&(n=t.map(_r),Ir.error(`Firestore (${wr}): ${e}`,...n))}function Sr(e,...t){var n;Ir.logLevel<=l.WARN&&(n=t.map(_r),Ir.warn(`Firestore (${wr}): ${e}`,...n))}function _r(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function xr(e="Unexpected state"){var t=`FIRESTORE (${wr}) INTERNAL ASSERTION FAILED: `+e;throw Tr(t),new Error(t)}function Dr(e){e||xr()}const Ar={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Cr extends o{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Nr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class kr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class Rr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(vr.UNAUTHENTICATED))}shutdown(){}}class Lr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Or{constructor(e){this.t=e,this.currentUser=vr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const s=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let i=new Nr;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Nr,t.enqueueRetryable(()=>s(this.currentUser))};const a=()=>{const e=i;t.enqueueRetryable(async()=>{await e.promise,await s(this.currentUser)})},o=e=>{Er("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(Er("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Nr))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(Er("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Dr("string"==typeof e.accessToken),new kr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return Dr(null===e||"string"==typeof e),new vr(e)}}class Mr{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r,this.type="FirstParty",this.user=vr.FIRST_PARTY,this.p=new Map}I(){return this.g?this.g():(Dr(!("object"!=typeof this.h||null===this.h||!this.h.auth||!this.h.auth.getAuthHeaderValueForFirstParty)),this.h.auth.getAuthHeaderValueForFirstParty([]))}get headers(){this.p.set("X-Goog-AuthUser",this.l);var e=this.I();return e&&this.p.set("Authorization",e),this.m&&this.p.set("X-Goog-Iam-Authorization-Token",this.m),this.p}}class Vr{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r}getToken(){return Promise.resolve(new Mr(this.h,this.l,this.m,this.g))}start(e,t){e.enqueueRetryable(()=>t(vr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Fr{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Pr{constructor(e){this.T=e,this.forceRefresh=!1,this.appCheck=null,this.A=null}start(t,n){const r=e=>{null!=e.error&&Er("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);var t=e.token!==this.A;return this.A=e.token,Er("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable(()=>r(e))};const s=e=>{Er("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.T.onInit(e=>s(e)),setTimeout(()=>{var e;this.appCheck||((e=this.T.getImmediate({optional:!0}))?s(e):Er("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(Dr("string"==typeof e.token),this.A=e.token,new Fr(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Br{static R(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var s=function(t){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(t);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let e=0;e<t;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let e=0;e<s.length;++e)r.length<20&&s[e]<n&&(r+=t.charAt(s[e]%t.length))}return r}}function Ur(e,t){return e<t?-1:t<e?1:0}function qr(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function Gr(e){return e+"\0"}class jr{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new Cr(Ar.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new Cr(Ar.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Cr(Ar.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new Cr(Ar.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return jr.fromMillis(Date.now())}static fromDate(e){return jr.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new jr(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Ur(this.nanoseconds,e.nanoseconds):Ur(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Kr{constructor(e){this.timestamp=e}static fromTimestamp(e){return new Kr(e)}static min(){return new Kr(new jr(0,0))}static max(){return new Kr(new jr(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class $r{constructor(e,t,n){void 0===t?t=0:t>e.length&&xr(),void 0===n?n=e.length-t:n>e.length-t&&xr(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===$r.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof $r?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class Qr extends $r{construct(e,t,n){return new Qr(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new Qr(t)}static emptyPath(){return new Qr([])}}const zr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Hr extends $r{construct(e,t,n){return new Hr(e,t,n)}static isValidIdentifier(e){return zr.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=!Hr.isValidIdentifier(e)?"`"+e+"`":e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Hr(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var s=()=>{if(0===n.length)throw new Cr(Ar.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new Cr(Ar.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Cr(Ar.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?i=!i:"."!==t||i?n+=t:s(),r++}if(s(),i)throw new Cr(Ar.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Hr(t)}static emptyPath(){return new Hr([])}}class Wr{constructor(e){this.path=e}static fromPath(e){return new Wr(Qr.fromString(e))}static fromName(e){return new Wr(Qr.fromString(e).popFirst(5))}static empty(){return new Wr(Qr.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===Qr.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Qr.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Wr(new Qr(e.slice()))}}class Yr{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function Xr(e){return e.fields.find(e=>2===e.kind)}function Jr(e){return e.fields.filter(e=>2!==e.kind)}Yr.UNKNOWN_ID=-1;class Zr{constructor(e,t){this.fieldPath=e,this.kind=t}}class es{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new es(0,rs.min())}}function ts(e,t){var n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,r=Kr.fromTimestamp(1e9===r?new jr(n+1,0):new jr(n,r));return new rs(r,Wr.empty(),t)}function ns(e){return new rs(e.readTime,e.key,-1)}class rs{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new rs(Kr.min(),Wr.empty(),-1)}static max(){return new rs(Kr.max(),Wr.empty(),-1)}}function ss(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=Wr.comparator(e.documentKey,t.documentKey),0!==n?n:Ur(e.largestBatchId,t.largestBatchId))}const is="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class as{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function os(e){if(e.code!==Ar.FAILED_PRECONDITION||e.message!==is)throw e;Er("LocalStore","Unexpectedly lost primary lease")}class us{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,s){return this.callbackAttached&&xr(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new us((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(s,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof us?t:us.resolve(t)}catch(e){return us.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):us.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):us.reject(t)}static resolve(n){return new us((e,t)=>{e(n)})}static reject(n){return new us((e,t)=>{t(n)})}static waitFor(e){return new us((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=us.resolve(!1);for(const n of e)t=t.next(e=>e?us.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new us((t,n)=>{const r=o.length,s=new Array(r);let i=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{s[a]=e,++i,i===r&&t(s)},e=>n(e))}})}static doWhile(r,s){return new us((e,t)=>{const n=()=>{!0===r()?s().next(()=>{n()},t):e()};n()})}}class cs{constructor(n,e){this.action=n,this.transaction=e,this.aborted=!1,this.P=new Nr,this.transaction.oncomplete=()=>{this.P.resolve()},this.transaction.onabort=()=>{e.error?this.P.reject(new ds(n,e.error)):this.P.resolve()},this.transaction.onerror=e=>{var t=ys(e.target.error);this.P.reject(new ds(n,t))}}static open(e,t,n,r){try{return new cs(t,e.transaction(r,n))}catch(e){throw new ds(t,e)}}get v(){return this.P.promise}abort(e){e&&this.P.reject(e),this.aborted||(Er("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}V(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){var t=this.transaction.objectStore(e);return new gs(t)}}class hs{constructor(e,t,n){this.name=e,this.version=t,this.S=n,12.2===hs.D(f())&&Tr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return Er("SimpleDb","Removing database:",e),ms(window.indexedDB.deleteDatabase(e)).toPromise()}static C(){if("object"!=typeof indexedDB)return!1;if(hs.N())return!0;const e=f(),t=hs.D(e),n=0<t&&t<10,r=hs.k(e),s=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||s)}static N(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.M)}static O(e,t){return e.store(t)}static D(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static k(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async F(i){return this.db||(Er("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=e=>{var t=e.target.result;n(t)},s.onblocked=()=>{r(new ds(i,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{var t=e.target.error;"VersionError"===t.name?r(new Cr(Ar.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?r(new Cr(Ar.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):r(new ds(i,t))},s.onupgradeneeded=e=>{Er("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.S.$(t,s.transaction,e.oldVersion,this.version).next(()=>{Er("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.B&&(this.db.onversionchange=e=>this.B(e)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.F(e);const t=cs.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.V(),e)).catch(e=>(t.abort(e),us.reject(e))).toPromise();return i.catch(()=>{}),await t.v,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(Er("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class ls{constructor(e){this.U=e,this.q=!1,this.K=null}get isDone(){return this.q}get G(){return this.K}set cursor(e){this.U=e}done(){this.q=!0}j(e){this.K=e}delete(){return ms(this.U.delete())}}class ds extends Cr{constructor(e,t){super(Ar.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function fs(e){return"IndexedDbTransactionError"===e.name}class gs{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(Er("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(Er("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),ms(n)}add(e){return Er("SimpleDb","ADD",this.store.name,e,e),ms(this.store.add(e))}get(t){return ms(this.store.get(t)).next(e=>(Er("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return Er("SimpleDb","DELETE",this.store.name,e),ms(this.store.delete(e))}count(){return Er("SimpleDb","COUNT",this.store.name),ms(this.store.count())}W(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.H(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new us((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}J(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new us((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}Y(e,t){Er("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.X=!1;var r=this.cursor(n);return this.H(r,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.H(r,t)}tt(s){const e=this.cursor({});return new us((n,r)=>{e.onerror=e=>{var t=ys(e.target.error);r(t)},e.onsuccess=e=>{const t=e.target.result;t?s(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}H(e,i){const a=[];return new us((s,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new ls(t),r=i(t.primaryKey,t.value,n);if(r instanceof us){const e=r.catch(e=>(n.done(),us.reject(e)));a.push(e)}n.isDone?s():null===n.G?t.continue():t.continue(n.G)}else s()}}).next(()=>us.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.X?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function ms(e){return new us((n,r)=>{e.onsuccess=e=>{var t=e.target.result;n(t)},e.onerror=e=>{var t=ys(e.target.error);r(t)}})}let ps=!1;function ys(e){const t=hs.D(f());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new Cr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ps||(ps=!0,setTimeout(()=>{throw e},0)),e}}return e}class vs{constructor(e,t){this.asyncQueue=e,this.et=t,this.task=null}start(){this.nt(15)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}nt(e){Er("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{Er("IndexBackiller",`Documents written: ${await this.et.st()}`)}catch(e){fs(e)?Er("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await os(e)}await this.nt(1)})}}class ws{constructor(e,t){this.localStore=e,this.persistence=t}async st(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.it(e,t))}it(e,t){const n=new Set;let r=t,s=!0;return us.doWhile(()=>!0===s&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(s=!1):(Er("IndexBackiller",`Processing collection: ${t}`),this.rt(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}rt(r,s,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,s).next(n=>this.localStore.localDocuments.getNextDocuments(r,s,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.ot(n,e)).next(e=>(Er("IndexBackiller",`Updating offset: ${e}`),this.localStore.indexManager.updateCollectionGroup(r,s,e))).next(()=>t.size)}))}ot(e,t){let r=e;return t.changes.forEach((e,t)=>{var n=ns(t);0<ss(n,r)&&(r=n)}),new rs(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}class Is{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ut(e),this.ct=e=>t.writeSequenceNumber(e))}ut(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.ct&&this.ct(e),e}}function bs(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function Es(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Ts(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}Is.at=-1;class Ss{constructor(e,t){this.comparator=e,this.root=t||xs.EMPTY}insert(e,t){return new Ss(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,xs.BLACK,null,null))}remove(e){return new Ss(this.comparator,this.root.remove(e,this.comparator).copy(null,null,xs.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(`${e}:${t}`),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new _s(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new _s(this.root,e,this.comparator,!1)}getReverseIterator(){return new _s(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new _s(this.root,e,this.comparator,!0)}}class _s{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class xs{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:xs.RED,this.left=null!=r?r:xs.EMPTY,this.right=null!=s?s:xs.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new xs(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return xs.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return xs.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,xs.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,xs.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw xr();if(this.right.isRed())throw xr();var e=this.left.check();if(e!==this.right.check())throw xr();return e+(this.isRed()?0:1)}}xs.EMPTY=null,xs.RED=!0,xs.BLACK=!1,xs.EMPTY=new class{constructor(){this.size=0}get key(){throw xr()}get value(){throw xr()}get color(){throw xr()}get left(){throw xr()}get right(){throw xr()}copy(e,t,n,r,s){return this}insert(e,t,n){return new xs(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ds{constructor(e){this.comparator=e,this.data=new Ss(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new As(this.data.getIterator())}getIteratorFrom(e){return new As(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof Ds))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new Ds(this.comparator);return t.data=e,t}}class As{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Cs(e){return e.hasNext()?e.getNext():void 0}class Ns{constructor(e){(this.fields=e).sort(Hr.comparator)}static empty(){return new Ns([])}unionWith(e){let t=new Ds(Hr.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new Ns(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return qr(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class ks{constructor(e){this.binaryString=e}static fromBase64String(e){var t=atob(e);return new ks(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new ks(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Ur(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}ks.EMPTY_BYTE_STRING=new ks("");const Rs=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Ls(t){if(Dr(!!t),"string"!=typeof t)return{seconds:Os(t.seconds),nanos:Os(t.nanos)};{let e=0;var n=Rs.exec(t);Dr(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function Os(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Ms(e){return"string"==typeof e?ks.fromBase64String(e):ks.fromUint8Array(e)}function Vs(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function Fs(e){var t=Ls(e.mapValue.fields.__local_write_time__.timestampValue);return new jr(t.seconds,t.nanos)}class Ps{constructor(e,t,n,r,s,i,a,o){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=a,this.useFetchStreams=o}}class Bs{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Bs("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Bs&&e.projectId===this.projectId&&e.database===this.database}}function Us(e){return null==e}function qs(e){return 0===e&&1/e==-1/0}function Gs(e){return"number"==typeof e&&Number.isInteger(e)&&!qs(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}const js={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Ks={nullValue:"NULL_VALUE"};function $s(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Vs(e)?4:si(e)?9007199254740991:10:xr()}function Qs(r,s){if(r===s)return!0;var e,t,n=$s(r);if(n!==$s(s))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return r.booleanValue===s.booleanValue;case 4:return Fs(r).isEqual(Fs(s));case 3:return function(e){if("string"==typeof r.timestampValue&&"string"==typeof e.timestampValue&&r.timestampValue.length===e.timestampValue.length)return r.timestampValue===e.timestampValue;var t=Ls(r.timestampValue),n=Ls(e.timestampValue);return t.seconds===n.seconds&&t.nanos===n.nanos}(s);case 5:return r.stringValue===s.stringValue;case 6:return t=s,Ms(r.bytesValue).isEqual(Ms(t.bytesValue));case 7:return r.referenceValue===s.referenceValue;case 8:return e=s,Os((t=r).geoPointValue.latitude)===Os(e.geoPointValue.latitude)&&Os(t.geoPointValue.longitude)===Os(e.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Os(e.integerValue)===Os(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=Os(e.doubleValue),r=Os(t.doubleValue);return n===r?qs(n)===qs(r):isNaN(n)&&isNaN(r)}return!1}(r,s);case 9:return qr(r.arrayValue.values||[],s.arrayValue.values||[],Qs);case 10:return function(e){const t=e.mapValue.fields||{},n=s.mapValue.fields||{};if(bs(t)!==bs(n))return!1;for(const e in t)if(t.hasOwnProperty(e)&&(void 0===n[e]||!Qs(t[e],n[e])))return!1;return!0}(r);default:return xr()}}function zs(e,t){return void 0!==(e.values||[]).find(e=>Qs(e,t))}function Hs(e,t){if(e===t)return 0;var n,r,s,i,a=$s(e),o=$s(t);if(a!==o)return Ur(a,o);switch(a){case 0:case 9007199254740991:return 0;case 1:return Ur(e.booleanValue,t.booleanValue);case 2:return r=t,s=Os(e.integerValue||e.doubleValue),i=Os(r.integerValue||r.doubleValue),s<i?-1:i<s?1:s===i?0:isNaN(s)?isNaN(i)?0:-1:1;case 3:return Ws(e.timestampValue,t.timestampValue);case 4:return Ws(Fs(e),Fs(t));case 5:return Ur(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Ms(e),r=Ms(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const t=Ur(n[s],r[s]);if(0!==t)return t}return Ur(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(i=Ur(Os(n.latitude),Os(r.latitude)))?i:Ur(Os(n.longitude),Os(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const t=Hs(n[s],r[s]);if(t)return t}return Ur(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===js.mapValue&&t===js.mapValue)return 0;if(e===js.mapValue)return 1;if(t===js.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const t=Ur(r[o],i[o]);if(0!==t)return t;var a=Hs(n[r[o]],s[i[o]]);if(0!==a)return a}return Ur(r.length,i.length)}(e.mapValue,t.mapValue);default:throw xr()}}function Ws(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Ur(e,t);var n=Ls(e),r=Ls(t),s=Ur(n.seconds,r.seconds);return 0!==s?s:Ur(n.nanos,r.nanos)}function Ys(e){return function i(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Ls(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?Ms(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,Wr.fromName(t).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=i(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${i(e.fields[s])}`;return n+"}"}(e.mapValue):xr();var t}(e)}function Xs(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Js(e){return e&&"integerValue"in e}function Zs(e){return!!e&&"arrayValue"in e}function ei(e){return e&&"nullValue"in e}function ti(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function ni(e){return e&&"mapValue"in e}function ri(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return Es(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=ri(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=ri(t.arrayValue.values[e]);return r}return Object.assign({},t)}function si(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function ii(e,t){var n=Hs(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function ai(e,t){var n=Hs(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class oi{constructor(e){this.value=e}static empty(){return new oi({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!ni(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=ri(t)}setAll(e){let n=Hr.emptyPath(),r={},s=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,s),r={},s=[],n=t.popLast()}e?r[t.lastSegment()]=ri(e):s.push(t.lastSegment())});var t=this.getFieldsMap(n);this.applyChanges(t,r,s)}delete(e){const t=this.field(e.popLast());ni(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Qs(this.value,e.value)}getFieldsMap(t){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<t.length;++r){let e=n.mapValue.fields[t.get(r)];ni(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},n.mapValue.fields[t.get(r)]=e),n=e}return n.mapValue.fields}applyChanges(n,e,t){Es(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new oi(ri(this.value))}}class ui{constructor(e,t,n,r,s,i){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.data=s,this.documentState=i}static newInvalidDocument(e){return new ui(e,0,Kr.min(),Kr.min(),oi.empty(),0)}static newFoundDocument(e,t,n){return new ui(e,1,t,Kr.min(),n,0)}static newNoDocument(e,t){return new ui(e,2,t,Kr.min(),oi.empty(),0)}static newUnknownDocument(e,t){return new ui(e,3,t,Kr.min(),oi.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=oi.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=oi.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Kr.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof ui&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new ui(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class ci{constructor(e,t=null,n=[],r=[],s=null,i=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=a,this.ht=null}}function hi(e,t=null,n=[],r=[],s=null,i=null,a=null){return new ci(e,t,n,r,s,i,a)}function li(e){const t=e;if(null===t.ht){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>{return(t=e).field.canonicalString()+t.op.toString()+Ys(t.value);var t}).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),Us(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>Ys(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>Ys(e)).join(",")),t.ht=e}return t.ht}function di(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let a=0;a<e.orderBy.length;a++)if(n=e.orderBy[a],r=t.orderBy[a],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r,s,i;if(e.filters.length!==t.filters.length)return!1;for(let o=0;o<e.filters.length;o++)if(s=e.filters[o],i=t.filters[o],s.op!==i.op||!s.field.isEqual(i.field)||!Qs(s.value,i.value))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Ci(e.startAt,t.startAt)&&Ci(e.endAt,t.endAt)}function fi(e){return Wr.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function gi(e,t){return e.filters.filter(e=>e instanceof yi&&e.field.isEqual(t))}function mi(t,n,r){let s=Ks,i=!0;for(const r of gi(t,n)){let e=Ks,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?Ks:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Xs(Bs.empty(),Wr.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:xr();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=Ks}ii({value:s,inclusive:i},{value:e,inclusive:t})<0&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];ii({value:s,inclusive:i},{value:t,inclusive:r.inclusive})<0&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}function pi(t,n,r){let s=js,i=!0;for(const r of gi(t,n)){let e=js,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Xs(Bs.empty(),Wr.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?js:xr(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=js}0<ai({value:s,inclusive:i},{value:e,inclusive:t})&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<ai({value:s,inclusive:i},{value:t,inclusive:r.inclusive})&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}class yi extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.lt(e,t,n):new vi(e,t,n):"array-contains"===t?new Ei(e,n):"in"===t?new Ti(e,n):"not-in"===t?new Si(e,n):"array-contains-any"===t?new _i(e,n):new yi(e,t,n)}static lt(e,t,n){return new("in"===t?wi:Ii)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.ft(Hs(t,this.value)):null!==t&&$s(this.value)===$s(t)&&this.ft(Hs(t,this.value))}ft(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return xr()}}dt(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}}class vi extends yi{constructor(e,t,n){super(e,t,n),this.key=Wr.fromName(n.referenceValue)}matches(e){var t=Wr.comparator(e.key,this.key);return this.ft(t)}}class wi extends yi{constructor(e,t){super(e,"in",t),this.keys=bi(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class Ii extends yi{constructor(e,t){super(e,"not-in",t),this.keys=bi(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function bi(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>Wr.fromName(e.referenceValue))}class Ei extends yi{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return Zs(t)&&zs(t.arrayValue,this.value)}}class Ti extends yi{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&zs(this.value.arrayValue,t)}}class Si extends yi{constructor(e,t){super(e,"not-in",t)}matches(e){if(zs(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!zs(this.value.arrayValue,t)}}class _i extends yi{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Zs(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>zs(this.value.arrayValue,e))}}class xi{constructor(e,t){this.position=e,this.inclusive=t}}class Di{constructor(e,t="asc"){this.field=e,this.dir=t}}function Ai(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],a=e.position[s];if(r=i.field.isKeyField()?Wr.comparator(Wr.fromName(a.referenceValue),n.key):Hs(a,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Ci(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!Qs(e.position[n],t.position[n]))return!1;return!0}class Ni{constructor(e,t=null,n=[],r=[],s=null,i="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=a,this.endAt=o,this._t=null,this.wt=null,this.startAt,this.endAt}}function ki(e,t,n,r,s,i,a,o){return new Ni(e,t,n,r,s,i,a,o)}function Ri(e){return new Ni(e)}function Li(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Oi(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function Mi(e){for(const t of e.filters)if(t.dt())return t.field;return null}function Vi(e){return null!==e.collectionGroup}function Fi(t){const n=t;if(null===n._t){n._t=[];const t=Mi(n),e=Oi(n);if(null!==t&&null===e)t.isKeyField()||n._t.push(new Di(t)),n._t.push(new Di(Hr.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n._t.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n._t.push(new Di(Hr.keyField(),t))}}}return n._t}function Pi(e){const t=e;if(!t.wt)if("F"===t.limitType)t.wt=hi(t.path,t.collectionGroup,Fi(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of Fi(t)){const t="desc"===s.dir?"asc":"desc";e.push(new Di(s.field,t))}var n=t.endAt?new xi(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new xi(t.startAt.position,t.startAt.inclusive):null;t.wt=hi(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.wt}function Bi(e,t,n){return new Ni(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Ui(e,t){return di(Pi(e),Pi(t))&&e.limitType===t.limitType}function qi(e){return`${li(Pi(e))}|lt:${e.limitType}`}function Gi(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>{return`${(t=e).field.canonicalString()} ${t.op} ${Ys(t.value)}`;var t}).join(", ")}]`),Us(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>Ys(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>Ys(e)).join(",")),`Target(${t})`}(Pi(e))}; limitType=${e.limitType})`}function ji(n,e){return e.isFoundDocument()&&(s=n,a=(i=e).key.path,null!==s.collectionGroup?i.key.hasCollectionId(s.collectionGroup)&&s.path.isPrefixOf(a):Wr.isDocumentKey(s.path)?s.path.isEqual(a):s.path.isImmediateParentOf(a))&&function(e){for(const t of n.explicitOrderBy)if(!t.field.isKeyField()&&null===e.data.field(t.field))return;return 1}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return;return 1}(e)&&(s=e,(!(e=n).startAt||(t=e.startAt,r=Ai(t,Fi(e),s),t.inclusive?r<=0:r<0))&&(!e.endAt||(t=e.endAt,r=Ai(t,Fi(e),s),t.inclusive?0<=r:0<r)));var t,r,s,i,a}function Ki(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function $i(s){return(e,t)=>{let n=!1;for(const r of Fi(s)){const s=function(e,s,t){var n=e.field.isKeyField()?Wr.comparator(s.key,t.key):function(e,t){var n=s.data.field(e),r=t.data.field(e);return null!==n&&null!==r?Hs(n,r):xr()}(e.field,t);switch(e.dir){case"asc":return n;case"desc":return-1*n;default:return xr()}}(r,e,t);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}function Qi(e,t){if(e.gt){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:qs(t)?"-0":t}}function zi(e){return{integerValue:""+e}}function Hi(e,t){return Gs(t)?zi(t):Qi(e,t)}class Wi{constructor(){this._=void 0}}function Yi(e,t){return e instanceof na?Js(n=t)||n&&"doubleValue"in n?t:{integerValue:0}:null;var n}class Xi extends Wi{}class Ji extends Wi{constructor(e){super(),this.elements=e}}function Zi(e,t){const n=sa(t);for(const t of e.elements)n.some(e=>Qs(e,t))||n.push(t);return{arrayValue:{values:n}}}class ea extends Wi{constructor(e){super(),this.elements=e}}function ta(e,t){let n=sa(t);for(const t of e.elements)n=n.filter(e=>!Qs(e,t));return{arrayValue:{values:n}}}class na extends Wi{constructor(e,t){super(),this.It=e,this.yt=t}}function ra(e){return Os(e.integerValue||e.doubleValue)}function sa(e){return Zs(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class ia{constructor(e,t){this.field=e,this.transform=t}}class aa{constructor(e,t){this.version=e,this.transformResults=t}}class oa{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new oa}static exists(e){return new oa(void 0,e)}static updateTime(e){return new oa(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function ua(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class ca{}function ha(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new wa(e.key,oa.none()):new ga(e.key,e.data,oa.none());{const s=e.data,i=oi.empty();let t=new Ds(Hr.comparator);for(var r of n.fields)if(!t.has(r)){let e=s.field(r);null===e&&1<r.length&&(r=r.popLast(),e=s.field(r)),null===e?i.delete(r):i.set(r,e),t=t.add(r)}return new ma(e.key,i,new Ns(t.toArray()),oa.none())}}function la(e,t,n){e instanceof ga?function(e,t,n){const r=e.value.clone(),s=ya(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof ma?function(e,t,n){if(!ua(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=ya(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(pa(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function da(e,t,n,r){return e instanceof ga?function(e,t,n,r){if(!ua(e.precondition,t))return n;const s=e.value.clone(),i=va(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof ma?function(e,t,n,r){if(!ua(e.precondition,t))return n;const s=va(e.fieldTransforms,r,t),i=t.data;return i.setAll(pa(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):(t=t,n=n,ua(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n)}function fa(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&qr(n,r,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof Ji&&t instanceof Ji||e instanceof ea&&t instanceof ea?qr(e.elements,t.elements,Qs):e instanceof na&&t instanceof na?Qs(e.yt,t.yt):e instanceof Xi&&t instanceof Xi)}(e,t)))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class ga extends ca{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class ma extends ca{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function pa(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function ya(e,t,n){const r=new Map;Dr(e.length===n.length);for(let h=0;h<n.length;h++){var s=e[h],i=s.transform,a=t.data.field(s.field);r.set(s.field,(o=i,u=a,c=n[h],o instanceof Ji?Zi(o,u):o instanceof ea?ta(o,u):c))}var o,u,c;return r}function va(e,t,n){const r=new Map;for(const c of e){const e=c.transform,h=n.data.field(c.field);r.set(c.field,(s=e,i=h,a=t,u=o=void 0,s instanceof Xi?function(){const e={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:a.seconds,nanos:a.nanoseconds}}}};return i&&(e.fields.__previous_value__=i),{mapValue:e}}():s instanceof Ji?Zi(s,i):s instanceof ea?ta(s,i):(o=Yi(s=s,i),u=ra(o)+ra(s.yt),Js(o)&&Js(s.yt)?zi(u):Qi(s.It,u))))}var s,i,a,o,u;return r}class wa extends ca{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Ia extends ca{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class ba{constructor(e){this.count=e}}function Ea(e){switch(e){default:return xr(),0;case Ar.CANCELLED:case Ar.UNKNOWN:case Ar.DEADLINE_EXCEEDED:case Ar.RESOURCE_EXHAUSTED:case Ar.INTERNAL:case Ar.UNAVAILABLE:case Ar.UNAUTHENTICATED:return;case Ar.INVALID_ARGUMENT:case Ar.NOT_FOUND:case Ar.ALREADY_EXISTS:case Ar.PERMISSION_DENIED:case Ar.FAILED_PRECONDITION:case Ar.ABORTED:case Ar.OUT_OF_RANGE:case Ar.UNIMPLEMENTED:case Ar.DATA_LOSS:return 1}}function Ta(e){if(void 0===e)return Tr("GRPC error has no .code"),Ar.UNKNOWN;switch(e){case or.OK:return Ar.OK;case or.CANCELLED:return Ar.CANCELLED;case or.UNKNOWN:return Ar.UNKNOWN;case or.DEADLINE_EXCEEDED:return Ar.DEADLINE_EXCEEDED;case or.RESOURCE_EXHAUSTED:return Ar.RESOURCE_EXHAUSTED;case or.INTERNAL:return Ar.INTERNAL;case or.UNAVAILABLE:return Ar.UNAVAILABLE;case or.UNAUTHENTICATED:return Ar.UNAUTHENTICATED;case or.INVALID_ARGUMENT:return Ar.INVALID_ARGUMENT;case or.NOT_FOUND:return Ar.NOT_FOUND;case or.ALREADY_EXISTS:return Ar.ALREADY_EXISTS;case or.PERMISSION_DENIED:return Ar.PERMISSION_DENIED;case or.FAILED_PRECONDITION:return Ar.FAILED_PRECONDITION;case or.ABORTED:return Ar.ABORTED;case or.OUT_OF_RANGE:return Ar.OUT_OF_RANGE;case or.UNIMPLEMENTED:return Ar.UNIMPLEMENTED;case or.DATA_LOSS:return Ar.DATA_LOSS;default:return xr()}}(it=or=or||{})[it.OK=0]="OK",it[it.CANCELLED=1]="CANCELLED",it[it.UNKNOWN=2]="UNKNOWN",it[it.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",it[it.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",it[it.NOT_FOUND=5]="NOT_FOUND",it[it.ALREADY_EXISTS=6]="ALREADY_EXISTS",it[it.PERMISSION_DENIED=7]="PERMISSION_DENIED",it[it.UNAUTHENTICATED=16]="UNAUTHENTICATED",it[it.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",it[it.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",it[it.ABORTED=10]="ABORTED",it[it.OUT_OF_RANGE=11]="OUT_OF_RANGE",it[it.UNIMPLEMENTED=12]="UNIMPLEMENTED",it[it.INTERNAL=13]="INTERNAL",it[it.UNAVAILABLE=14]="UNAVAILABLE",it[it.DATA_LOSS=15]="DATA_LOSS";class Sa{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return void(r[s]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(r){Es(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return Ts(this.inner)}size(){return this.innerSize}}const _a=new Ss(Wr.comparator);const xa=new Ss(Wr.comparator);function Da(...e){let t=xa;for(const n of e)t=t.insert(n.key,n);return t}function Aa(e){let n=xa;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function Ca(){return new Sa(e=>e.toString(),(e,t)=>e.isEqual(t))}const Na=new Ss(Wr.comparator),ka=new Ds(Wr.comparator);function Ra(...e){let t=ka;for(const n of e)t=t.add(n);return t}const La=new Ds(Ur);class Oa{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t){const n=new Map;return n.set(e,Ma.createSynthesizedTargetChangeForCurrentChange(e,t)),new Oa(Kr.min(),n,La,_a,Ra())}}class Ma{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t){return new Ma(ks.EMPTY_BYTE_STRING,t,Ra(),Ra(),Ra())}}class Va{constructor(e,t,n,r){this.Tt=e,this.removedTargetIds=t,this.key=n,this.Et=r}}class Fa{constructor(e,t){this.targetId=e,this.At=t}}class Pa{constructor(e,t,n=ks.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Ba{constructor(){this.Rt=0,this.bt=Ga(),this.Pt=ks.EMPTY_BYTE_STRING,this.vt=!1,this.Vt=!0}get current(){return this.vt}get resumeToken(){return this.Pt}get St(){return 0!==this.Rt}get Dt(){return this.Vt}Ct(e){0<e.approximateByteSize()&&(this.Vt=!0,this.Pt=e)}xt(){let n=Ra(),r=Ra(),s=Ra();return this.bt.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:s=s.add(e);break;default:xr()}}),new Ma(this.Pt,this.vt,n,r,s)}Nt(){this.Vt=!1,this.bt=Ga()}kt(e,t){this.Vt=!0,this.bt=this.bt.insert(e,t)}Mt(e){this.Vt=!0,this.bt=this.bt.remove(e)}Ot(){this.Rt+=1}Ft(){--this.Rt}$t(){this.Vt=!0,this.vt=!0}}class Ua{constructor(e){this.Bt=e,this.Lt=new Map,this.Ut=_a,this.qt=qa(),this.Kt=new Ds(Ur)}Gt(e){for(const t of e.Tt)e.Et&&e.Et.isFoundDocument()?this.Qt(t,e.Et):this.jt(t,e.key,e.Et);for(const n of e.removedTargetIds)this.jt(n,e.key,e.Et)}Wt(n){this.forEachTarget(n,e=>{const t=this.zt(e);switch(n.state){case 0:this.Ht(e)&&t.Ct(n.resumeToken);break;case 1:t.Ft(),t.St||t.Nt(),t.Ct(n.resumeToken);break;case 2:t.Ft(),t.St||this.removeTarget(e);break;case 3:this.Ht(e)&&(t.$t(),t.Ct(n.resumeToken));break;case 4:this.Ht(e)&&(this.Jt(e),t.Ct(n.resumeToken));break;default:xr()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.Lt.forEach((e,t)=>{this.Ht(t)&&n(t)})}Yt(e){const t=e.targetId,n=e.At.count,r=this.Xt(t);if(r){const e=r.target;if(fi(e))if(0===n){const n=new Wr(e.path);this.jt(t,n,ui.newNoDocument(n,Kr.min()))}else Dr(1===n);else this.Zt(t)!==n&&(this.Jt(t),this.Kt=this.Kt.add(t))}}te(r){const s=new Map;this.Lt.forEach((e,t)=>{var n=this.Xt(t);if(n){if(e.current&&fi(n.target)){const s=new Wr(n.target.path);null!==this.Ut.get(s)||this.ee(t,s)||this.jt(t,s,ui.newNoDocument(s,r))}e.Dt&&(s.set(t,e.xt()),e.Nt())}});let i=Ra();this.qt.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{var t=this.Xt(e);return!t||2===t.purpose||(n=!1)}),n&&(i=i.add(e))}),this.Ut.forEach((e,t)=>t.setReadTime(r));var e=new Oa(r,s,this.Kt,this.Ut,i);return this.Ut=_a,this.qt=qa(),this.Kt=new Ds(Ur),e}Qt(e,t){var n;this.Ht(e)&&(n=this.ee(e,t.key)?2:0,this.zt(e).kt(t.key,n),this.Ut=this.Ut.insert(t.key,t),this.qt=this.qt.insert(t.key,this.ne(t.key).add(e)))}jt(e,t,n){if(this.Ht(e)){const r=this.zt(e);this.ee(e,t)?r.kt(t,1):r.Mt(t),this.qt=this.qt.insert(t,this.ne(t).delete(e)),n&&(this.Ut=this.Ut.insert(t,n))}}removeTarget(e){this.Lt.delete(e)}Zt(e){var t=this.zt(e).xt();return this.Bt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ot(e){this.zt(e).Ot()}zt(e){let t=this.Lt.get(e);return t||(t=new Ba,this.Lt.set(e,t)),t}ne(e){let t=this.qt.get(e);return t||(t=new Ds(Ur),this.qt=this.qt.insert(e,t)),t}Ht(e){var t=null!==this.Xt(e);return t||Er("WatchChangeAggregator","Detected inactive target",e),t}Xt(e){var t=this.Lt.get(e);return t&&t.St?null:this.Bt.se(e)}Jt(t){this.Lt.set(t,new Ba),this.Bt.getRemoteKeysForTarget(t).forEach(e=>{this.jt(t,e,null)})}ee(e,t){return this.Bt.getRemoteKeysForTarget(e).has(t)}}function qa(){return new Ss(Wr.comparator)}function Ga(){return new Ss(Wr.comparator)}const ja={asc:"ASCENDING",desc:"DESCENDING"},Ka={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class $a{constructor(e,t){this.databaseId=e,this.gt=t}}function Qa(e,t){return e.gt?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function za(e,t){return e.gt?t.toBase64():t.toUint8Array()}function Ha(e){return Dr(!!e),Kr.fromTimestamp((t=Ls(e),new jr(t.seconds,t.nanos)));var t}function Wa(e,t){return e=e,new Qr(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function Ya(e){var t=Qr.fromString(e);return Dr(mo(t)),t}function Xa(e,t){return Wa(e.databaseId,t.path)}function Ja(e,t){const n=Ya(t);if(n.get(1)!==e.databaseId.projectId)throw new Cr(Ar.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Cr(Ar.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Wr(no(n))}function Za(e,t){return Wa(e.databaseId,t)}function eo(e){var t=Ya(e);return 4===t.length?Qr.emptyPath():no(t)}function to(e){return new Qr(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function no(e){return Dr(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function ro(e,t,n){return{name:Xa(e,t),fields:n.value.mapValue.fields}}function so(e,t,n){const r=Ja(e,t.name),s=Ha(t.updateTime),i=new oi({mapValue:{fields:t.fields}}),a=ui.newFoundDocument(r,s,i);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function io(e,t){let n;if(t instanceof ga)n={update:ro(e,t.key,t.value)};else if(t instanceof wa)n={delete:Xa(e,t.key)};else if(t instanceof ma)n={update:ro(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof Ia))return xr();n={verify:Xa(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e){var t=e.transform;if(t instanceof Xi)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof Ji)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof ea)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof na)return{fieldPath:e.field.canonicalString(),increment:t.yt};throw xr()}(e))),t.precondition.isNone||(n.currentDocument=void 0!==(r=t.precondition).updateTime?{updateTime:(t=r.updateTime,Qa(e,t.toTimestamp()))}:void 0!==r.exists?{exists:r.exists}:xr()),n;var r}function ao(t,n){const e=n.currentDocument?void 0!==(s=n.currentDocument).updateTime?oa.updateTime(Ha(s.updateTime)):void 0!==s.exists?oa.exists(s.exists):oa.none():oa.none(),r=n.updateTransforms?n.updateTransforms.map(e=>function(e,t){let n=null;if("setToServerValue"in t)Dr("REQUEST_TIME"===t.setToServerValue),n=new Xi;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new Ji(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new ea(e)}else"increment"in t?n=new na(e,t.increment):xr();var r=Hr.fromServerFormat(t.fieldPath);return new ia(r,n)}(t,e)):[];var s;if(n.update){n.update.name;var i=Ja(t,n.update.name),a=new oi({mapValue:{fields:n.update.fields}});if(n.updateMask){const t=function(){const e=n.updateMask.fieldPaths||[];return new Ns(e.map(e=>Hr.fromServerFormat(e)))}();return new ma(i,a,t,e,r)}return new ga(i,a,e,r)}if(n.delete){const r=Ja(t,n.delete);return new wa(r,e)}if(n.verify){const r=Ja(t,n.verify);return new Ia(r,e)}return xr()}function oo(e,t){return{documents:[Za(e,t.path)]}}function uo(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=Za(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Za(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(e){if(0!==e.length){var t=e.map(e=>function(e){if("=="===e.op){if(ti(e.value))return{unaryFilter:{field:ho(e.field),op:"IS_NAN"}};if(ei(e.value))return{unaryFilter:{field:ho(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(ti(e.value))return{unaryFilter:{field:ho(e.field),op:"IS_NOT_NAN"}};if(ei(e.value))return{unaryFilter:{field:ho(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ho(e.field),op:(t=e.op,Ka[t]),value:e.value}};var t}(e));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}}(t.filters);s&&(n.structuredQuery.where=s);s=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:ho(e.field),direction:(e=e.dir,ja[e])}}(e))}(t.orderBy);s&&(n.structuredQuery.orderBy=s);var i,s=(i=t.limit,e.gt||Us(i)?i:{value:i});return null!==s&&(n.structuredQuery.limit=s),t.startAt&&(n.structuredQuery.startAt={before:(s=t.startAt).inclusive,values:s.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function co(e){let t=eo(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(0<r){Dr(1===r);const g=n.from[0];g.allDescendants?s=g.collectionId:t=t.child(g.collectionId)}let i=[];n.where&&(i=function t(e){return e?void 0!==e.unaryFilter?[go(e)]:void 0!==e.fieldFilter?[fo(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map(e=>t(e)).reduce((e,t)=>e.concat(t)):xr():[]}(n.where));let a=[];n.orderBy&&(a=n.orderBy.map(e=>function(e){return new Di(lo(e.field),function(){switch(e.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())}(e)));let o=null;var u,c,h,l;n.limit&&(o=(e=n.limit,Us(u="object"==typeof e?e.value:e)?null:u));let d=null;n.startAt&&(d=(c=n.startAt,l=!!c.before,h=c.values||[],new xi(h,l)));let f=null;return n.endAt&&(f=(c=n.endAt,h=!c.before,l=c.values||[],new xi(l,h))),ki(t,s,a,i,o,"F",d,f)}function ho(e){return{fieldPath:e.canonicalString()}}function lo(e){return Hr.fromServerFormat(e.fieldPath)}function fo(e){return yi.create(lo(e.fieldFilter.field),function(){switch(e.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return xr()}}(),e.fieldFilter.value)}function go(e){switch(e.unaryFilter.op){case"IS_NAN":var t=lo(e.unaryFilter.field);return yi.create(t,"==",{doubleValue:NaN});case"IS_NULL":t=lo(e.unaryFilter.field);return yi.create(t,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var n=lo(e.unaryFilter.field);return yi.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":n=lo(e.unaryFilter.field);return yi.create(n,"!=",{nullValue:"NULL_VALUE"});default:return xr()}}function mo(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}function po(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=yo(t)),t=function(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const r=e.charAt(s);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return yo(t)}function yo(e){return e+""}function vo(t){const n=t.length;if(Dr(2<=n),2===n)return Dr(""===t.charAt(0)&&""===t.charAt(1)),Qr.emptyPath();const r=n-2,s=[];let i="";for(let a=0;a<n;){const n=t.indexOf("",a);switch((n<0||n>r)&&xr(),t.charAt(n+1)){case"":const r=t.substring(a,n);let e;0===i.length?e=r:(i+=r,e=i,i=""),s.push(e);break;case"":i+=t.substring(a,n),i+="\0";break;case"":i+=t.substring(a,n+1);break;default:xr()}a=n+2}return new Qr(s)}const wo=["userId","batchId"];function Io(e,t){return[e,po(t)]}function bo(e,t,n){return[e,po(t),n]}const Eo={},To=["prefixPath","collectionGroup","readTime","documentId"],So=["prefixPath","collectionGroup","documentId"],_o=["collectionGroup","readTime","prefixPath","documentId"],xo=["canonicalId","targetId"],Do=["targetId","path"],Ao=["path","targetId"],Co=["collectionId","parent"],No=["indexId","uid"],ko=["uid","sequenceNumber"],Ro=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Lo=["indexId","uid","orderedDocumentKey"],Oo=["userId","collectionPath","documentId"],Mo=["userId","collectionPath","largestBatchId"],Vo=["userId","collectionGroup","largestBatchId"],Fo=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Po=[...Fo,"documentOverlays"],Bo=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Uo=Bo,qo=[...Uo,"indexConfiguration","indexState","indexEntries"];class Go extends as{constructor(e,t){super(),this.ie=e,this.currentSequenceNumber=t}}function jo(e,t){var n=e;return hs.O(n.ie,t)}class Ko{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const s=this.mutations[r];s.key.isEqual(e.key)&&la(s,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=da(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=da(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(i,a){const o=Ca();return this.mutations.forEach(e=>{const t=i.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=a.has(e.key)?null:r;var s=ha(n,r);null!==s&&o.set(e.key,s),n.isValidDocument()||n.convertToNoDocument(Kr.min())}),o}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),Ra())}isEqual(e){return this.batchId===e.batchId&&qr(this.mutations,e.mutations,(e,t)=>fa(e,t))&&qr(this.baseMutations,e.baseMutations,(e,t)=>fa(e,t))}}class $o{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Dr(e.mutations.length===n.length);let r=Na;var s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new $o(e,t,n,r)}}class Qo{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class zo{constructor(e,t,n,r,s=Kr.min(),i=Kr.min(),a=ks.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=a}withSequenceNumber(e){return new zo(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new zo(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new zo(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class Ho{constructor(e){this.re=e}}function Wo(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Yo(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:Xa(s=e.re,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:Qa(s,e.version.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Xo(t.version)};else{if(!t.isUnknownDocument())return xr();r.unknownDocument={path:n.path.toArray(),version:Xo(t.version)}}var s;return r}function Yo(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Xo(e){var t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function Jo(e){var t=new jr(e.seconds,e.nanoseconds);return Kr.fromTimestamp(t)}function Zo(t,e){const n=(e.baseMutations||[]).map(e=>ao(t.re,e));for(let i=0;i<e.mutations.length-1;++i){const n=e.mutations[i];if(i+1<e.mutations.length&&void 0!==e.mutations[i+1].transform){const r=e.mutations[i+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(i+1,1),++i}}const r=e.mutations.map(e=>ao(t.re,e)),s=jr.fromMillis(e.localWriteTimeMs);return new Ko(e.batchId,s,n,r)}function eu(e){var t,n=Jo(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?Jo(e.lastLimboFreeSnapshotVersion):Kr.min();let s;return s=void 0!==e.query.documents?(Dr(1===(t=e.query).documents.length),Pi(Ri(eo(t.documents[0])))):Pi(co(e.query)),new zo(s,e.targetId,0,e.lastListenSequenceNumber,n,r,ks.fromBase64String(e.resumeToken))}function tu(e,t){var n=Xo(t.snapshotVersion),r=Xo(t.lastLimboFreeSnapshotVersion),s=(fi(t.target)?oo:uo)(e.re,t.target),i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:li(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function nu(e){var t=co({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Bi(t,t.limit,"L"):t}function ru(e,t){return new Qo(t.largestBatchId,ao(e.re,t.overlayMutation))}function su(e,t){var n=t.path.lastSegment();return[e,po(t.path.popLast()),n]}function iu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Xo(r.readTime),documentKey:po(r.documentKey.path),largestBatchId:r.largestBatchId}}class au{getBundleMetadata(e,t){return ou(e).get(t).next(e=>{if(e)return{id:(t=e).bundleId,createTime:Jo(t.createTime),version:t.version};var t})}saveBundleMetadata(e,t){return ou(e).put({bundleId:(n=t).id,createTime:Xo(Ha(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return uu(e).get(t).next(e=>{if(e)return{name:(t=e).name,query:nu(t.bundledQuery),readTime:Jo(t.readTime)};var t})}saveNamedQuery(e,t){return uu(e).put({name:(t=t).name,readTime:Xo(Ha(t.readTime)),bundledQuery:t.bundledQuery})}}function ou(e){return jo(e,"bundles")}function uu(e){return jo(e,"namedQueries")}class cu{constructor(e,t){this.It=e,this.userId=t}static oe(e,t){var n=t.uid||"";return new cu(e,n)}getOverlay(e,t){return hu(e).get(su(this.userId,t)).next(e=>e?ru(this.It,e):null)}getOverlays(e,t){const n=Ca();return us.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(r,s,e){const i=[];return e.forEach((e,t)=>{var n=new Qo(s,t);i.push(this.ue(r,n))}),us.waitFor(i)}removeOverlaysForBatchId(n,e,r){const t=new Set;e.forEach(e=>t.add(po(e.getCollectionPath())));const s=[];return t.forEach(e=>{var t=IDBKeyRange.bound([this.userId,e,r],[this.userId,e,r+1],!1,!0);s.push(hu(n).Y("collectionPathOverlayIndex",t))}),us.waitFor(s)}getOverlaysForCollection(e,t,n){const r=Ca(),s=po(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return hu(e).W("collectionPathOverlayIndex",i).next(e=>{for(const t of e){const e=ru(this.It,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,s){const i=Ca();let a;var r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return hu(e).Z({index:"collectionGroupOverlayIndex",range:r},(e,t,n)=>{const r=ru(this.It,t);i.size()<s||r.largestBatchId===a?(i.set(r.getKey(),r),a=r.largestBatchId):n.done()}).next(()=>i)}ue(e,t){return hu(e).put(function(e,t,n){var[,r,s]=su(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:io(e.re,n.mutation)}}(this.It,this.userId,t))}}function hu(e){return jo(e,"documentOverlays")}class lu{constructor(){}ce(e,t){this.ae(e,t),t.he()}ae(e,t){var n,r;"nullValue"in e?this.le(t,5):"booleanValue"in e?(this.le(t,10),t.fe(e.booleanValue?1:0)):"integerValue"in e?(this.le(t,15),t.fe(Os(e.integerValue))):"doubleValue"in e?(n=Os(e.doubleValue),isNaN(n)?this.le(t,13):(this.le(t,15),qs(n)?t.fe(0):t.fe(n))):"timestampValue"in e?(r=e.timestampValue,this.le(t,20),"string"==typeof r?t.de(r):(t.de(`${r.seconds||""}`),t.fe(r.nanos||0))):"stringValue"in e?(this._e(e.stringValue,t),this.we(t)):"bytesValue"in e?(this.le(t,30),t.me(Ms(e.bytesValue)),this.we(t)):"referenceValue"in e?this.ge(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.le(t,45),t.fe(r.latitude||0),t.fe(r.longitude||0)):"mapValue"in e?si(e)?this.le(t,Number.MAX_SAFE_INTEGER):(this.ye(e.mapValue,t),this.we(t)):"arrayValue"in e?(this.pe(e.arrayValue,t),this.we(t)):xr()}_e(e,t){this.le(t,25),this.Ie(e,t)}Ie(e,t){t.de(e)}ye(e,t){var n=e.fields||{};this.le(t,55);for(const e of Object.keys(n))this._e(e,t),this.ae(n[e],t)}pe(e,t){var n=e.values||[];this.le(t,50);for(const e of n)this.ae(e,t)}ge(e,t){this.le(t,37),Wr.fromName(e).path.forEach(e=>{this.le(t,60),this.Ie(e,t)})}le(e,t){e.fe(t)}we(e){e.fe(2)}}function du(e){var t=64-function(e){let t=0;for(let r=0;r<8;++r){var n=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e);return Math.ceil(t/8)}lu.Te=new lu;class fu{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ee(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ae(n.value),n=t.next();this.Re()}be(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Pe(n.value),n=t.next();this.ve()}Ve(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ae(e);else if(e<2048)this.Ae(960|e>>>6),this.Ae(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ae(480|e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e);else{const e=t.codePointAt(0);this.Ae(240|e>>>18),this.Ae(128|63&e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e)}}this.Re()}Se(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Pe(e);else if(e<2048)this.Pe(960|e>>>6),this.Pe(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Pe(480|e>>>12),this.Pe(128|63&e>>>6),this.Pe(128|63&e);else{const e=t.codePointAt(0);this.Pe(240|e>>>18),this.Pe(128|63&e>>>12),this.Pe(128|63&e>>>6),this.Pe(128|63&e)}}this.ve()}De(e){var t=this.Ce(e),n=du(t);this.xe(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}Ne(e){var t=this.Ce(e),n=du(t);this.xe(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}ke(){this.Me(255),this.Me(255)}Oe(){this.Fe(255),this.Fe(255)}reset(){this.position=0}seed(e){this.xe(e.length),this.buffer.set(e,this.position),this.position+=e.length}$e(){return this.buffer.slice(0,this.position)}Ce(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Ae(e){var t=255&e;0==t?(this.Me(0),this.Me(255)):255==t?(this.Me(255),this.Me(0)):this.Me(t)}Pe(e){var t=255&e;0==t?(this.Fe(0),this.Fe(255)):255==t?(this.Fe(255),this.Fe(0)):this.Fe(e)}Re(){this.Me(0),this.Me(1)}ve(){this.Fe(0),this.Fe(1)}Me(e){this.xe(1),this.buffer[this.position++]=e}Fe(e){this.xe(1),this.buffer[this.position++]=~e}xe(e){var t=e+this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class gu{constructor(e){this.Be=e}me(e){this.Be.Ee(e)}de(e){this.Be.Ve(e)}fe(e){this.Be.De(e)}he(){this.Be.ke()}}class mu{constructor(e){this.Be=e}me(e){this.Be.be(e)}de(e){this.Be.Se(e)}fe(e){this.Be.Ne(e)}he(){this.Be.Oe()}}class pu{constructor(){this.Be=new fu,this.Le=new gu(this.Be),this.Ue=new mu(this.Be)}seed(e){this.Be.seed(e)}qe(e){return 0===e?this.Le:this.Ue}$e(){return this.Be.$e()}reset(){this.Be.reset()}}class yu{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Ke(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new yu(this.indexId,this.documentKey,this.arrayValue,n)}}function vu(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=wu(e.arrayValue,t.arrayValue),0!==n?n:(n=wu(e.directionalValue,t.directionalValue),0!==n?n:Wr.comparator(e.documentKey,t.documentKey)))}function wu(e,t){for(let r=0;r<e.length&&r<t.length;++r){var n=e[r]-t[r];if(0!=n)return n}return e.length-t.length}class Iu{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ge=e.orderBy,this.Qe=[];for(const t of e.filters){const e=t;e.dt()?this.je=e:this.Qe.push(e)}}We(e){var t=Xr(e);if(void 0!==t&&!this.ze(t))return!1;var n=Jr(e);let r=0,s=0;for(;r<n.length&&this.ze(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.je){const e=n[r];if(!this.He(this.je,e)||!this.Je(this.Ge[s++],e))return!1;++r}for(;r<n.length;++r){const e=n[r];if(s>=this.Ge.length||!this.Je(this.Ge[s++],e))return!1}return!0}ze(e){for(const t of this.Qe)if(this.He(t,e))return!0;return!1}He(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;var n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==n}Je(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}class bu{constructor(){this.Ye=new Eu}addToCollectionParentIndex(e,t){return this.Ye.add(t),us.resolve()}getCollectionParents(e,t){return us.resolve(this.Ye.getEntries(t))}addFieldIndex(e,t){return us.resolve()}deleteFieldIndex(e,t){return us.resolve()}getDocumentsMatchingTarget(e,t){return us.resolve(null)}getIndexType(e,t){return us.resolve(0)}getFieldIndexes(e,t){return us.resolve([])}getNextCollectionGroupToUpdate(e){return us.resolve(null)}getMinOffset(e,t){return us.resolve(rs.min())}getMinOffsetFromCollectionGroup(e,t){return us.resolve(rs.min())}updateCollectionGroup(e,t,n){return us.resolve()}updateIndexEntries(e,t){return us.resolve()}}class Eu{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Ds(Qr.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new Ds(Qr.comparator)).toArray()}}const Tu=new Uint8Array(0);class Su{constructor(e,t){this.user=e,this.databaseId=t,this.Xe=new Eu,this.Ze=new Sa(e=>li(e),(e,t)=>di(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this.Xe.has(t))return us.resolve();var n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.Xe.add(t)});r={collectionId:n,parent:po(r)};return _u(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[Gr(n),""],!1,!0);return _u(e).W(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(vo(t.parent))}return r})}addFieldIndex(e,t){const n=Du(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;const s=n.add(r);if(t.indexState){const n=Au(e);return s.next(e=>{n.put(iu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=Du(e),r=Au(e),s=xu(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}getDocumentsMatchingTarget(e,c){const h=xu(e);let l=!0;const n=new Map;return us.forEach(this.tn(c),t=>this.en(e,t).next(e=>{l=l&&!!e,n.set(t,e)})).next(()=>{if(l){let u=Ra();const l=[];return us.forEach(n,(e,t)=>{Er("IndexedDbIndexManager",`Using index ${o=e,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`} to execute ${li(c)}`);var n=function(e,t){var n=Xr(t);if(void 0===n)return null;for(const t of gi(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),r=function(e,t){const n=new Map;for(const r of Jr(t))for(const t of gi(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const s of Jr(t)){const t=(0===s.kind?mi:pi)(e,s.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new xi(n,r)}(t,e),i=function(e,t){const n=[];let r=!0;for(const s of Jr(t)){const t=(0===s.kind?pi:mi)(e,s.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new xi(n,r)}(t,e),a=this.nn(e,t,s),o=this.nn(e,t,i),r=this.sn(e,t,r),r=this.rn(e.indexId,n,a,s.inclusive,o,i.inclusive,r);return us.forEach(r,e=>h.J(e,c.limit).next(e=>{e.forEach(e=>{var t=Wr.fromSegments(e.documentKey);u.has(t)||(u=u.add(t),l.push(t))})}))}).next(()=>l)}return us.resolve(null)})}tn(e){var t;return(t=this.Ze.get(e))||(this.Ze.set(e,t=[e]),t)}rn(t,e,n,r,s,i,a){const o=(null!=e?e.length:1)*Math.max(n.length,s.length),u=o/(null!=e?e.length:1),c=[];for(let h=0;h<o;++h){const o=e?this.on(e[h/u]):Tu,l=this.un(t,o,n[h%u],r),d=this.cn(t,o,s[h%u],i),f=a.map(e=>this.un(t,o,e,!0));c.push(...this.createRange(l,d,f))}return c}un(e,t,n,r){const s=new yu(e,Wr.empty(),t,n);return r?s:s.Ke()}cn(e,t,n,r){const s=new yu(e,Wr.empty(),t,n);return r?s.Ke():s}en(e,t){const r=new Iu(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.We(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;return us.forEach(this.tn(t),t=>this.en(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new Ds(Hr.comparator),n=!1;for(const r of e.filters){const e=r;e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field))}for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>n)}an(e,t){const n=new pu;for(const s of Jr(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;var r=n.qe(s.kind);lu.Te.ce(e,r)}return n.$e()}on(e){const t=new pu;return lu.Te.ce(e,t.qe(0)),t.$e()}hn(e,t){const n=new pu;return lu.Te.ce(Xs(this.databaseId,t),n.qe(0===(r=Jr(e)).length?0:r[r.length-1].kind)),n.$e();var r}sn(e,t,n){if(null===n)return[];let r=[];r.push(new pu);let s=0;for(const i of Jr(e)){const e=n[s++];for(const n of r)if(this.ln(t,i.fieldPath)&&Zs(e))r=this.fn(r,i,e);else{const t=n.qe(i.kind);lu.Te.ce(e,t)}}return this.dn(r)}nn(e,t,n){return this.sn(e,t,n.position)}dn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].$e();return t}fn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new pu;r.seed(n.$e()),lu.Te.ce(e,r.qe(t.kind)),s.push(r)}return s}ln(e,t){return!!e.filters.find(e=>e instanceof yi&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=Du(e),r=Au(e);return(t?n.W("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.W()).next(e=>{const i=[];return us.forEach(e,s=>r.get([s.indexId,this.uid]).next(e=>{var t,n,r;i.push((t=s,n=(e=e)?new es(e.sequenceNumber,new rs(Jo(e.readTime),new Wr(vo(e.documentKey)),e.largestBatchId)):es.empty(),r=t.fields.map(([e,t])=>new Zr(Hr.fromServerFormat(e),t)),new Yr(t.indexId,t.collectionGroup,r,n)))})).next(()=>i)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:Ur(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const s=Du(e),i=Au(e);return this._n(e).next(t=>s.W("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>us.forEach(e,e=>i.put(iu(e.indexId,this.user,t,r)))))}updateIndexEntries(s,e){const n=new Map;return us.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?us.resolve(e):this.getFieldIndexes(s,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),us.forEach(e,n=>this.wn(s,t,n).next(e=>{var t=this.mn(r,n);return e.isEqual(t)?us.resolve():this.gn(s,r,n,e,t)}))))})}yn(e,t,n,r){return xu(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.hn(n,t.key),documentKey:t.key.path.toArray()})}pn(e,t,n,r){return xu(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.hn(n,t.key),t.key.path.toArray()])}wn(e,n,r){const t=xu(e);let s=new Ds(vu);return t.Z({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.hn(r,n)])},(e,t)=>{s=s.add(new yu(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>s)}mn(e,t){let n=new Ds(vu);var r=this.an(t,e);if(null==r)return n;const s=Xr(t);if(null!=s){var i=e.data.field(s.fieldPath);if(Zs(i))for(const s of i.arrayValue.values||[])n=n.add(new yu(t.indexId,e.key,this.on(s),r))}else n=n.add(new yu(t.indexId,e.key,Tu,r));return n}gn(t,n,r,c,e){Er("IndexedDbIndexManager","Updating index entries for document '%s'",n.key);const s=[];return function(e,n,r,s){var i=c.getIterator(),a=e.getIterator();let o=Cs(i),u=Cs(a);for(;o||u;){let e=!1,t=!1;if(o&&u){const r=n(o,u);r<0?t=!0:0<r&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(u),u=Cs(a)):t?(s(o),o=Cs(i)):(o=Cs(i),u=Cs(a))}}(e,vu,e=>{s.push(this.yn(t,n,r,e))},e=>{s.push(this.pn(t,n,r,e))}),us.waitFor(s)}_n(e){let r=1;return Au(e).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>vu(e,t)).filter((e,t,n)=>!t||0!==vu(e,n[t-1]));const r=[];r.push(e);for(const s of n){const n=vu(s,e),i=vu(s,t);if(0===n)r[0]=e.Ke();else if(0<n&&i<0)r.push(s),r.push(s.Ke());else if(0<i)break}r.push(t);const s=[];for(let a=0;a<r.length;a+=2)s.push(IDBKeyRange.bound([r[a].indexId,this.uid,r[a].arrayValue,r[a].directionalValue,Tu,[]],[r[a+1].indexId,this.uid,r[a+1].arrayValue,r[a+1].directionalValue,Tu,[]]));return s}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Cu)}getMinOffset(t,e){return us.mapArray(this.tn(e),e=>this.en(t,e).next(e=>e||xr())).next(Cu)}}function _u(e){return jo(e,"collectionParents")}function xu(e){return jo(e,"indexEntries")}function Du(e){return jo(e,"indexConfiguration")}function Au(e){return jo(e,"indexState")}function Cu(e){Dr(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let s=1;s<e.length;s++){var r=e[s].indexState.offset;ss(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new rs(t.readTime,t.documentKey,n)}const Nu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class ku{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new ku(e,ku.DEFAULT_COLLECTION_PERCENTILE,ku.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Ru(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.Z({range:a},(e,t,n)=>(o++,n.delete()));i.push(u.next(()=>{Dr(1===o)}));const c=[];for(const e of n.mutations){const r=bo(t,e.key.path,n.batchId);i.push(s.delete(r)),c.push(e.key)}return us.waitFor(i).next(()=>c)}function Lu(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw xr();t=e.noDocument}return JSON.stringify(t).length}ku.DEFAULT_COLLECTION_PERCENTILE=10,ku.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,ku.DEFAULT=new ku(41943040,ku.DEFAULT_COLLECTION_PERCENTILE,ku.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),ku.DISABLED=new ku(-1,0,0);class Ou{constructor(e,t,n,r){this.userId=e,this.It=t,this.indexManager=n,this.referenceDelegate=r,this.In={}}static oe(e,t,n,r){Dr(""!==e.uid);var s=e.isAuthenticated()?e.uid:"";return new Ou(s,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Vu(e).Z({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(h,l,d,f){const g=Fu(h),m=Vu(h);return m.add({}).next(e=>{Dr("number"==typeof e);const t=new Ko(e,l,d,f),n=(s=this.It,i=this.userId,a=t,o=a.baseMutations.map(e=>io(s.re,e)),u=a.mutations.map(e=>io(s.re,e)),{userId:i,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var s,i,a,o,u;let c=new Ds((e,t)=>Ur(e.canonicalString(),t.canonicalString()));for(const h of f){const l=bo(this.userId,h.key.path,e);c=c.add(h.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Eo))}return c.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(h,e))}),h.addOnCommittedListener(()=>{this.In[e]=t.keys()}),us.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return Vu(e).get(t).next(e=>e?(Dr(e.userId===this.userId),Zo(this.It,e)):null)}Tn(e,n){return this.In[n]?us.resolve(this.In[n]):this.lookupMutationBatch(e,n).next(e=>{if(e){var t=e.keys();return this.In[n]=t}return null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return Vu(e).Z({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(Dr(t.batchId>=r),s=Zo(this.It,t)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return Vu(e).Z({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Vu(e).W("userMutationsIndex",t).next(e=>e.map(e=>Zo(this.It,e)))}getAllMutationBatchesAffectingDocumentKey(a,o){const e=Io(this.userId,o.path),t=IDBKeyRange.lowerBound(e),u=[];return Fu(a).Z({range:t},(e,t,n)=>{var[r,s,i]=e,s=vo(s);if(r===this.userId&&o.path.isEqual(s))return Vu(a).get(i).next(e=>{if(!e)throw xr();Dr(e.userId===this.userId),u.push(Zo(this.It,e))});n.done()}).next(()=>u)}getAllMutationBatchesAffectingDocumentKeys(t,e){let o=new Ds(Ur);const n=[];return e.forEach(a=>{var e=Io(this.userId,a.path),e=IDBKeyRange.lowerBound(e),e=Fu(t).Z({range:e},(e,t,n)=>{var[r,s,i]=e,s=vo(s);r===this.userId&&a.path.isEqual(s)?o=o.add(i):n.done()});n.push(e)}),us.waitFor(n).next(()=>this.En(t,o))}getAllMutationBatchesAffectingQuery(e,t){const a=t.path,o=a.length+1,n=Io(this.userId,a),r=IDBKeyRange.lowerBound(n);let u=new Ds(Ur);return Fu(e).Z({range:r},(e,t,n)=>{var[r,s,i]=e,s=vo(s);r===this.userId&&a.isPrefixOf(s)?s.length===o&&(u=u.add(i)):n.done()}).next(()=>this.En(e,u))}En(t,e){const n=[],r=[];return e.forEach(e=>{r.push(Vu(t).get(e).next(e=>{if(null===e)throw xr();Dr(e.userId===this.userId),n.push(Zo(this.It,e))}))}),us.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return Ru(t.ie,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.An(n.batchId)}),us.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}An(e){delete this.In[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return us.resolve();var t=IDBKeyRange.lowerBound([this.userId]);const r=[];return Fu(n).Z({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=vo(e[1]);r.push(t)}else n.done()}).next(()=>{Dr(0===r.length)})})}containsKey(e,t){return Mu(e,this.userId,t)}Rn(e){return Pu(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function Mu(e,i,t){const n=Io(i,t.path),a=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return Fu(e).Z({range:r,X:!0},(e,t,n)=>{var[r,s]=e;r===i&&s===a&&(o=!0),n.done()}).next(()=>o)}function Vu(e){return jo(e,"mutations")}function Fu(e){return jo(e,"documentMutations")}function Pu(e){return jo(e,"mutationQueues")}class Bu{constructor(e){this.bn=e}next(){return this.bn+=2,this.bn}static Pn(){return new Bu(0)}static vn(){return new Bu(-1)}}class Uu{constructor(e,t){this.referenceDelegate=e,this.It=t}allocateTargetId(n){return this.Vn(n).next(e=>{const t=new Bu(e.highestTargetId);return e.highestTargetId=t.next(),this.Sn(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Vn(e).next(e=>Kr.fromTimestamp(new jr(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Vn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Vn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Sn(t,e)))}addTargetData(t,n){return this.Dn(t,n).next(()=>this.Vn(t).next(e=>(e.targetCount+=1,this.Cn(n,e),this.Sn(t,e))))}updateTargetData(e,t){return this.Dn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>qu(t).delete(e.targetId)).next(()=>this.Vn(t)).next(e=>(Dr(0<e.targetCount),--e.targetCount,this.Sn(t,e)))}removeTargets(r,s,i){let a=0;const o=[];return qu(r).Z((e,t)=>{var n=eu(t);n.sequenceNumber<=s&&null===i.get(n.targetId)&&(a++,o.push(this.removeTargetData(r,n)))}).next(()=>us.waitFor(o)).next(()=>a)}forEachTarget(e,r){return qu(e).Z((e,t)=>{var n=eu(t);r(n)})}Vn(e){return Gu(e).get("targetGlobalKey").next(e=>(Dr(null!==e),e))}Sn(e,t){return Gu(e).put("targetGlobalKey",t)}Dn(e,t){return qu(e).put(tu(this.It,t))}Cn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Vn(e).next(e=>e.targetCount)}getTargetData(e,s){var t=li(s),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let i=null;return qu(e).Z({range:t,index:"queryTargetsIndex"},(e,t,n)=>{var r=eu(t);di(s,r.target)&&(i=r,n.done())}).next(()=>i)}addMatchingKeys(n,e,r){const s=[],i=ju(n);return e.forEach(e=>{var t=po(e.path);s.push(i.put({targetId:r,path:t})),s.push(this.referenceDelegate.addReference(n,r,e))}),us.waitFor(s)}removeMatchingKeys(n,e,r){const s=ju(n);return us.forEach(e,e=>{var t=po(e.path);return us.waitFor([s.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=ju(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=ju(e);let s=Ra();return r.Z({range:n,X:!0},(e,t,n)=>{var r=vo(e[1]),r=new Wr(r);s=s.add(r)}).next(()=>s)}containsKey(e,t){var n=po(t.path),n=IDBKeyRange.bound([n],[Gr(n)],!1,!0);let r=0;return ju(e).Z({index:"documentTargetsIndex",X:!0,range:n},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}se(e,t){return qu(e).get(t).next(e=>e?eu(e):null)}}function qu(e){return jo(e,"targets")}function Gu(e){return jo(e,"targetGlobal")}function ju(e){return jo(e,"targetDocuments")}function Ku([e,t],[n,r]){var s=Ur(e,n);return 0===s?Ur(t,r):s}class $u{constructor(e){this.xn=e,this.buffer=new Ds(Ku),this.Nn=0}kn(){return++this.Nn}Mn(e){var t=[e,this.kn()];if(this.buffer.size<this.xn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Ku(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Qu{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.On=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Fn(6e4)}stop(){this.On&&(this.On.cancel(),this.On=null)}get started(){return null!==this.On}Fn(e){Er("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.On=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.On=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){fs(e)?Er("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await os(e)}await this.Fn(3e5)})}}class zu{constructor(e,t){this.$n=e,this.params=t}calculateTargetCount(e,t){return this.$n.Bn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return us.resolve(Is.at);const n=new $u(t);return this.$n.forEachTarget(e,e=>n.Mn(e.sequenceNumber)).next(()=>this.$n.Ln(e,e=>n.Mn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.$n.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.$n.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(Er("LruGarbageCollector","Garbage collection skipped; disabled"),us.resolve(Nu)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(Er("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Nu):this.Un(t,n))}getCacheSize(e){return this.$n.getCacheSize(e)}Un(t,n){let r,s,i,a,o,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(s=e>this.params.maximumSequenceNumbersToCollect?(Er("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,s))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(i=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(c=Date.now(),br()<=l.DEBUG&&Er("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-h}ms\n\tDetermined least recently used ${s} in `+(o-a)+"ms\n"+`\tRemoved ${i} targets in `+(u-o)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),us.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:e})))}}class Hu{constructor(e,t){this.db=e,this.garbageCollector=(e=this,t=t,new zu(e,t))}Bn(e){const n=this.qn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}qn(e){let t=0;return this.Ln(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Ln(e,n){return this.Kn(e,(e,t)=>n(t))}addReference(e,t,n){return Wu(e,n)}removeReference(e,t,n){return Wu(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Wu(e,t)}Gn(t,n){let r=!1;return Pu(t).tt(e=>Mu(t,e,n).next(e=>(e&&(r=!0),us.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let a=0;return this.Kn(n,(t,e)=>{if(e<=r){const r=this.Gn(n,t).next(e=>{if(!e)return a++,s.getEntry(n,t).next(()=>(s.removeEntry(t,Kr.min()),ju(n).delete([0,po(t.path)])))});i.push(r)}}).next(()=>us.waitFor(i)).next(()=>s.apply(n)).next(()=>a)}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Wu(e,t)}Kn(e,r){const t=ju(e);let s,i=Is.at;return t.Z({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(i!==Is.at&&r(new Wr(vo(s)),i),i=n,s=t):i=Is.at}).next(()=>{i!==Is.at&&r(new Wr(vo(s)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Wu(e,t){return ju(e).put((e=e.currentSequenceNumber,{targetId:0,path:po(t.path),sequenceNumber:e}))}class Yu{constructor(){this.changes=new Sa(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,ui.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?us.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Xu{constructor(e){this.It=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return tc(e).put(n)}removeEntry(e,n,t){return tc(e).delete(function(e){const t=n.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],Yo(e),t[t.length-1]]}(t))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.Qn(t,e)))}getEntry(e,n){let r=ui.newInvalidDocument(n);return tc(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(nc(n))},(e,t)=>{r=this.jn(n,t)}).next(()=>r)}Wn(e,n){let r={size:0,document:ui.newInvalidDocument(n)};return tc(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(nc(n))},(e,t)=>{r={document:this.jn(n,t),size:Lu(t)}}).next(()=>r)}getEntries(e,t){let r=_a;return this.zn(e,t,(e,t)=>{var n=this.jn(e,t);r=r.insert(e,n)}).next(()=>r)}Hn(e,t){let r=_a,s=new Ss(Wr.comparator);return this.zn(e,t,(e,t)=>{var n=this.jn(e,t);r=r.insert(e,n),s=s.insert(e,Lu(t))}).next(()=>({documents:r,Jn:s}))}zn(e,t,s){if(t.isEmpty())return us.resolve();let n=new Ds(sc);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(nc(n.first()),nc(n.last())),i=n.getIterator();let a=i.getNext();return tc(e).Z({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=Wr.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&sc(a,r)<0;)s(a,null),a=i.getNext();a&&a.isEqual(r)&&(s(a,t),a=i.hasNext()?i.getNext():null),a?n.j(nc(a)):n.done()}).next(()=>{for(;a;)s(a,null),a=i.hasNext()?i.getNext():null})}getAllFromCollection(e,t,n){var r=[t.popLast().toArray(),t.lastSegment(),Yo(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],s=[t.popLast().toArray(),t.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tc(e).W(IDBKeyRange.bound(r,s,!0)).next(e=>{let t=_a;for(const n of e){const e=this.jn(Wr.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);t=t.insert(e.key,e)}return t})}getAllFromCollectionGroup(e,t,n,s){let i=_a;var r=rc(t,n),a=rc(t,rs.max());return tc(e).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(r,a,!0)},(e,t,n)=>{var r=this.jn(Wr.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);i=i.insert(r.key,r),i.size===s&&n.done()}).next(()=>i)}newChangeBuffer(e){return new Zu(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return ec(e).get("remoteDocumentGlobalKey").next(e=>(Dr(!!e),e))}Qn(e,t){return ec(e).put("remoteDocumentGlobalKey",t)}jn(e,t){if(t){const e=function(e,t){let n;if(t.document)n=so(e.re,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=Wr.fromSegments(t.noDocument.path),s=Jo(t.noDocument.readTime);n=ui.newNoDocument(e,s),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return xr();{const e=Wr.fromSegments(t.unknownDocument.path),i=Jo(t.unknownDocument.version);n=ui.newUnknownDocument(e,i)}}return t.readTime&&n.setReadTime((t=t.readTime,r=new jr(t[0],t[1]),Kr.fromTimestamp(r))),n;var r}(this.It,t);if(!e.isNoDocument()||!e.version.isEqual(Kr.min()))return e}return ui.newInvalidDocument(e)}}function Ju(e){return new Xu(e)}class Zu extends Yu{constructor(e,t){super(),this.Yn=e,this.trackRemovals=t,this.Xn=new Sa(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(i){const a=[];let o=0,u=new Ds((e,t)=>Ur(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.Xn.get(e);if(a.push(this.Yn.removeEntry(i,e,n.readTime)),t.isValidDocument()){var r=Wo(this.Yn.It,t);u=u.add(e.path.popLast());var s=Lu(r);o+=s-n.size,a.push(this.Yn.addEntry(i,e,r))}else if(o-=n.size,this.trackRemovals){const o=Wo(this.Yn.It,t.convertToNoDocument(Kr.min()));a.push(this.Yn.addEntry(i,e,o))}}),u.forEach(e=>{a.push(this.Yn.indexManager.addToCollectionParentIndex(i,e))}),a.push(this.Yn.updateMetadata(i,o)),us.waitFor(a)}getFromCache(e,t){return this.Yn.Wn(e,t).next(e=>(this.Xn.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Yn.Hn(e,t).next(({documents:n,Jn:e})=>(e.forEach((e,t)=>{this.Xn.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function ec(e){return jo(e,"remoteDocumentGlobal")}function tc(e){return jo(e,"remoteDocumentsV14")}function nc(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function rc(e,t){const n=t.documentKey.path.toArray();return[e,Yo(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function sc(e,t){var n=e.path.toArray(),r=t.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=Ur(n[i],r[i]),s)return s;return s=Ur(n.length,r.length),s||(s=Ur(n[n.length-2],r[r.length-2]),s||Ur(n[n.length-1],r[r.length-1]))}class ic{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class ac{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.getBaseDocument(t,n,r))).next(e=>(null!==r&&da(r.mutation,e,Ns.empty(),jr.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,Ra()).next(()=>e))}getLocalViewOfDocuments(e,t,n=Ra()){const r=Ca();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=Da();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=Ca();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,Ra()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,s){let i=_a;const a=Ca(),o=Ca();return t.forEach((e,t)=>{const n=r.get(t.key);s.has(t.key)&&(void 0===n||n.mutation instanceof ma)?i=i.insert(t.key,t):void 0!==n&&(a.set(t.key,n.mutation.getFieldMask()),da(n.mutation,t,n.mutation.getFieldMask(),jr.now()))}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{var n;return o.set(e,new ic(t,null!==(n=a.get(e))&&void 0!==n?n:null))}),o))}recalculateAndSaveOverlays(i,a){const o=Ca();let u=new Ss((e,t)=>e-t),c=Ra();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(i,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||Ns.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||Ra()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,s=Ca();r.forEach(e=>{var t;c.has(e)||(null!==(t=ha(a.get(e),o.get(e)))&&s.set(e,t),c=c.add(e))}),e.push(this.documentOverlayCache.saveOverlays(i,n,s))}return us.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n){return r=t,Wr.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Vi(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n);var r}getNextDocuments(i,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(i,t,a,o).next(n=>{const e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(i,t,a.largestBatchId,o-n.size):us.resolve(Ca());let r=-1,s=n;return e.next(e=>us.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?us.resolve():this.getBaseDocument(i,t,e).next(e=>{s=s.insert(t,e)}))).next(()=>this.populateOverlays(i,e,n)).next(()=>this.computeViews(i,s,e,Ra())).next(e=>({batchId:r,changes:Aa(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Wr(t)).next(e=>{let t=Da();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(r,s,i){const a=s.collectionGroup;let o=Da();return this.indexManager.getCollectionParents(r,a).next(e=>us.forEach(e,e=>{var t,n=(t=s,e=e.child(a),new Ni(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt));return this.getDocumentsMatchingCollectionQuery(r,n,i).next(e=>{e.forEach((e,t)=>{o=o.insert(e,t)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,i,n){let a;return this.remoteDocumentCache.getAllFromCollection(t,i.path,n).next(e=>(a=e,this.documentOverlayCache.getOverlaysForCollection(t,i.path,n.largestBatchId))).next(r=>{r.forEach((e,t)=>{var n=t.getKey();null===a.get(n)&&(a=a.insert(n,ui.newInvalidDocument(n)))});let s=Da();return a.forEach((e,t)=>{var n=r.get(e);void 0!==n&&da(n.mutation,t,Ns.empty(),jr.now()),ji(i,t)&&(s=s.insert(e,t))}),s})}getBaseDocument(e,t,n){return null===n||1===n.mutation.type?this.remoteDocumentCache.getEntry(e,t):us.resolve(ui.newInvalidDocument(t))}}class oc{constructor(e){this.It=e,this.Zn=new Map,this.ts=new Map}getBundleMetadata(e,t){return us.resolve(this.Zn.get(t))}saveBundleMetadata(e,t){return this.Zn.set(t.id,{id:t.id,version:t.version,createTime:Ha(t.createTime)}),us.resolve()}getNamedQuery(e,t){return us.resolve(this.ts.get(t))}saveNamedQuery(e,t){return this.ts.set(t.name,{name:(t=t).name,query:nu(t.bundledQuery),readTime:Ha(t.readTime)}),us.resolve()}}class uc{constructor(){this.overlays=new Ss(Wr.comparator),this.es=new Map}getOverlay(e,t){return us.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Ca();return us.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.ue(n,r,t)}),us.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.es.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.es.delete(n)),us.resolve()}getOverlaysForCollection(e,t,n){const r=Ca(),s=t.length+1,i=new Wr(t.child("")),a=this.overlays.getIteratorFrom(i);for(;a.hasNext();){const e=a.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return us.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new Ss((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=Ca(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=Ca(),o=s.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return us.resolve(a)}ue(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.es.get(r.largestBatchId).delete(n.key);this.es.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Qo(t,n));let s=this.es.get(t);void 0===s&&(s=Ra(),this.es.set(t,s)),this.es.set(t,s.add(n.key))}}class cc{constructor(){this.ns=new Ds(hc.ss),this.rs=new Ds(hc.os)}isEmpty(){return this.ns.isEmpty()}addReference(e,t){var n=new hc(e,t);this.ns=this.ns.add(n),this.rs=this.rs.add(n)}us(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.cs(new hc(e,t))}hs(e,t){e.forEach(e=>this.removeReference(e,t))}ls(e){const t=new Wr(new Qr([])),n=new hc(t,e),r=new hc(t,e+1),s=[];return this.rs.forEachInRange([n,r],e=>{this.cs(e),s.push(e.key)}),s}fs(){this.ns.forEach(e=>this.cs(e))}cs(e){this.ns=this.ns.delete(e),this.rs=this.rs.delete(e)}ds(e){var t=new Wr(new Qr([])),n=new hc(t,e),t=new hc(t,e+1);let r=Ra();return this.rs.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new hc(e,0),t=this.ns.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)}}class hc{constructor(e,t){this.key=e,this._s=t}static ss(e,t){return Wr.comparator(e.key,t.key)||Ur(e._s,t._s)}static os(e,t){return Ur(e._s,t._s)||Wr.comparator(e.key,t.key)}}class lc{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.ws=1,this.gs=new Ds(hc.ss)}checkEmpty(e){return us.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var s=this.ws;this.ws++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1];var i=new Ko(s,t,n,r);this.mutationQueue.push(i);for(const t of r)this.gs=this.gs.add(new hc(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return us.resolve(i)}lookupMutationBatch(e,t){return us.resolve(this.ys(t))}getNextMutationBatchAfterBatchId(e,t){var n=this.ps(t+1),n=n<0?0:n;return us.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return us.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(e){return us.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new hc(t,0),r=new hc(t,Number.POSITIVE_INFINITY),s=[];return this.gs.forEachInRange([n,r],e=>{var t=this.ys(e._s);s.push(t)}),us.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new Ds(Ur);return t.forEach(e=>{var t=new hc(e,0),n=new hc(e,Number.POSITIVE_INFINITY);this.gs.forEachInRange([t,n],e=>{r=r.add(e._s)})}),us.resolve(this.Is(r))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;Wr.isDocumentKey(s)||(s=s.child(""));var i=new hc(new Wr(s),0);let a=new Ds(Ur);return this.gs.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e._s)),!0)},i),us.resolve(this.Is(a))}Is(e){const n=[];return e.forEach(e=>{var t=this.ys(e);null!==t&&n.push(t)}),n}removeMutationBatch(n,r){Dr(0===this.Ts(r.batchId,"removed")),this.mutationQueue.shift();let s=this.gs;return us.forEach(r.mutations,e=>{var t=new hc(e.key,r.batchId);return s=s.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.gs=s})}An(e){}containsKey(e,t){var n=new hc(t,0),n=this.gs.firstAfterOrEqual(n);return us.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,us.resolve()}Ts(e,t){return this.ps(e)}ps(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}ys(e){var t=this.ps(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class dc{constructor(e){this.Es=e,this.docs=new Ss(Wr.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Es(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return us.resolve(n?n.document.mutableCopy():ui.newInvalidDocument(t))}getEntries(e,t){let n=_a;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():ui.newInvalidDocument(e))}),us.resolve(n)}getAllFromCollection(e,t,n){let r=_a;const s=new Wr(t.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:e,value:{document:s}}=i.getNext();if(!t.isPrefixOf(e.path))break;e.path.length>t.length+1||ss(ns(s),n)<=0||(r=r.insert(s.key,s.mutableCopy()))}return us.resolve(r)}getAllFromCollectionGroup(e,t,n,r){xr()}As(e,t){return us.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new fc(this)}getSize(e){return us.resolve(this.size)}}class fc extends Yu{constructor(e){super(),this.Yn=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this.Yn.addEntry(n,t)):this.Yn.removeEntry(e)}),us.waitFor(r)}getFromCache(e,t){return this.Yn.getEntry(e,t)}getAllFromCache(e,t){return this.Yn.getEntries(e,t)}}class gc{constructor(e){this.persistence=e,this.Rs=new Sa(e=>li(e),di),this.lastRemoteSnapshotVersion=Kr.min(),this.highestTargetId=0,this.bs=0,this.Ps=new cc,this.targetCount=0,this.vs=Bu.Pn()}forEachTarget(e,n){return this.Rs.forEach((e,t)=>n(t)),us.resolve()}getLastRemoteSnapshotVersion(e){return us.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return us.resolve(this.bs)}allocateTargetId(e){return this.highestTargetId=this.vs.next(),us.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.bs&&(this.bs=t),us.resolve()}Dn(e){this.Rs.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.vs=new Bu(t),this.highestTargetId=t),e.sequenceNumber>this.bs&&(this.bs=e.sequenceNumber)}addTargetData(e,t){return this.Dn(t),this.targetCount+=1,us.resolve()}updateTargetData(e,t){return this.Dn(t),us.resolve()}removeTargetData(e,t){return this.Rs.delete(t.target),this.Ps.ls(t.targetId),--this.targetCount,us.resolve()}removeTargets(n,r,s){let i=0;const a=[];return this.Rs.forEach((e,t)=>{t.sequenceNumber<=r&&null===s.get(t.targetId)&&(this.Rs.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),i++)}),us.waitFor(a).next(()=>i)}getTargetCount(e){return us.resolve(this.targetCount)}getTargetData(e,t){var n=this.Rs.get(t)||null;return us.resolve(n)}addMatchingKeys(e,t,n){return this.Ps.us(t,n),us.resolve()}removeMatchingKeys(t,e,n){this.Ps.hs(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach(e=>{s.push(r.markPotentiallyOrphaned(t,e))}),us.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Ps.ls(t),us.resolve()}getMatchingKeysForTargetId(e,t){var n=this.Ps.ds(t);return us.resolve(n)}containsKey(e,t){return us.resolve(this.Ps.containsKey(t))}}class mc{constructor(e,t){this.Vs={},this.overlays={},this.Ss=new Is(0),this.Ds=!1,this.Ds=!0,this.referenceDelegate=e(this),this.Cs=new gc(this),this.indexManager=new bu,this.remoteDocumentCache=(e=e=>this.referenceDelegate.xs(e),new dc(e)),this.It=new Ho(t),this.Ns=new oc(this.It)}start(){return Promise.resolve()}shutdown(){return this.Ds=!1,Promise.resolve()}get started(){return this.Ds}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new uc,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Vs[e.toKey()];return n||(n=new lc(t,this.referenceDelegate),this.Vs[e.toKey()]=n),n}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ns}runTransaction(e,t,n){Er("MemoryPersistence","Starting transaction:",e);const r=new pc(this.Ss.next());return this.referenceDelegate.ks(),n(r).next(e=>this.referenceDelegate.Ms(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Os(t,n){return us.or(Object.values(this.Vs).map(e=>()=>e.containsKey(t,n)))}}class pc extends as{constructor(e){super(),this.currentSequenceNumber=e}}class yc{constructor(e){this.persistence=e,this.Fs=new cc,this.$s=null}static Bs(e){return new yc(e)}get Ls(){if(this.$s)return this.$s;throw xr()}addReference(e,t,n){return this.Fs.addReference(n,t),this.Ls.delete(n.toString()),us.resolve()}removeReference(e,t,n){return this.Fs.removeReference(n,t),this.Ls.add(n.toString()),us.resolve()}markPotentiallyOrphaned(e,t){return this.Ls.add(t.toString()),us.resolve()}removeTarget(e,t){this.Fs.ls(t.targetId).forEach(e=>this.Ls.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Ls.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}ks(){this.$s=new Set}Ms(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return us.forEach(this.Ls,e=>{const t=Wr.fromPath(e);return this.Us(n,t).next(e=>{e||r.removeEntry(t,Kr.min())})}).next(()=>(this.$s=null,r.apply(n)))}updateLimboDocument(e,t){return this.Us(e,t).next(e=>{e?this.Ls.delete(t.toString()):this.Ls.add(t.toString())})}xs(e){return 0}Us(e,t){return us.or([()=>us.resolve(this.Fs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Os(e,t)])}}class vc{constructor(e){this.It=e}$(t,e,n,r){const s=new cs("createOrUpgrade",e);var i;n<1&&1<=r&&(t.createObjectStore("owner"),(i=t).createObjectStore("mutationQueues",{keyPath:"userId"}),i.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",wo,{unique:!0}),i.createObjectStore("documentMutations"),wc(t),t.createObjectStore("remoteDocuments"));let a=us.resolve();return n<3&&3<=r&&(0!==n&&((i=t).deleteObjectStore("targetDocuments"),i.deleteObjectStore("targets"),i.deleteObjectStore("targetGlobal"),wc(t)),a=a.next(()=>function(){const e=s.store("targetGlobal"),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:Kr.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",t)}())),n<4&&4<=r&&(0!==n&&(a=a.next(()=>function(r,s){return s.store("mutations").W().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",wo,{unique:!0});const t=s.store("mutations"),n=e.map(e=>t.put(e));return us.waitFor(n)})}(t,s))),a=a.next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.qs(s))),n<6&&6<=r&&(a=a.next(()=>(t.createObjectStore("remoteDocumentGlobal"),this.Ks(s)))),n<7&&7<=r&&(a=a.next(()=>this.Gs(s))),n<8&&8<=r&&(a=a.next(()=>this.Qs(t,s))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.js(s))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{!function(){const e=t.createObjectStore("documentOverlays",{keyPath:Oo});e.createIndex("collectionPathOverlayIndex",Mo,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",Vo,{unique:!1})}()})),n<13&&13<=r&&(a=a.next(()=>function(){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:To});e.createIndex("documentKeyIndex",So),e.createIndex("collectionGroupIndex",_o)}()).next(()=>this.Ws(t,s)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.zs(t,s))),n<15&&15<=r&&(a=a.next(()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:No}).createIndex("sequenceNumberIndex",ko,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Ro}).createIndex("documentKeyIndex",Lo,{unique:!1})}(t))),a}Ks(t){let n=0;return t.store("remoteDocuments").Z((e,t)=>{n+=Lu(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}qs(r){const e=r.store("mutationQueues"),t=r.store("mutations");return e.W().next(e=>us.forEach(e,n=>{var e=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return t.W("userMutationsIndex",e).next(e=>us.forEach(e,e=>{Dr(e.userId===n.userId);var t=Zo(this.It,e);return Ru(r,n.userId,t).next(()=>{})}))}))}Gs(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(s=>{const i=[];return t.Z((e,t)=>{const n=new Qr(e),r=[0,po(n)];i.push(a.get(r).next(e=>e?us.resolve():(e=>a.put({targetId:0,path:po(e),sequenceNumber:s.highestListenSequenceNumber}))(n)))}).next(()=>us.waitFor(i))})}Qs(e,t){e.createObjectStore("collectionParents",{keyPath:Co});const n=t.store("collectionParents"),r=new Eu,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:po(r)})}};return t.store("remoteDocuments").Z({X:!0},(e,t)=>{const n=new Qr(e);return s(n.popLast())}).next(()=>t.store("documentMutations").Z({X:!0},([,e],t)=>{const n=vo(e);return s(n.popLast())}))}js(e){const r=e.store("targets");return r.Z((e,t)=>{var n=eu(t),n=tu(this.It,n);return r.put(n)})}Ws(e,i){const t=i.store("remoteDocuments"),a=[];return t.Z((e,t)=>{const n=i.store("remoteDocumentsV14"),r=((s=t).document?new Wr(Qr.fromString(s.document.name).popFirst(5)):s.noDocument?Wr.fromSegments(s.noDocument.path):s.unknownDocument?Wr.fromSegments(s.unknownDocument.path):xr()).path.toArray();var s={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};a.push(n.put(s))}).next(()=>us.waitFor(a))}zs(e,i){const t=i.store("mutations"),a=Ju(this.It),o=new mc(yc.Bs,this.It.re);return t.W().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!==(t=r.get(e.userId))&&void 0!==t?t:Ra();Zo(this.It,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),us.forEach(r,(e,t)=>{var n=new vr(t),r=cu.oe(this.It,n),s=o.getIndexManager(n),n=Ou.oe(n,this.It,s,o.referenceDelegate);return new ac(a,n,r,s).recalculateAndSaveOverlaysForDocumentKeys(new Go(i,Is.at),e).next()})})}}function wc(e){e.createObjectStore("targetDocuments",{keyPath:Do}).createIndex("documentTargetsIndex",Ao,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",xo,{unique:!0}),e.createObjectStore("targetGlobal")}const Ic="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class bc{constructor(e,t,n,r,s,i,a,o,u,c,h=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Hs=s,this.window=i,this.document=a,this.Js=u,this.Ys=c,this.Xs=h,this.Ss=null,this.Ds=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Zs=null,this.inForeground=!1,this.ti=null,this.ei=null,this.ni=Number.NEGATIVE_INFINITY,this.si=e=>Promise.resolve(),!bc.C())throw new Cr(Ar.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Hu(this,r),this.ii=t+"main",this.It=new Ho(o),this.ri=new hs(this.ii,this.Xs,new vc(this.It)),this.Cs=new Uu(this.referenceDelegate,this.It),this.remoteDocumentCache=Ju(this.It),this.Ns=new au,this.window&&this.window.localStorage?this.oi=this.window.localStorage:(this.oi=null,!1===c&&Tr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ui().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Cr(Ar.FAILED_PRECONDITION,Ic);return this.ci(),this.ai(),this.hi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Cs.getHighestSequenceNumber(e))}).then(e=>{this.Ss=new Is(e,this.Js)}).then(()=>{this.Ds=!0}).catch(e=>(this.ri&&this.ri.close(),Promise.reject(e)))}li(t){return this.si=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ri.L(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Hs.enqueueAndForget(async()=>{this.started&&await this.ui()}))}ui(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>Tc(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.fi(t).next(e=>{e||(this.isPrimary=!1,this.Hs.enqueueRetryable(()=>this.si(!1)))})}).next(()=>this.di(t)).next(e=>this.isPrimary&&!e?this._i(t).next(()=>!1):!!e&&this.wi(t).next(()=>!0))).catch(e=>{if(fs(e))return Er("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return Er("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Hs.enqueueRetryable(()=>this.si(e)),this.isPrimary=e})}fi(e){return Ec(e).get("owner").next(e=>us.resolve(this.mi(e)))}gi(e){return Tc(e).delete(this.clientId)}async yi(){if(this.isPrimary&&!this.pi(this.ni,18e5)){this.ni=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=jo(e,"clientMetadata");return r.W().next(e=>{const t=this.Ii(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return us.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.oi)for(const t of e)this.oi.removeItem(this.Ti(t.clientId))}}hi(){this.ei=this.Hs.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.ui().then(()=>this.yi()).then(()=>this.hi()))}mi(e){return!!e&&e.ownerId===this.clientId}di(t){return this.Ys?us.resolve(!0):Ec(t).get("owner").next(e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)){if(this.mi(e)&&this.networkEnabled)return!0;if(!this.mi(e)){if(!e.allowTabSynchronization)throw new Cr(Ar.FAILED_PRECONDITION,Ic);return!1}}return!(!this.networkEnabled||!this.inForeground)||Tc(t).W().next(e=>void 0===this.Ii(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&Er("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Ds=!1,this.Ai(),this.ei&&(this.ei.cancel(),this.ei=null),this.Ri(),this.bi(),await this.ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new Go(e,Is.at);return this._i(t).next(()=>this.gi(t))}),this.ri.close(),this.Pi()}Ii(e,t){return e.filter(e=>this.pi(e.updateTimeMs,t)&&!this.Ei(e.clientId))}vi(){return this.runTransaction("getActiveClients","readonly",e=>Tc(e).W().next(e=>this.Ii(e,18e5).map(e=>e.clientId)))}get started(){return this.Ds}getMutationQueue(e,t){return Ou.oe(e,this.It,t,this.referenceDelegate)}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Su(e,this.It.re.databaseId)}getDocumentOverlayCache(e){return cu.oe(this.It,e)}getBundleCache(){return this.Ns}runTransaction(t,n,r){Er("IndexedDbPersistence","Starting transaction:",t);var e,s="readonly"===n?"readonly":"readwrite",e=15===(e=this.Xs)?qo:14===e?Uo:13===e?Bo:12===e?Po:11===e?Fo:void xr();let i;return this.ri.runTransaction(t,s,e,e=>(i=new Go(e,this.Ss?this.Ss.next():Is.at),"readwrite-primary"===n?this.fi(i).next(e=>!!e||this.di(i)).next(e=>{if(!e)throw Tr(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Hs.enqueueRetryable(()=>this.si(!1)),new Cr(Ar.FAILED_PRECONDITION,is);return r(i)}).next(e=>this.wi(i).next(()=>e)):this.Vi(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Vi(e){return Ec(e).get("owner").next(e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)&&!this.mi(e)&&!(this.Ys||this.allowTabSynchronization&&e.allowTabSynchronization))throw new Cr(Ar.FAILED_PRECONDITION,Ic)})}wi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Ec(e).put("owner",t)}static C(){return hs.C()}_i(e){const t=Ec(e);return t.get("owner").next(e=>this.mi(e)?(Er("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):us.resolve())}pi(e,t){var n=Date.now();return!(e<n-t||n<e&&(Tr(`Detected an update time that is in the future: ${e} > ${n}`),1))}ci(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ti=()=>{this.Hs.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.ui()))},this.document.addEventListener("visibilitychange",this.ti),this.inForeground="visible"===this.document.visibilityState)}Ri(){this.ti&&(this.document.removeEventListener("visibilitychange",this.ti),this.ti=null)}ai(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Zs=()=>{this.Ai(),s()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Hs.enterRestrictedMode(!0),this.Hs.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Zs))}bi(){this.Zs&&(this.window.removeEventListener("pagehide",this.Zs),this.Zs=null)}Ei(e){var t;try{var n=null!==(null===(t=this.oi)||void 0===t?void 0:t.getItem(this.Ti(e)));return Er("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return Tr("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Ai(){if(this.oi)try{this.oi.setItem(this.Ti(this.clientId),String(Date.now()))}catch(e){Tr("Failed to set zombie client id.",e)}}Pi(){if(this.oi)try{this.oi.removeItem(this.Ti(this.clientId))}catch(e){}}Ti(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Ec(e){return jo(e,"owner")}function Tc(e){return jo(e,"clientMetadata")}function Sc(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class _c{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Si=n,this.Di=r}static Ci(e,t){let n=Ra(),r=Ra();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new _c(e,t.fromCache,n,r)}}class xc{constructor(){this.xi=!1}initialize(e,t){this.Ni=e,this.indexManager=t,this.xi=!0}getDocumentsMatchingQuery(t,n,r,s){return this.ki(t,n).next(e=>e||this.Mi(t,n,s,r)).next(e=>e||this.Oi(t,n))}ki(s,i){if(Li(i))return us.resolve(null);let t=Pi(i);return this.indexManager.getIndexType(s,t).next(e=>0===e?null:(null!==i.limit&&1===e&&(i=Bi(i,null,"F"),t=Pi(i)),this.indexManager.getDocumentsMatchingTarget(s,t).next(e=>{const r=Ra(...e);return this.Ni.getDocuments(s,r).next(n=>this.indexManager.getMinOffset(s,t).next(e=>{var t=this.Fi(i,n);return this.$i(i,t,r,e.readTime)?this.ki(s,Bi(i,null,"F")):this.Bi(s,t,i,e)}))})))}Mi(n,r,s,i){return Li(r)||i.isEqual(Kr.min())?this.Oi(n,r):this.Ni.getDocuments(n,s).next(e=>{var t=this.Fi(r,e);return this.$i(r,t,s,i)?this.Oi(n,r):(br()<=l.DEBUG&&Er("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Gi(r)),this.Bi(n,t,r,ts(i,-1)))})}Fi(n,e){let r=new Ds($i(n));return e.forEach((e,t)=>{ji(n,t)&&(r=r.add(t))}),r}$i(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Oi(e,t){return br()<=l.DEBUG&&Er("QueryEngine","Using full collection scan to execute query:",Gi(t)),this.Ni.getDocumentsMatchingQuery(e,t,rs.min())}Bi(e,n,t,r){return this.Ni.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class Dc{constructor(e,t,n,r){this.persistence=e,this.Li=t,this.It=r,this.Ui=new Ss(Ur),this.qi=new Sa(e=>li(e),di),this.Ki=new Map,this.Gi=e.getRemoteDocumentCache(),this.Cs=e.getTargetCache(),this.Ns=e.getBundleCache(),this.Qi(n)}Qi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new ac(this.Gi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Gi.setIndexManager(this.indexManager),this.Li.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Ui))}}function Ac(e,t,n,r){return new Dc(e,t,n,r)}async function Cc(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",s=>{let i;return a.mutationQueue.getAllMutationBatches(s).next(e=>(i=e,a.Qi(t),a.mutationQueue.getAllMutationBatches(s))).next(e=>{const t=[],n=[];let r=Ra();for(const s of i){t.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}for(const s of e){n.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(s,r).next(e=>({ji:e,removedBatchIds:t,addedBatchIds:n}))})})}function Nc(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Cs.getLastRemoteSnapshotVersion(e))}function kc(e,c){const h=e,l=c.snapshotVersion;let d=h.Ui;return h.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{const e=h.Gi.newChangeBuffer({trackRemovals:!0});d=h.Ui;const u=[];c.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(h.Cs.removeMatchingKeys(o,t.removedDocuments,n).next(()=>h.Cs.addMatchingKeys(o,t.addedDocuments,n)));let e=r.withSequenceNumber(o.currentSequenceNumber);var s,i,a;c.targetMismatches.has(n)?e=e.withResumeToken(ks.EMPTY_BYTE_STRING,Kr.min()).withLastLimboFreeSnapshotVersion(Kr.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),s=r,i=e,a=t,0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(h.Cs.updateTargetData(o,e))}});let t=_a,n=Ra();if(c.documentUpdates.forEach(e=>{c.resolvedLimboDocuments.has(e)&&u.push(h.persistence.referenceDelegate.updateLimboDocument(o,e))}),u.push(Rc(o,e,c.documentUpdates).next(e=>{t=e.Wi,n=e.zi})),!l.isEqual(Kr.min())){const c=h.Cs.getLastRemoteSnapshotVersion(o).next(e=>h.Cs.setTargetsMetadata(o,o.currentSequenceNumber,l));u.push(c)}return us.waitFor(u).next(()=>e.apply(o)).next(()=>h.localDocuments.getLocalViewOfDocuments(o,t,n)).next(()=>t)}).then(e=>(h.Ui=d,e))}function Rc(e,i,t){let n=Ra(),a=Ra();return t.forEach(e=>n=n.add(e)),i.getEntries(e,n).next(r=>{let s=_a;return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(Kr.min())?(i.removeEntry(e,t.readTime),s=s.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(i.addEntry(t),s=s.insert(e,t)):Er("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{Wi:s,zi:a}})}function Lc(e,r){const s=e;return s.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return s.Cs.getTargetData(t,r).next(e=>e?(n=e,us.resolve(n)):s.Cs.allocateTargetId(t).next(e=>(n=new zo(r,e,0,t.currentSequenceNumber),s.Cs.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=s.Ui.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(s.Ui=s.Ui.insert(e.targetId,e),s.qi.set(r,e.targetId)),e})}async function Oc(e,t,n){const r=e,s=r.Ui.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!fs(e))throw e;Er("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.Ui=r.Ui.remove(t),r.qi.delete(s.target)}function Mc(e,n,r){const s=e;let i=Kr.min(),a=Ra();return s.persistence.runTransaction("Execute query","readonly",t=>function(e,t,n){const r=e,s=r.qi.get(n);return void 0!==s?us.resolve(r.Ui.get(s)):r.Cs.getTargetData(t,n)}(s,t,Pi(n)).next(e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,s.Cs.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>s.Li.getDocumentsMatchingQuery(t,n,r?i:Kr.min(),r?a:Ra())).next(e=>(Pc(s,Ki(n),e),{documents:e,Hi:a})))}function Vc(e,t){const n=e,r=n.Cs,s=n.Ui.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.se(e,t).next(e=>e?e.target:null))}function Fc(e,t){const n=e,r=n.Ki.get(t)||Kr.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.Gi.getAllFromCollectionGroup(e,t,ts(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(Pc(n,t,e),e))}function Pc(e,t,n){let r=Kr.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.Ki.set(t,r)}function Bc(e,t){return`firestore_clients_${e}_${t}`}function Uc(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function qc(e,t){return`firestore_targets_${e}_${t}`}class Gc{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Zi(e,t,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new Cr(r.error.code,r.error.message))),i?new Gc(e,t,r.state,s):(Tr("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class jc{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Zi(e,t){var n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new Cr(n.error.code,n.error.message))),s?new jc(e,n.state,r):(Tr("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Kc{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Zi(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=La;for(let i=0;r&&i<n.activeTargetIds.length;++i)r=Gs(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new Kc(e,s):(Tr("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class $c{constructor(e,t){this.clientId=e,this.onlineState=t}static Zi(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new $c(t.clientId,t.onlineState):(Tr("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Qc{constructor(){this.activeTargetIds=La}er(e){this.activeTargetIds=this.activeTargetIds.add(e)}nr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}tr(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class zc{constructor(e,t,n,r,s){this.window=e,this.Hs=t,this.persistenceKey=n,this.sr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ir=this.rr.bind(this),this.ur=new Ss(Ur),this.started=!1,this.cr=[];var i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ar=Bc(this.persistenceKey,this.sr),this.hr=`firestore_sequence_number_${this.persistenceKey}`,this.ur=this.ur.insert(this.sr,new Qc),this.lr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.dr=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this._r=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.wr=`firestore_online_state_${this.persistenceKey}`,this.mr=`firestore_bundle_loaded_v2_${this.persistenceKey}`,this.window.addEventListener("storage",this.ir)}static C(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.vi();for(const n of e)if(n!==this.sr){const e=this.getItem(Bc(this.persistenceKey,n));var t;!e||(t=Kc.Zi(n,e))&&(this.ur=this.ur.insert(t.clientId,t))}this.gr();const n=this.storage.getItem(this.wr);if(n){const e=this.yr(n);e&&this.pr(e)}for(const e of this.cr)this.rr(e);this.cr=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.hr,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Ir(this.ur)}isActiveQueryTarget(n){let r=!1;return this.ur.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Tr(e,"pending")}updateMutationState(e,t,n){this.Tr(e,t,n),this.Er(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(qc(this.persistenceKey,e)))||(n=jc.Zi(e,n))&&(t=n.state)),this.Ar.er(e),this.gr(),t}removeLocalQueryTarget(e){this.Ar.nr(e),this.gr()}isLocalQueryTarget(e){return this.Ar.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(qc(this.persistenceKey,e))}updateQueryState(e,t,n){this.Rr(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Er(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.br(e)}notifyBundleLoaded(e){this.Pr(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ir),this.removeItem(this.ar),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return Er("SharedClientState","READ",e,t),t}setItem(e,t){Er("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){Er("SharedClientState","REMOVE",e),this.storage.removeItem(e)}rr(e){const s=e;s.storageArea===this.storage&&(Er("SharedClientState","EVENT",s.key,s.newValue),s.key!==this.ar?this.Hs.enqueueRetryable(async()=>{if(this.started){if(null!==s.key)if(this.lr.test(s.key)){if(null==s.newValue){var e=this.vr(s.key);return this.Vr(e,null)}e=this.Sr(s.key,s.newValue);if(e)return this.Vr(e.clientId,e)}else if(this.dr.test(s.key)){if(null!==s.newValue){var t=this.Dr(s.key,s.newValue);if(t)return this.Cr(t)}}else if(this._r.test(s.key)){if(null!==s.newValue){t=this.Nr(s.key,s.newValue);if(t)return this.kr(t)}}else if(s.key===this.wr){if(null!==s.newValue){var n=this.yr(s.newValue);if(n)return this.pr(n)}}else if(s.key===this.hr){n=function(e){let t=Is.at;if(null!=e)try{var n=JSON.parse(e);Dr("number"==typeof n),t=n}catch(e){Tr("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(s.newValue);n!==Is.at&&this.sequenceNumberHandler(n)}else if(s.key===this.mr){const r=this.Mr(s.newValue);await Promise.all(r.map(e=>this.syncEngine.Or(e)))}}else this.cr.push(s)}):Tr("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Ar(){return this.ur.get(this.sr)}gr(){this.setItem(this.ar,this.Ar.tr())}Tr(e,t,n){const r=new Gc(this.currentUser,e,t,n),s=Uc(this.persistenceKey,this.currentUser,e);this.setItem(s,r.tr())}Er(e){var t=Uc(this.persistenceKey,this.currentUser,e);this.removeItem(t)}br(e){var t={clientId:this.sr,onlineState:e};this.storage.setItem(this.wr,JSON.stringify(t))}Rr(e,t,n){const r=qc(this.persistenceKey,e),s=new jc(e,t,n);this.setItem(r,s.tr())}Pr(e){var t=JSON.stringify(Array.from(e));this.setItem(this.mr,t)}vr(e){var t=this.lr.exec(e);return t?t[1]:null}Sr(e,t){var n=this.vr(e);return Kc.Zi(n,t)}Dr(e,t){var n=this.dr.exec(e),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return Gc.Zi(new vr(n),r,t)}Nr(e,t){var n=this._r.exec(e),n=Number(n[1]);return jc.Zi(n,t)}yr(e){return $c.Zi(e)}Mr(e){return JSON.parse(e)}async Cr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Fr(e.batchId,e.state,e.error);Er("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}kr(e){return this.syncEngine.$r(e.targetId,e.state,e.error)}Vr(e,t){const n=t?this.ur.insert(e,t):this.ur.remove(e),r=this.Ir(this.ur),s=this.Ir(n),i=[],a=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||a.push(e)}),this.syncEngine.Br(i,a).then(()=>{this.ur=n})}pr(e){this.ur.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Ir(e){let n=La;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class Hc{constructor(){this.Lr=new Qc,this.Ur={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Lr.er(e),this.Ur[e]||"not-current"}updateQueryState(e,t,n){this.Ur[e]=t}removeLocalQueryTarget(e){this.Lr.nr(e)}isLocalQueryTarget(e){return this.Lr.activeTargetIds.has(e)}clearQueryState(e){delete this.Ur[e]}getAllActiveQueryTargets(){return this.Lr.activeTargetIds}isActiveQueryTarget(e){return this.Lr.activeTargetIds.has(e)}start(){return this.Lr=new Qc,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Wc{qr(e){}shutdown(){}}class Yc{constructor(){this.Kr=()=>this.Gr(),this.Qr=()=>this.jr(),this.Wr=[],this.zr()}qr(e){this.Wr.push(e)}shutdown(){window.removeEventListener("online",this.Kr),window.removeEventListener("offline",this.Qr)}zr(){window.addEventListener("online",this.Kr),window.addEventListener("offline",this.Qr)}Gr(){Er("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Wr)e(0)}jr(){Er("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Wr)e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Xc={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Jc{constructor(e){this.Hr=e.Hr,this.Jr=e.Jr}Yr(e){this.Xr=e}Zr(e){this.eo=e}onMessage(e){this.no=e}close(){this.Jr()}send(e){this.Hr(e)}so(){this.Xr()}io(e){this.eo(e)}ro(e){this.no(e)}}class Zc extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http";this.oo=t+"://"+e.host,this.uo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}co(t,e,n,r,s){const i=this.ao(t,e);Er("RestConnection","Sending: ",i,n);var a={};return this.ho(a,r,s),this.lo(t,i,a,n).then(e=>(Er("RestConnection","Received: ",e),e),e=>{throw Sr("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e})}fo(e,t,n,r,s,i){return this.co(e,t,n,r,s)}ho(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+wr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}ao(e,t){var n=Xc[e];return`${this.oo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}lo(o,t,n,r){return new Promise((s,i)=>{const a=new pr;a.listenOnce(hr.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case cr.NO_ERROR:var e=a.getResponseJson();Er("Connection","XHR received:",JSON.stringify(e)),s(e);break;case cr.TIMEOUT:Er("Connection",'RPC "'+o+'" timed out'),i(new Cr(Ar.DEADLINE_EXCEEDED,"Request time out"));break;case cr.HTTP_ERROR:var t,n=a.getStatus();if(Er("Connection",'RPC "'+o+'" failed with status:',n,"response text:",a.getResponseText()),0<n){const o=a.getResponseJson().error;o&&o.status&&o.message?(r=o.status.toLowerCase().replace(/_/g,"-"),t=0<=Object.values(Ar).indexOf(r)?r:Ar.UNKNOWN,i(new Cr(t,o.message))):i(new Cr(Ar.UNKNOWN,"Server responded with status "+a.getStatus()))}else i(new Cr(Ar.UNAVAILABLE,"Connection failed."));break;default:xr()}}finally{Er("Connection",'RPC "'+o+'" completed.')}var r});var e=JSON.stringify(r);a.send(t,"POST",e,n,15)})}_o(e,t,n){const r=[this.oo,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=new nr,i=ur(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(a.xmlHttpFactory=new gr({})),this.ho(a.initMessageHeaders,t,n),"undefined"!=typeof window&&(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(f())||"object"==typeof navigator&&"ReactNative"===navigator.product||0<=f().indexOf("Electron/")||function(){const e=f();return 0<=e.indexOf("MSIE ")||0<=e.indexOf("Trident/")}()||0<=f().indexOf("MSAppHost/")||"object"==typeof(o="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0)&&void 0!==o.id||(a.httpHeadersOverwriteParam="$httpHeaders");var o=r.join("");Er("Connection","Creating WebChannel: "+o,a);const u=s.createWebChannel(o,a);let c=!1,h=!1;const l=new Jc({Hr:e=>{h?Er("Connection","Not sending because WebChannel is closed:",e):(c||(Er("Connection","Opening WebChannel transport."),u.open(),c=!0),Er("Connection","WebChannel sending:",e),u.send(e))},Jr:()=>u.close()}),d=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return d(u,mr.EventType.OPEN,()=>{h||Er("Connection","WebChannel transport opened.")}),d(u,mr.EventType.CLOSE,()=>{h||(h=!0,Er("Connection","WebChannel transport closed"),l.io())}),d(u,mr.EventType.ERROR,e=>{h||(h=!0,Sr("Connection","WebChannel transport errored:",e),l.io(new Cr(Ar.UNAVAILABLE,"The operation could not be completed")))}),d(u,mr.EventType.MESSAGE,n=>{if(!h){var e=n.data[0];Dr(!!e);var r=e.error||(null===(r=e[0])||void 0===r?void 0:r.error);if(r){Er("Connection","WebChannel received error:",r);const n=r.status;let e=function(e){var t=or[e];if(void 0!==t)return Ta(t)}(n),t=r.message;void 0===e&&(e=Ar.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),h=!0,l.io(new Cr(e,t)),u.close()}else Er("Connection","WebChannel received:",e),l.ro(e)}}),d(i,lr.STAT_EVENT,e=>{e.stat===dr?Er("Connection","Detected buffering proxy"):e.stat===fr&&Er("Connection","Detected no buffering proxy")}),setTimeout(()=>{l.so()},0),l}}function eh(){return"undefined"!=typeof window?window:null}function th(){return"undefined"!=typeof document?document:null}function nh(e){return new $a(e,!0)}class rh{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Hs=e,this.timerId=t,this.wo=n,this.mo=r,this.yo=s,this.po=0,this.Io=null,this.To=Date.now(),this.reset()}reset(){this.po=0}Eo(){this.po=this.yo}Ao(e){this.cancel();var t=Math.floor(this.po+this.Ro()),n=Math.max(0,Date.now()-this.To),r=Math.max(0,t-n);0<r&&Er("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.po} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Io=this.Hs.enqueueAfterDelay(this.timerId,r,()=>(this.To=Date.now(),e())),this.po*=this.mo,this.po<this.wo&&(this.po=this.wo),this.po>this.yo&&(this.po=this.yo)}bo(){null!==this.Io&&(this.Io.skipDelay(),this.Io=null)}cancel(){null!==this.Io&&(this.Io.cancel(),this.Io=null)}Ro(){return(Math.random()-.5)*this.po}}class sh{constructor(e,t,n,r,s,i,a,o){this.Hs=e,this.Po=n,this.vo=r,this.Vo=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.So=0,this.Do=null,this.Co=null,this.stream=null,this.xo=new rh(e,t)}No(){return 1===this.state||5===this.state||this.ko()}ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Mo()}async stop(){this.No()&&await this.close(0)}Oo(){this.state=0,this.xo.reset()}Fo(){this.ko()&&null===this.Do&&(this.Do=this.Hs.enqueueAfterDelay(this.Po,6e4,()=>this.$o()))}Bo(e){this.Lo(),this.stream.send(e)}async $o(){if(this.ko())return this.close(0)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}Uo(){this.Co&&(this.Co.cancel(),this.Co=null)}async close(e,t){this.Lo(),this.Uo(),this.xo.cancel(),this.So++,4!==e?this.xo.reset():t&&t.code===Ar.RESOURCE_EXHAUSTED?(Tr(t.toString()),Tr("Using maximum backoff delay to prevent overloading the backend."),this.xo.Eo()):t&&t.code===Ar.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.qo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Zr(t)}qo(){}auth(){this.state=1;const e=this.Ko(this.So),n=this.So;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.So===n&&this.Go(e,t)},t=>{e(()=>{var e=new Cr(Ar.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Qo(e)})})}Go(e,t){const n=this.Ko(this.So);this.stream=this.jo(e,t),this.stream.Yr(()=>{n(()=>(this.state=2,this.Co=this.Hs.enqueueAfterDelay(this.vo,1e4,()=>(this.ko()&&(this.state=3),Promise.resolve())),this.listener.Yr()))}),this.stream.Zr(e=>{n(()=>this.Qo(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Mo(){this.state=5,this.xo.Ao(async()=>{this.state=0,this.start()})}Qo(e){return Er("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Ko(t){return e=>{this.Hs.enqueueAndForget(()=>this.So===t?e():(Er("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class ih extends sh{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.It=s}jo(e,t){return this.Vo._o("Listen",e,t)}onMessage(e){this.xo.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:xr(),s=t.targetChange.targetIds||[],i=(f=t.targetChange.resumeToken,e.gt?(Dr(void 0===f||"string"==typeof f),ks.fromBase64String(f||"")):(Dr(void 0===f||f instanceof Uint8Array),ks.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?Ar.UNKNOWN:Ta(f.code),new Cr(o,f.message||""));n=new Pa(r,s,i,o||null)}else if("documentChange"in t){t.documentChange;var u=t.documentChange;u.document,u.document.name,u.document.updateTime;var o=Ja(e,u.document.name),c=Ha(u.document.updateTime),h=new oi({mapValue:{fields:u.document.fields}}),c=ui.newFoundDocument(o,c,h),h=u.targetIds||[],u=u.removedTargetIds||[];n=new Va(h,u,c.key,c)}else if("documentDelete"in t){t.documentDelete;h=t.documentDelete;h.document;u=Ja(e,h.document),c=h.readTime?Ha(h.readTime):Kr.min(),c=ui.newNoDocument(u,c),h=h.removedTargetIds||[];n=new Va([],h,c.key,c)}else if("documentRemove"in t){t.documentRemove;var l=t.documentRemove;l.document;var d=Ja(e,l.document),l=l.removedTargetIds||[];n=new Va([],l,d,null)}else{if(!("filter"in t))return xr();{t.filter;const e=t.filter;e.targetId;l=e.count||0,d=new ba(l),l=e.targetId;n=new Fa(l,d)}}var o,f;return n}(this.It,e),n=function(e){if(!("targetChange"in e))return Kr.min();var t=e.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?Ha(t.readTime):Kr.min()}(e);return this.listener.Wo(t,n)}zo(e){const t={};t.database=to(this.It),t.addTarget=function(e,t){let n;var r=t.target;return n=fi(r)?{documents:oo(e,r)}:{query:uo(e,r)},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()?n.resumeToken=za(e,t.resumeToken):0<t.snapshotVersion.compareTo(Kr.min())&&(n.readTime=Qa(e,t.snapshotVersion.toTimestamp())),n}(this.It,e);var n,r,r=(this.It,n=e,null==(r=function(){switch(n.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return xr()}}())?null:{"goog-listen-tags":r});r&&(t.labels=r),this.Bo(t)}Ho(e){const t={};t.database=to(this.It),t.removeTarget=e,this.Bo(t)}}class ah extends sh{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.It=s,this.Jo=!1}get Yo(){return this.Jo}start(){this.Jo=!1,this.lastStreamToken=void 0,super.start()}qo(){this.Jo&&this.Xo([])}jo(e,t){return this.Vo._o("Write",e,t)}onMessage(e){if(Dr(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Jo){this.xo.reset();var t=(r=e.writeResults,s=e.commitTime,r&&0<r.length?(Dr(void 0!==s),r.map(e=>function(e,t){let n=e.updateTime?Ha(e.updateTime):Ha(t);return n.isEqual(Kr.min())&&(n=Ha(t)),new aa(n,e.transformResults||[])}(e,s))):[]),n=Ha(e.commitTime);return this.listener.Zo(n,t)}var r,s;return Dr(!e.writeResults||0===e.writeResults.length),this.Jo=!0,this.listener.tu()}eu(){const e={};e.database=to(this.It),this.Bo(e)}Xo(e){var t={streamToken:this.lastStreamToken,writes:e.map(e=>io(this.It,e))};this.Bo(t)}}class oh extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.Vo=n,this.It=r,this.nu=!1}su(){if(this.nu)throw new Cr(Ar.FAILED_PRECONDITION,"The client has already been terminated.")}co(n,r,s){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.Vo.co(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Ar.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Cr(Ar.UNKNOWN,e.toString())})}fo(n,r,s,i){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.Vo.fo(n,r,s,e,t,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Ar.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Cr(Ar.UNKNOWN,e.toString())})}terminate(){this.nu=!0}}class uh{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.iu=0,this.ru=null,this.ou=!0}uu(){0===this.iu&&(this.cu("Unknown"),this.ru=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.ru=null,this.au("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve())))}hu(e){"Online"===this.state?this.cu("Unknown"):(this.iu++,1<=this.iu&&(this.lu(),this.au(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.cu("Offline")))}set(e){this.lu(),this.iu=0,"Online"===e&&(this.ou=!1),this.cu(e)}cu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}au(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ou?(Tr(t),this.ou=!1):Er("OnlineStateTracker",t)}lu(){null!==this.ru&&(this.ru.cancel(),this.ru=null)}}class ch{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.fu=[],this.du=new Map,this._u=new Set,this.wu=[],this.mu=s,this.mu.qr(e=>{n.enqueueAndForget(async()=>{vh(this)&&(Er("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t._u.add(4),await lh(t),t.gu.set("Unknown"),t._u.delete(4),await hh(t)}(this))})}),this.gu=new uh(n,r)}}async function hh(e){if(vh(e))for(const t of e.wu)await t(!0)}async function lh(e){for(const t of e.wu)await t(!1)}function dh(e,t){const n=e;n.du.has(t.targetId)||(n.du.set(t.targetId,t),yh(n)?ph(n):Dh(n).ko()&&gh(n,t))}function fh(e,t){const n=e,r=Dh(n);n.du.delete(t),r.ko()&&mh(n,t),0===n.du.size&&(r.ko()?r.Fo():vh(n)&&n.gu.set("Unknown"))}function gh(e,t){e.yu.Ot(t.targetId),Dh(e).zo(t)}function mh(e,t){e.yu.Ot(t),Dh(e).Ho(t)}function ph(t){t.yu=new Ua({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),se:e=>t.du.get(e)||null}),Dh(t).start(),t.gu.uu()}function yh(e){return vh(e)&&!Dh(e).No()&&0<e.du.size}function vh(e){return 0===e._u.size}function wh(e){e.yu=void 0}async function Ih(e,t,n){if(!fs(t))throw t;e._u.add(1),await lh(e),e.gu.set("Offline"),n=n||(()=>Nc(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{Er("RemoteStore","Retrying IndexedDB access"),await n(),e._u.delete(1),await hh(e)})}function bh(t,n){return n().catch(e=>Ih(t,e,n))}async function Eh(e){const t=e,n=Ah(t);let r=0<t.fu.length?t.fu[t.fu.length-1].batchId:-1;for(;vh(s=t)&&s.fu.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.fu.length&&n.Fo();break}r=e.batchId,function(e,t){e.fu.push(t);const n=Ah(e);n.ko()&&n.Yo&&n.Xo(t.mutations)}(t,e)}catch(e){await Ih(t,e)}var s;Th(t)&&Sh(t)}function Th(e){return vh(e)&&!Ah(e).No()&&0<e.fu.length}function Sh(e){Ah(e).start()}async function _h(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),Er("RemoteStore","RemoteStore received new credentials");var r=vh(n);n._u.add(3),await lh(n),r&&n.gu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n._u.delete(3),await hh(n)}async function xh(e,t){const n=e;t?(n._u.delete(2),await hh(n)):(n._u.add(2),await lh(n),n.gu.set("Unknown"))}function Dh(t){return t.pu||(t.pu=function(e,t,n){const r=e;return r.su(),new ih(t,r.Vo,r.authCredentials,r.appCheckCredentials,r.It,n)}(t.datastore,t.asyncQueue,{Yr:(async function(n){n.du.forEach((e,t)=>{gh(n,e)})}).bind(null,t),Zr:(async function(e,t){wh(e),yh(e)?(e.gu.hu(t),ph(e)):e.gu.set("Unknown")}).bind(null,t),Wo:(async function(e,r,t){if(e.gu.set("Online"),r instanceof Pa&&2===r.state&&r.cause)try{await async function(e){var t=r.cause;for(const n of r.targetIds)e.du.has(n)&&(await e.remoteSyncer.rejectListen(n,t),e.du.delete(n),e.yu.removeTarget(n))}(e)}catch(t){Er("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),t),await Ih(e,t)}else if(r instanceof Va?e.yu.Gt(r):r instanceof Fa?e.yu.Yt(r):e.yu.Wt(r),!t.isEqual(Kr.min()))try{const r=await Nc(e.localStore);0<=t.compareTo(r)&&await function(r,s){const e=r.yu.te(s);return e.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=r.du.get(t);n&&r.du.set(t,n.withResumeToken(e.resumeToken,s))}}),e.targetMismatches.forEach(e=>{const t=r.du.get(e);var n;t&&(r.du.set(e,t.withResumeToken(ks.EMPTY_BYTE_STRING,t.snapshotVersion)),mh(r,e),n=new zo(t.target,e,1,t.sequenceNumber),gh(r,n))}),r.remoteSyncer.applyRemoteEvent(e)}(e,t)}catch(r){Er("RemoteStore","Failed to raise snapshot:",r),await Ih(e,r)}}).bind(null,t)}),t.wu.push(async e=>{e?(t.pu.Oo(),yh(t)?ph(t):t.gu.set("Unknown")):(await t.pu.stop(),wh(t))})),t.pu}function Ah(t){return t.Iu||(t.Iu=function(e,t,n){const r=e;return r.su(),new ah(t,r.Vo,r.authCredentials,r.appCheckCredentials,r.It,n)}(t.datastore,t.asyncQueue,{Yr:(async function(e){Ah(e).eu()}).bind(null,t),Zr:(async function(e,t){t&&Ah(e).Yo&&await async function(e,t){if(Ea(n=t.code)&&n!==Ar.ABORTED){const n=e.fu.shift();Ah(e).Oo(),await bh(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await Eh(e)}var n}(e,t),Th(e)&&Sh(e)}).bind(null,t),tu:(async function(e){const t=Ah(e);for(const n of e.fu)t.Xo(n.mutations)}).bind(null,t),Zo:(async function(e,t,n){const r=e.fu.shift(),s=$o.from(r,t,n);await bh(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await Eh(e)}).bind(null,t)}),t.wu.push(async e=>{e?(t.Iu.Oo(),await Eh(t)):(await t.Iu.stop(),0<t.fu.length&&(Er("RemoteStore",`Stopping write stream with ${t.fu.length} pending writes`),t.fu=[]))})),t.Iu}class Ch{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Nr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,a=new Ch(e,t,i,r,s);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Cr(Ar.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Nh(e,t){if(Tr("AsyncQueue",`${t}: ${e}`),fs(e))return new Cr(Ar.UNAVAILABLE,`${t}: ${e}`);throw e}class kh{constructor(n){this.comparator=n?(e,t)=>n(e,t)||Wr.comparator(e.key,t.key):(e,t)=>Wr.comparator(e.key,t.key),this.keyedMap=Da(),this.sortedSet=new Ss(this.comparator)}static emptySet(e){return new kh(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof kh))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new kh;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Rh{constructor(){this.Tu=new Ss(Wr.comparator)}track(e){var t=e.doc.key,n=this.Tu.get(t);!n||0!==e.type&&3===n.type?this.Tu=this.Tu.insert(t,e):3===e.type&&1!==n.type?this.Tu=this.Tu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Tu=this.Tu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Tu=this.Tu.remove(t):1===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):xr()}Eu(){const n=[];return this.Tu.inorderTraversal((e,t)=>{n.push(t)}),n}}class Lh{constructor(e,t,n,r,s,i,a,o){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=a,this.excludesMetadataChanges=o}static fromInitialDocuments(e,t,n,r){const s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new Lh(e,t,kh.emptySet(t),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Ui(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class Oh{constructor(){this.Au=void 0,this.listeners=[]}}class Mh{constructor(){this.queries=new Sa(e=>qi(e),Ui),this.onlineState="Unknown",this.Ru=new Set}}async function Vh(e,t){const n=e,r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new Oh),s)try{i.Au=await n.onListen(r)}catch(e){const n=Nh(e,`Initialization of query '${Gi(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.bu(n.onlineState),!i.Au||t.Pu(i.Au)&&Ph(n)}async function Fh(e,t){const n=e,r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Ph(e){e.Ru.forEach(e=>{e.next()})}class Bh{constructor(e,t,n){this.query=e,this.vu=t,this.Vu=!1,this.Su=null,this.onlineState="Unknown",this.options=n||{}}Pu(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new Lh(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}let t=!1;return this.Vu?this.Du(e)&&(this.vu.next(e),t=!0):this.Cu(e,this.onlineState)&&(this.xu(e),t=!0),this.Su=e,t}onError(e){this.vu.error(e)}bu(e){this.onlineState=e;let t=!1;return this.Su&&!this.Vu&&this.Cu(this.Su,e)&&(this.xu(this.Su),t=!0),t}Cu(e,t){return!e.fromCache||!(this.options.Nu&&"Offline"!==t||e.docs.isEmpty()&&"Offline"!==t)}Du(e){if(0<e.docChanges.length)return!0;var t=this.Su&&this.Su.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}xu(e){e=Lh.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.Vu=!0,this.vu.next(e)}}class Uh{constructor(e,t){this.payload=e,this.byteLength=t}ku(){return"metadata"in this.payload}}class qh{constructor(e){this.It=e}Ji(e){return Ja(this.It,e)}Yi(e){return e.metadata.exists?so(this.It,e.document,!1):ui.newNoDocument(this.Ji(e.metadata.name),this.Xi(e.metadata.readTime))}Xi(e){return Ha(e)}}class Gh{constructor(e,t,n){this.Mu=e,this.localStore=t,this.It=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=jh(e)}Ou(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.payload.namedQuery)this.queries.push(e.payload.namedQuery);else if(e.payload.documentMetadata){this.documents.push({metadata:e.payload.documentMetadata}),e.payload.documentMetadata.exists||++t;const n=Qr.fromString(e.payload.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.payload.document&&(this.documents[this.documents.length-1].document=e.payload.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}Fu(e){const t=new Map,n=new qh(this.It);for(const s of e)if(s.metadata.queries){const e=n.Ji(s.metadata.name);for(const n of s.metadata.queries){var r=(t.get(n)||Ra()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=e;let i=Ra(),a=_a;for(const e of n){const n=t.Ji(e.metadata.name);e.document&&(i=i.add(n));const c=t.Yi(e);c.setReadTime(t.Xi(e.metadata.readTime)),a=a.insert(n,c)}const o=s.Gi.newChangeBuffer({trackRemovals:!0}),u=await Lc(s,(r=r,Pi(Ri(Qr.fromString(`__bundle__/docs/${r}`)))));return s.persistence.runTransaction("Apply bundle documents","readwrite",t=>Rc(t,o,a).next(e=>(o.apply(t),e)).next(e=>s.Cs.removeMatchingKeysForTargetId(t,u.targetId).next(()=>s.Cs.addMatchingKeys(t,i,u.targetId)).next(()=>s.localDocuments.getLocalViewOfDocuments(t,e.Wi,e.zi)).next(()=>e.Wi)))}(this.localStore,new qh(this.It),this.documents,this.Mu.id),t=this.Fu(this.documents);for(const e of this.queries)await async function(e,n,r=Ra()){const s=await Lc(e,Pi(nu(n.bundledQuery))),i=e;return i.persistence.runTransaction("Save named query","readwrite",e=>{var t=Ha(n.readTime);if(0<=s.snapshotVersion.compareTo(t))return i.Ns.saveNamedQuery(e,n);t=s.withResumeToken(ks.EMPTY_BYTE_STRING,t);return i.Ui=i.Ui.insert(t.targetId,t),i.Cs.updateTargetData(e,t).next(()=>i.Cs.removeMatchingKeysForTargetId(e,s.targetId)).next(()=>i.Cs.addMatchingKeys(e,r,s.targetId)).next(()=>i.Ns.saveNamedQuery(e,n))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,$u:this.collectionGroups,Bu:e}}}function jh(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Kh{constructor(e){this.key=e}}class $h{constructor(e){this.key=e}}class Qh{constructor(e,t){this.query=e,this.Lu=t,this.Uu=null,this.current=!1,this.qu=Ra(),this.mutatedKeys=Ra(),this.Ku=$i(e),this.Gu=new kh(this.Ku)}get Qu(){return this.Lu}ju(e,t){const o=t?t.Wu:new Rh,u=(t||this).Gu;let c=(t||this).mutatedKeys,h=u,l=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=ji(this.query,t)?t:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(o.track({type:3,doc:r}),a=!0):this.zu(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this.Ku(r,d)||f&&this.Ku(r,f)<0)&&(l=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(l=!0)),a&&(c=r?(h=h.add(r),i?c.add(e):c.delete(e)):(h=h.delete(e),c.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),c=c.delete(e.key),o.track({type:1,doc:e})}return{Gu:h,Wu:o,$i:l,mutatedKeys:c}}zu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.Gu;this.Gu=e.Gu,this.mutatedKeys=e.mutatedKeys;const s=e.Wu.Eu();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return xr()}};return n(e)-n(t)}(e.type,t.type)||this.Ku(e.doc,t.doc)),this.Hu(n);var i=t?this.Ju():[],a=0===this.qu.size&&this.current?1:0,o=a!==this.Uu;return this.Uu=a,0!==s.length||o?{snapshot:new Lh(this.query,e.Gu,r,s,e.mutatedKeys,0==a,o,!1),Yu:i}:{Yu:i}}bu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Gu:this.Gu,Wu:new Rh,mutatedKeys:this.mutatedKeys,$i:!1},!1)):{Yu:[]}}Xu(e){return!this.Lu.has(e)&&!!this.Gu.has(e)&&!this.Gu.get(e).hasLocalMutations}Hu(e){e&&(e.addedDocuments.forEach(e=>this.Lu=this.Lu.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Lu=this.Lu.delete(e)),this.current=e.current)}Ju(){if(!this.current)return[];const t=this.qu;this.qu=Ra(),this.Gu.forEach(e=>{this.Xu(e.key)&&(this.qu=this.qu.add(e.key))});const n=[];return t.forEach(e=>{this.qu.has(e)||n.push(new $h(e))}),this.qu.forEach(e=>{t.has(e)||n.push(new Kh(e))}),n}Zu(e){this.Lu=e.Hi,this.qu=Ra();var t=this.ju(e.documents);return this.applyChanges(t,!0)}tc(){return Lh.fromInitialDocuments(this.query,this.Gu,this.mutatedKeys,0===this.Uu)}}class zh{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Hh{constructor(e){this.key=e,this.ec=!1}}class Wh{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.nc={},this.sc=new Sa(e=>qi(e),Ui),this.ic=new Map,this.rc=new Set,this.oc=new Ss(Wr.comparator),this.uc=new Map,this.cc=new cc,this.ac={},this.hc=new Map,this.lc=Bu.vn(),this.onlineState="Unknown",this.fc=void 0}get isPrimaryClient(){return!0===this.fc}}async function Yh(n,e,t,r){n.dc=(e,i,t)=>async function(e,t,n){let r=t.view.ju(i);r.$i&&(r=await Mc(e.localStore,t.query,!1).then(({documents:e})=>t.view.ju(e,r)));var s=n&&n.targetChanges.get(t.targetId),s=t.view.applyChanges(r,e.isPrimaryClient,s);return il(e,t.targetId,s.Yu),s.snapshot}(n,e,t);const s=await Mc(n.localStore,e,!0),i=new Qh(e,s.Hi),a=i.ju(s.documents),o=Ma.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState),u=i.applyChanges(a,n.isPrimaryClient,o);il(n,t,u.Yu);var c=new zh(e,t,i);return n.sc.set(e,c),n.ic.has(t)?n.ic.get(t).push(e):n.ic.set(t,[e]),u.snapshot}async function Xh(e,t,n){const r=dl(e);try{const e=await function(e,s){const i=e,a=jr.now(),o=s.reduce((e,t)=>e.add(t.key),Ra());let u,c;return i.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=_a,r=Ra();return i.Gi.getEntries(n,o).next(e=>{t=e,t.forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>i.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of s){const s=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=Yi(r.transform,e||null);null!=s&&(null===n&&(n=oi.empty()),n.set(r.field,s))}return n||null}(n,u.get(n.key).overlayedDocument);null!=s&&t.push(new ma(n.key,s,function r(e){const s=[];return Es(e.fields,(e,t)=>{const n=new Hr([e]);if(ni(t)){const e=r(t.mapValue).fields;if(0===e.length)s.push(n);else for(const t of e)s.push(n.child(t))}else s.push(n)}),new Ns(s)}(s.value.mapValue),oa.exists(!0)))}return i.mutationQueue.addMutationBatch(n,a,t,s)}).next(e=>{var t=(c=e).applyToLocalDocumentSet(u,r);return i.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:c.batchId,changes:Aa(u)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.ac[e.currentUser.toKey()];r=r||new Ss(Ur),r=r.insert(t,n),e.ac[e.currentUser.toKey()]=r}(r,e.batchId,n),await ol(r,e.changes),await Eh(r.remoteStore)}catch(e){const t=Nh(e,"Failed to persist write");n.reject(t)}}async function Jh(e,t){const r=e;try{const e=await kc(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.uc.get(t);n&&(Dr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.ec=!0:0<e.modifiedDocuments.size?Dr(n.ec):0<e.removedDocuments.size&&(Dr(n.ec),n.ec=!1))}),await ol(r,e,t)}catch(e){await os(e)}}function Zh(r,s,e){const t=r;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const r=[];t.sc.forEach((e,t)=>{var n=t.view.bu(s);n.snapshot&&r.push(n.snapshot)}),function(e,n){const t=e;t.onlineState=n;let r=!1;t.queries.forEach((e,t)=>{for(const e of t.listeners)e.bu(n)&&(r=!0)}),r&&Ph(t)}(t.eventManager,s),r.length&&t.nc.Wo(r),t.onlineState=s,t.isPrimaryClient&&t.sharedClientState.setOnlineState(s)}}async function el(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=s.Gi.newChangeBuffer({trackRemovals:!0});return function(e,t,r,s){const i=r.batch,n=i.keys();let a=us.resolve();return n.forEach(n=>{a=a.next(()=>s.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);Dr(null!==t),e.version.compareTo(t)<0&&(i.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),s.addEntry(e)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))}(s,e,r,n).next(()=>n.apply(e)).next(()=>s.mutationQueue.performConsistencyCheck(e)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Ra();for(let n=0;n<e.mutationResults.length;++n)0<e.mutationResults[n].transformResults.length&&(t=t.add(e.batch.mutations[n].key));return t}(r))).next(()=>s.localDocuments.getDocuments(e,t))})}(n.localStore,t);nl(n,r,null),tl(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await ol(n,e)}catch(e){await os(e)}}function tl(e,t){(e.hc.get(t)||[]).forEach(e=>{e.resolve()}),e.hc.delete(t)}function nl(e,t,n){const r=e;let s=r.ac[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.ac[r.currentUser.toKey()]=s}}function rl(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.ic.get(e))t.sc.delete(r),n&&t.nc._c(r,n);t.ic.delete(e),t.isPrimaryClient&&t.cc.ls(e).forEach(e=>{t.cc.containsKey(e)||sl(t,e)})}function sl(e,t){e.rc.delete(t.path.canonicalString());var n=e.oc.get(t);null!==n&&(fh(e.remoteStore,n),e.oc=e.oc.remove(t),e.uc.delete(n),al(e))}function il(e,t,n){for(const r of n)r instanceof Kh?(e.cc.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.oc.get(n)||e.rc.has(r)||(Er("SyncEngine","New document in limbo: "+n),e.rc.add(r),al(e))}(e,r)):r instanceof $h?(Er("SyncEngine","Document no longer in limbo: "+r.key),e.cc.removeReference(r.key,t),e.cc.containsKey(r.key)||sl(e,r.key)):xr()}function al(e){for(;0<e.rc.size&&e.oc.size<e.maxConcurrentLimboResolutions;){var t=e.rc.values().next().value;e.rc.delete(t);var n=new Wr(Qr.fromString(t)),t=e.lc.next();e.uc.set(t,new Hh(n)),e.oc=e.oc.insert(n,t),dh(e.remoteStore,new zo(Pi(Ri(n.path)),t,2,Is.at))}}async function ol(e,t,r){const s=e,i=[],a=[],o=[];s.sc.isEmpty()||(s.sc.forEach((e,n)=>{o.push(s.dc(n,t,r).then(e=>{var t;e&&(s.isPrimaryClient&&s.sharedClientState.updateQueryState(n.targetId,e.fromCache?"not-current":"current"),i.push(e),t=_c.Ci(n.targetId,e),a.push(t))}))}),await Promise.all(o),s.nc.Wo(i),await async function(e,t){const r=e;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>us.forEach(t,t=>us.forEach(t.Si,e=>r.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>us.forEach(t.Di,e=>r.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(e){if(!fs(e))throw e;Er("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=r.Ui.get(t),n=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(n);r.Ui=r.Ui.insert(t,s)}}}(s.localStore,a))}async function ul(r,e){const s=r;if(ll(s),dl(s),!0===e&&!0!==s.fc){const r=s.sharedClientState.getAllActiveQueryTargets(),e=await cl(s,r.toArray());s.fc=!0,await xh(s.remoteStore,!0);for(const r of e)dh(s.remoteStore,r)}else if(!1===e&&!1!==s.fc){const r=[];let n=Promise.resolve();s.ic.forEach((e,t)=>{s.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(rl(s,t),Oc(s.localStore,t,!0))),fh(s.remoteStore,t)}),await n,await cl(s,r),function(){const n=s;n.uc.forEach((e,t)=>{fh(n.remoteStore,t)}),n.cc.fs(),n.uc=new Map,n.oc=new Ss(Wr.comparator)}(),s.fc=!1,await xh(s.remoteStore,!1)}}async function cl(t,n){const r=t,s=[],i=[];for(const t of n){let e;const h=r.ic.get(t);if(h&&0!==h.length){e=await Lc(r.localStore,Pi(h[0]));for(const t of h){const n=r.sc.get(t),h=(a=r,o=n,c=u=void 0,c=await Mc((u=a).localStore,o.query,!0),c=o.view.Zu(c),u.isPrimaryClient&&il(u,o.targetId,c.Yu),await c);h.snapshot&&i.push(h.snapshot)}}else{const h=await Vc(r.localStore,t);e=await Lc(r.localStore,h),await Yh(r,hl(h),t,!1)}s.push(e)}var a,o,u,c;return r.nc.Wo(i),s}function hl(e){return ki(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function ll(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Jh.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(e,t){const n=e,r=n.uc.get(t);if(r&&r.ec)return Ra().add(r.key);{let e=Ra();const r=n.ic.get(t);if(!r)return e;for(const t of r){const r=n.sc.get(t);e=e.unionWith(r.view.Qu)}return e}}).bind(null,t),t.remoteStore.remoteSyncer.rejectListen=(async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.uc.get(t),i=s&&s.key;if(i){let e=new Ss(Wr.comparator);e=e.insert(i,ui.newNoDocument(i,Kr.min()));const n=Ra().add(i),s=new Oa(Kr.min(),new Map,new Ds(Ur),e,n);await Jh(r,s),r.oc=r.oc.remove(i),r.uc.delete(t),al(r)}else await Oc(r.localStore,t,!1).then(()=>rl(r,t,n)).catch(os)}).bind(null,t),t.nc.Wo=(function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.listeners)t.Pu(e)&&(r=!0);s.Au=e}}r&&Ph(n)}).bind(null,t.eventManager),t.nc._c=(function(e,t,n){const r=e,s=r.queries.get(t);if(s)for(const e of s.listeners)e.onError(n);r.queries.delete(t)}).bind(null,t.eventManager),t}function dl(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=el.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=(async function(e,t,n){const r=e;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return s.mutationQueue.lookupMutationBatch(t,r).next(e=>(Dr(null!==e),n=e.keys(),s.mutationQueue.removeMutationBatch(t,e))).next(()=>s.mutationQueue.performConsistencyCheck(t)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>s.localDocuments.getDocuments(t,n))})}(r.localStore,t);nl(r,t,n),tl(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await ol(r,e)}catch(n){await os(n)}}).bind(null,t),t}class fl{constructor(){this.synchronizeTabs=!1}async initialize(e){this.It=nh(e.databaseInfo.databaseId),this.sharedClientState=this.mc(e),this.persistence=this.gc(e),await this.persistence.start(),this.localStore=this.yc(e),this.gcScheduler=this.Ic(e,this.localStore),this.indexBackfillerScheduler=this.Tc(e,this.localStore)}Ic(e,t){return null}Tc(e,t){return null}yc(e){return Ac(this.persistence,new xc,e.initialUser,this.It)}gc(e){return new mc(yc.Bs,this.It)}mc(e){return new Hc}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class gl extends fl{constructor(e,t,n){super(),this.Ec=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Ec.initialize(this,e),await dl(this.Ec.syncEngine),await Eh(this.Ec.remoteStore),await this.persistence.li(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}yc(e){return Ac(this.persistence,new xc,e.initialUser,this.It)}Ic(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new Qu(n,e.asyncQueue,t)}Tc(e,t){var n=new ws(t,this.persistence);return new vs(e.asyncQueue,n)}gc(e){var t=Sc(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?ku.withCacheSize(this.cacheSizeBytes):ku.DEFAULT;return new bc(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,eh(),th(),this.It,this.sharedClientState,!!this.forceOwnership)}mc(e){return new Hc}}class ml extends gl{constructor(e,t){super(e,t,!1),this.Ec=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.Ec.syncEngine;this.sharedClientState instanceof zc&&(this.sharedClientState.syncEngine={Fr:(async function(e,t,n,r){var s=e,i=await function(e,n){const r=e,s=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>s.Tn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):us.resolve(null)))}(s.localStore,t);null!==i?("pending"===n?await Eh(s.remoteStore):"acknowledged"===n||"rejected"===n?(nl(s,t,r||null),tl(s,t),s.localStore.mutationQueue.An(t)):xr(),await ol(s,i)):Er("SyncEngine","Cannot apply mutation batch with id: "+t)}).bind(null,t),$r:(async function(e,t,n,r){const s=e;if(s.fc)Er("SyncEngine","Ignoring unexpected query state notification.");else{var i=s.ic.get(t);if(i&&0<i.length)switch(n){case"current":case"not-current":{const e=await Fc(s.localStore,Ki(i[0])),r=Oa.createSynthesizedRemoteEventForCurrentChange(t,"current"===n);await ol(s,e,r);break}case"rejected":await Oc(s.localStore,t,!0),rl(s,t,r);break;default:xr()}}}).bind(null,t),Br:(async function(e,t,n){const r=ll(e);if(r.fc){for(const e of t)if(r.ic.has(e))Er("SyncEngine","Adding an already active target "+e);else{const t=await Vc(r.localStore,e),n=await Lc(r.localStore,t);await Yh(r,hl(t),n.targetId,!1),dh(r.remoteStore,n)}for(const e of n)r.ic.has(e)&&await Oc(r.localStore,e,!1).then(()=>{fh(r.remoteStore,e),rl(r,e)}).catch(os)}}).bind(null,t),vi:(function(e){return e.localStore.persistence.vi()}).bind(null,t),Or:(async function(e,t){const n=e;return Fc(n.localStore,t).then(e=>ol(n,e))}).bind(null,t)},await this.sharedClientState.start()),await this.persistence.li(async e=>{await ul(this.Ec.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}mc(e){var t=eh();if(!zc.C(t))throw new Cr(Ar.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=Sc(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new zc(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class pl{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Zh(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){Er("SyncEngine","User change. New user:",t.toKey());const r=await Cc(n.localStore,t);n.currentUser=t,(e=n).hc.forEach(e=>{e.forEach(e=>{e.reject(new Cr(Ar.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.hc.clear(),n.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await ol(n,r.ji)}}).bind(null,this.syncEngine),await xh(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Mh}createDatastore(e){var t,n,r,s,i=nh(e.databaseInfo.databaseId),t=(t=e.databaseInfo,new Zc(t));return n=e.authCredentials,r=e.appCheckCredentials,s=t,e=i,new oh(n,r,s,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>Zh(this.syncEngine,e,0),i=new(Yc.C()?Yc:Wc),new ch(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,a){const o=new Wh(e,t,n,r,s,i);return a&&(o.fc=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=e;Er("RemoteStore","RemoteStore shutting down."),t._u.add(5),await lh(t),t.mu.shutdown(),t.gu.set("Unknown")}(this.remoteStore)}}function yl(t,n=10240){let r=0;return{async read(){if(r<t.byteLength){var e={value:t.slice(r,r+n),done:!1};return r+=n,e}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class vl{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ac(this.observer.next,e)}error(e){this.observer.error?this.Ac(this.observer.error,e):Tr("Uncaught Error in snapshot listener:",e)}Rc(){this.muted=!0}Ac(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class wl{constructor(e,t){this.bc=e,this.It=t,this.metadata=new Nr,this.buffer=new Uint8Array,this.Pc=new TextDecoder("utf-8"),this.vc().then(e=>{e&&e.ku()?this.metadata.resolve(e.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.payload)}`))},e=>this.metadata.reject(e))}close(){return this.bc.cancel()}async getMetadata(){return this.metadata.promise}async wc(){return await this.getMetadata(),this.vc()}async vc(){var e=await this.Vc();if(null===e)return null;var t=this.Pc.decode(e),n=Number(t);isNaN(n)&&this.Sc(`length string (${t}) is not valid number`);t=await this.Dc(n);return new Uh(JSON.parse(t),e.length+n)}Cc(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async Vc(){for(;this.Cc()<0&&!await this.xc(););if(0===this.buffer.length)return null;var e=this.Cc();e<0&&this.Sc("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Dc(e){for(;this.buffer.length<e;)await this.xc()&&this.Sc("Reached the end of bundle when more is expected.");var t=this.Pc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Sc(e){throw this.bc.cancel(),new Error(`Invalid bundle format: ${e}`)}async xc(){var e=await this.bc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Il{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Cr(Ar.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const r=e,n=to(r.It)+"/documents",s={documents:t.map(e=>Xa(r.It,e))},i=await r.fo("BatchGetDocuments",n,s,t.length),a=new Map;i.forEach(e=>{const t=(n=r.It,"found"in(e=e)?function(e,t){Dr(!!t.found),t.found.name,t.found.updateTime;var n=Ja(e,t.found.name),r=Ha(t.found.updateTime),s=new oi({mapValue:{fields:t.found.fields}});return ui.newFoundDocument(n,r,s)}(n,e):"missing"in e?function(e,t){Dr(!!t.missing),Dr(!!t.readTime);var n=Ja(e,t.missing),r=Ha(t.readTime);return ui.newNoDocument(n,r)}(n,e):xr());var n;a.set(t.key.toString(),t)});const o=[];return t.forEach(e=>{var t=a.get(e.toString());Dr(!!t),o.push(t)}),o}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new wa(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{var n=Wr.fromPath(t);this.mutations.push(new Ia(n,this.precondition(n)))}),await async function(e,t){const n=e,r=to(n.It)+"/documents",s={writes:t.map(e=>io(n.It,e))};await n.co("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw xr();t=Kr.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new Cr(Ar.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){var t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?oa.updateTime(t):oa.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return oa.exists(!0);if(t.isEqual(Kr.min()))throw new Cr(Ar.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return oa.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class bl{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.Nc=n.maxAttempts,this.xo=new rh(this.asyncQueue,"transaction_retry")}run(){--this.Nc,this.kc()}kc(){this.xo.Ao(async()=>{const t=new Il(this.datastore),e=this.Mc(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.Oc(e)}))}).catch(e=>{this.Oc(e)})})}Mc(e){try{var t=this.updateFunction(e);return!Us(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Oc(e){0<this.Nc&&this.Fc(e)?(--this.Nc,this.asyncQueue.enqueueAndForget(()=>(this.kc(),Promise.resolve()))):this.deferred.reject(e)}Fc(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||!Ea(t)}}class El{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=vr.UNAUTHENTICATED,this.clientId=Br.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{Er("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(Er("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Cr(Ar.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Nr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=Nh(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function Tl(e,t){e.asyncQueue.verifyOperationInProgress(),Er("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await Cc(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e.offlineComponents=t}async function Sl(e,n){e.asyncQueue.verifyOperationInProgress();var t=await _l(e);Er("FirestoreClient","Initializing OnlineComponentProvider");var r=await e.getConfiguration();await n.initialize(t,r),e.setCredentialChangeListener(e=>_h(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>_h(n.remoteStore,t)),e.onlineComponents=n}async function _l(e){return e.offlineComponents||(Er("FirestoreClient","Using default OfflineComponentProvider"),await Tl(e,new fl)),e.offlineComponents}async function xl(e){return e.onlineComponents||(Er("FirestoreClient","Using default OnlineComponentProvider"),await Sl(e,new pl)),e.onlineComponents}function Dl(e){return _l(e).then(e=>e.persistence)}function Al(e){return _l(e).then(e=>e.localStore)}function Cl(e){return xl(e).then(e=>e.remoteStore)}function Nl(e){return xl(e).then(e=>e.syncEngine)}async function kl(e){const t=await xl(e),n=t.eventManager;return n.onListen=(async function(e,t){const n=ll(e);let r,s;const i=n.sc.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.tc();else{const e=await Lc(n.localStore,Pi(t));n.isPrimaryClient&&dh(n.remoteStore,e);const i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await Yh(n,t,r,"current"===i)}return s}).bind(null,t.syncEngine),n.onUnlisten=(async function(e,t){const n=e,r=n.sc.get(t),s=n.ic.get(r.targetId);if(1<s.length)return n.ic.set(r.targetId,s.filter(e=>!Ui(e,t))),void n.sc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Oc(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),fh(n.remoteStore,r.targetId),rl(n,r.targetId)}).catch(os)):(rl(n,r.targetId),await Oc(n.localStore,r.targetId,!0))}).bind(null,t.syncEngine),n}function Rl(e,t,n={}){const r=new Nr;return e.asyncQueue.enqueueAndForget(async()=>function(n,r,s,i,a){const e=new vl({next:e=>{r.enqueueAndForget(()=>Fh(n,o));var t=e.docs.has(s);!t&&e.fromCache?a.reject(new Cr(Ar.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&i&&"server"===i.source?a.reject(new Cr(Ar.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new Bh(Ri(s.path),e,{includeMetadataChanges:!0,Nu:!0});return Vh(n,o)}(await kl(e),e.asyncQueue,t,n,r)),r.promise}function Ll(e,t,n={}){const r=new Nr;return e.asyncQueue.enqueueAndForget(async()=>function(t,n,e,r,s){const i=new vl({next:e=>{n.enqueueAndForget(()=>Fh(t,a)),e.fromCache&&"server"===r.source?s.reject(new Cr(Ar.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(e)},error:e=>s.reject(e)}),a=new Bh(e,i,{includeMetadataChanges:!0,Nu:!0});return Vh(t,a)}(await kl(e),e.asyncQueue,t,n,r)),r.promise}function Ol(e,t,n,r){const s=(n=n,t=nh(t),i="string"==typeof n?(new TextEncoder).encode(n):n,n=function(e){if(e instanceof Uint8Array)return yl(e,void 0);if(e instanceof ArrayBuffer)return yl(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(i),t=t,new wl(n,t));var i;e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=e;!async function(t,n,r){try{var s=await n.getMetadata();if(await function(e,t){const n=e,r=Ha(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Ns.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,s))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes}),Promise.resolve(new Set);r._updateProgress(jh(s));const a=new Gh(s,t.localStore,n.It);let e=await n.wc();for(;e;){const t=await a.Ou(e);t&&r._updateProgress(t),e=await n.wc()}var i=await a.complete();return await ol(t,i.Bu,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Ns.saveBundleMetadata(e,t))}(t.localStore,s),r._completeWith(i.progress),Promise.resolve(i.$u)}catch(t){return Sr("SyncEngine",`Loading bundle failed with ${t}`),r._failWith(t),Promise.resolve(new Set)}}(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}(await Nl(e),s,r)})}const Ml=new Map;function Vl(e,t,n){if(!n)throw new Cr(Ar.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Fl(e,t,n,r){if(!0===t&&!0===r)throw new Cr(Ar.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function Pl(e){if(!Wr.isDocumentKey(e))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Bl(e){if(Wr.isDocumentKey(e))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Ul(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":xr();if(e instanceof Array)return"an array";var t=(e=e).constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function ql(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new Cr(Ar.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Ul(e);throw new Cr(Ar.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function Gl(e,t){if(t<=0)throw new Cr(Ar.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class jl{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new Cr(Ar.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Cr(Ar.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,Fl("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Kl{constructor(e,t,n){this._authCredentials=t,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new jl({}),this._settingsFrozen=!1,e instanceof Bs?this._databaseId=e:(this._app=e,this._databaseId=function(e){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new Cr(Ar.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Bs(e.options.projectId)}(e))}get app(){if(!this._app)throw new Cr(Ar.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Cr(Ar.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new jl(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Rr;switch(e.type){case"gapi":var t=e.client;return new Vr(t,e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new Cr(Ar.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Ml.get(e);t&&(Er("ComponentProvider","Removing Datastore"),Ml.delete(e),t.terminate())}(this),Promise.resolve()}}function $l(n,e,t,r={}){var s;const i=(n=ql(n,Kl))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&Sr("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${t}`,ssl:!1})),r.mockUserToken){let e,t;if("string"==typeof r.mockUserToken)e=r.mockUserToken,t=vr.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,s=e.sub||e.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return s=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},e),[a(JSON.stringify({alg:"none",type:"JWT"})),a(JSON.stringify(s)),""].join(".")}(r.mockUserToken,null===(s=n._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new Cr(Ar.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new vr(i)}n._authCredentials=new Lr(new kr(e,t))}}class Ql{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Hl(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Ql(this.firestore,e,this._key)}}class zl{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new zl(this.firestore,e,this._query)}}class Hl extends zl{constructor(e,t,n){super(e,t,Ri(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Ql(this.firestore,null,new Wr(e))}withConverter(e){return new Hl(this.firestore,e,this._path)}}function Wl(e,t,...n){if(e=m(e),Vl("collection","path",t),e instanceof Kl){var r=Qr.fromString(t,...n);return Bl(r),new Hl(e,null,r)}if(!(e instanceof Ql||e instanceof Hl))throw new Cr(Ar.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(Qr.fromString(t,...n));return Bl(r),new Hl(e.firestore,null,r)}function Yl(e,t,...n){if(e=m(e),Vl("doc","path",t=1===arguments.length?Br.R():t),e instanceof Kl){var r=Qr.fromString(t,...n);return Pl(r),new Ql(e,null,new Wr(r))}if(!(e instanceof Ql||e instanceof Hl))throw new Cr(Ar.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(Qr.fromString(t,...n));return Pl(r),new Ql(e.firestore,e instanceof Hl?e.converter:null,new Wr(r))}function Xl(e,t){return e=m(e),t=m(t),(e instanceof Ql||e instanceof Hl)&&(t instanceof Ql||t instanceof Hl)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Jl(e,t){return e=m(e),t=m(t),e instanceof zl&&t instanceof zl&&e.firestore===t.firestore&&Ui(e._query,t._query)&&e.converter===t.converter}class Zl{constructor(){this.$c=Promise.resolve(),this.Bc=[],this.Lc=!1,this.Uc=[],this.qc=null,this.Kc=!1,this.Gc=!1,this.Qc=[],this.xo=new rh(this,"async_queue_retry"),this.jc=()=>{var e=th();e&&Er("AsyncQueue","Visibility state changed to "+e.visibilityState),this.xo.bo()};const e=th();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.jc)}get isShuttingDown(){return this.Lc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Wc(),this.zc(e)}enterRestrictedMode(e){if(!this.Lc){this.Lc=!0,this.Gc=e||!1;const t=th();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.jc)}}enqueue(e){if(this.Wc(),this.Lc)return new Promise(()=>{});const t=new Nr;return this.zc(()=>this.Lc&&this.Gc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Bc.push(e),this.Hc()))}async Hc(){if(0!==this.Bc.length){try{await this.Bc[0](),this.Bc.shift(),this.xo.reset()}catch(e){if(!fs(e))throw e;Er("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Bc.length&&this.xo.Ao(()=>this.Hc())}}zc(e){var t=this.$c.then(()=>(this.Kc=!0,e().catch(e=>{throw this.qc=e,this.Kc=!1,Tr("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e}).then(e=>(this.Kc=!1,e))));return this.$c=t}enqueueAfterDelay(e,t,n){this.Wc(),-1<this.Qc.indexOf(e)&&(t=0);var r=Ch.createAndSchedule(this,e,t,n,e=>this.Jc(e));return this.Uc.push(r),r}Wc(){this.qc&&xr()}verifyOperationInProgress(){}async Yc(){for(var e;await(e=this.$c),e!==this.$c;);}Xc(e){for(const t of this.Uc)if(t.timerId===e)return!0;return!1}Zc(t){return this.Yc().then(()=>{this.Uc.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.Uc)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Yc()})}ta(e){this.Qc.push(e)}Jc(e){var t=this.Uc.indexOf(e);this.Uc.splice(t,1)}}function ed(e){return function(e){if("object"==typeof e&&null!==e){var t=e;for(const e of["next","error","complete"])if(e in t&&"function"==typeof t[e])return 1}}(e)}class td{constructor(){this._progressObserver={},this._taskCompletionResolver=new Nr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var nd,rd,sd;class id extends Kl{constructor(e,t,n){super(e,t,n),this.type="firestore",this._queue=new Zl,this._persistenceKey="name"in e?e.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||od(this),this._firestoreClient.terminate()}}function ad(e){return e._firestoreClient||od(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function od(e){var t,n,r,s,i,a=e._freezeSettings(),a=(n=e._databaseId,r=(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",s=e._persistenceKey,i=a,new Ps(n,r,s,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,i.useFetchStreams));e._firestoreClient=new El(e._authCredentials,e._appCheckCredentials,e._queue,a)}function ud(e,n,r){const s=new Nr;return e.asyncQueue.enqueue(async()=>{try{await Tl(e,r),await Sl(e,n),s.resolve()}catch(e){const n=e;if(!("FirebaseError"===(t=n).name?t.code===Ar.FAILED_PRECONDITION||t.code===Ar.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)))throw n;Sr("Error enabling offline persistence. Falling back to persistence disabled: "+n),s.reject(n)}var t}).then(()=>s.promise)}function cd(e){return function(e){const t=new Nr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;vh(n.remoteStore)||Er("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=n.localStore;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}();if(-1===e)return void t.resolve();const r=n.hc.get(e)||[];r.push(t),n.hc.set(e,r)}catch(e){const n=Nh(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await Nl(e),t)),t.promise}(ad(e=ql(e,id)))}function hd(e){return(n=ad(e=ql(e,id))).asyncQueue.enqueue(async()=>{const e=await Dl(n),t=await Cl(n);return e.setNetworkEnabled(!0),function(){const e=t;return e._u.delete(0),hh(e)}()});var n}function ld(e){return(n=ad(e=ql(e,id))).asyncQueue.enqueue(async()=>{const e=await Dl(n),t=await Cl(n);return e.setNetworkEnabled(!1),async function(){const e=t;e._u.add(0),await lh(e),e.gu.set("Offline")}()});var n}function dd(t,e){return n=ad(t=ql(t,id)),r=e,n.asyncQueue.enqueue(async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Ns.getNamedQuery(e,t))}(await Al(n),r)).then(e=>e?new zl(t,null,e.query):null);var n,r}function fd(e){if(e._initialized||e._terminated)throw new Cr(Ar.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class gd{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new Cr(Ar.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Hr(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class md{constructor(e){this._byteString=e}static fromBase64String(e){try{return new md(ks.fromBase64String(e))}catch(e){throw new Cr(Ar.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new md(ks.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class pd{constructor(e){this._methodName=e}}class yd{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new Cr(Ar.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new Cr(Ar.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Ur(this._lat,e._lat)||Ur(this._long,e._long)}}const vd=/^__.*__$/;class wd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new ma(e,this.data,this.fieldMask,t,this.fieldTransforms):new ga(e,this.data,t,this.fieldTransforms)}}class Id{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new ma(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function bd(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw xr()}}class Ed{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.It=n,this.ignoreUndefinedProperties=r,void 0===s&&this.ea(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get na(){return this.settings.na}sa(e){return new Ed(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.It,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ia(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.sa({path:n,ra:!1});return r.oa(e),r}ua(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.sa({path:n,ra:!1});return r.ea(),r}ca(e){return this.sa({path:void 0,ra:!0})}aa(e){return Gd(e,this.settings.methodName,this.settings.ha||!1,this.path,this.settings.la)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}ea(){if(this.path)for(let e=0;e<this.path.length;e++)this.oa(this.path.get(e))}oa(e){if(0===e.length)throw this.aa("Document fields must not be empty");if(bd(this.na)&&vd.test(e))throw this.aa('Document fields cannot begin and end with "__"')}}class Td{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.It=n||nh(e)}fa(e,t,n,r=!1){return new Ed({na:e,methodName:t,la:n,path:Hr.emptyPath(),ra:!1,ha:r},this.databaseId,this.It,this.ignoreUndefinedProperties)}}function Sd(e){var t=e._freezeSettings(),n=nh(e._databaseId);return new Td(e._databaseId,!!t.ignoreUndefinedProperties,n)}function _d(e,t,n,r,s,i={}){const a=e.fa(i.merge||i.mergeFields?2:0,t,n,s);Pd("Data must be an object, but it was:",a,r);var o=Vd(r,a);let u,c;if(i.merge)u=new Ns(a.fieldMask),c=a.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=Bd(t,r,n);if(!a.contains(s))throw new Cr(Ar.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);jd(e,s)||e.push(s)}u=new Ns(e),c=a.fieldTransforms.filter(e=>u.covers(e.field))}else u=null,c=a.fieldTransforms;return new wd(new oi(o),u,c)}class xd extends pd{_toFieldTransform(e){if(2!==e.na)throw 1===e.na?e.aa(`${this._methodName}() can only appear at the top level of your update data`):e.aa(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof xd}}function Dd(e,t,n){return new Ed({na:3,la:t.settings.la,methodName:e._methodName,ra:n},t.databaseId,t.It,t.ignoreUndefinedProperties)}class Ad extends pd{_toFieldTransform(e){return new ia(e.path,new Xi)}isEqual(e){return e instanceof Ad}}class Cd extends pd{constructor(e,t){super(e),this.da=t}_toFieldTransform(e){const t=Dd(this,e,!0),n=this.da.map(e=>Md(e,t)),r=new Ji(n);return new ia(e.path,r)}isEqual(e){return this===e}}class Nd extends pd{constructor(e,t){super(e),this.da=t}_toFieldTransform(e){const t=Dd(this,e,!0),n=this.da.map(e=>Md(e,t)),r=new ea(n);return new ia(e.path,r)}isEqual(e){return this===e}}class kd extends pd{constructor(e,t){super(e),this._a=t}_toFieldTransform(e){var t=new na(e.It,Hi(e.It,this._a));return new ia(e.path,t)}isEqual(e){return this===e}}function Rd(e,s,i,t){const a=e.fa(1,s,i);Pd("Data must be an object, but it was:",a,t);const o=[],u=oi.empty();Es(t,(e,t)=>{var n=qd(s,e,i);t=m(t);var r=a.ua(n);if(t instanceof xd)o.push(n);else{const e=Md(t,r);null!=e&&(o.push(n),u.set(n,e))}});var n=new Ns(o);return new Id(u,n,a.fieldTransforms)}function Ld(e,t,n,r,s,i){const a=e.fa(1,t,n),o=[Bd(t,r,n)],u=[s];if(i.length%2!=0)throw new Cr(Ar.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<i.length;f+=2)o.push(Bd(t,i[f])),u.push(i[f+1]);const c=[],h=oi.empty();for(let g=o.length-1;0<=g;--g)if(!jd(c,o[g])){const t=o[g];var l=m(l=u[g]);const r=a.ua(t);if(l instanceof xd)c.push(t);else{const e=Md(l,r);null!=e&&(c.push(t),h.set(t,e))}}var d=new Ns(c);return new Id(h,d,a.fieldTransforms)}function Od(e,t,n,r=!1){return Md(n,e.fa(r?4:3,t))}function Md(i,e){if(Fd(i=m(i)))return Pd("Unsupported field value:",e,i),Vd(i,e);if(i instanceof pd)return function(e,t){if(!bd(t.na))throw t.aa(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.aa(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(i,e),null;if(void 0===i&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),i instanceof Array){if(e.settings.ra&&4!==e.na)throw e.aa("Nested arrays are not supported");return function(t){const n=[];let r=0;for(const s of i){let e=Md(s,t.ca(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e)}return function(e,t){if(null===(e=m(i)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Hi(t.It,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=jr.fromDate(e);return{timestampValue:Qa(t.It,n)}}if(e instanceof jr){n=new jr(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:Qa(t.It,n)}}if(e instanceof yd)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof md)return{bytesValue:za(t.It,e._byteString)};if(e instanceof Ql){const r=t.databaseId,s=e.firestore._databaseId;if(!s.isEqual(r))throw t.aa(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:Wa(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.aa(`Unsupported field value: ${Ul(e)}`)}(0,e)}function Vd(e,r){const s={};return Ts(e)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):Es(e,(e,t)=>{var n=Md(t,r.ia(e));null!=n&&(s[e]=n)}),{mapValue:{fields:s}}}function Fd(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof jr||e instanceof yd||e instanceof md||e instanceof Ql||e instanceof pd)}function Pd(e,t,n){if(!Fd(n)||("object"!=typeof(s=n)||null===s||Object.getPrototypeOf(s)!==Object.prototype&&null!==Object.getPrototypeOf(s))){var r=Ul(n);throw"an object"===r?t.aa(e+" a custom object"):t.aa(e+" "+r)}var s}function Bd(e,t,n){if((t=m(t))instanceof gd)return t._internalPath;if("string"==typeof t)return qd(e,t);throw Gd("Field path arguments must be of type string or ",e,!1,void 0,n)}const Ud=new RegExp("[~\\*/\\[\\]]");function qd(t,n,r){if(0<=n.search(Ud))throw Gd(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new gd(...n.split("."))._internalPath}catch(e){throw Gd(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function Gd(e,t,n,r,s){var i=r&&!r.isEmpty(),a=void 0!==s;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let u="";return(i||a)&&(u+=" (found",i&&(u+=` in field ${r}`),a&&(u+=` in document ${s}`),u+=")"),new Cr(Ar.INVALID_ARGUMENT,o+e+u)}function jd(e,t){return e.some(e=>e.isEqual(t))}class Kd{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Ql(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new $d(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field(Qd("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class $d extends Kd{data(){return super.data()}}function Qd(e,t){return"string"==typeof t?qd(e,t):(t instanceof gd?t:t._delegate)._internalPath}class zd{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Hd extends Kd{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new Wd(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field(Qd("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Wd extends Hd{data(e={}){return super.data(e)}}class Yd{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new zd(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new Wd(this._firestore,this._userDataWriter,e.key,e,new zd(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new Cr(Ar.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,t){if(i._snapshot.oldDocs.isEmpty()){let t=0;return i._snapshot.docChanges.map(e=>({type:"added",doc:new Wd(i._firestore,i._userDataWriter,e.doc.key,e.doc,new zd(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter),oldIndex:-1,newIndex:t++}))}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new Wd(i._firestore,i._userDataWriter,e.doc.key,e.doc,new zd(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=s.indexOf(e.doc.key),s=s.delete(e.doc.key)),1!==e.type&&(s=s.add(e.doc),r=s.indexOf(e.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return xr()}}(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Xd(e,t){return e instanceof Hd&&t instanceof Hd?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Yd&&t instanceof Yd&&e._firestore===t._firestore&&Jl(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function Jd(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new Cr(Ar.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Zd{}function ef(e,...t){for(const n of t)e=n._apply(e);return e}class tf extends Zd{constructor(e,t,n){super(),this.wa=e,this.ma=t,this.ga=n,this.type="where"}_apply(e){var t=Sd(e.firestore),t=function(e,t,n,r,s,i,a){let o;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Cr(Ar.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){cf(a,i);const t=[];for(const n of a)t.push(uf(r,e,n));o={arrayValue:{values:t}}}else o=uf(r,e,a)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||cf(a,i),o=Od(n,t,a,"in"===i||"not-in"===i);var u=yi.create(s,i,o);return function(e,t){if(t.dt()){const r=Mi(e);if(null!==r&&!r.isEqual(t.field))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${t.field.toString()}'`);var n=Oi(e);null!==n&&hf(0,t.field,n)}const r=function(e,t){for(const n of e.filters)if(0<=t.indexOf(n.op))return n.op;return null}(e,function(){switch(t.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===t.op?new Cr(Ar.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new Cr(Ar.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}(e,u),u}(e._query,"where",t,e.firestore._databaseId,this.wa,this.ma,this.ga);return new zl(e.firestore,e.converter,(e=e._query,t=e.filters.concat([t]),new Ni(e.path,e.collectionGroup,e.explicitOrderBy.slice(),t,e.limit,e.limitType,e.startAt,e.endAt)))}}class nf extends Zd{constructor(e,t){super(),this.wa=e,this.ya=t,this.type="orderBy"}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new Cr(Ar.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new Cr(Ar.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r,s=new Di(t,n);return n=s,null!==Oi(e=e)||null!==(r=Mi(e))&&hf(0,r,n.field),s}(e._query,this.wa,this.ya);return new zl(e.firestore,e.converter,(e=e._query,t=e.explicitOrderBy.concat([t]),new Ni(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class rf extends Zd{constructor(e,t,n){super(),this.type=e,this.pa=t,this.Ia=n}_apply(e){return new zl(e.firestore,e.converter,Bi(e._query,this.pa,this.Ia))}}class sf extends Zd{constructor(e,t,n){super(),this.type=e,this.Ta=t,this.Ea=n}_apply(e){var t,n=of(e,this.type,this.Ta,this.Ea);return new zl(e.firestore,e.converter,(t=e._query,e=n,new Ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class af extends Zd{constructor(e,t,n){super(),this.type=e,this.Ta=t,this.Ea=n}_apply(e){var t,n=of(e,this.type,this.Ta,this.Ea);return new zl(e.firestore,e.converter,(t=e._query,e=n,new Ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function of(e,t,n,r){if(n[0]=m(n[0]),n[0]instanceof Kd)return function(e,t,n,r,s){if(!r)throw new Cr(Ar.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Fi(e))if(n.field.isKeyField())i.push(Xs(t,r.key));else{const e=r.data.field(n.field);if(Vs(e))throw new Cr(Ar.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new xi(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var s=Sd(e.firestore);return function(e,t,n,r,s,i){const a=e.explicitOrderBy;if(s.length>a.length)throw new Cr(Ar.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const o=[];for(let u=0;u<s.length;u++){const c=s[u];if(a[u].field.isKeyField()){if("string"!=typeof c)throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!Vi(e)&&-1!==c.indexOf("/"))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(Qr.fromString(c));if(!Wr.isDocumentKey(n))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new Wr(n);o.push(Xs(t,s))}else{const e=Od(n,r,c);o.push(e)}}return new xi(o,i)}(e._query,e.firestore._databaseId,s,t,n,r)}function uf(e,t,n){if("string"==typeof(n=m(n))){if(""===n)throw new Cr(Ar.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Vi(t)&&-1!==n.indexOf("/"))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(Qr.fromString(n));if(!Wr.isDocumentKey(r))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Xs(e,new Wr(r))}if(n instanceof Ql)return Xs(e,n._key);throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Ul(n)}.`)}function cf(e,t){if(!Array.isArray(e)||0===e.length)throw new Cr(Ar.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(10<e.length)throw new Cr(Ar.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function hf(e,t,n){if(!n.isEqual(t))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}const lf={maxAttempts:5};class df{convertValue(e,t="none"){switch($s(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Os(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ms(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw xr()}}convertObject(e,n){const r={};return Es(e.fields,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new yd(Os(e.latitude),Os(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=function e(t){var n=t.mapValue.fields.__previous_value__;return Vs(n)?e(n):n}(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Fs(e));default:return null}}convertTimestamp(e){var t=Ls(e);return new jr(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=Qr.fromString(e);Dr(mo(n));const r=new Bs(n.get(1),n.get(3)),s=new Wr(n.popFirst(5));return r.isEqual(t)||Tr(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function ff(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class gf extends df{constructor(e){super(),this.firestore=e}convertBytes(e){return new md(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Ql(this.firestore,null,t)}}class mf{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Sd(e)}set(e,t,n){this._verifyNotCommitted();const r=pf(e,this._firestore),s=ff(r.converter,t,n),i=_d(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,oa.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var s=pf(e,this._firestore);let i;return i="string"==typeof(t=m(t))||t instanceof gd?Ld(this._dataReader,"WriteBatch.update",s._key,t,n,r):Rd(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,oa.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=pf(e,this._firestore);return this._mutations=this._mutations.concat(new wa(t._key,oa.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Cr(Ar.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function pf(e,t){if((e=m(e)).firestore!==t)throw new Cr(Ar.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class yf extends df{constructor(e){super(),this.firestore=e}convertBytes(e){return new md(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Ql(this.firestore,null,t)}}function vf(t){t=ql(t,Ql);const n=ql(t.firestore,id),e=ad(n),r=new yf(n);return function(e,t){const n=new Nr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(t);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Cr(Ar.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=Nh(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Al(e),t,n)),n.promise}(e,t._key).then(e=>new Hd(n,r,t._key,e,new zd(null!==e&&e.hasLocalMutations,!0),t.converter))}function wf(t){t=ql(t,zl);const n=ql(t.firestore,id),e=ad(n),r=new yf(n);return function(e,t){const n=new Nr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await Mc(e,t,!0),i=new Qh(t,s.Hi),a=i.ju(s.documents),o=i.applyChanges(a,!1);n.resolve(o.snapshot)}catch(e){var r=Nh(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Al(e),t,n)),n.promise}(e,t._query).then(e=>new Yd(n,r,t,e))}function If(e,t,n){e=ql(e,Ql);var r=ql(e.firestore,id),s=ff(e.converter,t,n);return Sf(r,[_d(Sd(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,oa.none())])}function bf(e,t,n,...r){e=ql(e,Ql);var s=ql(e.firestore,id),i=Sd(s);let a;return a="string"==typeof(t=m(t))||t instanceof gd?Ld(i,"updateDoc",e._key,t,n,r):Rd(i,"updateDoc",e._key,t),Sf(s,[a.toMutation(e._key,oa.exists(!0))])}function Ef(t,...n){var e;t=m(t);let r={includeMetadataChanges:!1},s=0;"object"!=typeof n[s]||ed(n[s])||(r=n[s],s++);var i={includeMetadataChanges:r.includeMetadataChanges};if(ed(n[s])){const t=n[s];n[s]=null===(e=t.next)||void 0===e?void 0:e.bind(t),n[s+1]=null===(e=t.error)||void 0===e?void 0:e.bind(t),n[s+2]=null===(e=t.complete)||void 0===e?void 0:e.bind(t)}let a,o,u;if(t instanceof Ql)o=ql(t.firestore,id),u=Ri(t._key.path),a={next:e=>{n[s]&&n[s](_f(o,t,e))},error:n[s+1],complete:n[s+2]};else{const c=ql(t,zl);o=ql(c.firestore,id),u=c._query;const h=new yf(o);a={next:e=>{n[s]&&n[s](new Yd(o,h,c,e))},error:n[s+1],complete:n[s+2]},Jd(t._query)}return function(e,t,n,r){const s=new vl(r),i=new Bh(t,s,n);return e.asyncQueue.enqueueAndForget(async()=>Vh(await kl(e),i)),()=>{s.Rc(),e.asyncQueue.enqueueAndForget(async()=>Fh(await kl(e),i))}}(ad(o),u,i,a)}function Tf(e,t){return function(e,t){const n=new vl(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.Ru.add(t),t.next()}(await kl(e),n)),()=>{n.Rc(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.Ru.delete(t)}(await kl(e),n))}}(ad(e=ql(e,id)),ed(t)?t:{next:t})}function Sf(e,t){return function(e,t){const n=new Nr;return e.asyncQueue.enqueueAndForget(async()=>Xh(await Nl(e),t,n)),n.promise}(ad(e),t)}function _f(e,t,n){var r=n.docs.get(t._key),s=new yf(e);return new Hd(e,s,t._key,r,new zd(n.hasPendingWrites,n.fromCache),t.converter)}class xf extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=Sd(e)}get(e){const n=pf(e,this._firestore),r=new gf(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return xr();const t=e[0];if(t.isFoundDocument())return new Kd(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new Kd(this._firestore,r,n._key,null,n.converter);throw xr()})}set(e,t,n){var r=pf(e,this._firestore),s=ff(r.converter,t,n),s=_d(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){var s=pf(e,this._firestore),i="string"==typeof(t=m(t))||t instanceof gd?Ld(this._dataReader,"Transaction.update",s._key,t,n,r):Rd(this._dataReader,"Transaction.update",s._key,t);return this._transaction.update(s._key,i),this}delete(e){var t=pf(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=pf(e,this._firestore),n=new yf(this._firestore);return super.get(e).then(e=>new Hd(this._firestore,n,t._key,e._document,new zd(!1,!1),t.converter))}}function Df(t,n,e){t=ql(t,id);var r=Object.assign(Object.assign({},lf),e);return function(){if(r.maxAttempts<1)throw new Cr(Ar.INVALID_ARGUMENT,"Max attempts must be at least 1")}(),function(t,n,r){const s=new Nr;return t.asyncQueue.enqueueAndForget(async()=>{var e=await xl(t).then(e=>e.datastore);new bl(t.asyncQueue,e,r,n,s).run()}),s.promise}(ad(t),e=>n(new xf(t,e)),r)}nd=eg.SDK_VERSION,wr=nd,eg._registerComponent(new c("firestore",(e,{options:t})=>{const n=e.getProvider("app").getImmediate(),r=new id(n,new Or(e.getProvider("auth-internal")),new Pr(e.getProvider("app-check-internal")));return t=Object.assign({useFetchStreams:!0},t),r._setSettings(t),r},"PUBLIC")),eg.registerVersion(yr,"3.4.14",void 0),eg.registerVersion(yr,"3.4.14","esm2017");function Af(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new Cr("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function Cf(){if("undefined"==typeof Uint8Array)throw new Cr("unimplemented","Uint8Arrays are not available in this environment.")}function Nf(){if("undefined"==typeof atob)throw new Cr("unimplemented","Blobs are unavailable in Firestore in this environment.")}class kf{constructor(e){this._delegate=e}static fromBase64String(e){return Nf(),new kf(md.fromBase64String(e))}static fromUint8Array(e){return Cf(),new kf(md.fromUint8Array(e))}toBase64(){return Nf(),this._delegate.toBase64()}toUint8Array(){return Cf(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Rf(e){return function(e,t){if("object"!=typeof e||null===e)return;var n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return 1;return}(e,["next","error","complete"])}class Lf{enableIndexedDbPersistence(e,t){return function(e,t){fd(e=ql(e,id));var n=ad(e),r=e._freezeSettings(),s=new pl;return ud(n,s,new gl(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){fd(e=ql(e,id));var t=ad(e),n=e._freezeSettings(),r=new pl;return ud(t,r,new ml(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new Cr(Ar.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new Nr;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!hs.C())return Promise.resolve();var t=e+"main";await hs.delete(t)}(Sc(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}(e._delegate)}}class Of{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof Bs||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Sr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){$l(this._delegate,e,t,n)}enableNetwork(){return hd(this._delegate)}disableNetwork(){return ld(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,Fl("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return cd(this._delegate)}onSnapshotsInSync(e){return Tf(this._delegate,e)}get app(){if(!this._appCompat)throw new Cr("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new Hf(this,Wl(this._delegate,e))}catch(e){throw Uf(e,"collection()","Firestore.collection()")}}doc(e){try{return new Bf(this,Yl(this._delegate,e))}catch(e){throw Uf(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new $f(this,function(e,t){if(e=ql(e,Kl),Vl("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new zl(e,null,(t=t,new Ni(Qr.emptyPath(),t)))}(this._delegate,e))}catch(e){throw Uf(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Df(this._delegate,e=>t(new Vf(this,e)))}batch(){return ad(this._delegate),new Ff(new mf(this._delegate,e=>Sf(this._delegate,e)))}loadBundle(e){return t=this._delegate,e=e,n=ad(t=ql(t,id)),r=new td,Ol(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return dd(this._delegate,e).then(e=>e?new $f(this,e):null)}}class Mf extends df{constructor(e){super(),this.firestore=e}convertBytes(e){return new kf(new md(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return Bf.forKey(t,this.firestore,null)}}class Vf{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Mf(e)}get(e){const t=Wf(e);return this._delegate.get(t).then(e=>new jf(this._firestore,new Hd(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){var r=Wf(e);return n?(Af("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=Wf(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=Wf(e);return this._delegate.delete(t),this}}class Ff{constructor(e){this._delegate=e}set(e,t,n){var r=Wf(e);return n?(Af("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=Wf(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=Wf(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class Pf{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new Wd(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new Kf(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=Pf.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let s=r.get(t);return s||(s=new Pf(e,new Mf(e),t),r.set(t,s)),s}}Pf.INSTANCES=new WeakMap;class Bf{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Mf(e)}static forPath(e,t,n){if(e.length%2!=0)throw new Cr("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${e.canonicalString()} has ${e.length}`);return new Bf(t,new Ql(t._delegate,n,new Wr(e)))}static forKey(e,t,n){return new Bf(t,new Ql(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new Hf(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new Hf(this.firestore,Wl(this._delegate,e))}catch(e){throw Uf(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=m(e))instanceof Ql&&Xl(this._delegate,e)}set(e,t){t=Af("DocumentReference.set",t);try{return t?If(this._delegate,e,t):If(this._delegate,e)}catch(e){throw Uf(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?bf(this._delegate,e):bf(this._delegate,e,t,...n)}catch(e){throw Uf(e,"updateDoc()","DocumentReference.update()")}}delete(){return Sf(ql((e=this._delegate).firestore,id),[new wa(e._key,oa.none())]);var e}onSnapshot(...e){var t=qf(e),n=Gf(e,e=>new jf(this.firestore,new Hd(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return Ef(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?vf:"server"===(null==e?void 0:e.source)?function(t){t=ql(t,Ql);const n=ql(t.firestore,id);return Rl(ad(n),t._key,{source:"server"}).then(e=>_f(n,t,e))}:function(t){t=ql(t,Ql);const n=ql(t.firestore,id);return Rl(ad(n),t._key).then(e=>_f(n,t,e))})(this._delegate),t.then(e=>new jf(this.firestore,new Hd(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new Bf(this.firestore,e?this._delegate.withConverter(Pf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Uf(e,t,n){return e.message=e.message.replace(t,n),e}function qf(e){for(const t of e)if("object"==typeof t&&!Rf(t))return t;return{}}function Gf(e,t){var n;let r;return r=Rf(e[0])?e[0]:Rf(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class jf{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new Bf(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Xd(this._delegate,e._delegate)}}class Kf extends jf{data(e){var t=this._delegate.data(e);return void 0!==t||xr(),t}}class $f{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Mf(e)}where(e,t,n){try{return new $f(this.firestore,ef(this._delegate,(r=n,s=t,i=Qd("where",e),new tf(i,s,r))))}catch(e){throw Uf(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(e,t){try{return new $f(this.firestore,ef(this._delegate,([n,r="asc"]=[e,t],s=r,i=Qd("orderBy",n),new nf(i,s))))}catch(e){throw Uf(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,s,i}limit(e){try{return new $f(this.firestore,ef(this._delegate,(Gl("limit",t=e),new rf("limit",t,"F"))))}catch(e){throw Uf(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new $f(this.firestore,ef(this._delegate,(Gl("limitToLast",t=e),new rf("limitToLast",t,"L"))))}catch(e){throw Uf(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new $f(this.firestore,ef(this._delegate,function(...e){return new sf("startAt",e,!0)}(...e)))}catch(e){throw Uf(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new $f(this.firestore,ef(this._delegate,function(...e){return new sf("startAfter",e,!1)}(...e)))}catch(e){throw Uf(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new $f(this.firestore,ef(this._delegate,function(...e){return new af("endBefore",e,!1)}(...e)))}catch(e){throw Uf(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new $f(this.firestore,ef(this._delegate,function(...e){return new af("endAt",e,!0)}(...e)))}catch(e){throw Uf(e,"endAt()","Query.endAt()")}}isEqual(e){return Jl(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?wf:"server"===(null==e?void 0:e.source)?function(t){t=ql(t,zl);const n=ql(t.firestore,id),e=ad(n),r=new yf(n);return Ll(e,t._query,{source:"server"}).then(e=>new Yd(n,r,t,e))}:function(t){t=ql(t,zl);const n=ql(t.firestore,id),e=ad(n),r=new yf(n);return Jd(t._query),Ll(e,t._query).then(e=>new Yd(n,r,t,e))})(this._delegate),t.then(e=>new zf(this.firestore,new Yd(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=qf(e),n=Gf(e,e=>new zf(this.firestore,new Yd(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return Ef(this._delegate,t,n)}withConverter(e){return new $f(this.firestore,e?this._delegate.withConverter(Pf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class Qf{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new Kf(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class zf{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new $f(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new Kf(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new Qf(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new Kf(this._firestore,e))})}isEqual(e){return Xd(this._delegate,e._delegate)}}class Hf extends $f{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new Bf(this.firestore,e):null}doc(e){try{return void 0===e?new Bf(this.firestore,Yl(this._delegate)):new Bf(this.firestore,Yl(this._delegate,e))}catch(e){throw Uf(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=ql(e.firestore,id),r=Yl(e),s=ff(e.converter,t);return Sf(n,[_d(Sd(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,oa.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new Bf(this.firestore,e))}isEqual(e){return Xl(this._delegate,e._delegate)}withConverter(e){return new Hf(this.firestore,e?this._delegate.withConverter(Pf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Wf(e){return ql(e,Ql)}const Yf={Firestore:Of,GeoPoint:yd,Timestamp:jr,Blob:kf,Transaction:Vf,WriteBatch:Ff,DocumentReference:Bf,DocumentSnapshot:jf,Query:$f,QueryDocumentSnapshot:Kf,QuerySnapshot:zf,CollectionReference:Hf,FieldPath:class Xf{constructor(...e){this._delegate=new gd(...e)}static documentId(){return new Xf(Hr.keyField().canonicalString())}isEqual(e){return(e=m(e))instanceof gd&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class Jf{constructor(e){this._delegate=e}static serverTimestamp(){const e=new Ad("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new Jf(e)}static delete(){const e=new xd("deleteField");return e._methodName="FieldValue.delete",new Jf(e)}static arrayUnion(...e){const t=function(...e){return new Cd("arrayUnion",e)}(...e);return t._methodName="FieldValue.arrayUnion",new Jf(t)}static arrayRemove(...e){const t=function(...e){return new Nd("arrayRemove",e)}(...e);return t._methodName="FieldValue.arrayRemove",new Jf(t)}static increment(e){const t=new kd("increment",e);return t._methodName="FieldValue.increment",new Jf(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){e=e,Ir.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};rd=t.default,sd=(e,t)=>new Of(e,t,new Lf),rd.INTERNAL.registerComponent(new c("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return sd(t,n)},"PUBLIC").setServiceProps(Object.assign({},Yf))),rd.registerVersion("@firebase/firestore-compat","0.1.23")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore-compat.js.map
