import{_registerComponent as t,registerVersion as e,_getProvider as n,getApp as s,_removeServiceInstance as r,SDK_VERSION as i}from"https://www.gstatic.com/firebasejs/9.9.3/firebase-app.js";const o=function(t){const e=[];let n=0;for(let s=0;s<t.length;s++){let r=t.charCodeAt(s);r<128?e[n++]=r:r<2048?(e[n++]=r>>6|192,e[n++]=63&r|128):55296==(64512&r)&&s+1<t.length&&56320==(64512&t.charCodeAt(s+1))?(r=65536+((1023&r)<<10)+(1023&t.charCodeAt(++s)),e[n++]=r>>18|240,e[n++]=r>>12&63|128,e[n++]=r>>6&63|128,e[n++]=63&r|128):(e[n++]=r>>12|224,e[n++]=r>>6&63|128,e[n++]=63&r|128)}return e},a={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(t,e){if(!Array.isArray(t))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let e=0;e<t.length;e+=3){const r=t[e],i=e+1<t.length,o=i?t[e+1]:0,a=e+2<t.length,u=a?t[e+2]:0,c=r>>2,h=(3&r)<<4|o>>4;let l=(15&o)<<2|u>>6,d=63&u;a||(d=64,i||(l=64)),s.push(n[c],n[h],n[l],n[d])}return s.join("")},encodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(o(t),e)},decodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):function(t){const e=[];let n=0,s=0;for(;n<t.length;){const r=t[n++];if(r<128)e[s++]=String.fromCharCode(r);else if(r>191&&r<224){const i=t[n++];e[s++]=String.fromCharCode((31&r)<<6|63&i)}else if(r>239&&r<365){const i=((7&r)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++])-65536;e[s++]=String.fromCharCode(55296+(i>>10)),e[s++]=String.fromCharCode(56320+(1023&i))}else{const i=t[n++],o=t[n++];e[s++]=String.fromCharCode((15&r)<<12|(63&i)<<6|63&o)}}return e.join("")}(this.decodeStringToByteArray(t,e))},decodeStringToByteArray(t,e){this.init_();const n=e?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let e=0;e<t.length;){const r=n[t.charAt(e++)],i=e<t.length?n[t.charAt(e)]:0;++e;const o=e<t.length?n[t.charAt(e)]:64;++e;const a=e<t.length?n[t.charAt(e)]:64;if(++e,null==r||null==i||null==o||null==a)throw Error();const u=r<<2|i>>4;if(s.push(u),64!==o){const t=i<<4&240|o>>2;if(s.push(t),64!==a){const t=o<<6&192|a;s.push(t)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}},u=function(t){return function(t){const e=o(t);return a.encodeByteArray(e,!0)}(t).replace(/\./g,"")};function c(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){return!function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(t){return!1}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class l extends Error{constructor(t,e,n){super(e),this.code=t,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,l.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,d.prototype.create)}}class d{constructor(t,e,n){this.service=t,this.serviceName=e,this.errors=n}create(t,...e){const n=e[0]||{},s=`${this.service}/${t}`,r=this.errors[t],i=r?function(t,e){return t.replace(f,((t,n)=>{const s=e[n];return null!=s?String(s):`<${n}?>`}))}(r,n):"Error",o=`${this.serviceName}: ${i} (${s}).`;return new l(s,o,n)}}const f=/\{\$([^}]+)}/g;function m(t,e){if(t===e)return!0;const n=Object.keys(t),s=Object.keys(e);for(const r of n){if(!s.includes(r))return!1;const n=t[r],i=e[r];if(g(n)&&g(i)){if(!m(n,i))return!1}else if(n!==i)return!1}for(const t of s)if(!n.includes(t))return!1;return!0}function g(t){return null!==t&&"object"==typeof t}function p(t){return t&&t._delegate?t._delegate:t}class y{constructor(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}var w;!function(t){t[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT"}(w||(w={}));const v={debug:w.DEBUG,verbose:w.VERBOSE,info:w.INFO,warn:w.WARN,error:w.ERROR,silent:w.SILENT},I=w.INFO,b={[w.DEBUG]:"log",[w.VERBOSE]:"log",[w.INFO]:"info",[w.WARN]:"warn",[w.ERROR]:"error"},E=(t,e,...n)=>{if(e<t.logLevel)return;const s=(new Date).toISOString(),r=b[e];if(!r)throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`);console[r](`[${s}]  ${t.name}:`,...n)};var T,S="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},x=x||{},D=S||self;function _(){}function A(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function C(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var N="closure_uid_"+(1e9*Math.random()>>>0),k=0;function R(t,e,n){return t.call.apply(t.bind,arguments)}function L(t,e,n){if(!t)throw Error();if(2<arguments.length){var s=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,s),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function M(t,e,n){return(M=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?R:L).apply(null,arguments)}function O(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function V(t,e){function n(){}n.prototype=e.prototype,t.Z=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.Vb=function(t,n,s){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.prototype[n].apply(t,r)}}function F(){this.s=this.s,this.o=this.o}var P={};F.prototype.s=!1,F.prototype.na=function(){if(!this.s&&(this.s=!0,this.M(),0)){var t=function(t){return Object.prototype.hasOwnProperty.call(t,N)&&t[N]||(t[N]=++k)}(this);delete P[t]}},F.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const B=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},U=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){const s=t.length,r="string"==typeof t?t.split(""):t;for(let i=0;i<s;i++)i in r&&e.call(n,r[i],i,t)};function q(t){return Array.prototype.concat.apply([],arguments)}function G(t){const e=t.length;if(0<e){const n=Array(e);for(let s=0;s<e;s++)n[s]=t[s];return n}return[]}function K(t){return/^[\s\xa0]*$/.test(t)}var j,$=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function z(t,e){return-1!=t.indexOf(e)}function Q(t,e){return t<e?-1:t>e?1:0}t:{var H=D.navigator;if(H){var W=H.userAgent;if(W){j=W;break t}}j=""}function Y(t,e,n){for(const s in t)e.call(n,t[s],s,t)}function X(t){const e={};for(const n in t)e[n]=t[n];return e}var J="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Z(t,e){let n,s;for(let e=1;e<arguments.length;e++){for(n in s=arguments[e],s)t[n]=s[n];for(let e=0;e<J.length;e++)n=J[e],Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])}}function tt(t){return tt[" "](t),t}tt[" "]=_;var et,nt,st=z(j,"Opera"),rt=z(j,"Trident")||z(j,"MSIE"),it=z(j,"Edge"),ot=it||rt,at=z(j,"Gecko")&&!(z(j.toLowerCase(),"webkit")&&!z(j,"Edge"))&&!(z(j,"Trident")||z(j,"MSIE"))&&!z(j,"Edge"),ut=z(j.toLowerCase(),"webkit")&&!z(j,"Edge");function ct(){var t=D.document;return t?t.documentMode:void 0}t:{var ht="",lt=(nt=j,at?/rv:([^\);]+)(\)|;)/.exec(nt):it?/Edge\/([\d\.]+)/.exec(nt):rt?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(nt):ut?/WebKit\/(\S+)/.exec(nt):st?/(?:Version)[ \/]?(\S+)/.exec(nt):void 0);if(lt&&(ht=lt?lt[1]:""),rt){var dt=ct();if(null!=dt&&dt>parseFloat(ht)){et=String(dt);break t}}et=ht}var ft,mt={};function gt(){return function(t){var e=mt;return Object.prototype.hasOwnProperty.call(e,9)?e[9]:e[9]=t(9)}((function(){let t=0;const e=$(String(et)).split("."),n=$("9").split("."),s=Math.max(e.length,n.length);for(let o=0;0==t&&o<s;o++){var r=e[o]||"",i=n[o]||"";do{if(r=/(\d*)(\D*)(.*)/.exec(r)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],0==r[0].length&&0==i[0].length)break;t=Q(0==r[1].length?0:parseInt(r[1],10),0==i[1].length?0:parseInt(i[1],10))||Q(0==r[2].length,0==i[2].length)||Q(r[2],i[2]),r=r[3],i=i[3]}while(0==t)}return 0<=t}))}if(D.document&&rt){var pt=ct();ft=pt||(parseInt(et,10)||void 0)}else ft=void 0;var yt=ft,wt=function(){if(!D.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{D.addEventListener("test",_,e),D.removeEventListener("test",_,e)}catch(t){}return t}();function vt(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}function It(t,e){if(vt.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,s=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(at){t:{try{tt(e.nodeName);var r=!0;break t}catch(t){}r=!1}r||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,s?(this.clientX=void 0!==s.clientX?s.clientX:s.pageX,this.clientY=void 0!==s.clientY?s.clientY:s.pageY,this.screenX=s.screenX||0,this.screenY=s.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:bt[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&It.Z.h.call(this)}}vt.prototype.h=function(){this.defaultPrevented=!0},V(It,vt);var bt={2:"touch",3:"pen",4:"mouse"};It.prototype.h=function(){It.Z.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var Et="closure_listenable_"+(1e6*Math.random()|0),Tt=0;function St(t,e,n,s,r){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!s,this.ia=r,this.key=++Tt,this.ca=this.fa=!1}function xt(t){t.ca=!0,t.listener=null,t.proxy=null,t.src=null,t.ia=null}function Dt(t){this.src=t,this.g={},this.h=0}function _t(t,e){var n=e.type;if(n in t.g){var s,r=t.g[n],i=B(r,e);(s=0<=i)&&Array.prototype.splice.call(r,i,1),s&&(xt(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function At(t,e,n,s){for(var r=0;r<t.length;++r){var i=t[r];if(!i.ca&&i.listener==e&&i.capture==!!n&&i.ia==s)return r}return-1}Dt.prototype.add=function(t,e,n,s,r){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=At(t,e,s,r);return-1<o?(e=t[o],n||(e.fa=!1)):((e=new St(e,this.src,i,!!s,r)).fa=n,t.push(e)),e};var Ct="closure_lm_"+(1e6*Math.random()|0),Nt={};function kt(t,e,n,s,r){if(s&&s.once)return Lt(t,e,n,s,r);if(Array.isArray(e)){for(var i=0;i<e.length;i++)kt(t,e[i],n,s,r);return null}return n=Ut(n),t&&t[Et]?t.N(e,n,C(s)?!!s.capture:!!s,r):Rt(t,e,n,!1,s,r)}function Rt(t,e,n,s,r,i){if(!e)throw Error("Invalid event type");var o=C(r)?!!r.capture:!!r,a=Pt(t);if(a||(t[Ct]=a=new Dt(t)),(n=a.add(e,n,s,o,i)).proxy)return n;if(s=function(){function t(n){return e.call(t.src,t.listener,n)}var e=Ft;return t}(),n.proxy=s,s.src=t,s.listener=n,t.addEventListener)wt||(r=o),void 0===r&&(r=!1),t.addEventListener(e.toString(),s,r);else if(t.attachEvent)t.attachEvent(Vt(e.toString()),s);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(s)}return n}function Lt(t,e,n,s,r){if(Array.isArray(e)){for(var i=0;i<e.length;i++)Lt(t,e[i],n,s,r);return null}return n=Ut(n),t&&t[Et]?t.O(e,n,C(s)?!!s.capture:!!s,r):Rt(t,e,n,!0,s,r)}function Mt(t,e,n,s,r){if(Array.isArray(e))for(var i=0;i<e.length;i++)Mt(t,e[i],n,s,r);else s=C(s)?!!s.capture:!!s,n=Ut(n),t&&t[Et]?(t=t.i,(e=String(e).toString())in t.g&&(-1<(n=At(i=t.g[e],n,s,r))&&(xt(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--)))):t&&(t=Pt(t))&&(e=t.g[e.toString()],t=-1,e&&(t=At(e,n,s,r)),(n=-1<t?e[t]:null)&&Ot(n))}function Ot(t){if("number"!=typeof t&&t&&!t.ca){var e=t.src;if(e&&e[Et])_t(e.i,t);else{var n=t.type,s=t.proxy;e.removeEventListener?e.removeEventListener(n,s,t.capture):e.detachEvent?e.detachEvent(Vt(n),s):e.addListener&&e.removeListener&&e.removeListener(s),(n=Pt(e))?(_t(n,t),0==n.h&&(n.src=null,e[Ct]=null)):xt(t)}}}function Vt(t){return t in Nt?Nt[t]:Nt[t]="on"+t}function Ft(t,e){if(t.ca)t=!0;else{e=new It(e,this);var n=t.listener,s=t.ia||t.src;t.fa&&Ot(t),t=n.call(s,e)}return t}function Pt(t){return(t=t[Ct])instanceof Dt?t:null}var Bt="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ut(t){return"function"==typeof t?t:(t[Bt]||(t[Bt]=function(e){return t.handleEvent(e)}),t[Bt])}function qt(){F.call(this),this.i=new Dt(this),this.P=this,this.I=null}function Gt(t,e){var n,s=t.I;if(s)for(n=[];s;s=s.I)n.push(s);if(t=t.P,s=e.type||e,"string"==typeof e)e=new vt(e,t);else if(e instanceof vt)e.target=e.target||t;else{var r=e;Z(e=new vt(s,t),r)}if(r=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];r=Kt(o,s,!0,e)&&r}if(r=Kt(o=e.g=t,s,!0,e)&&r,r=Kt(o,s,!1,e)&&r,n)for(i=0;i<n.length;i++)r=Kt(o=e.g=n[i],s,!1,e)&&r}function Kt(t,e,n,s){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var r=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.ca&&o.capture==n){var a=o.listener,u=o.ia||o.src;o.fa&&_t(t.i,o),r=!1!==a.call(u,s)&&r}}return r&&!s.defaultPrevented}V(qt,F),qt.prototype[Et]=!0,qt.prototype.removeEventListener=function(t,e,n,s){Mt(this,t,e,n,s)},qt.prototype.M=function(){if(qt.Z.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],s=0;s<n.length;s++)xt(n[s]);delete e.g[t],e.h--}}this.I=null},qt.prototype.N=function(t,e,n,s){return this.i.add(String(t),e,!1,n,s)},qt.prototype.O=function(t,e,n,s){return this.i.add(String(t),e,!0,n,s)};var jt=D.JSON.stringify;function $t(){var t=Jt;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var zt,Qt=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new Ht),(t=>t.reset()));class Ht{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Wt(t){D.setTimeout((()=>{throw t}),0)}function Yt(t,e){zt||function(){var t=D.Promise.resolve(void 0);zt=function(){t.then(Zt)}}(),Xt||(zt(),Xt=!0),Jt.add(t,e)}var Xt=!1,Jt=new class{constructor(){this.h=this.g=null}add(t,e){const n=Qt.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}};function Zt(){for(var t;t=$t();){try{t.h.call(t.g)}catch(t){Wt(t)}var e=Qt;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}Xt=!1}function te(t,e){qt.call(this),this.h=t||1,this.g=e||D,this.j=M(this.kb,this),this.l=Date.now()}function ee(t){t.da=!1,t.S&&(t.g.clearTimeout(t.S),t.S=null)}function ne(t,e,n){if("function"==typeof t)n&&(t=M(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=M(t.handleEvent,t)}return 2147483647<Number(e)?-1:D.setTimeout(t,e||0)}function se(t){t.g=ne((()=>{t.g=null,t.i&&(t.i=!1,se(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}V(te,qt),(T=te.prototype).da=!1,T.S=null,T.kb=function(){if(this.da){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-t):(this.S&&(this.g.clearTimeout(this.S),this.S=null),Gt(this,"tick"),this.da&&(ee(this),this.start()))}},T.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},T.M=function(){te.Z.M.call(this),ee(this),delete this.g};class re extends F{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:se(this)}M(){super.M(),this.g&&(D.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ie(t){F.call(this),this.h=t,this.g={}}V(ie,F);var oe=[];function ae(t,e,n,s){Array.isArray(n)||(n&&(oe[0]=n.toString()),n=oe);for(var r=0;r<n.length;r++){var i=kt(e,n[r],s||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function ue(t){Y(t.g,(function(t,e){this.g.hasOwnProperty(e)&&Ot(t)}),t),t.g={}}function ce(){this.g=!0}function he(t,e,n,s){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var s=n[t];if(!(2>s.length)){var r=s[1];if(Array.isArray(r)&&!(1>r.length)){var i=r[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<r.length;o++)r[o]=""}}}return jt(n)}catch(t){return e}}(t,n)+(s?" "+s:"")}))}ie.prototype.M=function(){ie.Z.M.call(this),ue(this)},ie.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ce.prototype.Aa=function(){this.g=!1},ce.prototype.info=function(){};var le={},de=null;function fe(){return de=de||new qt}function me(t){vt.call(this,le.Ma,t)}function ge(t){const e=fe();Gt(e,new me(e,t))}function pe(t,e){vt.call(this,le.STAT_EVENT,t),this.stat=e}function ye(t){const e=fe();Gt(e,new pe(e,t))}function we(t,e){vt.call(this,le.Na,t),this.size=e}function ve(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return D.setTimeout((function(){t()}),e)}le.Ma="serverreachability",V(me,vt),le.STAT_EVENT="statevent",V(pe,vt),le.Na="timingevent",V(we,vt);var Ie={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},be={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function Ee(){}function Te(t){return t.h||(t.h=t.i())}function Se(){}Ee.prototype.h=null;var xe,De={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function _e(){vt.call(this,"d")}function Ae(){vt.call(this,"c")}function Ce(){}function Ne(t,e,n,s){this.l=t,this.j=e,this.m=n,this.X=s||1,this.V=new ie(this),this.P=Re,t=ot?125:void 0,this.W=new te(t),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new ke}function ke(){this.i=null,this.g="",this.h=!1}V(_e,vt),V(Ae,vt),V(Ce,Ee),Ce.prototype.g=function(){return new XMLHttpRequest},Ce.prototype.i=function(){return{}},xe=new Ce;var Re=45e3,Le={},Me={};function Oe(t,e,n){t.K=1,t.v=rn(Je(e)),t.s=n,t.U=!0,Ve(t,null)}function Ve(t,e){t.F=Date.now(),Ue(t),t.A=Je(t.v);var n=t.A,s=t.X;Array.isArray(s)||(s=[String(s)]),wn(n.h,"t",s),t.C=0,n=t.l.H,t.h=new ke,t.g=ws(t.l,n?e:null,!t.s),0<t.O&&(t.L=new re(M(t.Ia,t,t.g),t.O)),ae(t.V,t.g,"readystatechange",t.gb),e=t.H?X(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.s,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),ge(1),function(t,e,n,s,r,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),u=0;u<a.length;u++){var c=a[u].split("=");if(1<c.length){var h=c[0];c=c[1];var l=h.split("_");o=2<=l.length&&"type"==l[1]?o+(h+"=")+c+"&":o+(h+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+s+") [attempt "+r+"]: "+e+"\n"+n+"\n"+o}))}(t.j,t.u,t.A,t.m,t.X,t.s)}function Fe(t){return!!t.g&&("GET"==t.u&&2!=t.K&&t.l.Ba)}function Pe(t,e,n){let s,r=!0;for(;!t.I&&t.C<n.length;){if(s=Be(t,n),s==Me){4==e&&(t.o=4,ye(14),r=!1),he(t.j,t.m,null,"[Incomplete Response]");break}if(s==Le){t.o=4,ye(15),he(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}he(t.j,t.m,s,null),$e(t,s)}Fe(t)&&s!=Me&&s!=Le&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,ye(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.aa&&(t.aa=!0,(e=t.l).g==t&&e.$&&!e.L&&(e.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),hs(e),e.L=!0,ye(11))):(he(t.j,t.m,n,"[Invalid Chunked Response]"),je(t),Ke(t))}function Be(t,e){var n=t.C,s=e.indexOf("\n",n);return-1==s?Me:(n=Number(e.substring(n,s)),isNaN(n)?Le:(s+=1)+n>e.length?Me:(e=e.substr(s,n),t.C=s+n,e))}function Ue(t){t.Y=Date.now()+t.P,qe(t,t.P)}function qe(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=ve(M(t.eb,t),e)}function Ge(t){t.B&&(D.clearTimeout(t.B),t.B=null)}function Ke(t){0==t.l.G||t.I||fs(t.l,t)}function je(t){Ge(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,ee(t.W),ue(t.V),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function $e(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||Sn(n.i,t)))if(n.I=t.N,!t.J&&Sn(n.i,t)&&3==n.G){try{var s=n.Ca.g.parse(e)}catch(t){s=null}if(Array.isArray(s)&&3==s.length){var r=s;if(0==r[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;ds(n),es(n)}cs(n),ye(18)}}else n.ta=r[1],0<n.ta-n.U&&37500>r[2]&&n.N&&0==n.A&&!n.v&&(n.v=ve(M(n.ab,n),6e3));if(1>=Tn(n.i)&&n.ka){try{n.ka()}catch(t){}n.ka=void 0}}else gs(n,11)}else if((t.J||n.g==t)&&ds(n),!K(e))for(r=n.Ca.g.parse(e),e=0;e<r.length;e++){let c=r[e];if(n.U=c[0],c=c[1],2==n.G)if("c"==c[0]){n.J=c[1],n.la=c[2];const e=c[3];null!=e&&(n.ma=e,n.h.info("VER="+n.ma));const r=c[4];null!=r&&(n.za=r,n.h.info("SVER="+n.za));const h=c[5];null!=h&&"number"==typeof h&&0<h&&(s=1.5*h,n.K=s,n.h.info("backChannelRequestTimeoutMs_="+s)),s=n;const l=t.g;if(l){const t=l.g?l.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=s.i;!i.g&&(z(t,"spdy")||z(t,"quic")||z(t,"h2"))&&(i.j=i.l,i.g=new Set,i.h&&(xn(i,i.h),i.h=null))}if(s.D){const t=l.g?l.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(s.sa=t,sn(s.F,s.D,t))}}n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-t.F,n.h.info("Handshake RTT: "+n.O+"ms"));var o=t;if((s=n).oa=ys(s,s.H?s.la:null,s.W),o.J){Dn(s.i,o);var a=o,u=s.K;u&&a.setTimeout(u),a.B&&(Ge(a),Ue(a)),s.g=o}else us(s);0<n.l.length&&rs(n)}else"stop"!=c[0]&&"close"!=c[0]||gs(n,7);else 3==n.G&&("stop"==c[0]||"close"==c[0]?"stop"==c[0]?gs(n,7):ts(n):"noop"!=c[0]&&n.j&&n.j.wa(c),n.A=0)}ge(4)}catch(t){}}function ze(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(A(t)||"string"==typeof t)U(t,e,void 0);else{if(t.T&&"function"==typeof t.T)var n=t.T();else if(t.R&&"function"==typeof t.R)n=void 0;else if(A(t)||"string"==typeof t){n=[];for(var s=t.length,r=0;r<s;r++)n.push(r)}else for(r in n=[],s=0,t)n[s++]=r;s=function(t){if(t.R&&"function"==typeof t.R)return t.R();if("string"==typeof t)return t.split("");if(A(t)){for(var e=[],n=t.length,s=0;s<n;s++)e.push(t[s]);return e}for(s in e=[],n=0,t)e[n++]=t[s];return e}(t),r=s.length;for(var i=0;i<r;i++)e.call(void 0,s[i],n&&n[i],t)}}function Qe(t,e){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var s=0;s<n;s+=2)this.set(arguments[s],arguments[s+1])}else if(t)if(t instanceof Qe)for(n=t.T(),s=0;s<n.length;s++)this.set(n[s],t.get(n[s]));else for(s in t)this.set(s,t[s])}function He(t){if(t.i!=t.g.length){for(var e=0,n=0;e<t.g.length;){var s=t.g[e];We(t.h,s)&&(t.g[n++]=s),e++}t.g.length=n}if(t.i!=t.g.length){var r={};for(n=e=0;e<t.g.length;)We(r,s=t.g[e])||(t.g[n++]=s,r[s]=1),e++;t.g.length=n}}function We(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(T=Ne.prototype).setTimeout=function(t){this.P=t},T.gb=function(t){t=t.target;const e=this.L;e&&3==Wn(t)?e.l():this.Ia(t)},T.Ia=function(t){try{if(t==this.g)t:{const h=Wn(this.g);var e=this.g.Da();const l=this.g.ba();if(!(3>h)&&(3!=h||ot||this.g&&(this.h.h||this.g.ga()||Yn(this.g)))){this.I||4!=h||7==e||ge(8==e||0>=l?3:2),Ge(this);var n=this.g.ba();this.N=n;e:if(Fe(this)){var s=Yn(this.g);t="";var r=s.length,i=4==Wn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){je(this),Ke(this);var o="";break e}this.h.i=new D.TextDecoder}for(e=0;e<r;e++)this.h.h=!0,t+=this.h.i.decode(s[e],{stream:i&&e==r-1});s.splice(0,r),this.h.g+=t,this.C=0,o=this.h.g}else o=this.g.ga();if(this.i=200==n,function(t,e,n,s,r,i,o){t.info((function(){return"XMLHTTP RESP ("+s+") [ attempt "+r+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.j,this.u,this.A,this.m,this.X,h,n),this.i){if(this.$&&!this.J){e:{if(this.g){var a,u=this.g;if((a=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!K(a)){var c=a;break e}}c=null}if(!(n=c)){this.i=!1,this.o=3,ye(12),je(this),Ke(this);break t}he(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,$e(this,n)}this.U?(Pe(this,h,o),ot&&this.i&&3==h&&(ae(this.V,this.W,"tick",this.fb),this.W.start())):(he(this.j,this.m,o,null),$e(this,o)),4==h&&je(this),this.i&&!this.I&&(4==h?fs(this.l,this):(this.i=!1,Ue(this)))}else 400==n&&0<o.indexOf("Unknown SID")?(this.o=3,ye(12)):(this.o=0,ye(13)),je(this),Ke(this)}}}catch(t){}},T.fb=function(){if(this.g){var t=Wn(this.g),e=this.g.ga();this.C<e.length&&(Ge(this),Pe(this,t,e),this.i&&4!=t&&Ue(this))}},T.cancel=function(){this.I=!0,je(this)},T.eb=function(){this.B=null;const t=Date.now();0<=t-this.Y?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.A),2!=this.K&&(ge(3),ye(17)),je(this),this.o=2,Ke(this)):qe(this,this.Y-t)},(T=Qe.prototype).R=function(){He(this);for(var t=[],e=0;e<this.g.length;e++)t.push(this.h[this.g[e]]);return t},T.T=function(){return He(this),this.g.concat()},T.get=function(t,e){return We(this.h,t)?this.h[t]:e},T.set=function(t,e){We(this.h,t)||(this.i++,this.g.push(t)),this.h[t]=e},T.forEach=function(t,e){for(var n=this.T(),s=0;s<n.length;s++){var r=n[s],i=this.get(r);t.call(e,i,r,this)}};var Ye=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Xe(t,e){if(this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,t instanceof Xe){this.g=void 0!==e?e:t.g,Ze(this,t.j),this.s=t.s,tn(this,t.i),en(this,t.m),this.l=t.l,e=t.h;var n=new mn;n.i=e.i,e.g&&(n.g=new Qe(e.g),n.h=e.h),nn(this,n),this.o=t.o}else t&&(n=String(t).match(Ye))?(this.g=!!e,Ze(this,n[1]||"",!0),this.s=on(n[2]||""),tn(this,n[3]||"",!0),en(this,n[4]),this.l=on(n[5]||"",!0),nn(this,n[6]||"",!0),this.o=on(n[7]||"")):(this.g=!!e,this.h=new mn(null,this.g))}function Je(t){return new Xe(t)}function Ze(t,e,n){t.j=n?on(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function tn(t,e,n){t.i=n?on(e,!0):e}function en(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function nn(t,e,n){e instanceof mn?(t.h=e,function(t,e){e&&!t.j&&(gn(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(pn(this,e),wn(this,n,t))}),t)),t.j=e}(t.h,t.g)):(n||(e=an(e,dn)),t.h=new mn(e,t.g))}function sn(t,e,n){t.h.set(e,n)}function rn(t){return sn(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function on(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function an(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,un),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function un(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Xe.prototype.toString=function(){var t=[],e=this.j;e&&t.push(an(e,cn,!0),":");var n=this.i;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(an(e,cn,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&t.push("/"),t.push(an(n,"/"==n.charAt(0)?ln:hn,!0))),(n=this.h.toString())&&t.push("?",n),(n=this.o)&&t.push("#",an(n,fn)),t.join("")};var cn=/[#\/\?@]/g,hn=/[#\?:]/g,ln=/[#\?]/g,dn=/[#\?@]/g,fn=/#/g;function mn(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function gn(t){t.g||(t.g=new Qe,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var s=t[n].indexOf("="),r=null;if(0<=s){var i=t[n].substring(0,s);r=t[n].substring(s+1)}else i=t[n];e(i,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function pn(t,e){gn(t),e=vn(t,e),We(t.g.h,e)&&(t.i=null,t.h-=t.g.get(e).length,We((t=t.g).h,e)&&(delete t.h[e],t.i--,t.g.length>2*t.i&&He(t)))}function yn(t,e){return gn(t),e=vn(t,e),We(t.g.h,e)}function wn(t,e,n){pn(t,e),0<n.length&&(t.i=null,t.g.set(vn(t,e),G(n)),t.h+=n.length)}function vn(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}(T=mn.prototype).add=function(t,e){gn(this),this.i=null,t=vn(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},T.forEach=function(t,e){gn(this),this.g.forEach((function(n,s){U(n,(function(n){t.call(e,n,s,this)}),this)}),this)},T.T=function(){gn(this);for(var t=this.g.R(),e=this.g.T(),n=[],s=0;s<e.length;s++)for(var r=t[s],i=0;i<r.length;i++)n.push(e[s]);return n},T.R=function(t){gn(this);var e=[];if("string"==typeof t)yn(this,t)&&(e=q(e,this.g.get(vn(this,t))));else{t=this.g.R();for(var n=0;n<t.length;n++)e=q(e,t[n])}return e},T.set=function(t,e){return gn(this),this.i=null,yn(this,t=vn(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},T.get=function(t,e){return t&&0<(t=this.R(t)).length?String(t[0]):e},T.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var t=[],e=this.g.T(),n=0;n<e.length;n++){var s=e[n],r=encodeURIComponent(String(s));s=this.R(s);for(var i=0;i<s.length;i++){var o=r;""!==s[i]&&(o+="="+encodeURIComponent(String(s[i]))),t.push(o)}}return this.i=t.join("&")};function In(t){this.l=t||bn,D.PerformanceNavigationTiming?t=0<(t=D.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):t=!!(D.g&&D.g.Ea&&D.g.Ea()&&D.g.Ea().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var bn=10;function En(t){return!!t.h||!!t.g&&t.g.size>=t.j}function Tn(t){return t.h?1:t.g?t.g.size:0}function Sn(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function xn(t,e){t.g?t.g.add(e):t.h=e}function Dn(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function _n(t){if(null!=t.h)return t.i.concat(t.h.D);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}return G(t.i)}function An(){}function Cn(){this.g=new An}function Nn(t,e,n){const s=n||"";try{ze(t,(function(t,n){let r=t;C(t)&&(r=jt(t)),e.push(s+n+"="+encodeURIComponent(r))}))}catch(t){throw e.push(s+"type="+encodeURIComponent("_badmap")),t}}function kn(t,e,n,s,r){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,r(s)}catch(t){}}function Rn(t){this.l=t.$b||null,this.j=t.ib||!1}function Ln(t,e){qt.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=Mn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}In.prototype.cancel=function(){if(this.i=_n(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},An.prototype.stringify=function(t){return D.JSON.stringify(t,void 0)},An.prototype.parse=function(t){return D.JSON.parse(t,void 0)},V(Rn,Ee),Rn.prototype.g=function(){return new Ln(this.l,this.j)},Rn.prototype.i=function(t){return function(){return t}}({}),V(Ln,qt);var Mn=0;function On(t){t.j.read().then(t.Sa.bind(t)).catch(t.ha.bind(t))}function Vn(t){t.readyState=4,t.l=null,t.j=null,t.A=null,Fn(t)}function Fn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(T=Ln.prototype).open=function(t,e){if(this.readyState!=Mn)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,Fn(this)},T.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||D).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ha.bind(this))},T.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Vn(this)),this.readyState=Mn},T.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,Fn(this)),this.g&&(this.readyState=3,Fn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==D.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;On(this)}else t.text().then(this.Ua.bind(this),this.ha.bind(this))},T.Sa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?Vn(this):Fn(this),3==this.readyState&&On(this)}},T.Ua=function(t){this.g&&(this.response=this.responseText=t,Vn(this))},T.Ta=function(t){this.g&&(this.response=t,Vn(this))},T.ha=function(){this.g&&Vn(this)},T.setRequestHeader=function(t,e){this.v.append(t,e)},T.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},T.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(Ln.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var Pn=D.JSON.parse;function Bn(t){qt.call(this),this.headers=new Qe,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Un,this.K=this.L=!1}V(Bn,qt);var Un="",qn=/^https?$/i,Gn=["POST","PUT"];function Kn(t){return"content-type"==t.toLowerCase()}function jn(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,$n(t),Qn(t)}function $n(t){t.D||(t.D=!0,Gt(t,"complete"),Gt(t,"error"))}function zn(t){if(t.h&&void 0!==x&&(!t.C[1]||4!=Wn(t)||2!=t.ba()))if(t.v&&4==Wn(t))ne(t.Fa,0,t);else if(Gt(t,"readystatechange"),4==Wn(t)){t.h=!1;try{const a=t.ba();t:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var s;if(s=0===a){var r=String(t.H).match(Ye)[1]||null;if(!r&&D.self&&D.self.location){var i=D.self.location.protocol;r=i.substr(0,i.length-1)}s=!qn.test(r?r.toLowerCase():"")}n=s}if(n)Gt(t,"complete"),Gt(t,"success");else{t.m=6;try{var o=2<Wn(t)?t.g.statusText:""}catch(t){o=""}t.j=o+" ["+t.ba()+"]",$n(t)}}finally{Qn(t)}}}function Qn(t,e){if(t.g){Hn(t);const n=t.g,s=t.C[0]?_:null;t.g=null,t.C=null,e||Gt(t,"ready");try{n.onreadystatechange=s}catch(t){}}}function Hn(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(D.clearTimeout(t.A),t.A=null)}function Wn(t){return t.g?t.g.readyState:0}function Yn(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case Un:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Xn(t,e,n){t:{for(s in n){var s=!1;break t}s=!0}s||(n=function(t){let e="";return Y(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):sn(t,e,n))}function Jn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Zn(t){this.za=0,this.l=[],this.h=new ce,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=Jn("failFast",!1,t),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=Jn("baseRetryDelayMs",5e3,t),this.$a=Jn("retryDelaySeedMs",1e4,t),this.Ya=Jn("forwardChannelMaxRetries",2,t),this.ra=Jn("forwardChannelRequestTimeoutMs",2e4,t),this.qa=t&&t.xmlHttpFactory||void 0,this.Ba=t&&t.Yb||!1,this.K=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.J="",this.i=new In(t&&t.concurrentRequestLimit),this.Ca=new Cn,this.ja=t&&t.fastHandshake||!1,this.Ra=t&&t.Wb||!1,t&&t.Aa&&this.h.Aa(),t&&t.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&t&&t.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!t||!1!==t.Xb}function ts(t){if(ns(t),3==t.G){var e=t.V++,n=Je(t.F);sn(n,"SID",t.J),sn(n,"RID",e),sn(n,"TYPE","terminate"),os(t,n),(e=new Ne(t,t.h,e,void 0)).K=2,e.v=rn(Je(n)),n=!1,D.navigator&&D.navigator.sendBeacon&&(n=D.navigator.sendBeacon(e.v.toString(),"")),!n&&D.Image&&((new Image).src=e.v,n=!0),n||(e.g=ws(e.l,null),e.g.ea(e.v)),e.F=Date.now(),Ue(e)}ps(t)}function es(t){t.g&&(hs(t),t.g.cancel(),t.g=null)}function ns(t){es(t),t.u&&(D.clearTimeout(t.u),t.u=null),ds(t),t.i.cancel(),t.m&&("number"==typeof t.m&&D.clearTimeout(t.m),t.m=null)}function ss(t,e){t.l.push(new class{constructor(t,e){this.h=t,this.g=e}}(t.Za++,e)),3==t.G&&rs(t)}function rs(t){En(t.i)||t.m||(t.m=!0,Yt(t.Ha,t),t.C=0)}function is(t,e){var n;n=e?e.m:t.V++;const s=Je(t.F);sn(s,"SID",t.J),sn(s,"RID",n),sn(s,"AID",t.U),os(t,s),t.o&&t.s&&Xn(s,t.o,t.s),n=new Ne(t,t.h,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.l=e.D.concat(t.l)),e=as(t,n,1e3),n.setTimeout(Math.round(.5*t.ra)+Math.round(.5*t.ra*Math.random())),xn(t.i,n),Oe(n,s,e)}function os(t,e){t.j&&ze({},(function(t,n){sn(e,n,t)}))}function as(t,e,n){n=Math.min(t.l.length,n);var s=t.j?M(t.j.Oa,t.j,t):null;t:{var r=t.l;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=r[0].h,t.push("ofs="+e)):e=0:t.push("ofs="+e);let i=!0;for(let o=0;o<n;o++){let n=r[o].h;const a=r[o].g;if(n-=e,0>n)e=Math.max(0,r[o].h-100),i=!1;else try{Nn(a,t,"req"+n+"_")}catch(t){s&&s(a)}}if(i){s=t.join("&");break t}}}return t=t.l.splice(0,n),e.D=t,s}function us(t){t.g||t.u||(t.Y=1,Yt(t.Ga,t),t.A=0)}function cs(t){return!(t.g||t.u||3<=t.A)&&(t.Y++,t.u=ve(M(t.Ga,t),ms(t,t.A)),t.A++,!0)}function hs(t){null!=t.B&&(D.clearTimeout(t.B),t.B=null)}function ls(t){t.g=new Ne(t,t.h,"rpc",t.Y),null===t.o&&(t.g.H=t.s),t.g.O=0;var e=Je(t.oa);sn(e,"RID","rpc"),sn(e,"SID",t.J),sn(e,"CI",t.N?"0":"1"),sn(e,"AID",t.U),os(t,e),sn(e,"TYPE","xmlhttp"),t.o&&t.s&&Xn(e,t.o,t.s),t.K&&t.g.setTimeout(t.K);var n=t.g;t=t.la,n.K=1,n.v=rn(Je(e)),n.s=null,n.U=!0,Ve(n,t)}function ds(t){null!=t.v&&(D.clearTimeout(t.v),t.v=null)}function fs(t,e){var n=null;if(t.g==e){ds(t),hs(t),t.g=null;var s=2}else{if(!Sn(t.i,e))return;n=e.D,Dn(t.i,e),s=1}if(t.I=e.N,0!=t.G)if(e.i)if(1==s){n=e.s?e.s.length:0,e=Date.now()-e.F;var r=t.C;Gt(s=fe(),new we(s,n,e,r)),rs(t)}else us(t);else if(3==(r=e.o)||0==r&&0<t.I||!(1==s&&function(t,e){return!(Tn(t.i)>=t.i.j-(t.m?1:0)||(t.m?(t.l=e.D.concat(t.l),0):1==t.G||2==t.G||t.C>=(t.Xa?0:t.Ya)||(t.m=ve(M(t.Ha,t,e),ms(t,t.C)),t.C++,0)))}(t,e)||2==s&&cs(t)))switch(n&&0<n.length&&(e=t.i,e.i=e.i.concat(n)),r){case 1:gs(t,5);break;case 4:gs(t,10);break;case 3:gs(t,6);break;default:gs(t,2)}}function ms(t,e){let n=t.Pa+Math.floor(Math.random()*t.$a);return t.j||(n*=2),n*e}function gs(t,e){if(t.h.info("Error code "+e),2==e){var n=null;t.j&&(n=null);var s=M(t.jb,t);n||(n=new Xe("//www.google.com/images/cleardot.gif"),D.location&&"http"==D.location.protocol||Ze(n,"https"),rn(n)),function(t,e){const n=new ce;if(D.Image){const s=new Image;s.onload=O(kn,n,s,"TestLoadImage: loaded",!0,e),s.onerror=O(kn,n,s,"TestLoadImage: error",!1,e),s.onabort=O(kn,n,s,"TestLoadImage: abort",!1,e),s.ontimeout=O(kn,n,s,"TestLoadImage: timeout",!1,e),D.setTimeout((function(){s.ontimeout&&s.ontimeout()}),1e4),s.src=t}else e(!1)}(n.toString(),s)}else ye(2);t.G=0,t.j&&t.j.va(e),ps(t),ns(t)}function ps(t){t.G=0,t.I=-1,t.j&&(0==_n(t.i).length&&0==t.l.length||(t.i.i.length=0,G(t.l),t.l.length=0),t.j.ua())}function ys(t,e,n){let s=function(t){return t instanceof Xe?Je(t):new Xe(t,void 0)}(n);if(""!=s.i)e&&tn(s,e+"."+s.i),en(s,s.m);else{const t=D.location;s=function(t,e,n,s){var r=new Xe(null,void 0);return t&&Ze(r,t),e&&tn(r,e),n&&en(r,n),s&&(r.l=s),r}(t.protocol,e?e+"."+t.hostname:t.hostname,+t.port,n)}return t.aa&&Y(t.aa,(function(t,e){sn(s,e,t)})),e=t.D,n=t.sa,e&&n&&sn(s,e,n),sn(s,"VER",t.ma),os(t,s),s}function ws(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ba&&!t.qa?new Bn(new Rn({ib:!0})):new Bn(t.qa)).L=t.H,e}function vs(){}function Is(){if(rt&&!(10<=Number(yt)))throw Error("Environmental error: no available transport.")}function bs(t,e){qt.call(this),this.g=new Zn(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.P=t,(t=e&&e.httpHeadersOverwriteParam)&&!K(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!K(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&(e in(t=this.h)&&delete t[e])),this.j=new Ss(this)}function Es(t){_e.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function Ts(){Ae.call(this),this.status=1}function Ss(t){this.g=t}(T=Bn.prototype).ea=function(t,e,n,s){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():xe.g(),this.C=this.u?Te(this.u):Te(xe),this.g.onreadystatechange=M(this.Fa,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void jn(this,t)}t=n||"";const r=new Qe(this.headers);s&&ze(s,(function(t,e){r.set(e,t)})),s=function(t){t:{var e=Kn;const n=t.length,s="string"==typeof t?t.split(""):t;for(let r=0;r<n;r++)if(r in s&&e.call(void 0,s[r],r,t)){e=r;break t}e=-1}return 0>e?null:"string"==typeof t?t.charAt(e):t[e]}(r.T()),n=D.FormData&&t instanceof D.FormData,!(0<=B(Gn,e))||s||n||r.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),r.forEach((function(t,e){this.g.setRequestHeader(e,t)}),this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Hn(this),0<this.B&&((this.K=function(t){return rt&&gt()&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=M(this.pa,this)):this.A=ne(this.pa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){jn(this,t)}},T.pa=function(){void 0!==x&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Gt(this,"timeout"),this.abort(8))},T.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,Gt(this,"complete"),Gt(this,"abort"),Qn(this))},T.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Qn(this,!0)),Bn.Z.M.call(this)},T.Fa=function(){this.s||(this.F||this.v||this.l?zn(this):this.cb())},T.cb=function(){zn(this)},T.ba=function(){try{return 2<Wn(this)?this.g.status:-1}catch(t){return-1}},T.ga=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},T.Qa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),Pn(e)}},T.Da=function(){return this.m},T.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(T=Zn.prototype).ma=8,T.G=1,T.hb=function(t){try{this.h.info("Origin Trials invoked: "+t)}catch(t){}},T.Ha=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.V=Math.floor(1e5*Math.random()),t=this.V++;const r=new Ne(this,this.h,t,void 0);let i=this.s;if(this.P&&(i?(i=X(i),Z(i,this.P)):i=this.P),null===this.o&&(r.H=i),this.ja)t:{for(var e=0,n=0;n<this.l.length;n++){var s=this.l[n];if(void 0===(s="__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s.length:void 0))break;if(4096<(e+=s)){e=n;break t}if(4096===e||n===this.l.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=as(this,r,e),sn(n=Je(this.F),"RID",t),sn(n,"CVER",22),this.D&&sn(n,"X-HTTP-Session-Id",this.D),os(this,n),this.o&&i&&Xn(n,this.o,i),xn(this.i,r),this.Ra&&sn(n,"TYPE","init"),this.ja?(sn(n,"$req",e),sn(n,"SID","null"),r.$=!0,Oe(r,n,null)):Oe(r,n,e),this.G=2}}else 3==this.G&&(t?is(this,t):0==this.l.length||En(this.i)||is(this))},T.Ga=function(){if(this.u=null,ls(this),this.$&&!(this.L||null==this.g||0>=this.O)){var t=2*this.O;this.h.info("BP detection timer enabled: "+t),this.B=ve(M(this.bb,this),t)}},T.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,ye(10),es(this),ls(this))},T.ab=function(){null!=this.v&&(this.v=null,es(this),cs(this),ye(19))},T.jb=function(t){t?(this.h.info("Successfully pinged google.com"),ye(2)):(this.h.info("Failed to ping google.com"),ye(1))},(T=vs.prototype).xa=function(){},T.wa=function(){},T.va=function(){},T.ua=function(){},T.Oa=function(){},Is.prototype.g=function(t,e){return new bs(t,e)},V(bs,qt),bs.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;t.Wa&&(t.h.info("Origin Trials enabled."),Yt(M(t.hb,t,e))),ye(0),t.W=e,t.aa=n||{},t.N=t.X,t.F=ys(t,null,t.W),rs(t)},bs.prototype.close=function(){ts(this.g)},bs.prototype.u=function(t){if("string"==typeof t){var e={};e.__data__=t,ss(this.g,e)}else this.v?((e={}).__data__=jt(t),ss(this.g,e)):ss(this.g,t)},bs.prototype.M=function(){this.g.j=null,delete this.j,ts(this.g),delete this.g,bs.Z.M.call(this)},V(Es,_e),V(Ts,Ae),V(Ss,vs),Ss.prototype.xa=function(){Gt(this.g,"a")},Ss.prototype.wa=function(t){Gt(this.g,new Es(t))},Ss.prototype.va=function(t){Gt(this.g,new Ts(t))},Ss.prototype.ua=function(){Gt(this.g,"b")},Is.prototype.createWebChannel=Is.prototype.g,bs.prototype.send=bs.prototype.u,bs.prototype.open=bs.prototype.m,bs.prototype.close=bs.prototype.close,Ie.NO_ERROR=0,Ie.TIMEOUT=8,Ie.HTTP_ERROR=6,be.COMPLETE="complete",Se.EventType=De,De.OPEN="a",De.CLOSE="b",De.ERROR="c",De.MESSAGE="d",qt.prototype.listen=qt.prototype.N,Bn.prototype.listenOnce=Bn.prototype.O,Bn.prototype.getLastError=Bn.prototype.La,Bn.prototype.getLastErrorCode=Bn.prototype.Da,Bn.prototype.getStatus=Bn.prototype.ba,Bn.prototype.getResponseJson=Bn.prototype.Qa,Bn.prototype.getResponseText=Bn.prototype.ga,Bn.prototype.send=Bn.prototype.ea;var xs=Ie,Ds=be,_s=le,As=10,Cs=11,Ns=Rn,ks=Se,Rs=Bn;const Ls="@firebase/firestore";class Ms{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}Ms.UNAUTHENTICATED=new Ms(null),Ms.GOOGLE_CREDENTIALS=new Ms("google-credentials-uid"),Ms.FIRST_PARTY=new Ms("first-party-uid"),Ms.MOCK_USER=new Ms("mock-user");let Os="9.9.3";const Vs=new class{constructor(t){this.name=t,this._logLevel=I,this._logHandler=E,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in w))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel="string"==typeof t?v[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,w.DEBUG,...t),this._logHandler(this,w.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,w.VERBOSE,...t),this._logHandler(this,w.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,w.INFO,...t),this._logHandler(this,w.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,w.WARN,...t),this._logHandler(this,w.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,w.ERROR,...t),this._logHandler(this,w.ERROR,...t)}}("@firebase/firestore");function Fs(){return Vs.logLevel}function Ps(t){Vs.setLogLevel(t)}function Bs(t,...e){if(Vs.logLevel<=w.DEBUG){const n=e.map(Gs);Vs.debug(`Firestore (${Os}): ${t}`,...n)}}function Us(t,...e){if(Vs.logLevel<=w.ERROR){const n=e.map(Gs);Vs.error(`Firestore (${Os}): ${t}`,...n)}}function qs(t,...e){if(Vs.logLevel<=w.WARN){const n=e.map(Gs);Vs.warn(`Firestore (${Os}): ${t}`,...n)}}function Gs(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function Ks(t="Unexpected state"){const e=`FIRESTORE (${Os}) INTERNAL ASSERTION FAILED: `+t;throw Us(e),new Error(e)}function js(t,e){t||Ks()}function $s(t,e){t||Ks()}function zs(t,e){return t}const Qs={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Hs extends l{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Ws{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class Ys{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Xs{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(Ms.UNAUTHENTICATED)))}shutdown(){}}class Js{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class Zs{constructor(t){this.t=t,this.currentUser=Ms.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const s=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let r=new Ws;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new Ws,t.enqueueRetryable((()=>s(this.currentUser)))};const i=()=>{const e=r;t.enqueueRetryable((async()=>{await e.promise,await s(this.currentUser)}))},o=t=>{Bs("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(Bs("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new Ws)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(Bs("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(js("string"==typeof e.accessToken),new Ys(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return js(null===t||"string"==typeof t),new Ms(t)}}class tr{constructor(t,e,n,s){this.h=t,this.l=e,this.m=n,this.g=s,this.type="FirstParty",this.user=Ms.FIRST_PARTY,this.p=new Map}I(){return this.g?this.g():(js(!("object"!=typeof this.h||null===this.h||!this.h.auth||!this.h.auth.getAuthHeaderValueForFirstParty)),this.h.auth.getAuthHeaderValueForFirstParty([]))}get headers(){this.p.set("X-Goog-AuthUser",this.l);const t=this.I();return t&&this.p.set("Authorization",t),this.m&&this.p.set("X-Goog-Iam-Authorization-Token",this.m),this.p}}class er{constructor(t,e,n,s){this.h=t,this.l=e,this.m=n,this.g=s}getToken(){return Promise.resolve(new tr(this.h,this.l,this.m,this.g))}start(t,e){t.enqueueRetryable((()=>e(Ms.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class nr{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class sr{constructor(t){this.T=t,this.forceRefresh=!1,this.appCheck=null,this.A=null}start(t,e){const n=t=>{null!=t.error&&Bs("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.A;return this.A=t.token,Bs("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const s=t=>{Bs("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.T.onInit((t=>s(t))),setTimeout((()=>{if(!this.appCheck){const t=this.T.getImmediate({optional:!0});t?s(t):Bs("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(js("string"==typeof t.token),this.A=t.token,new nr(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class rr{getToken(){return Promise.resolve(new nr(""))}invalidateToken(){}start(t,e){}shutdown(){}}function ir(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class or{static R(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const s=ir(40);for(let r=0;r<s.length;++r)n.length<20&&s[r]<e&&(n+=t.charAt(s[r]%t.length))}return n}}function ar(t,e){return t<e?-1:t>e?1:0}function ur(t,e,n){return t.length===e.length&&t.every(((t,s)=>n(t,e[s])))}function cr(t){return t+"\0"}class hr{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Hs(Qs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Hs(Qs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Hs(Qs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Hs(Qs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return hr.fromMillis(Date.now())}static fromDate(t){return hr.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new hr(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?ar(this.nanoseconds,t.nanoseconds):ar(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class lr{constructor(t){this.timestamp=t}static fromTimestamp(t){return new lr(t)}static min(){return new lr(new hr(0,0))}static max(){return new lr(new hr(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class dr{constructor(t,e,n){void 0===e?e=0:e>t.length&&Ks(),void 0===n?n=t.length-e:n>t.length-e&&Ks(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===dr.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof dr?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let s=0;s<n;s++){const n=t.get(s),r=e.get(s);if(n<r)return-1;if(n>r)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class fr extends dr{construct(t,e,n){return new fr(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new Hs(Qs.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new fr(e)}static emptyPath(){return new fr([])}}const mr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class gr extends dr{construct(t,e,n){return new gr(t,e,n)}static isValidIdentifier(t){return mr.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),gr.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new gr(["__name__"])}static fromServerFormat(t){const e=[];let n="",s=0;const r=()=>{if(0===n.length)throw new Hs(Qs.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;s<t.length;){const e=t[s];if("\\"===e){if(s+1===t.length)throw new Hs(Qs.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[s+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Hs(Qs.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,s+=2}else"`"===e?(i=!i,s++):"."!==e||i?(n+=e,s++):(r(),s++)}if(r(),i)throw new Hs(Qs.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new gr(e)}static emptyPath(){return new gr([])}}class pr{constructor(t){this.path=t}static fromPath(t){return new pr(fr.fromString(t))}static fromName(t){return new pr(fr.fromString(t).popFirst(5))}static empty(){return new pr(fr.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===fr.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return fr.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new pr(new fr(t.slice()))}}class yr{constructor(t,e,n,s){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=s}}function wr(t){return t.fields.find((t=>2===t.kind))}function vr(t){return t.fields.filter((t=>2!==t.kind))}function Ir(t,e){let n=ar(t.collectionGroup,e.collectionGroup);if(0!==n)return n;for(let s=0;s<Math.min(t.fields.length,e.fields.length);++s)if(n=Er(t.fields[s],e.fields[s]),0!==n)return n;return ar(t.fields.length,e.fields.length)}yr.UNKNOWN_ID=-1;class br{constructor(t,e){this.fieldPath=t,this.kind=e}}function Er(t,e){const n=gr.comparator(t.fieldPath,e.fieldPath);return 0!==n?n:ar(t.kind,e.kind)}class Tr{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new Tr(0,Dr.min())}}function Sr(t,e){const n=t.toTimestamp().seconds,s=t.toTimestamp().nanoseconds+1,r=lr.fromTimestamp(1e9===s?new hr(n+1,0):new hr(n,s));return new Dr(r,pr.empty(),e)}function xr(t){return new Dr(t.readTime,t.key,-1)}class Dr{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new Dr(lr.min(),pr.empty(),-1)}static max(){return new Dr(lr.max(),pr.empty(),-1)}}function _r(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=pr.comparator(t.documentKey,e.documentKey),0!==n?n:ar(t.largestBatchId,e.largestBatchId))}const Ar="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Cr{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function Nr(t){if(t.code!==Qs.FAILED_PRECONDITION||t.message!==Ar)throw t;Bs("LocalStore","Unexpectedly lost primary lease")}class kr{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Ks(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new kr(((n,s)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,s)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,s)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof kr?e:kr.resolve(e)}catch(t){return kr.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):kr.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):kr.reject(e)}static resolve(t){return new kr(((e,n)=>{e(t)}))}static reject(t){return new kr(((e,n)=>{n(t)}))}static waitFor(t){return new kr(((e,n)=>{let s=0,r=0,i=!1;t.forEach((t=>{++s,t.next((()=>{++r,i&&r===s&&e()}),(t=>n(t)))})),i=!0,r===s&&e()}))}static or(t){let e=kr.resolve(!1);for(const n of t)e=e.next((t=>t?kr.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,s)=>{n.push(e.call(this,t,s))})),this.waitFor(n)}static mapArray(t,e){return new kr(((n,s)=>{const r=t.length,i=new Array(r);let o=0;for(let a=0;a<r;a++){const u=a;e(t[u]).next((t=>{i[u]=t,++o,o===r&&n(i)}),(t=>s(t)))}}))}static doWhile(t,e){return new kr(((n,s)=>{const r=()=>{!0===t()?e().next((()=>{r()}),s):n()};r()}))}}class Rr{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.P=new Ws,this.transaction.oncomplete=()=>{this.P.resolve()},this.transaction.onabort=()=>{e.error?this.P.reject(new Or(t,e.error)):this.P.resolve()},this.transaction.onerror=e=>{const n=Ur(e.target.error);this.P.reject(new Or(t,n))}}static open(t,e,n,s){try{return new Rr(e,t.transaction(s,n))}catch(t){throw new Or(e,t)}}get v(){return this.P.promise}abort(t){t&&this.P.reject(t),this.aborted||(Bs("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}V(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new Fr(e)}}class Lr{constructor(t,e,n){this.name=t,this.version=e,this.S=n,12.2===Lr.D(c())&&Us("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return Bs("SimpleDb","Removing database:",t),Pr(window.indexedDB.deleteDatabase(t)).toPromise()}static C(){if("object"!=typeof indexedDB)return!1;if(Lr.N())return!0;const t=c(),e=Lr.D(t),n=0<e&&e<10,s=Lr.k(t),r=0<s&&s<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||r)}static N(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.M)}static O(t,e){return t.store(e)}static D(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static k(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async F(t){return this.db||(Bs("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=t=>{const n=t.target.result;e(n)},s.onblocked=()=>{n(new Or(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{const s=e.target.error;"VersionError"===s.name?n(new Hs(Qs.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new Hs(Qs.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new Or(t,s))},s.onupgradeneeded=t=>{Bs("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.S.$(e,s.transaction,t.oldVersion,this.version).next((()=>{Bs("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.B&&(this.db.onversionchange=t=>this.B(t)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,s){const r="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.F(t);const e=Rr.open(this.db,t,r?"readonly":"readwrite",n),i=s(e).next((t=>(e.V(),t))).catch((t=>(e.abort(t),kr.reject(t)))).toPromise();return i.catch((()=>{})),await e.v,i}catch(t){const e=t,n="FirebaseError"!==e.name&&i<3;if(Bs("SimpleDb","Transaction failed with error:",e.message,"Retrying:",n),this.close(),!n)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Mr{constructor(t){this.U=t,this.q=!1,this.K=null}get isDone(){return this.q}get G(){return this.K}set cursor(t){this.U=t}done(){this.q=!0}j(t){this.K=t}delete(){return Pr(this.U.delete())}}class Or extends Hs{constructor(t,e){super(Qs.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function Vr(t){return"IndexedDbTransactionError"===t.name}class Fr{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(Bs("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(Bs("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Pr(n)}add(t){return Bs("SimpleDb","ADD",this.store.name,t,t),Pr(this.store.add(t))}get(t){return Pr(this.store.get(t)).next((e=>(void 0===e&&(e=null),Bs("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return Bs("SimpleDb","DELETE",this.store.name,t),Pr(this.store.delete(t))}count(){return Bs("SimpleDb","COUNT",this.store.name),Pr(this.store.count())}W(t,e){const n=this.options(t,e);if(n.index||"function"!=typeof this.store.getAll){const t=this.cursor(n),e=[];return this.H(t,((t,n)=>{e.push(n)})).next((()=>e))}{const t=this.store.getAll(n.range);return new kr(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}}J(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new kr(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}Y(t,e){Bs("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.X=!1;const s=this.cursor(n);return this.H(s,((t,e,n)=>n.delete()))}Z(t,e){let n;e?n=t:(n={},e=t);const s=this.cursor(n);return this.H(s,e)}tt(t){const e=this.cursor({});return new kr(((n,s)=>{e.onerror=t=>{const e=Ur(t.target.error);s(e)},e.onsuccess=e=>{const s=e.target.result;s?t(s.primaryKey,s.value).next((t=>{t?s.continue():n()})):n()}}))}H(t,e){const n=[];return new kr(((s,r)=>{t.onerror=t=>{r(t.target.error)},t.onsuccess=t=>{const r=t.target.result;if(!r)return void s();const i=new Mr(r),o=e(r.primaryKey,r.value,i);if(o instanceof kr){const t=o.catch((t=>(i.done(),kr.reject(t))));n.push(t)}i.isDone?s():null===i.G?r.continue():r.continue(i.G)}})).next((()=>kr.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.X?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Pr(t){return new kr(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Ur(t.target.error);n(e)}}))}let Br=!1;function Ur(t){const e=Lr.D(c());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new Hs("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Br||(Br=!0,setTimeout((()=>{throw t}),0)),t}}return t}class qr{constructor(t,e){this.asyncQueue=t,this.et=e,this.task=null}start(){this.nt(15)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}nt(t){Bs("IndexBackiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{Bs("IndexBackiller",`Documents written: ${await this.et.st()}`)}catch(t){Vr(t)?Bs("IndexBackiller","Ignoring IndexedDB error during index backfill: ",t):await Nr(t)}await this.nt(1)}))}}class Gr{constructor(t,e){this.localStore=t,this.persistence=e}async st(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.it(e,t)))}it(t,e){const n=new Set;let s=e,r=!0;return kr.doWhile((()=>!0===r&&s>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return Bs("IndexBackiller",`Processing collection: ${e}`),this.rt(t,e,s).next((t=>{s-=t,n.add(e)}));r=!1})))).next((()=>e-s))}rt(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((s=>this.localStore.localDocuments.getNextDocuments(t,e,s,n).next((n=>{const r=n.changes;return this.localStore.indexManager.updateIndexEntries(t,r).next((()=>this.ot(s,n))).next((n=>(Bs("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>r.size))}))))}ot(t,e){let n=t;return e.changes.forEach(((t,e)=>{const s=xr(e);_r(s,n)>0&&(n=s)})),new Dr(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class Kr{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.ut(t),this.ct=t=>e.writeSequenceNumber(t))}ut(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ct&&this.ct(t),t}}function jr(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function $r(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function zr(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}Kr.at=-1;class Qr{constructor(t,e){this.comparator=t,this.root=e||Wr.EMPTY}insert(t,e){return new Qr(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Wr.BLACK,null,null))}remove(t){return new Qr(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Wr.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(t,n.key);if(0===s)return e+n.left.size;s<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Hr(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Hr(this.root,t,this.comparator,!1)}getReverseIterator(){return new Hr(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Hr(this.root,t,this.comparator,!0)}}class Hr{constructor(t,e,n,s){this.isReverse=s,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?n(t.key,e):1,e&&s&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(0===r){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Wr{constructor(t,e,n,s,r){this.key=t,this.value=e,this.color=null!=n?n:Wr.RED,this.left=null!=s?s:Wr.EMPTY,this.right=null!=r?r:Wr.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,s,r){return new Wr(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let s=this;const r=n(t,s.key);return s=r<0?s.copy(null,null,null,s.left.insert(t,e,n),null):0===r?s.copy(null,e,null,null,null):s.copy(null,null,null,null,s.right.insert(t,e,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return Wr.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,s=this;if(e(t,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(t,e),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===e(t,s.key)){if(s.right.isEmpty())return Wr.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(t,e))}return s.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,Wr.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,Wr.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ks();if(this.right.isRed())throw Ks();const t=this.left.check();if(t!==this.right.check())throw Ks();return t+(this.isRed()?0:1)}}Wr.EMPTY=null,Wr.RED=!0,Wr.BLACK=!1,Wr.EMPTY=new class{constructor(){this.size=0}get key(){throw Ks()}get value(){throw Ks()}get color(){throw Ks()}get left(){throw Ks()}get right(){throw Ks()}copy(t,e,n,s,r){return this}insert(t,e,n){return new Wr(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Yr{constructor(t){this.comparator=t,this.data=new Qr(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,t[1])>=0)return;e(s.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Xr(this.data.getIterator())}getIteratorFrom(t){return new Xr(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof Yr))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(0!==this.comparator(t,s))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new Yr(this.comparator);return e.data=t,e}}class Xr{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Jr(t){return t.hasNext()?t.getNext():void 0}class Zr{constructor(t){this.fields=t,t.sort(gr.comparator)}static empty(){return new Zr([])}unionWith(t){let e=new Yr(gr.comparator);for(const t of this.fields)e=e.add(t);for(const n of t)e=e.add(n);return new Zr(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return ur(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}function ti(){return"undefined"!=typeof atob}class ei{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new ei(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new ei(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return ar(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}ei.EMPTY_BYTE_STRING=new ei("");const ni=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function si(t){if(js(!!t),"string"==typeof t){let e=0;const n=ni.exec(t);if(js(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const s=new Date(t);return{seconds:Math.floor(s.getTime()/1e3),nanos:e}}return{seconds:ri(t.seconds),nanos:ri(t.nanos)}}function ri(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function ii(t){return"string"==typeof t?ei.fromBase64String(t):ei.fromUint8Array(t)}function oi(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function ai(t){const e=t.mapValue.fields.__previous_value__;return oi(e)?ai(e):e}function ui(t){const e=si(t.mapValue.fields.__local_write_time__.timestampValue);return new hr(e.seconds,e.nanos)}class ci{constructor(t,e,n,s,r,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=s,this.ssl=r,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class hi{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new hi("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof hi&&t.projectId===this.projectId&&t.database===this.database}}function li(t){return null==t}function di(t){return 0===t&&1/t==-1/0}function fi(t){return"number"==typeof t&&Number.isInteger(t)&&!di(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}const mi={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},gi={nullValue:"NULL_VALUE"};function pi(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?oi(t)?4:Ni(t)?9007199254740991:10:Ks()}function yi(t,e){if(t===e)return!0;const n=pi(t);if(n!==pi(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return ui(t).isEqual(ui(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=si(t.timestampValue),s=si(e.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return ii(t.bytesValue).isEqual(ii(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return ri(t.geoPointValue.latitude)===ri(e.geoPointValue.latitude)&&ri(t.geoPointValue.longitude)===ri(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return ri(t.integerValue)===ri(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=ri(t.doubleValue),s=ri(e.doubleValue);return n===s?di(n)===di(s):isNaN(n)&&isNaN(s)}return!1}(t,e);case 9:return ur(t.arrayValue.values||[],e.arrayValue.values||[],yi);case 10:return function(t,e){const n=t.mapValue.fields||{},s=e.mapValue.fields||{};if(jr(n)!==jr(s))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===s[t]||!yi(n[t],s[t])))return!1;return!0}(t,e);default:return Ks()}}function wi(t,e){return void 0!==(t.values||[]).find((t=>yi(t,e)))}function vi(t,e){if(t===e)return 0;const n=pi(t),s=pi(e);if(n!==s)return ar(n,s);switch(n){case 0:case 9007199254740991:return 0;case 1:return ar(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=ri(t.integerValue||t.doubleValue),s=ri(e.integerValue||e.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(t,e);case 3:return Ii(t.timestampValue,e.timestampValue);case 4:return Ii(ui(t),ui(e));case 5:return ar(t.stringValue,e.stringValue);case 6:return function(t,e){const n=ii(t),s=ii(e);return n.compareTo(s)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),s=e.split("/");for(let t=0;t<n.length&&t<s.length;t++){const e=ar(n[t],s[t]);if(0!==e)return e}return ar(n.length,s.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=ar(ri(t.latitude),ri(e.latitude));return 0!==n?n:ar(ri(t.longitude),ri(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],s=e.values||[];for(let t=0;t<n.length&&t<s.length;++t){const e=vi(n[t],s[t]);if(e)return e}return ar(n.length,s.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===mi.mapValue&&e===mi.mapValue)return 0;if(t===mi.mapValue)return 1;if(e===mi.mapValue)return-1;const n=t.fields||{},s=Object.keys(n),r=e.fields||{},i=Object.keys(r);s.sort(),i.sort();for(let t=0;t<s.length&&t<i.length;++t){const e=ar(s[t],i[t]);if(0!==e)return e;const o=vi(n[s[t]],r[i[t]]);if(0!==o)return o}return ar(s.length,i.length)}(t.mapValue,e.mapValue);default:throw Ks()}}function Ii(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return ar(t,e);const n=si(t),s=si(e),r=ar(n.seconds,s.seconds);return 0!==r?r:ar(n.nanos,s.nanos)}function bi(t){return Ei(t)}function Ei(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=si(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?ii(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,pr.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const s of t.values||[])n?n=!1:e+=",",e+=Ei(s);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",s=!0;for(const r of e)s?s=!1:n+=",",n+=`${r}:${Ei(t.fields[r])}`;return n+"}"}(t.mapValue):Ks();var e,n}function Ti(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function Si(t){return!!t&&"integerValue"in t}function xi(t){return!!t&&"arrayValue"in t}function Di(t){return!!t&&"nullValue"in t}function _i(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Ai(t){return!!t&&"mapValue"in t}function Ci(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return $r(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=Ci(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=Ci(t.arrayValue.values[n]);return e}return Object.assign({},t)}function Ni(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function ki(t){return"nullValue"in t?gi:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?Ti(hi.empty(),pr.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:Ks()}function Ri(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?Ti(hi.empty(),pr.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?mi:Ks()}function Li(t,e){const n=vi(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function Mi(t,e){const n=vi(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class Oi{constructor(t){this.value=t}static empty(){return new Oi({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Ai(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Ci(e)}setAll(t){let e=gr.emptyPath(),n={},s=[];t.forEach(((t,r)=>{if(!e.isImmediateParentOf(r)){const t=this.getFieldsMap(e);this.applyChanges(t,n,s),n={},s=[],e=r.popLast()}t?n[r.lastSegment()]=Ci(t):s.push(r.lastSegment())}));const r=this.getFieldsMap(e);this.applyChanges(r,n,s)}delete(t){const e=this.field(t.popLast());Ai(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return yi(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let s=e.mapValue.fields[t.get(n)];Ai(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=s),e=s}return e.mapValue.fields}applyChanges(t,e,n){$r(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new Oi(Ci(this.value))}}function Vi(t){const e=[];return $r(t.fields,((t,n)=>{const s=new gr([t]);if(Ai(n)){const t=Vi(n.mapValue).fields;if(0===t.length)e.push(s);else for(const n of t)e.push(s.child(n))}else e.push(s)})),new Zr(e)}class Fi{constructor(t,e,n,s,r,i){this.key=t,this.documentType=e,this.version=n,this.readTime=s,this.data=r,this.documentState=i}static newInvalidDocument(t){return new Fi(t,0,lr.min(),lr.min(),Oi.empty(),0)}static newFoundDocument(t,e,n){return new Fi(t,1,e,lr.min(),n,0)}static newNoDocument(t,e){return new Fi(t,2,e,lr.min(),Oi.empty(),0)}static newUnknownDocument(t,e){return new Fi(t,3,e,lr.min(),Oi.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Oi.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Oi.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=lr.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof Fi&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new Fi(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Pi{constructor(t,e=null,n=[],s=[],r=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=s,this.limit=r,this.startAt=i,this.endAt=o,this.ht=null}}function Bi(t,e=null,n=[],s=[],r=null,i=null,o=null){return new Pi(t,e,n,s,r,i,o)}function Ui(t){const e=zs(t);if(null===e.ht){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>{return(e=t).field.canonicalString()+e.op.toString()+bi(e.value);var e})).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),li(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>bi(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>bi(t))).join(",")),e.ht=t}return e.ht}function qi(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!so(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let r=0;r<t.filters.length;r++)if(n=t.filters[r],s=e.filters[r],n.op!==s.op||!n.field.isEqual(s.field)||!yi(n.value,s.value))return!1;var n,s;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!io(t.startAt,e.startAt)&&io(t.endAt,e.endAt)}function Gi(t){return pr.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function Ki(t,e){return t.filters.filter((t=>t instanceof zi&&t.field.isEqual(e)))}function ji(t,e,n){let s=gi,r=!0;for(const n of Ki(t,e)){let t=gi,e=!0;switch(n.op){case"<":case"<=":t=ki(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=gi}Li({value:s,inclusive:r},{value:t,inclusive:e})<0&&(s=t,r=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];Li({value:s,inclusive:r},{value:t,inclusive:n.inclusive})<0&&(s=t,r=n.inclusive);break}return{value:s,inclusive:r}}function $i(t,e,n){let s=mi,r=!0;for(const n of Ki(t,e)){let t=mi,e=!0;switch(n.op){case">=":case">":t=Ri(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=mi}Mi({value:s,inclusive:r},{value:t,inclusive:e})>0&&(s=t,r=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];Mi({value:s,inclusive:r},{value:t,inclusive:n.inclusive})>0&&(s=t,r=n.inclusive);break}return{value:s,inclusive:r}}class zi extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.lt(t,e,n):new Qi(t,e,n):"array-contains"===e?new Xi(t,n):"in"===e?new Ji(t,n):"not-in"===e?new Zi(t,n):"array-contains-any"===e?new to(t,n):new zi(t,e,n)}static lt(t,e,n){return"in"===e?new Hi(t,n):new Wi(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.ft(vi(e,this.value)):null!==e&&pi(this.value)===pi(e)&&this.ft(vi(e,this.value))}ft(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return Ks()}}dt(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class Qi extends zi{constructor(t,e,n){super(t,e,n),this.key=pr.fromName(n.referenceValue)}matches(t){const e=pr.comparator(t.key,this.key);return this.ft(e)}}class Hi extends zi{constructor(t,e){super(t,"in",e),this.keys=Yi("in",e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Wi extends zi{constructor(t,e){super(t,"not-in",e),this.keys=Yi("not-in",e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Yi(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>pr.fromName(t.referenceValue)))}class Xi extends zi{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return xi(e)&&wi(e.arrayValue,this.value)}}class Ji extends zi{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&wi(this.value.arrayValue,e)}}class Zi extends zi{constructor(t,e){super(t,"not-in",e)}matches(t){if(wi(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!wi(this.value.arrayValue,e)}}class to extends zi{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!xi(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>wi(this.value.arrayValue,t)))}}class eo{constructor(t,e){this.position=t,this.inclusive=e}}class no{constructor(t,e="asc"){this.field=t,this.dir=e}}function so(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function ro(t,e,n){let s=0;for(let r=0;r<t.position.length;r++){const i=e[r],o=t.position[r];if(s=i.field.isKeyField()?pr.comparator(pr.fromName(o.referenceValue),n.key):vi(o,n.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function io(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!yi(t.position[n],e.position[n]))return!1;return!0}class oo{constructor(t,e=null,n=[],s=[],r=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=s,this.limit=r,this.limitType=i,this.startAt=o,this.endAt=a,this._t=null,this.wt=null,this.startAt,this.endAt}}function ao(t,e,n,s,r,i,o,a){return new oo(t,e,n,s,r,i,o,a)}function uo(t){return new oo(t)}function co(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}function ho(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function lo(t){for(const e of t.filters)if(e.dt())return e.field;return null}function fo(t){return null!==t.collectionGroup}function mo(t){const e=zs(t);if(null===e._t){e._t=[];const t=lo(e),n=ho(e);if(null!==t&&null===n)t.isKeyField()||e._t.push(new no(t)),e._t.push(new no(gr.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e._t.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e._t.push(new no(gr.keyField(),t))}}}return e._t}function go(t){const e=zs(t);if(!e.wt)if("F"===e.limitType)e.wt=Bi(e.path,e.collectionGroup,mo(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const n of mo(e)){const e="desc"===n.dir?"asc":"desc";t.push(new no(n.field,e))}const n=e.endAt?new eo(e.endAt.position,e.endAt.inclusive):null,s=e.startAt?new eo(e.startAt.position,e.startAt.inclusive):null;e.wt=Bi(e.path,e.collectionGroup,t,e.filters,e.limit,n,s)}return e.wt}function po(t,e,n){return new oo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function yo(t,e){return qi(go(t),go(e))&&t.limitType===e.limitType}function wo(t){return`${Ui(go(t))}|lt:${t.limitType}`}function vo(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>{return`${(e=t).field.canonicalString()} ${e.op} ${bi(e.value)}`;var e})).join(", ")}]`),li(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>bi(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>bi(t))).join(",")),`Target(${e})`}(go(t))}; limitType=${t.limitType})`}function Io(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):pr.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of t.explicitOrderBy)if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const s=ro(t,e,n);return t.inclusive?s<=0:s<0}(t.startAt,mo(t),e))&&!(t.endAt&&!function(t,e,n){const s=ro(t,e,n);return t.inclusive?s>=0:s>0}(t.endAt,mo(t),e))}(t,e)}function bo(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function Eo(t){return(e,n)=>{let s=!1;for(const r of mo(t)){const t=To(r,e,n);if(0!==t)return t;s=s||r.field.isKeyField()}return 0}}function To(t,e,n){const s=t.field.isKeyField()?pr.comparator(e.key,n.key):function(t,e,n){const s=e.data.field(t),r=n.data.field(t);return null!==s&&null!==r?vi(s,r):Ks()}(t.field,e,n);switch(t.dir){case"asc":return s;case"desc":return-1*s;default:return Ks()}}function So(t,e){if(t.gt){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:di(e)?"-0":e}}function xo(t){return{integerValue:""+t}}function Do(t,e){return fi(e)?xo(e):So(t,e)}class _o{constructor(){this._=void 0}}function Ao(t,e,n){return t instanceof ko?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof Ro?Lo(t,e):t instanceof Mo?Oo(t,e):function(t,e){const n=No(t,e),s=Fo(n)+Fo(t.yt);return Si(n)&&Si(t.yt)?xo(s):So(t.It,s)}(t,e)}function Co(t,e,n){return t instanceof Ro?Lo(t,e):t instanceof Mo?Oo(t,e):n}function No(t,e){return t instanceof Vo?Si(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class ko extends _o{}class Ro extends _o{constructor(t){super(),this.elements=t}}function Lo(t,e){const n=Po(e);for(const e of t.elements)n.some((t=>yi(t,e)))||n.push(e);return{arrayValue:{values:n}}}class Mo extends _o{constructor(t){super(),this.elements=t}}function Oo(t,e){let n=Po(e);for(const e of t.elements)n=n.filter((t=>!yi(t,e)));return{arrayValue:{values:n}}}class Vo extends _o{constructor(t,e){super(),this.It=t,this.yt=e}}function Fo(t){return ri(t.integerValue||t.doubleValue)}function Po(t){return xi(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Bo{constructor(t,e){this.field=t,this.transform=e}}class Uo{constructor(t,e){this.version=t,this.transformResults=e}}class qo{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new qo}static exists(t){return new qo(void 0,t)}static updateTime(t){return new qo(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Go(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class Ko{}function jo(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new ta(t.key,qo.none()):new Wo(t.key,t.data,qo.none());{const n=t.data,s=Oi.empty();let r=new Yr(gr.comparator);for(let t of e.fields)if(!r.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?s.delete(t):s.set(t,e),r=r.add(t)}return new Yo(t.key,s,new Zr(r.toArray()),qo.none())}}function $o(t,e,n){t instanceof Wo?function(t,e,n){const s=t.value.clone(),r=Jo(t.fieldTransforms,e,n.transformResults);s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):t instanceof Yo?function(t,e,n){if(!Go(t.precondition,e))return void e.convertToUnknownDocument(n.version);const s=Jo(t.fieldTransforms,e,n.transformResults),r=e.data;r.setAll(Xo(t)),r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function zo(t,e,n,s){return t instanceof Wo?function(t,e,n,s){if(!Go(t.precondition,e))return n;const r=t.value.clone(),i=Zo(t.fieldTransforms,s,e);return r.setAll(i),e.convertToFoundDocument(e.version,r).setHasLocalMutations(),null}(t,e,n,s):t instanceof Yo?function(t,e,n,s){if(!Go(t.precondition,e))return n;const r=Zo(t.fieldTransforms,s,e),i=e.data;return i.setAll(Xo(t)),i.setAll(r),e.convertToFoundDocument(e.version,i).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,s):function(t,e,n){return Go(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function Qo(t,e){let n=null;for(const s of t.fieldTransforms){const t=e.data.field(s.field),r=No(s.transform,t||null);null!=r&&(null===n&&(n=Oi.empty()),n.set(s.field,r))}return n||null}function Ho(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&ur(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof Ro&&e instanceof Ro||t instanceof Mo&&e instanceof Mo?ur(t.elements,e.elements,yi):t instanceof Vo&&e instanceof Vo?yi(t.yt,e.yt):t instanceof ko&&e instanceof ko}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class Wo extends Ko{constructor(t,e,n,s=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=s,this.type=0}getFieldMask(){return null}}class Yo extends Ko{constructor(t,e,n,s,r=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=s,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function Xo(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=t.data.field(n);e.set(n,s)}})),e}function Jo(t,e,n){const s=new Map;js(t.length===n.length);for(let r=0;r<n.length;r++){const i=t[r],o=i.transform,a=e.data.field(i.field);s.set(i.field,Co(o,a,n[r]))}return s}function Zo(t,e,n){const s=new Map;for(const r of t){const t=r.transform,i=n.data.field(r.field);s.set(r.field,Ao(t,i,e))}return s}class ta extends Ko{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class ea extends Ko{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class na{constructor(t){this.count=t}}var sa,ra;function ia(t){switch(t){default:return Ks();case Qs.CANCELLED:case Qs.UNKNOWN:case Qs.DEADLINE_EXCEEDED:case Qs.RESOURCE_EXHAUSTED:case Qs.INTERNAL:case Qs.UNAVAILABLE:case Qs.UNAUTHENTICATED:return!1;case Qs.INVALID_ARGUMENT:case Qs.NOT_FOUND:case Qs.ALREADY_EXISTS:case Qs.PERMISSION_DENIED:case Qs.FAILED_PRECONDITION:case Qs.ABORTED:case Qs.OUT_OF_RANGE:case Qs.UNIMPLEMENTED:case Qs.DATA_LOSS:return!0}}function oa(t){if(void 0===t)return Us("GRPC error has no .code"),Qs.UNKNOWN;switch(t){case sa.OK:return Qs.OK;case sa.CANCELLED:return Qs.CANCELLED;case sa.UNKNOWN:return Qs.UNKNOWN;case sa.DEADLINE_EXCEEDED:return Qs.DEADLINE_EXCEEDED;case sa.RESOURCE_EXHAUSTED:return Qs.RESOURCE_EXHAUSTED;case sa.INTERNAL:return Qs.INTERNAL;case sa.UNAVAILABLE:return Qs.UNAVAILABLE;case sa.UNAUTHENTICATED:return Qs.UNAUTHENTICATED;case sa.INVALID_ARGUMENT:return Qs.INVALID_ARGUMENT;case sa.NOT_FOUND:return Qs.NOT_FOUND;case sa.ALREADY_EXISTS:return Qs.ALREADY_EXISTS;case sa.PERMISSION_DENIED:return Qs.PERMISSION_DENIED;case sa.FAILED_PRECONDITION:return Qs.FAILED_PRECONDITION;case sa.ABORTED:return Qs.ABORTED;case sa.OUT_OF_RANGE:return Qs.OUT_OF_RANGE;case sa.UNIMPLEMENTED:return Qs.UNIMPLEMENTED;case sa.DATA_LOSS:return Qs.DATA_LOSS;default:return Ks()}}(ra=sa||(sa={}))[ra.OK=0]="OK",ra[ra.CANCELLED=1]="CANCELLED",ra[ra.UNKNOWN=2]="UNKNOWN",ra[ra.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",ra[ra.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",ra[ra.NOT_FOUND=5]="NOT_FOUND",ra[ra.ALREADY_EXISTS=6]="ALREADY_EXISTS",ra[ra.PERMISSION_DENIED=7]="PERMISSION_DENIED",ra[ra.UNAUTHENTICATED=16]="UNAUTHENTICATED",ra[ra.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",ra[ra.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",ra[ra.ABORTED=10]="ABORTED",ra[ra.OUT_OF_RANGE=11]="OUT_OF_RANGE",ra[ra.UNIMPLEMENTED=12]="UNIMPLEMENTED",ra[ra.INTERNAL=13]="INTERNAL",ra[ra.UNAVAILABLE=14]="UNAVAILABLE",ra[ra.DATA_LOSS=15]="DATA_LOSS";class aa{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,s]of n)if(this.equalsFn(e,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),s=this.inner[n];if(void 0===s)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<s.length;n++)if(this.equalsFn(s[n][0],t))return void(s[n]=[t,e]);s.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],t))return 1===n.length?delete this.inner[e]:n.splice(s,1),this.innerSize--,!0;return!1}forEach(t){$r(this.inner,((e,n)=>{for(const[e,s]of n)t(e,s)}))}isEmpty(){return zr(this.inner)}size(){return this.innerSize}}const ua=new Qr(pr.comparator);function ca(){return ua}const ha=new Qr(pr.comparator);function la(...t){let e=ha;for(const n of t)e=e.insert(n.key,n);return e}function da(t){let e=ha;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function fa(){return ga()}function ma(){return ga()}function ga(){return new aa((t=>t.toString()),((t,e)=>t.isEqual(e)))}const pa=new Qr(pr.comparator),ya=new Yr(pr.comparator);function wa(...t){let e=ya;for(const n of t)e=e.add(n);return e}const va=new Yr(ar);function Ia(){return va}class ba{constructor(t,e,n,s,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,Ea.createSynthesizedTargetChangeForCurrentChange(t,e)),new ba(lr.min(),n,Ia(),ca(),wa())}}class Ea{constructor(t,e,n,s,r){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e){return new Ea(ei.EMPTY_BYTE_STRING,e,wa(),wa(),wa())}}class Ta{constructor(t,e,n,s){this.Tt=t,this.removedTargetIds=e,this.key=n,this.Et=s}}class Sa{constructor(t,e){this.targetId=t,this.At=e}}class xa{constructor(t,e,n=ei.EMPTY_BYTE_STRING,s=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=s}}class Da{constructor(){this.Rt=0,this.bt=Ca(),this.Pt=ei.EMPTY_BYTE_STRING,this.vt=!1,this.Vt=!0}get current(){return this.vt}get resumeToken(){return this.Pt}get St(){return 0!==this.Rt}get Dt(){return this.Vt}Ct(t){t.approximateByteSize()>0&&(this.Vt=!0,this.Pt=t)}xt(){let t=wa(),e=wa(),n=wa();return this.bt.forEach(((s,r)=>{switch(r){case 0:t=t.add(s);break;case 2:e=e.add(s);break;case 1:n=n.add(s);break;default:Ks()}})),new Ea(this.Pt,this.vt,t,e,n)}Nt(){this.Vt=!1,this.bt=Ca()}kt(t,e){this.Vt=!0,this.bt=this.bt.insert(t,e)}Mt(t){this.Vt=!0,this.bt=this.bt.remove(t)}Ot(){this.Rt+=1}Ft(){this.Rt-=1}$t(){this.Vt=!0,this.vt=!0}}class _a{constructor(t){this.Bt=t,this.Lt=new Map,this.Ut=ca(),this.qt=Aa(),this.Kt=new Yr(ar)}Gt(t){for(const e of t.Tt)t.Et&&t.Et.isFoundDocument()?this.Qt(e,t.Et):this.jt(e,t.key,t.Et);for(const e of t.removedTargetIds)this.jt(e,t.key,t.Et)}Wt(t){this.forEachTarget(t,(e=>{const n=this.zt(e);switch(t.state){case 0:this.Ht(e)&&n.Ct(t.resumeToken);break;case 1:n.Ft(),n.St||n.Nt(),n.Ct(t.resumeToken);break;case 2:n.Ft(),n.St||this.removeTarget(e);break;case 3:this.Ht(e)&&(n.$t(),n.Ct(t.resumeToken));break;case 4:this.Ht(e)&&(this.Jt(e),n.Ct(t.resumeToken));break;default:Ks()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Lt.forEach(((t,n)=>{this.Ht(n)&&e(n)}))}Yt(t){const e=t.targetId,n=t.At.count,s=this.Xt(e);if(s){const t=s.target;if(Gi(t))if(0===n){const n=new pr(t.path);this.jt(e,n,Fi.newNoDocument(n,lr.min()))}else js(1===n);else this.Zt(e)!==n&&(this.Jt(e),this.Kt=this.Kt.add(e))}}te(t){const e=new Map;this.Lt.forEach(((n,s)=>{const r=this.Xt(s);if(r){if(n.current&&Gi(r.target)){const e=new pr(r.target.path);null!==this.Ut.get(e)||this.ee(s,e)||this.jt(s,e,Fi.newNoDocument(e,t))}n.Dt&&(e.set(s,n.xt()),n.Nt())}}));let n=wa();this.qt.forEach(((t,e)=>{let s=!0;e.forEachWhile((t=>{const e=this.Xt(t);return!e||2===e.purpose||(s=!1,!1)})),s&&(n=n.add(t))})),this.Ut.forEach(((e,n)=>n.setReadTime(t)));const s=new ba(t,e,this.Kt,this.Ut,n);return this.Ut=ca(),this.qt=Aa(),this.Kt=new Yr(ar),s}Qt(t,e){if(!this.Ht(t))return;const n=this.ee(t,e.key)?2:0;this.zt(t).kt(e.key,n),this.Ut=this.Ut.insert(e.key,e),this.qt=this.qt.insert(e.key,this.ne(e.key).add(t))}jt(t,e,n){if(!this.Ht(t))return;const s=this.zt(t);this.ee(t,e)?s.kt(e,1):s.Mt(e),this.qt=this.qt.insert(e,this.ne(e).delete(t)),n&&(this.Ut=this.Ut.insert(e,n))}removeTarget(t){this.Lt.delete(t)}Zt(t){const e=this.zt(t).xt();return this.Bt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Ot(t){this.zt(t).Ot()}zt(t){let e=this.Lt.get(t);return e||(e=new Da,this.Lt.set(t,e)),e}ne(t){let e=this.qt.get(t);return e||(e=new Yr(ar),this.qt=this.qt.insert(t,e)),e}Ht(t){const e=null!==this.Xt(t);return e||Bs("WatchChangeAggregator","Detected inactive target",t),e}Xt(t){const e=this.Lt.get(t);return e&&e.St?null:this.Bt.se(t)}Jt(t){this.Lt.set(t,new Da),this.Bt.getRemoteKeysForTarget(t).forEach((e=>{this.jt(t,e,null)}))}ee(t,e){return this.Bt.getRemoteKeysForTarget(t).has(e)}}function Aa(){return new Qr(pr.comparator)}function Ca(){return new Qr(pr.comparator)}const Na={asc:"ASCENDING",desc:"DESCENDING"},ka={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Ra{constructor(t,e){this.databaseId=t,this.gt=e}}function La(t,e){return t.gt?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Ma(t,e){return t.gt?e.toBase64():e.toUint8Array()}function Oa(t,e){return La(t,e.toTimestamp())}function Va(t){return js(!!t),lr.fromTimestamp(function(t){const e=si(t);return new hr(e.seconds,e.nanos)}(t))}function Fa(t,e){return function(t){return new fr(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function Pa(t){const e=fr.fromString(t);return js(ou(e)),e}function Ba(t,e){return Fa(t.databaseId,e.path)}function Ua(t,e){const n=Pa(e);if(n.get(1)!==t.databaseId.projectId)throw new Hs(Qs.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Hs(Qs.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new pr(ja(n))}function qa(t,e){return Fa(t.databaseId,e)}function Ga(t){const e=Pa(t);return 4===e.length?fr.emptyPath():ja(e)}function Ka(t){return new fr(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function ja(t){return js(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function $a(t,e,n){return{name:Ba(t,e),fields:n.value.mapValue.fields}}function za(t,e,n){const s=Ua(t,e.name),r=Va(e.updateTime),i=new Oi({mapValue:{fields:e.fields}}),o=Fi.newFoundDocument(s,r,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Qa(t,e){let n;if(e instanceof Wo)n={update:$a(t,e.key,e.value)};else if(e instanceof ta)n={delete:Ba(t,e.key)};else if(e instanceof Yo)n={update:$a(t,e.key,e.data),updateMask:iu(e.fieldMask)};else{if(!(e instanceof ea))return Ks();n={verify:Ba(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof ko)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Ro)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Mo)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Vo)return{fieldPath:e.field.canonicalString(),increment:n.yt};throw Ks()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:Oa(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:Ks()}(t,e.precondition)),n}function Ha(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?qo.updateTime(Va(t.updateTime)):void 0!==t.exists?qo.exists(t.exists):qo.none()}(e.currentDocument):qo.none(),s=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)js("REQUEST_TIME"===e.setToServerValue),n=new ko;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new Ro(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new Mo(t)}else"increment"in e?n=new Vo(t,e.increment):Ks();const s=gr.fromServerFormat(e.fieldPath);return new Bo(s,n)}(t,e))):[];if(e.update){e.update.name;const r=Ua(t,e.update.name),i=new Oi({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new Zr(e.map((t=>gr.fromServerFormat(t))))}(e.updateMask);return new Yo(r,i,t,n,s)}return new Wo(r,i,n,s)}if(e.delete){const s=Ua(t,e.delete);return new ta(s,n)}if(e.verify){const s=Ua(t,e.verify);return new ea(s,n)}return Ks()}function Wa(t,e){return{documents:[qa(t,e.path)]}}function Ya(t,e){const n={structuredQuery:{}},s=e.path;null!==e.collectionGroup?(n.parent=qa(t,s),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=qa(t,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const r=function(t){if(0===t.length)return;const e=t.map((t=>function(t){if("=="===t.op){if(_i(t.value))return{unaryFilter:{field:eu(t.field),op:"IS_NAN"}};if(Di(t.value))return{unaryFilter:{field:eu(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(_i(t.value))return{unaryFilter:{field:eu(t.field),op:"IS_NOT_NAN"}};if(Di(t.value))return{unaryFilter:{field:eu(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:eu(t.field),op:tu(t.op),value:t.value}}}(t)));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(e.filters);r&&(n.structuredQuery.where=r);const i=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:eu(t.field),direction:Za(t.dir)}}(t)))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(t,e){return t.gt||li(e)?e:{value:e}}(t,e.limit);var a;return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt={before:(a=e.startAt).inclusive,values:a.position}),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),n}function Xa(t){let e=Ga(t.parent);const n=t.structuredQuery,s=n.from?n.from.length:0;let r=null;if(s>0){js(1===s);const t=n.from[0];t.allDescendants?r=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=Ja(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new no(nu(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,li(e)?null:e}(n.limit));let u=null;n.startAt&&(u=function(t){const e=!!t.before,n=t.values||[];return new eo(n,e)}(n.startAt));let c=null;return n.endAt&&(c=function(t){const e=!t.before,n=t.values||[];return new eo(n,e)}(n.endAt)),ao(e,r,o,i,a,"F",u,c)}function Ja(t){return t?void 0!==t.unaryFilter?[ru(t)]:void 0!==t.fieldFilter?[su(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((t=>Ja(t))).reduce(((t,e)=>t.concat(e))):Ks():[]}function Za(t){return Na[t]}function tu(t){return ka[t]}function eu(t){return{fieldPath:t.canonicalString()}}function nu(t){return gr.fromServerFormat(t.fieldPath)}function su(t){return zi.create(nu(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Ks()}}(t.fieldFilter.op),t.fieldFilter.value)}function ru(t){switch(t.unaryFilter.op){case"IS_NAN":const e=nu(t.unaryFilter.field);return zi.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=nu(t.unaryFilter.field);return zi.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=nu(t.unaryFilter.field);return zi.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=nu(t.unaryFilter.field);return zi.create(r,"!=",{nullValue:"NULL_VALUE"});default:return Ks()}}function iu(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function ou(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function au(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=cu(e)),e=uu(t.get(n),e);return cu(e)}function uu(t,e){let n=e;const s=t.length;for(let e=0;e<s;e++){const s=t.charAt(e);switch(s){case"\0":n+="";break;case"":n+="";break;default:n+=s}}return n}function cu(t){return t+""}function hu(t){const e=t.length;if(js(e>=2),2===e)return js(""===t.charAt(0)&&""===t.charAt(1)),fr.emptyPath();const n=e-2,s=[];let r="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&Ks(),t.charAt(e+1)){case"":const n=t.substring(i,e);let o;0===r.length?o=n:(r+=n,o=r,r=""),s.push(o);break;case"":r+=t.substring(i,e),r+="\0";break;case"":r+=t.substring(i,e+1);break;default:Ks()}i=e+2}return new fr(s)}const lu=["userId","batchId"];function du(t,e){return[t,au(e)]}function fu(t,e,n){return[t,au(e),n]}const mu={},gu=["prefixPath","collectionGroup","readTime","documentId"],pu=["prefixPath","collectionGroup","documentId"],yu=["collectionGroup","readTime","prefixPath","documentId"],wu=["canonicalId","targetId"],vu=["targetId","path"],Iu=["path","targetId"],bu=["collectionId","parent"],Eu=["indexId","uid"],Tu=["uid","sequenceNumber"],Su=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],xu=["indexId","uid","orderedDocumentKey"],Du=["userId","collectionPath","documentId"],_u=["userId","collectionPath","largestBatchId"],Au=["userId","collectionGroup","largestBatchId"],Cu=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Nu=[...Cu,"documentOverlays"],ku=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Ru=ku,Lu=[...Ru,"indexConfiguration","indexState","indexEntries"];class Mu extends Cr{constructor(t,e){super(),this.ie=t,this.currentSequenceNumber=e}}function Ou(t,e){const n=zs(t);return Lr.O(n.ie,e)}class Vu{constructor(t,e,n,s){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const s=this.mutations[e];s.key.isEqual(t.key)&&$o(s,t,n[e])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=zo(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=zo(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=ma();return this.mutations.forEach((s=>{const r=t.get(s.key),i=r.overlayedDocument;let o=this.applyToLocalView(i,r.mutatedFields);o=e.has(s.key)?null:o;const a=jo(i,o);null!==a&&n.set(s.key,a),i.isValidDocument()||i.convertToNoDocument(lr.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),wa())}isEqual(t){return this.batchId===t.batchId&&ur(this.mutations,t.mutations,((t,e)=>Ho(t,e)))&&ur(this.baseMutations,t.baseMutations,((t,e)=>Ho(t,e)))}}class Fu{constructor(t,e,n,s){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=s}static from(t,e,n){js(t.mutations.length===n.length);let s=pa;const r=t.mutations;for(let t=0;t<r.length;t++)s=s.insert(r[t].key,n[t].version);return new Fu(t,e,n,s)}}class Pu{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Bu{constructor(t,e,n,s,r=lr.min(),i=lr.min(),o=ei.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new Bu(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new Bu(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new Bu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class Uu{constructor(t){this.re=t}}function qu(t,e){const n=e.key,s={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Gu(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())s.document=function(t,e){return{name:Ba(t,e.key),fields:e.data.value.mapValue.fields,updateTime:La(t,e.version.toTimestamp())}}(t.re,e);else if(e.isNoDocument())s.noDocument={path:n.path.toArray(),readTime:Ku(e.version)};else{if(!e.isUnknownDocument())return Ks();s.unknownDocument={path:n.path.toArray(),version:Ku(e.version)}}return s}function Gu(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function Ku(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function ju(t){const e=new hr(t.seconds,t.nanoseconds);return lr.fromTimestamp(e)}function $u(t,e){const n=(e.baseMutations||[]).map((e=>Ha(t.re,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const s=e.mutations[t+1];n.updateTransforms=s.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const s=e.mutations.map((e=>Ha(t.re,e))),r=hr.fromMillis(e.localWriteTimeMs);return new Vu(e.batchId,r,n,s)}function zu(t){const e=ju(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?ju(t.lastLimboFreeSnapshotVersion):lr.min();let s;var r;return void 0!==t.query.documents?(js(1===(r=t.query).documents.length),s=go(uo(Ga(r.documents[0])))):s=function(t){return go(Xa(t))}(t.query),new Bu(s,t.targetId,0,t.lastListenSequenceNumber,e,n,ei.fromBase64String(t.resumeToken))}function Qu(t,e){const n=Ku(e.snapshotVersion),s=Ku(e.lastLimboFreeSnapshotVersion);let r;r=Gi(e.target)?Wa(t.re,e.target):Ya(t.re,e.target);const i=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Ui(e.target),readTime:n,resumeToken:i,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:s,query:r}}function Hu(t){const e=Xa({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?po(e,e.limit,"L"):e}function Wu(t,e){return new Pu(e.largestBatchId,Ha(t.re,e.overlayMutation))}function Yu(t,e){const n=e.path.lastSegment();return[t,au(e.path.popLast()),n]}function Xu(t,e,n,s){return{indexId:t,uid:e.uid||"",sequenceNumber:n,readTime:Ku(s.readTime),documentKey:au(s.documentKey.path),largestBatchId:s.largestBatchId}}class Ju{getBundleMetadata(t,e){return Zu(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:ju(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return Zu(t).put({bundleId:(n=e).id,createTime:Ku(Va(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return tc(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:Hu(e.bundledQuery),readTime:ju(e.readTime)};var e}))}saveNamedQuery(t,e){return tc(t).put(function(t){return{name:t.name,readTime:Ku(Va(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function Zu(t){return Ou(t,"bundles")}function tc(t){return Ou(t,"namedQueries")}class ec{constructor(t,e){this.It=t,this.userId=e}static oe(t,e){const n=e.uid||"";return new ec(t,n)}getOverlay(t,e){return nc(t).get(Yu(this.userId,e)).next((t=>t?Wu(this.It,t):null))}getOverlays(t,e){const n=fa();return kr.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const s=[];return n.forEach(((n,r)=>{const i=new Pu(e,r);s.push(this.ue(t,i))})),kr.waitFor(s)}removeOverlaysForBatchId(t,e,n){const s=new Set;e.forEach((t=>s.add(au(t.getCollectionPath()))));const r=[];return s.forEach((e=>{const s=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);r.push(nc(t).Y("collectionPathOverlayIndex",s))})),kr.waitFor(r)}getOverlaysForCollection(t,e,n){const s=fa(),r=au(e),i=IDBKeyRange.bound([this.userId,r,n],[this.userId,r,Number.POSITIVE_INFINITY],!0);return nc(t).W("collectionPathOverlayIndex",i).next((t=>{for(const e of t){const t=Wu(this.It,e);s.set(t.getKey(),t)}return s}))}getOverlaysForCollectionGroup(t,e,n,s){const r=fa();let i;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return nc(t).Z({index:"collectionGroupOverlayIndex",range:o},((t,e,n)=>{const o=Wu(this.It,e);r.size()<s||o.largestBatchId===i?(r.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>r))}ue(t,e){return nc(t).put(function(t,e,n){const[s,r,i]=Yu(e,n.mutation.key);return{userId:e,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Qa(t.re,n.mutation)}}(this.It,this.userId,e))}}function nc(t){return Ou(t,"documentOverlays")}class sc{constructor(){}ce(t,e){this.ae(t,e),e.he()}ae(t,e){if("nullValue"in t)this.le(e,5);else if("booleanValue"in t)this.le(e,10),e.fe(t.booleanValue?1:0);else if("integerValue"in t)this.le(e,15),e.fe(ri(t.integerValue));else if("doubleValue"in t){const n=ri(t.doubleValue);isNaN(n)?this.le(e,13):(this.le(e,15),di(n)?e.fe(0):e.fe(n))}else if("timestampValue"in t){const n=t.timestampValue;this.le(e,20),"string"==typeof n?e.de(n):(e.de(`${n.seconds||""}`),e.fe(n.nanos||0))}else if("stringValue"in t)this._e(t.stringValue,e),this.we(e);else if("bytesValue"in t)this.le(e,30),e.me(ii(t.bytesValue)),this.we(e);else if("referenceValue"in t)this.ge(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.le(e,45),e.fe(n.latitude||0),e.fe(n.longitude||0)}else"mapValue"in t?Ni(t)?this.le(e,Number.MAX_SAFE_INTEGER):(this.ye(t.mapValue,e),this.we(e)):"arrayValue"in t?(this.pe(t.arrayValue,e),this.we(e)):Ks()}_e(t,e){this.le(e,25),this.Ie(t,e)}Ie(t,e){e.de(t)}ye(t,e){const n=t.fields||{};this.le(e,55);for(const t of Object.keys(n))this._e(t,e),this.ae(n[t],e)}pe(t,e){const n=t.values||[];this.le(e,50);for(const t of n)this.ae(t,e)}ge(t,e){this.le(e,37),pr.fromName(t).path.forEach((t=>{this.le(e,60),this.Ie(t,e)}))}le(t,e){t.fe(e)}we(t){t.fe(2)}}function rc(t){if(0===t)return 8;let e=0;return t>>4==0&&(e+=4,t<<=4),t>>6==0&&(e+=2,t<<=2),t>>7==0&&(e+=1),e}function ic(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const s=rc(255&t[n]);if(e+=s,8!==s)break}return e}(t);return Math.ceil(e/8)}sc.Te=new sc;class oc{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ee(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ae(n.value),n=e.next();this.Re()}be(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Pe(n.value),n=e.next();this.ve()}Ve(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ae(t);else if(t<2048)this.Ae(960|t>>>6),this.Ae(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ae(480|t>>>12),this.Ae(128|63&t>>>6),this.Ae(128|63&t);else{const t=e.codePointAt(0);this.Ae(240|t>>>18),this.Ae(128|63&t>>>12),this.Ae(128|63&t>>>6),this.Ae(128|63&t)}}this.Re()}Se(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Pe(t);else if(t<2048)this.Pe(960|t>>>6),this.Pe(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Pe(480|t>>>12),this.Pe(128|63&t>>>6),this.Pe(128|63&t);else{const t=e.codePointAt(0);this.Pe(240|t>>>18),this.Pe(128|63&t>>>12),this.Pe(128|63&t>>>6),this.Pe(128|63&t)}}this.ve()}De(t){const e=this.Ce(t),n=ic(e);this.xe(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}Ne(t){const e=this.Ce(t),n=ic(e);this.xe(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}ke(){this.Me(255),this.Me(255)}Oe(){this.Fe(255),this.Fe(255)}reset(){this.position=0}seed(t){this.xe(t.length),this.buffer.set(t,this.position),this.position+=t.length}$e(){return this.buffer.slice(0,this.position)}Ce(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=0!=(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}Ae(t){const e=255&t;0===e?(this.Me(0),this.Me(255)):255===e?(this.Me(255),this.Me(0)):this.Me(e)}Pe(t){const e=255&t;0===e?(this.Fe(0),this.Fe(255)):255===e?(this.Fe(255),this.Fe(0)):this.Fe(t)}Re(){this.Me(0),this.Me(1)}ve(){this.Fe(0),this.Fe(1)}Me(t){this.xe(1),this.buffer[this.position++]=t}Fe(t){this.xe(1),this.buffer[this.position++]=~t}xe(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const s=new Uint8Array(n);s.set(this.buffer),this.buffer=s}}class ac{constructor(t){this.Be=t}me(t){this.Be.Ee(t)}de(t){this.Be.Ve(t)}fe(t){this.Be.De(t)}he(){this.Be.ke()}}class uc{constructor(t){this.Be=t}me(t){this.Be.be(t)}de(t){this.Be.Se(t)}fe(t){this.Be.Ne(t)}he(){this.Be.Oe()}}class cc{constructor(){this.Be=new oc,this.Le=new ac(this.Be),this.Ue=new uc(this.Be)}seed(t){this.Be.seed(t)}qe(t){return 0===t?this.Le:this.Ue}$e(){return this.Be.$e()}reset(){this.Be.reset()}}class hc{constructor(t,e,n,s){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=s}Ke(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new hc(this.indexId,this.documentKey,this.arrayValue,n)}}function lc(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=dc(t.arrayValue,e.arrayValue),0!==n?n:(n=dc(t.directionalValue,e.directionalValue),0!==n?n:pr.comparator(t.documentKey,e.documentKey)))}function dc(t,e){for(let n=0;n<t.length&&n<e.length;++n){const s=t[n]-e[n];if(0!==s)return s}return t.length-e.length}class fc{constructor(t){this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Ge=t.orderBy,this.Qe=[];for(const e of t.filters){const t=e;t.dt()?this.je=t:this.Qe.push(t)}}We(t){const e=wr(t);if(void 0!==e&&!this.ze(e))return!1;const n=vr(t);let s=0,r=0;for(;s<n.length&&this.ze(n[s]);++s);if(s===n.length)return!0;if(void 0!==this.je){const t=n[s];if(!this.He(this.je,t)||!this.Je(this.Ge[r++],t))return!1;++s}for(;s<n.length;++s){const t=n[s];if(r>=this.Ge.length||!this.Je(this.Ge[r++],t))return!1}return!0}ze(t){for(const e of this.Qe)if(this.He(e,t))return!0;return!1}He(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}Je(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}class mc{constructor(){this.Ye=new gc}addToCollectionParentIndex(t,e){return this.Ye.add(e),kr.resolve()}getCollectionParents(t,e){return kr.resolve(this.Ye.getEntries(e))}addFieldIndex(t,e){return kr.resolve()}deleteFieldIndex(t,e){return kr.resolve()}getDocumentsMatchingTarget(t,e){return kr.resolve(null)}getIndexType(t,e){return kr.resolve(0)}getFieldIndexes(t,e){return kr.resolve([])}getNextCollectionGroupToUpdate(t){return kr.resolve(null)}getMinOffset(t,e){return kr.resolve(Dr.min())}getMinOffsetFromCollectionGroup(t,e){return kr.resolve(Dr.min())}updateCollectionGroup(t,e,n){return kr.resolve()}updateIndexEntries(t,e){return kr.resolve()}}class gc{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e]||new Yr(fr.comparator),r=!s.has(n);return this.index[e]=s.add(n),r}has(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e];return s&&s.has(n)}getEntries(t){return(this.index[t]||new Yr(fr.comparator)).toArray()}}const pc=new Uint8Array(0);class yc{constructor(t,e){this.user=t,this.databaseId=e,this.Xe=new gc,this.Ze=new aa((t=>Ui(t)),((t,e)=>qi(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.Xe.has(e)){const n=e.lastSegment(),s=e.popLast();t.addOnCommittedListener((()=>{this.Xe.add(e)}));const r={collectionId:n,parent:au(s)};return wc(t).put(r)}return kr.resolve()}getCollectionParents(t,e){const n=[],s=IDBKeyRange.bound([e,""],[cr(e),""],!1,!0);return wc(t).W(s).next((t=>{for(const s of t){if(s.collectionId!==e)break;n.push(hu(s.parent))}return n}))}addFieldIndex(t,e){const n=Ic(t),s=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete s.indexId;const r=n.add(s);if(e.indexState){const n=bc(t);return r.next((t=>{n.put(Xu(t,this.user,e.indexState.sequenceNumber,e.indexState.offset))}))}return r.next()}deleteFieldIndex(t,e){const n=Ic(t),s=bc(t),r=vc(t);return n.delete(e.indexId).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}getDocumentsMatchingTarget(t,e){const n=vc(t);let s=!0;const r=new Map;return kr.forEach(this.tn(e),(e=>this.en(t,e).next((t=>{s&&(s=!!t),r.set(e,t)})))).next((()=>{if(s){let t=wa();const s=[];return kr.forEach(r,((r,i)=>{var o;Bs("IndexedDbIndexManager",`Using index ${o=r,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`} to execute ${Ui(e)}`);const a=function(t,e){const n=wr(e);if(void 0===n)return null;for(const e of Ki(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(i,r),u=function(t,e){const n=new Map;for(const s of vr(e))for(const e of Ki(t,s.fieldPath))switch(e.op){case"==":case"in":n.set(s.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(s.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(i,r),c=function(t,e){const n=[];let s=!0;for(const r of vr(e)){const e=0===r.kind?ji(t,r.fieldPath,t.startAt):$i(t,r.fieldPath,t.startAt);n.push(e.value),s&&(s=e.inclusive)}return new eo(n,s)}(i,r),h=function(t,e){const n=[];let s=!0;for(const r of vr(e)){const e=0===r.kind?$i(t,r.fieldPath,t.endAt):ji(t,r.fieldPath,t.endAt);n.push(e.value),s&&(s=e.inclusive)}return new eo(n,s)}(i,r),l=this.nn(r,i,c),d=this.nn(r,i,h),f=this.sn(r,i,u),m=this.rn(r.indexId,a,l,c.inclusive,d,h.inclusive,f);return kr.forEach(m,(r=>n.J(r,e.limit).next((e=>{e.forEach((e=>{const n=pr.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),s.push(n))}))}))))})).next((()=>s))}return kr.resolve(null)}))}tn(t){let e=this.Ze.get(t);return e||(e=[t],this.Ze.set(t,e),e)}rn(t,e,n,s,r,i,o){const a=(null!=e?e.length:1)*Math.max(n.length,r.length),u=a/(null!=e?e.length:1),c=[];for(let h=0;h<a;++h){const a=e?this.on(e[h/u]):pc,l=this.un(t,a,n[h%u],s),d=this.cn(t,a,r[h%u],i),f=o.map((e=>this.un(t,a,e,!0)));c.push(...this.createRange(l,d,f))}return c}un(t,e,n,s){const r=new hc(t,pr.empty(),e,n);return s?r:r.Ke()}cn(t,e,n,s){const r=new hc(t,pr.empty(),e,n);return s?r.Ke():r}en(t,e){const n=new fc(e),s=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,s).next((t=>{let e=null;for(const s of t)n.We(s)&&(!e||s.fields.length>e.fields.length)&&(e=s);return e}))}getIndexType(t,e){let n=2;return kr.forEach(this.tn(e),(e=>this.en(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new Yr(gr.comparator),n=!1;for(const s of t.filters){const t=s;t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field))}for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>n))}an(t,e){const n=new cc;for(const s of vr(t)){const t=e.data.field(s.fieldPath);if(null==t)return null;const r=n.qe(s.kind);sc.Te.ce(t,r)}return n.$e()}on(t){const e=new cc;return sc.Te.ce(t,e.qe(0)),e.$e()}hn(t,e){const n=new cc;return sc.Te.ce(Ti(this.databaseId,e),n.qe(function(t){const e=vr(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.$e()}sn(t,e,n){if(null===n)return[];let s=[];s.push(new cc);let r=0;for(const i of vr(t)){const t=n[r++];for(const n of s)if(this.ln(e,i.fieldPath)&&xi(t))s=this.fn(s,i,t);else{const e=n.qe(i.kind);sc.Te.ce(t,e)}}return this.dn(s)}nn(t,e,n){return this.sn(t,e,n.position)}dn(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].$e();return e}fn(t,e,n){const s=[...t],r=[];for(const t of n.arrayValue.values||[])for(const n of s){const s=new cc;s.seed(n.$e()),sc.Te.ce(t,s.qe(e.kind)),r.push(s)}return r}ln(t,e){return!!t.filters.find((t=>t instanceof zi&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=Ic(t),s=bc(t);return(e?n.W("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.W()).next((t=>{const e=[];return kr.forEach(t,(t=>s.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new Tr(e.sequenceNumber,new Dr(ju(e.readTime),new pr(hu(e.documentKey)),e.largestBatchId)):Tr.empty(),s=t.fields.map((([t,e])=>new br(gr.fromServerFormat(t),e)));return new yr(t.indexId,t.collectionGroup,s,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:ar(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const s=Ic(t),r=bc(t);return this._n(t).next((t=>s.W("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>kr.forEach(e,(e=>r.put(Xu(e.indexId,this.user,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return kr.forEach(e,((e,s)=>{const r=n.get(e.collectionGroup);return(r?kr.resolve(r):this.getFieldIndexes(t,e.collectionGroup)).next((r=>(n.set(e.collectionGroup,r),kr.forEach(r,(n=>this.wn(t,e,n).next((e=>{const r=this.mn(s,n);return e.isEqual(r)?kr.resolve():this.gn(t,s,n,e,r)})))))))}))}yn(t,e,n,s){return vc(t).put({indexId:s.indexId,uid:this.uid,arrayValue:s.arrayValue,directionalValue:s.directionalValue,orderedDocumentKey:this.hn(n,e.key),documentKey:e.key.path.toArray()})}pn(t,e,n,s){return vc(t).delete([s.indexId,this.uid,s.arrayValue,s.directionalValue,this.hn(n,e.key),e.key.path.toArray()])}wn(t,e,n){const s=vc(t);let r=new Yr(lc);return s.Z({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.hn(n,e)])},((t,s)=>{r=r.add(new hc(n.indexId,e,s.arrayValue,s.directionalValue))})).next((()=>r))}mn(t,e){let n=new Yr(lc);const s=this.an(e,t);if(null==s)return n;const r=wr(e);if(null!=r){const i=t.data.field(r.fieldPath);if(xi(i))for(const r of i.arrayValue.values||[])n=n.add(new hc(e.indexId,t.key,this.on(r),s))}else n=n.add(new hc(e.indexId,t.key,pc,s));return n}gn(t,e,n,s,r){Bs("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const i=[];return function(t,e,n,s,r){const i=t.getIterator(),o=e.getIterator();let a=Jr(i),u=Jr(o);for(;a||u;){let t=!1,e=!1;if(a&&u){const s=n(a,u);s<0?e=!0:s>0&&(t=!0)}else null!=a?e=!0:t=!0;t?(s(u),u=Jr(o)):e?(r(a),a=Jr(i)):(a=Jr(i),u=Jr(o))}}(s,r,lc,(s=>{i.push(this.yn(t,e,n,s))}),(s=>{i.push(this.pn(t,e,n,s))})),kr.waitFor(i)}_n(t){let e=1;return bc(t).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,s)=>{s.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>lc(t,e))).filter(((t,e,n)=>!e||0!==lc(t,n[e-1])));const s=[];s.push(t);for(const r of n){const n=lc(r,t),i=lc(r,e);if(0===n)s[0]=t.Ke();else if(n>0&&i<0)s.push(r),s.push(r.Ke());else if(i>0)break}s.push(e);const r=[];for(let t=0;t<s.length;t+=2)r.push(IDBKeyRange.bound([s[t].indexId,this.uid,s[t].arrayValue,s[t].directionalValue,pc,[]],[s[t+1].indexId,this.uid,s[t+1].arrayValue,s[t+1].directionalValue,pc,[]]));return r}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(Ec)}getMinOffset(t,e){return kr.mapArray(this.tn(e),(e=>this.en(t,e).next((t=>t||Ks())))).next(Ec)}}function wc(t){return Ou(t,"collectionParents")}function vc(t){return Ou(t,"indexEntries")}function Ic(t){return Ou(t,"indexConfiguration")}function bc(t){return Ou(t,"indexState")}function Ec(t){js(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let s=1;s<t.length;s++){const r=t[s].indexState.offset;_r(r,e)<0&&(e=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new Dr(e.readTime,e.documentKey,n)}const Tc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Sc{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Sc(t,Sc.DEFAULT_COLLECTION_PERCENTILE,Sc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function xc(t,e,n){const s=t.store("mutations"),r=t.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=s.Z({range:o},((t,e,n)=>(a++,n.delete())));i.push(u.next((()=>{js(1===a)})));const c=[];for(const t of n.mutations){const s=fu(e,t.key.path,n.batchId);i.push(r.delete(s)),c.push(t.key)}return kr.waitFor(i).next((()=>c))}function Dc(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Ks();e=t.noDocument}return JSON.stringify(e).length}Sc.DEFAULT_COLLECTION_PERCENTILE=10,Sc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Sc.DEFAULT=new Sc(41943040,Sc.DEFAULT_COLLECTION_PERCENTILE,Sc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Sc.DISABLED=new Sc(-1,0,0);class _c{constructor(t,e,n,s){this.userId=t,this.It=e,this.indexManager=n,this.referenceDelegate=s,this.In={}}static oe(t,e,n,s){js(""!==t.uid);const r=t.isAuthenticated()?t.uid:"";return new _c(r,e,n,s)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Cc(t).Z({index:"userMutationsIndex",range:n},((t,n,s)=>{e=!1,s.done()})).next((()=>e))}addMutationBatch(t,e,n,s){const r=Nc(t),i=Cc(t);return i.add({}).next((o=>{js("number"==typeof o);const a=new Vu(o,e,n,s),u=function(t,e,n){const s=n.baseMutations.map((e=>Qa(t.re,e))),r=n.mutations.map((e=>Qa(t.re,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:s,mutations:r}}(this.It,this.userId,a),c=[];let h=new Yr(((t,e)=>ar(t.canonicalString(),e.canonicalString())));for(const t of s){const e=fu(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),c.push(i.put(u)),c.push(r.put(e,mu))}return h.forEach((e=>{c.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.In[o]=a.keys()})),kr.waitFor(c).next((()=>a))}))}lookupMutationBatch(t,e){return Cc(t).get(e).next((t=>t?(js(t.userId===this.userId),$u(this.It,t)):null))}Tn(t,e){return this.In[e]?kr.resolve(this.In[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.In[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=IDBKeyRange.lowerBound([this.userId,n]);let r=null;return Cc(t).Z({index:"userMutationsIndex",range:s},((t,e,s)=>{e.userId===this.userId&&(js(e.batchId>=n),r=$u(this.It,e)),s.done()})).next((()=>r))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Cc(t).Z({index:"userMutationsIndex",range:e,reverse:!0},((t,e,s)=>{n=e.batchId,s.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Cc(t).W("userMutationsIndex",e).next((t=>t.map((t=>$u(this.It,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=du(this.userId,e.path),s=IDBKeyRange.lowerBound(n),r=[];return Nc(t).Z({range:s},((n,s,i)=>{const[o,a,u]=n,c=hu(a);if(o===this.userId&&e.path.isEqual(c))return Cc(t).get(u).next((t=>{if(!t)throw Ks();js(t.userId===this.userId),r.push($u(this.It,t))}));i.done()})).next((()=>r))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Yr(ar);const s=[];return e.forEach((e=>{const r=du(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=Nc(t).Z({range:i},((t,s,r)=>{const[i,o,a]=t,u=hu(o);i===this.userId&&e.path.isEqual(u)?n=n.add(a):r.done()}));s.push(o)})),kr.waitFor(s).next((()=>this.En(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1,r=du(this.userId,n),i=IDBKeyRange.lowerBound(r);let o=new Yr(ar);return Nc(t).Z({range:i},((t,e,r)=>{const[i,a,u]=t,c=hu(a);i===this.userId&&n.isPrefixOf(c)?c.length===s&&(o=o.add(u)):r.done()})).next((()=>this.En(t,o)))}En(t,e){const n=[],s=[];return e.forEach((e=>{s.push(Cc(t).get(e).next((t=>{if(null===t)throw Ks();js(t.userId===this.userId),n.push($u(this.It,t))})))})),kr.waitFor(s).next((()=>n))}removeMutationBatch(t,e){return xc(t.ie,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.An(e.batchId)})),kr.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}An(t){delete this.In[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return kr.resolve();const n=IDBKeyRange.lowerBound([this.userId]),s=[];return Nc(t).Z({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=hu(t[1]);s.push(e)}else n.done()})).next((()=>{js(0===s.length)}))}))}containsKey(t,e){return Ac(t,this.userId,e)}Rn(t){return kc(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Ac(t,e,n){const s=du(e,n.path),r=s[1],i=IDBKeyRange.lowerBound(s);let o=!1;return Nc(t).Z({range:i,X:!0},((t,n,s)=>{const[i,a,u]=t;i===e&&a===r&&(o=!0),s.done()})).next((()=>o))}function Cc(t){return Ou(t,"mutations")}function Nc(t){return Ou(t,"documentMutations")}function kc(t){return Ou(t,"mutationQueues")}class Rc{constructor(t){this.bn=t}next(){return this.bn+=2,this.bn}static Pn(){return new Rc(0)}static vn(){return new Rc(-1)}}class Lc{constructor(t,e){this.referenceDelegate=t,this.It=e}allocateTargetId(t){return this.Vn(t).next((e=>{const n=new Rc(e.highestTargetId);return e.highestTargetId=n.next(),this.Sn(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.Vn(t).next((t=>lr.fromTimestamp(new hr(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.Vn(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.Vn(t).next((s=>(s.highestListenSequenceNumber=e,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),e>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=e),this.Sn(t,s))))}addTargetData(t,e){return this.Dn(t,e).next((()=>this.Vn(t).next((n=>(n.targetCount+=1,this.Cn(e,n),this.Sn(t,n))))))}updateTargetData(t,e){return this.Dn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>Mc(t).delete(e.targetId))).next((()=>this.Vn(t))).next((e=>(js(e.targetCount>0),e.targetCount-=1,this.Sn(t,e))))}removeTargets(t,e,n){let s=0;const r=[];return Mc(t).Z(((i,o)=>{const a=zu(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(s++,r.push(this.removeTargetData(t,a)))})).next((()=>kr.waitFor(r))).next((()=>s))}forEachTarget(t,e){return Mc(t).Z(((t,n)=>{const s=zu(n);e(s)}))}Vn(t){return Oc(t).get("targetGlobalKey").next((t=>(js(null!==t),t)))}Sn(t,e){return Oc(t).put("targetGlobalKey",e)}Dn(t,e){return Mc(t).put(Qu(this.It,e))}Cn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Vn(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Ui(e),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return Mc(t).Z({range:s,index:"queryTargetsIndex"},((t,n,s)=>{const i=zu(n);qi(e,i.target)&&(r=i,s.done())})).next((()=>r))}addMatchingKeys(t,e,n){const s=[],r=Vc(t);return e.forEach((e=>{const i=au(e.path);s.push(r.put({targetId:n,path:i})),s.push(this.referenceDelegate.addReference(t,n,e))})),kr.waitFor(s)}removeMatchingKeys(t,e,n){const s=Vc(t);return kr.forEach(e,(e=>{const r=au(e.path);return kr.waitFor([s.delete([n,r]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=Vc(t),s=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),s=Vc(t);let r=wa();return s.Z({range:n,X:!0},((t,e,n)=>{const s=hu(t[1]),i=new pr(s);r=r.add(i)})).next((()=>r))}containsKey(t,e){const n=au(e.path),s=IDBKeyRange.bound([n],[cr(n)],!1,!0);let r=0;return Vc(t).Z({index:"documentTargetsIndex",X:!0,range:s},(([t,e],n,s)=>{0!==t&&(r++,s.done())})).next((()=>r>0))}se(t,e){return Mc(t).get(e).next((t=>t?zu(t):null))}}function Mc(t){return Ou(t,"targets")}function Oc(t){return Ou(t,"targetGlobal")}function Vc(t){return Ou(t,"targetDocuments")}function Fc([t,e],[n,s]){const r=ar(t,n);return 0===r?ar(e,s):r}class Pc{constructor(t){this.xn=t,this.buffer=new Yr(Fc),this.Nn=0}kn(){return++this.Nn}Mn(t){const e=[t,this.kn()];if(this.buffer.size<this.xn)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();Fc(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Bc{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.On=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Fn(6e4)}stop(){this.On&&(this.On.cancel(),this.On=null)}get started(){return null!==this.On}Fn(t){Bs("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.On=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.On=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){Vr(t)?Bs("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await Nr(t)}await this.Fn(3e5)}))}}class Uc{constructor(t,e){this.$n=t,this.params=e}calculateTargetCount(t,e){return this.$n.Bn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return kr.resolve(Kr.at);const n=new Pc(e);return this.$n.forEachTarget(t,(t=>n.Mn(t.sequenceNumber))).next((()=>this.$n.Ln(t,(t=>n.Mn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.$n.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.$n.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(Bs("LruGarbageCollector","Garbage collection skipped; disabled"),kr.resolve(Tc)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(Bs("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Tc):this.Un(t,e)))}getCacheSize(t){return this.$n.getCacheSize(t)}Un(t,e){let n,s,r,i,o,a,u;const c=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(Bs("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),s=this.params.maximumSequenceNumbersToCollect):s=e,i=Date.now(),this.nthSequenceNumber(t,s)))).next((s=>(n=s,o=Date.now(),this.removeTargets(t,n,e)))).next((e=>(r=e,a=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(u=Date.now(),Fs()<=w.DEBUG&&Bs("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-c}ms\n\tDetermined least recently used ${s} in `+(o-i)+"ms\n"+`\tRemoved ${r} targets in `+(a-o)+"ms\n"+`\tRemoved ${t} documents in `+(u-a)+"ms\n"+`Total Duration: ${u-c}ms`),kr.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:r,documentsRemoved:t}))))}}class qc{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new Uc(t,e)}(this,e)}Bn(t){const e=this.qn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}qn(t){let e=0;return this.Ln(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Ln(t,e){return this.Kn(t,((t,n)=>e(n)))}addReference(t,e,n){return Gc(t,n)}removeReference(t,e,n){return Gc(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Gc(t,e)}Gn(t,e){return function(t,e){let n=!1;return kc(t).tt((s=>Ac(t,s,e).next((t=>(t&&(n=!0),kr.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let r=0;return this.Kn(t,((i,o)=>{if(o<=e){const e=this.Gn(t,i).next((e=>{if(!e)return r++,n.getEntry(t,i).next((()=>(n.removeEntry(i,lr.min()),Vc(t).delete([0,au(i.path)]))))}));s.push(e)}})).next((()=>kr.waitFor(s))).next((()=>n.apply(t))).next((()=>r))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Gc(t,e)}Kn(t,e){const n=Vc(t);let s,r=Kr.at;return n.Z({index:"documentTargetsIndex"},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(r!==Kr.at&&e(new pr(hu(s)),r),r=o,s=i):r=Kr.at})).next((()=>{r!==Kr.at&&e(new pr(hu(s)),r)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Gc(t,e){return Vc(t).put(function(t,e){return{targetId:0,path:au(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class Kc{constructor(){this.changes=new aa((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,Fi.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?kr.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class jc{constructor(t){this.It=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return Hc(t).put(n)}removeEntry(t,e,n){return Hc(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Gu(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.Qn(t,n))))}getEntry(t,e){let n=Fi.newInvalidDocument(e);return Hc(t).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Wc(e))},((t,s)=>{n=this.jn(e,s)})).next((()=>n))}Wn(t,e){let n={size:0,document:Fi.newInvalidDocument(e)};return Hc(t).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Wc(e))},((t,s)=>{n={document:this.jn(e,s),size:Dc(s)}})).next((()=>n))}getEntries(t,e){let n=ca();return this.zn(t,e,((t,e)=>{const s=this.jn(t,e);n=n.insert(t,s)})).next((()=>n))}Hn(t,e){let n=ca(),s=new Qr(pr.comparator);return this.zn(t,e,((t,e)=>{const r=this.jn(t,e);n=n.insert(t,r),s=s.insert(t,Dc(e))})).next((()=>({documents:n,Jn:s})))}zn(t,e,n){if(e.isEmpty())return kr.resolve();let s=new Yr(Xc);e.forEach((t=>s=s.add(t)));const r=IDBKeyRange.bound(Wc(s.first()),Wc(s.last())),i=s.getIterator();let o=i.getNext();return Hc(t).Z({index:"documentKeyIndex",range:r},((t,e,s)=>{const r=pr.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&Xc(o,r)<0;)n(o,null),o=i.getNext();o&&o.isEqual(r)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?s.j(Wc(o)):s.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getAllFromCollection(t,e,n){const s=[e.popLast().toArray(),e.lastSegment(),Gu(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],r=[e.popLast().toArray(),e.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Hc(t).W(IDBKeyRange.bound(s,r,!0)).next((t=>{let e=ca();for(const n of t){const t=this.jn(pr.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);e=e.insert(t.key,t)}return e}))}getAllFromCollectionGroup(t,e,n,s){let r=ca();const i=Yc(e,n),o=Yc(e,Dr.max());return Hc(t).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((t,e,n)=>{const i=this.jn(pr.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);r=r.insert(i.key,i),r.size===s&&n.done()})).next((()=>r))}newChangeBuffer(t){return new zc(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return Qc(t).get("remoteDocumentGlobalKey").next((t=>(js(!!t),t)))}Qn(t,e){return Qc(t).put("remoteDocumentGlobalKey",e)}jn(t,e){if(e){const t=function(t,e){let n;if(e.document)n=za(t.re,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=pr.fromSegments(e.noDocument.path),s=ju(e.noDocument.readTime);n=Fi.newNoDocument(t,s),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return Ks();{const t=pr.fromSegments(e.unknownDocument.path),s=ju(e.unknownDocument.version);n=Fi.newUnknownDocument(t,s)}}return e.readTime&&n.setReadTime(function(t){const e=new hr(t[0],t[1]);return lr.fromTimestamp(e)}(e.readTime)),n}(this.It,e);if(!t.isNoDocument()||!t.version.isEqual(lr.min()))return t}return Fi.newInvalidDocument(t)}}function $c(t){return new jc(t)}class zc extends Kc{constructor(t,e){super(),this.Yn=t,this.trackRemovals=e,this.Xn=new aa((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,s=new Yr(((t,e)=>ar(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((r,i)=>{const o=this.Xn.get(r);if(e.push(this.Yn.removeEntry(t,r,o.readTime)),i.isValidDocument()){const a=qu(this.Yn.It,i);s=s.add(r.path.popLast());const u=Dc(a);n+=u-o.size,e.push(this.Yn.addEntry(t,r,a))}else if(n-=o.size,this.trackRemovals){const n=qu(this.Yn.It,i.convertToNoDocument(lr.min()));e.push(this.Yn.addEntry(t,r,n))}})),s.forEach((n=>{e.push(this.Yn.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.Yn.updateMetadata(t,n)),kr.waitFor(e)}getFromCache(t,e){return this.Yn.Wn(t,e).next((t=>(this.Xn.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.Yn.Hn(t,e).next((({documents:t,Jn:e})=>(e.forEach(((e,n)=>{this.Xn.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function Qc(t){return Ou(t,"remoteDocumentGlobal")}function Hc(t){return Ou(t,"remoteDocumentsV14")}function Wc(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Yc(t,e){const n=e.documentKey.path.toArray();return[t,Gu(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Xc(t,e){const n=t.path.toArray(),s=e.path.toArray();let r=0;for(let t=0;t<n.length-2&&t<s.length-2;++t)if(r=ar(n[t],s[t]),r)return r;return r=ar(n.length,s.length),r||(r=ar(n[n.length-2],s[s.length-2]),r||ar(n[n.length-1],s[s.length-1]))}class Jc{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class Zc{constructor(t,e,n,s){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=s}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((s=>(n=s,this.getBaseDocument(t,e,n)))).next((t=>(null!==n&&zo(n.mutation,t,Zr.empty(),hr.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,wa()).next((()=>e))))}getLocalViewOfDocuments(t,e,n=wa()){const s=fa();return this.populateOverlays(t,s,e).next((()=>this.computeViews(t,e,s,n).next((t=>{let e=la();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=fa();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,wa())))}populateOverlays(t,e,n){const s=[];return n.forEach((t=>{e.has(t)||s.push(t)})),this.documentOverlayCache.getOverlays(t,s).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,s){let r=ca();const i=ga(),o=ga();return e.forEach(((t,e)=>{const o=n.get(e.key);s.has(e.key)&&(void 0===o||o.mutation instanceof Yo)?r=r.insert(e.key,e):void 0!==o&&(i.set(e.key,o.mutation.getFieldMask()),zo(o.mutation,e,o.mutation.getFieldMask(),hr.now()))})),this.recalculateAndSaveOverlays(t,r).next((t=>(t.forEach(((t,e)=>i.set(t,e))),e.forEach(((t,e)=>{var n;return o.set(t,new Jc(e,null!==(n=i.get(t))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(t,e){const n=ga();let s=new Qr(((t,e)=>t-e)),r=wa();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const r of t)r.keys().forEach((t=>{const i=e.get(t);if(null===i)return;let o=n.get(t)||Zr.empty();o=r.applyToLocalView(i,o),n.set(t,o);const a=(s.get(r.batchId)||wa()).add(t);s=s.insert(r.batchId,a)}))})).next((()=>{const i=[],o=s.getReverseIterator();for(;o.hasNext();){const s=o.getNext(),a=s.key,u=s.value,c=ma();u.forEach((t=>{if(!r.has(t)){const s=jo(e.get(t),n.get(t));null!==s&&c.set(t,s),r=r.add(t)}})),i.push(this.documentOverlayCache.saveOverlays(t,a,c))}return kr.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n){return function(t){return pr.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):fo(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n):this.getDocumentsMatchingCollectionQuery(t,e,n)}getNextDocuments(t,e,n,s){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,s).next((r=>{const i=s-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,s-r.size):kr.resolve(fa());let o=-1,a=r;return i.next((e=>kr.forEach(e,((e,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),r.get(e)?kr.resolve():this.getBaseDocument(t,e,n).next((t=>{a=a.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,r))).next((()=>this.computeViews(t,a,e,wa()))).next((t=>({batchId:o,changes:da(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new pr(e)).next((t=>{let e=la();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n){const s=e.collectionGroup;let r=la();return this.indexManager.getCollectionParents(t,s).next((i=>kr.forEach(i,(i=>{const o=function(t,e){return new oo(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(s));return this.getDocumentsMatchingCollectionQuery(t,o,n).next((t=>{t.forEach(((t,e)=>{r=r.insert(t,e)}))}))})).next((()=>r))))}getDocumentsMatchingCollectionQuery(t,e,n){let s;return this.remoteDocumentCache.getAllFromCollection(t,e.path,n).next((r=>(s=r,this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId)))).next((t=>{t.forEach(((t,e)=>{const n=e.getKey();null===s.get(n)&&(s=s.insert(n,Fi.newInvalidDocument(n)))}));let n=la();return s.forEach(((s,r)=>{const i=t.get(s);void 0!==i&&zo(i.mutation,r,Zr.empty(),hr.now()),Io(e,r)&&(n=n.insert(s,r))})),n}))}getBaseDocument(t,e,n){return null===n||1===n.mutation.type?this.remoteDocumentCache.getEntry(t,e):kr.resolve(Fi.newInvalidDocument(e))}}class th{constructor(t){this.It=t,this.Zn=new Map,this.ts=new Map}getBundleMetadata(t,e){return kr.resolve(this.Zn.get(e))}saveBundleMetadata(t,e){var n;return this.Zn.set(e.id,{id:(n=e).id,version:n.version,createTime:Va(n.createTime)}),kr.resolve()}getNamedQuery(t,e){return kr.resolve(this.ts.get(e))}saveNamedQuery(t,e){return this.ts.set(e.name,function(t){return{name:t.name,query:Hu(t.bundledQuery),readTime:Va(t.readTime)}}(e)),kr.resolve()}}class eh{constructor(){this.overlays=new Qr(pr.comparator),this.es=new Map}getOverlay(t,e){return kr.resolve(this.overlays.get(e))}getOverlays(t,e){const n=fa();return kr.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,s)=>{this.ue(t,e,s)})),kr.resolve()}removeOverlaysForBatchId(t,e,n){const s=this.es.get(n);return void 0!==s&&(s.forEach((t=>this.overlays=this.overlays.remove(t))),this.es.delete(n)),kr.resolve()}getOverlaysForCollection(t,e,n){const s=fa(),r=e.length+1,i=new pr(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===r&&t.largestBatchId>n&&s.set(t.getKey(),t)}return kr.resolve(s)}getOverlaysForCollectionGroup(t,e,n,s){let r=new Qr(((t,e)=>t-e));const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=r.get(t.largestBatchId);null===e&&(e=fa(),r=r.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=fa(),a=r.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=s)););return kr.resolve(o)}ue(t,e,n){const s=this.overlays.get(n.key);if(null!==s){const t=this.es.get(s.largestBatchId).delete(n.key);this.es.set(s.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new Pu(e,n));let r=this.es.get(e);void 0===r&&(r=wa(),this.es.set(e,r)),this.es.set(e,r.add(n.key))}}class nh{constructor(){this.ns=new Yr(sh.ss),this.rs=new Yr(sh.os)}isEmpty(){return this.ns.isEmpty()}addReference(t,e){const n=new sh(t,e);this.ns=this.ns.add(n),this.rs=this.rs.add(n)}us(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.cs(new sh(t,e))}hs(t,e){t.forEach((t=>this.removeReference(t,e)))}ls(t){const e=new pr(new fr([])),n=new sh(e,t),s=new sh(e,t+1),r=[];return this.rs.forEachInRange([n,s],(t=>{this.cs(t),r.push(t.key)})),r}fs(){this.ns.forEach((t=>this.cs(t)))}cs(t){this.ns=this.ns.delete(t),this.rs=this.rs.delete(t)}ds(t){const e=new pr(new fr([])),n=new sh(e,t),s=new sh(e,t+1);let r=wa();return this.rs.forEachInRange([n,s],(t=>{r=r.add(t.key)})),r}containsKey(t){const e=new sh(t,0),n=this.ns.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class sh{constructor(t,e){this.key=t,this._s=e}static ss(t,e){return pr.comparator(t.key,e.key)||ar(t._s,e._s)}static os(t,e){return ar(t._s,e._s)||pr.comparator(t.key,e.key)}}class rh{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.ws=1,this.gs=new Yr(sh.ss)}checkEmpty(t){return kr.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,s){const r=this.ws;this.ws++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Vu(r,e,n,s);this.mutationQueue.push(i);for(const e of s)this.gs=this.gs.add(new sh(e.key,r)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return kr.resolve(i)}lookupMutationBatch(t,e){return kr.resolve(this.ys(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=this.ps(n),r=s<0?0:s;return kr.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return kr.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(t){return kr.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new sh(e,0),s=new sh(e,Number.POSITIVE_INFINITY),r=[];return this.gs.forEachInRange([n,s],(t=>{const e=this.ys(t._s);r.push(e)})),kr.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Yr(ar);return e.forEach((t=>{const e=new sh(t,0),s=new sh(t,Number.POSITIVE_INFINITY);this.gs.forEachInRange([e,s],(t=>{n=n.add(t._s)}))})),kr.resolve(this.Is(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1;let r=n;pr.isDocumentKey(r)||(r=r.child(""));const i=new sh(new pr(r),0);let o=new Yr(ar);return this.gs.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===s&&(o=o.add(t._s)),!0)}),i),kr.resolve(this.Is(o))}Is(t){const e=[];return t.forEach((t=>{const n=this.ys(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){js(0===this.Ts(e.batchId,"removed")),this.mutationQueue.shift();let n=this.gs;return kr.forEach(e.mutations,(s=>{const r=new sh(s.key,e.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,s.key)})).next((()=>{this.gs=n}))}An(t){}containsKey(t,e){const n=new sh(e,0),s=this.gs.firstAfterOrEqual(n);return kr.resolve(e.isEqual(s&&s.key))}performConsistencyCheck(t){return this.mutationQueue.length,kr.resolve()}Ts(t,e){return this.ps(t)}ps(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}ys(t){const e=this.ps(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class ih{constructor(t){this.Es=t,this.docs=new Qr(pr.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,s=this.docs.get(n),r=s?s.size:0,i=this.Es(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-r,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return kr.resolve(n?n.document.mutableCopy():Fi.newInvalidDocument(e))}getEntries(t,e){let n=ca();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():Fi.newInvalidDocument(t))})),kr.resolve(n)}getAllFromCollection(t,e,n){let s=ca();const r=new pr(e.child("")),i=this.docs.getIteratorFrom(r);for(;i.hasNext();){const{key:t,value:{document:r}}=i.getNext();if(!e.isPrefixOf(t.path))break;t.path.length>e.length+1||_r(xr(r),n)<=0||(s=s.insert(r.key,r.mutableCopy()))}return kr.resolve(s)}getAllFromCollectionGroup(t,e,n,s){Ks()}As(t,e){return kr.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new oh(this)}getSize(t){return kr.resolve(this.size)}}class oh extends Kc{constructor(t){super(),this.Yn=t}applyChanges(t){const e=[];return this.changes.forEach(((n,s)=>{s.isValidDocument()?e.push(this.Yn.addEntry(t,s)):this.Yn.removeEntry(n)})),kr.waitFor(e)}getFromCache(t,e){return this.Yn.getEntry(t,e)}getAllFromCache(t,e){return this.Yn.getEntries(t,e)}}class ah{constructor(t){this.persistence=t,this.Rs=new aa((t=>Ui(t)),qi),this.lastRemoteSnapshotVersion=lr.min(),this.highestTargetId=0,this.bs=0,this.Ps=new nh,this.targetCount=0,this.vs=Rc.Pn()}forEachTarget(t,e){return this.Rs.forEach(((t,n)=>e(n))),kr.resolve()}getLastRemoteSnapshotVersion(t){return kr.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return kr.resolve(this.bs)}allocateTargetId(t){return this.highestTargetId=this.vs.next(),kr.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.bs&&(this.bs=e),kr.resolve()}Dn(t){this.Rs.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.vs=new Rc(e),this.highestTargetId=e),t.sequenceNumber>this.bs&&(this.bs=t.sequenceNumber)}addTargetData(t,e){return this.Dn(e),this.targetCount+=1,kr.resolve()}updateTargetData(t,e){return this.Dn(e),kr.resolve()}removeTargetData(t,e){return this.Rs.delete(e.target),this.Ps.ls(e.targetId),this.targetCount-=1,kr.resolve()}removeTargets(t,e,n){let s=0;const r=[];return this.Rs.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Rs.delete(i),r.push(this.removeMatchingKeysForTargetId(t,o.targetId)),s++)})),kr.waitFor(r).next((()=>s))}getTargetCount(t){return kr.resolve(this.targetCount)}getTargetData(t,e){const n=this.Rs.get(e)||null;return kr.resolve(n)}addMatchingKeys(t,e,n){return this.Ps.us(e,n),kr.resolve()}removeMatchingKeys(t,e,n){this.Ps.hs(e,n);const s=this.persistence.referenceDelegate,r=[];return s&&e.forEach((e=>{r.push(s.markPotentiallyOrphaned(t,e))})),kr.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.Ps.ls(e),kr.resolve()}getMatchingKeysForTargetId(t,e){const n=this.Ps.ds(e);return kr.resolve(n)}containsKey(t,e){return kr.resolve(this.Ps.containsKey(e))}}class uh{constructor(t,e){this.Vs={},this.overlays={},this.Ss=new Kr(0),this.Ds=!1,this.Ds=!0,this.referenceDelegate=t(this),this.Cs=new ah(this),this.indexManager=new mc,this.remoteDocumentCache=function(t){return new ih(t)}((t=>this.referenceDelegate.xs(t))),this.It=new Uu(e),this.Ns=new th(this.It)}start(){return Promise.resolve()}shutdown(){return this.Ds=!1,Promise.resolve()}get started(){return this.Ds}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new eh,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Vs[t.toKey()];return n||(n=new rh(e,this.referenceDelegate),this.Vs[t.toKey()]=n),n}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ns}runTransaction(t,e,n){Bs("MemoryPersistence","Starting transaction:",t);const s=new ch(this.Ss.next());return this.referenceDelegate.ks(),n(s).next((t=>this.referenceDelegate.Ms(s).next((()=>t)))).toPromise().then((t=>(s.raiseOnCommittedEvent(),t)))}Os(t,e){return kr.or(Object.values(this.Vs).map((n=>()=>n.containsKey(t,e))))}}class ch extends Cr{constructor(t){super(),this.currentSequenceNumber=t}}class hh{constructor(t){this.persistence=t,this.Fs=new nh,this.$s=null}static Bs(t){return new hh(t)}get Ls(){if(this.$s)return this.$s;throw Ks()}addReference(t,e,n){return this.Fs.addReference(n,e),this.Ls.delete(n.toString()),kr.resolve()}removeReference(t,e,n){return this.Fs.removeReference(n,e),this.Ls.add(n.toString()),kr.resolve()}markPotentiallyOrphaned(t,e){return this.Ls.add(e.toString()),kr.resolve()}removeTarget(t,e){this.Fs.ls(e.targetId).forEach((t=>this.Ls.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Ls.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}ks(){this.$s=new Set}Ms(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return kr.forEach(this.Ls,(n=>{const s=pr.fromPath(n);return this.Us(t,s).next((t=>{t||e.removeEntry(s,lr.min())}))})).next((()=>(this.$s=null,e.apply(t))))}updateLimboDocument(t,e){return this.Us(t,e).next((t=>{t?this.Ls.delete(e.toString()):this.Ls.add(e.toString())}))}xs(t){return 0}Us(t,e){return kr.or([()=>kr.resolve(this.Fs.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Os(t,e)])}}class lh{constructor(t){this.It=t}$(t,e,n,s){const r=new Rr("createOrUpgrade",e);n<1&&s>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",lu,{unique:!0}),t.createObjectStore("documentMutations")}(t),dh(t),function(t){t.createObjectStore("remoteDocuments")}(t));let i=kr.resolve();return n<3&&s>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),dh(t)),i=i.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:lr.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(r)))),n<4&&s>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store("mutations").W().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",lu,{unique:!0});const s=e.store("mutations"),r=n.map((t=>s.put(t)));return kr.waitFor(r)}))}(t,r)))),i=i.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&s>=5&&(i=i.next((()=>this.qs(r)))),n<6&&s>=6&&(i=i.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.Ks(r))))),n<7&&s>=7&&(i=i.next((()=>this.Gs(r)))),n<8&&s>=8&&(i=i.next((()=>this.Qs(t,r)))),n<9&&s>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&s>=10&&(i=i.next((()=>this.js(r)))),n<11&&s>=11&&(i=i.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&s>=12&&(i=i.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:Du});e.createIndex("collectionPathOverlayIndex",_u,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",Au,{unique:!1})}(t)}))),n<13&&s>=13&&(i=i.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:gu});e.createIndex("documentKeyIndex",pu),e.createIndex("collectionGroupIndex",yu)}(t))).next((()=>this.Ws(t,r))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&s>=14&&(i=i.next((()=>this.zs(t,r)))),n<15&&s>=15&&(i=i.next((()=>function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:Eu}).createIndex("sequenceNumberIndex",Tu,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:Su}).createIndex("documentKeyIndex",xu,{unique:!1})}(t)))),i}Ks(t){let e=0;return t.store("remoteDocuments").Z(((t,n)=>{e+=Dc(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}qs(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.W().next((e=>kr.forEach(e,(e=>{const s=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.W("userMutationsIndex",s).next((n=>kr.forEach(n,(n=>{js(n.userId===e.userId);const s=$u(this.It,n);return xc(t,e.userId,s).next((()=>{}))}))))}))))}Gs(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const s=[];return n.Z(((n,r)=>{const i=new fr(n),o=function(t){return[0,au(t)]}(i);s.push(e.get(o).next((n=>n?kr.resolve():(n=>e.put({targetId:0,path:au(n),sequenceNumber:t.highestListenSequenceNumber}))(i))))})).next((()=>kr.waitFor(s)))}))}Qs(t,e){t.createObjectStore("collectionParents",{keyPath:bu});const n=e.store("collectionParents"),s=new gc,r=t=>{if(s.add(t)){const e=t.lastSegment(),s=t.popLast();return n.put({collectionId:e,parent:au(s)})}};return e.store("remoteDocuments").Z({X:!0},((t,e)=>{const n=new fr(t);return r(n.popLast())})).next((()=>e.store("documentMutations").Z({X:!0},(([t,e,n],s)=>{const i=hu(e);return r(i.popLast())}))))}js(t){const e=t.store("targets");return e.Z(((t,n)=>{const s=zu(n),r=Qu(this.It,s);return e.put(r)}))}Ws(t,e){const n=e.store("remoteDocuments"),s=[];return n.Z(((t,n)=>{const r=e.store("remoteDocumentsV14"),i=(o=n,o.document?new pr(fr.fromString(o.document.name).popFirst(5)):o.noDocument?pr.fromSegments(o.noDocument.path):o.unknownDocument?pr.fromSegments(o.unknownDocument.path):Ks()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};s.push(r.put(a))})).next((()=>kr.waitFor(s)))}zs(t,e){const n=e.store("mutations"),s=$c(this.It),r=new uh(hh.Bs,this.It.re);return n.W().next((t=>{const n=new Map;return t.forEach((t=>{var e;let s=null!==(e=n.get(t.userId))&&void 0!==e?e:wa();$u(this.It,t).keys().forEach((t=>s=s.add(t))),n.set(t.userId,s)})),kr.forEach(n,((t,n)=>{const i=new Ms(n),o=ec.oe(this.It,i),a=r.getIndexManager(i),u=_c.oe(i,this.It,a,r.referenceDelegate);return new Zc(s,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new Mu(e,Kr.at),t).next()}))}))}}function dh(t){t.createObjectStore("targetDocuments",{keyPath:vu}).createIndex("documentTargetsIndex",Iu,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",wu,{unique:!0}),t.createObjectStore("targetGlobal")}const fh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class mh{constructor(t,e,n,s,r,i,o,a,u,c,h=15){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Hs=r,this.window=i,this.document=o,this.Js=u,this.Ys=c,this.Xs=h,this.Ss=null,this.Ds=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Zs=null,this.inForeground=!1,this.ti=null,this.ei=null,this.ni=Number.NEGATIVE_INFINITY,this.si=t=>Promise.resolve(),!mh.C())throw new Hs(Qs.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new qc(this,s),this.ii=e+"main",this.It=new Uu(a),this.ri=new Lr(this.ii,this.Xs,new lh(this.It)),this.Cs=new Lc(this.referenceDelegate,this.It),this.remoteDocumentCache=$c(this.It),this.Ns=new Ju,this.window&&this.window.localStorage?this.oi=this.window.localStorage:(this.oi=null,!1===c&&Us("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ui().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Hs(Qs.FAILED_PRECONDITION,fh);return this.ci(),this.ai(),this.hi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Cs.getHighestSequenceNumber(t)))})).then((t=>{this.Ss=new Kr(t,this.Js)})).then((()=>{this.Ds=!0})).catch((t=>(this.ri&&this.ri.close(),Promise.reject(t))))}li(t){return this.si=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ri.L((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Hs.enqueueAndForget((async()=>{this.started&&await this.ui()})))}ui(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>ph(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.fi(t).next((t=>{t||(this.isPrimary=!1,this.Hs.enqueueRetryable((()=>this.si(!1))))}))})).next((()=>this.di(t))).next((e=>this.isPrimary&&!e?this._i(t).next((()=>!1)):!!e&&this.wi(t).next((()=>!0)))))).catch((t=>{if(Vr(t))return Bs("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return Bs("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.Hs.enqueueRetryable((()=>this.si(t))),this.isPrimary=t}))}fi(t){return gh(t).get("owner").next((t=>kr.resolve(this.mi(t))))}gi(t){return ph(t).delete(this.clientId)}async yi(){if(this.isPrimary&&!this.pi(this.ni,18e5)){this.ni=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=Ou(t,"clientMetadata");return e.W().next((t=>{const n=this.Ii(t,18e5),s=t.filter((t=>-1===n.indexOf(t)));return kr.forEach(s,(t=>e.delete(t.clientId))).next((()=>s))}))})).catch((()=>[]));if(this.oi)for(const e of t)this.oi.removeItem(this.Ti(e.clientId))}}hi(){this.ei=this.Hs.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.ui().then((()=>this.yi())).then((()=>this.hi()))))}mi(t){return!!t&&t.ownerId===this.clientId}di(t){return this.Ys?kr.resolve(!0):gh(t).get("owner").next((e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)){if(this.mi(e)&&this.networkEnabled)return!0;if(!this.mi(e)){if(!e.allowTabSynchronization)throw new Hs(Qs.FAILED_PRECONDITION,fh);return!1}}return!(!this.networkEnabled||!this.inForeground)||ph(t).W().next((t=>void 0===this.Ii(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,s=this.networkEnabled===t.networkEnabled;if(e||n&&s)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&Bs("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.Ds=!1,this.Ai(),this.ei&&(this.ei.cancel(),this.ei=null),this.Ri(),this.bi(),await this.ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new Mu(t,Kr.at);return this._i(e).next((()=>this.gi(e)))})),this.ri.close(),this.Pi()}Ii(t,e){return t.filter((t=>this.pi(t.updateTimeMs,e)&&!this.Ei(t.clientId)))}vi(){return this.runTransaction("getActiveClients","readonly",(t=>ph(t).W().next((t=>this.Ii(t,18e5).map((t=>t.clientId))))))}get started(){return this.Ds}getMutationQueue(t,e){return _c.oe(t,this.It,e,this.referenceDelegate)}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new yc(t,this.It.re.databaseId)}getDocumentOverlayCache(t){return ec.oe(this.It,t)}getBundleCache(){return this.Ns}runTransaction(t,e,n){Bs("IndexedDbPersistence","Starting transaction:",t);const s="readonly"===e?"readonly":"readwrite",r=15===(i=this.Xs)?Lu:14===i?Ru:13===i?ku:12===i?Nu:11===i?Cu:void Ks();var i;let o;return this.ri.runTransaction(t,s,r,(s=>(o=new Mu(s,this.Ss?this.Ss.next():Kr.at),"readwrite-primary"===e?this.fi(o).next((t=>!!t||this.di(o))).next((e=>{if(!e)throw Us(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Hs.enqueueRetryable((()=>this.si(!1))),new Hs(Qs.FAILED_PRECONDITION,Ar);return n(o)})).next((t=>this.wi(o).next((()=>t)))):this.Vi(o).next((()=>n(o)))))).then((t=>(o.raiseOnCommittedEvent(),t)))}Vi(t){return gh(t).get("owner").next((t=>{if(null!==t&&this.pi(t.leaseTimestampMs,5e3)&&!this.Ei(t.ownerId)&&!this.mi(t)&&!(this.Ys||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Hs(Qs.FAILED_PRECONDITION,fh)}))}wi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return gh(t).put("owner",e)}static C(){return Lr.C()}_i(t){const e=gh(t);return e.get("owner").next((t=>this.mi(t)?(Bs("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):kr.resolve()))}pi(t,e){const n=Date.now();return!(t<n-e||t>n&&(Us(`Detected an update time that is in the future: ${t} > ${n}`),1))}ci(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ti=()=>{this.Hs.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.ui())))},this.document.addEventListener("visibilitychange",this.ti),this.inForeground="visible"===this.document.visibilityState)}Ri(){this.ti&&(this.document.removeEventListener("visibilitychange",this.ti),this.ti=null)}ai(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Zs=()=>{this.Ai(),h()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Hs.enterRestrictedMode(!0),this.Hs.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Zs))}bi(){this.Zs&&(this.window.removeEventListener("pagehide",this.Zs),this.Zs=null)}Ei(t){var e;try{const n=null!==(null===(e=this.oi)||void 0===e?void 0:e.getItem(this.Ti(t)));return Bs("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return Us("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}Ai(){if(this.oi)try{this.oi.setItem(this.Ti(this.clientId),String(Date.now()))}catch(t){Us("Failed to set zombie client id.",t)}}Pi(){if(this.oi)try{this.oi.removeItem(this.Ti(this.clientId))}catch(t){}}Ti(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function gh(t){return Ou(t,"owner")}function ph(t){return Ou(t,"clientMetadata")}function yh(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class wh{constructor(t,e,n,s){this.targetId=t,this.fromCache=e,this.Si=n,this.Di=s}static Ci(t,e){let n=wa(),s=wa();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:s=s.add(t.doc.key)}return new wh(t,e.fromCache,n,s)}}class vh{constructor(){this.xi=!1}initialize(t,e){this.Ni=t,this.indexManager=e,this.xi=!0}getDocumentsMatchingQuery(t,e,n,s){return this.ki(t,e).next((r=>r||this.Mi(t,e,s,n))).next((n=>n||this.Oi(t,e)))}ki(t,e){if(co(e))return kr.resolve(null);let n=go(e);return this.indexManager.getIndexType(t,n).next((s=>0===s?null:(null!==e.limit&&1===s&&(e=po(e,null,"F"),n=go(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next((s=>{const r=wa(...s);return this.Ni.getDocuments(t,r).next((s=>this.indexManager.getMinOffset(t,n).next((n=>{const i=this.Fi(e,s);return this.$i(e,i,r,n.readTime)?this.ki(t,po(e,null,"F")):this.Bi(t,i,e,n)}))))})))))}Mi(t,e,n,s){return co(e)||s.isEqual(lr.min())?this.Oi(t,e):this.Ni.getDocuments(t,n).next((r=>{const i=this.Fi(e,r);return this.$i(e,i,n,s)?this.Oi(t,e):(Fs()<=w.DEBUG&&Bs("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),vo(e)),this.Bi(t,i,e,Sr(s,-1)))}))}Fi(t,e){let n=new Yr(Eo(t));return e.forEach(((e,s)=>{Io(t,s)&&(n=n.add(s))})),n}$i(t,e,n,s){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const r="F"===t.limitType?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(s)>0)}Oi(t,e){return Fs()<=w.DEBUG&&Bs("QueryEngine","Using full collection scan to execute query:",vo(e)),this.Ni.getDocumentsMatchingQuery(t,e,Dr.min())}Bi(t,e,n,s){return this.Ni.getDocumentsMatchingQuery(t,n,s).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class Ih{constructor(t,e,n,s){this.persistence=t,this.Li=e,this.It=s,this.Ui=new Qr(ar),this.qi=new aa((t=>Ui(t)),qi),this.Ki=new Map,this.Gi=t.getRemoteDocumentCache(),this.Cs=t.getTargetCache(),this.Ns=t.getBundleCache(),this.Qi(n)}Qi(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Zc(this.Gi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Gi.setIndexManager(this.indexManager),this.Li.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.Ui)))}}function bh(t,e,n,s){return new Ih(t,e,n,s)}async function Eh(t,e){const n=zs(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let s;return n.mutationQueue.getAllMutationBatches(t).next((r=>(s=r,n.Qi(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const r=[],i=[];let o=wa();for(const t of s){r.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.localDocuments.getDocuments(t,o).next((t=>({ji:t,removedBatchIds:r,addedBatchIds:i})))}))}))}function Th(t){const e=zs(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Cs.getLastRemoteSnapshotVersion(t)))}function Sh(t,e,n){let s=wa(),r=wa();return n.forEach((t=>s=s.add(t))),e.getEntries(t,s).next((t=>{let s=ca();return n.forEach(((n,i)=>{const o=t.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(r=r.add(n)),i.isNoDocument()&&i.version.isEqual(lr.min())?(e.removeEntry(n,i.readTime),s=s.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(e.addEntry(i),s=s.insert(n,i)):Bs("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{Wi:s,zi:r}}))}function xh(t,e){const n=zs(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}function Dh(t,e){const n=zs(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let s;return n.Cs.getTargetData(t,e).next((r=>r?(s=r,kr.resolve(s)):n.Cs.allocateTargetId(t).next((r=>(s=new Bu(e,r,0,t.currentSequenceNumber),n.Cs.addTargetData(t,s).next((()=>s)))))))})).then((t=>{const s=n.Ui.get(t.targetId);return(null===s||t.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.Ui=n.Ui.insert(t.targetId,t),n.qi.set(e,t.targetId)),t}))}async function _h(t,e,n){const s=zs(t),r=s.Ui.get(e),i=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",i,(t=>s.persistence.referenceDelegate.removeTarget(t,r)))}catch(t){if(!Vr(t))throw t;Bs("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}s.Ui=s.Ui.remove(e),s.qi.delete(r.target)}function Ah(t,e,n){const s=zs(t);let r=lr.min(),i=wa();return s.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const s=zs(t),r=s.qi.get(n);return void 0!==r?kr.resolve(s.Ui.get(r)):s.Cs.getTargetData(e,n)}(s,t,go(e)).next((e=>{if(e)return r=e.lastLimboFreeSnapshotVersion,s.Cs.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>s.Li.getDocumentsMatchingQuery(t,e,n?r:lr.min(),n?i:wa()))).next((t=>(kh(s,bo(e),t),{documents:t,Hi:i})))))}function Ch(t,e){const n=zs(t),s=zs(n.Cs),r=n.Ui.get(e);return r?Promise.resolve(r.target):n.persistence.runTransaction("Get target data","readonly",(t=>s.se(t,e).next((t=>t?t.target:null))))}function Nh(t,e){const n=zs(t),s=n.Ki.get(e)||lr.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.Gi.getAllFromCollectionGroup(t,e,Sr(s,-1),Number.MAX_SAFE_INTEGER))).then((t=>(kh(n,e,t),t)))}function kh(t,e,n){let s=lr.min();n.forEach(((t,e)=>{e.readTime.compareTo(s)>0&&(s=e.readTime)})),t.Ki.set(e,s)}async function Rh(t,e,n=wa()){const s=await Dh(t,go(Hu(e.bundledQuery))),r=zs(t);return r.persistence.runTransaction("Save named query","readwrite",(t=>{const i=Va(e.readTime);if(s.snapshotVersion.compareTo(i)>=0)return r.Ns.saveNamedQuery(t,e);const o=s.withResumeToken(ei.EMPTY_BYTE_STRING,i);return r.Ui=r.Ui.insert(o.targetId,o),r.Cs.updateTargetData(t,o).next((()=>r.Cs.removeMatchingKeysForTargetId(t,s.targetId))).next((()=>r.Cs.addMatchingKeys(t,n,s.targetId))).next((()=>r.Ns.saveNamedQuery(t,e)))}))}function Lh(t,e){return`firestore_clients_${t}_${e}`}function Mh(t,e,n){let s=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(s+=`_${e.uid}`),s}function Oh(t,e){return`firestore_targets_${t}_${e}`}class Vh{constructor(t,e,n,s){this.user=t,this.batchId=e,this.state=n,this.error=s}static Zi(t,e,n){const s=JSON.parse(n);let r,i="object"==typeof s&&-1!==["pending","acknowledged","rejected"].indexOf(s.state)&&(void 0===s.error||"object"==typeof s.error);return i&&s.error&&(i="string"==typeof s.error.message&&"string"==typeof s.error.code,i&&(r=new Hs(s.error.code,s.error.message))),i?new Vh(t,e,s.state,r):(Us("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}tr(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Fh{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Zi(t,e){const n=JSON.parse(e);let s,r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code,r&&(s=new Hs(n.error.code,n.error.message))),r?new Fh(t,n.state,s):(Us("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}tr(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Ph{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Zi(t,e){const n=JSON.parse(e);let s="object"==typeof n&&n.activeTargetIds instanceof Array,r=Ia();for(let t=0;s&&t<n.activeTargetIds.length;++t)s=fi(n.activeTargetIds[t]),r=r.add(n.activeTargetIds[t]);return s?new Ph(t,r):(Us("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class Bh{constructor(t,e){this.clientId=t,this.onlineState=e}static Zi(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new Bh(e.clientId,e.onlineState):(Us("SharedClientState",`Failed to parse online state: ${t}`),null)}}class Uh{constructor(){this.activeTargetIds=Ia()}er(t){this.activeTargetIds=this.activeTargetIds.add(t)}nr(t){this.activeTargetIds=this.activeTargetIds.delete(t)}tr(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class qh{constructor(t,e,n,s,r){this.window=t,this.Hs=e,this.persistenceKey=n,this.sr=s,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ir=this.rr.bind(this),this.ur=new Qr(ar),this.started=!1,this.cr=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=r,this.ar=Lh(this.persistenceKey,this.sr),this.hr=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.ur=this.ur.insert(this.sr,new Uh),this.lr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.dr=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this._r=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.wr=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.mr=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.ir)}static C(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.vi();for(const e of t){if(e===this.sr)continue;const t=this.getItem(Lh(this.persistenceKey,e));if(t){const n=Ph.Zi(e,t);n&&(this.ur=this.ur.insert(n.clientId,n))}}this.gr();const e=this.storage.getItem(this.wr);if(e){const t=this.yr(e);t&&this.pr(t)}for(const t of this.cr)this.rr(t);this.cr=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.hr,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Ir(this.ur)}isActiveQueryTarget(t){let e=!1;return this.ur.forEach(((n,s)=>{s.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.Tr(t,"pending")}updateMutationState(t,e,n){this.Tr(t,e,n),this.Er(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(Oh(this.persistenceKey,t));if(n){const s=Fh.Zi(t,n);s&&(e=s.state)}}return this.Ar.er(t),this.gr(),e}removeLocalQueryTarget(t){this.Ar.nr(t),this.gr()}isLocalQueryTarget(t){return this.Ar.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(Oh(this.persistenceKey,t))}updateQueryState(t,e,n){this.Rr(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.Er(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.br(t)}notifyBundleLoaded(t){this.Pr(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ir),this.removeItem(this.ar),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return Bs("SharedClientState","READ",t,e),e}setItem(t,e){Bs("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){Bs("SharedClientState","REMOVE",t),this.storage.removeItem(t)}rr(t){const e=t;if(e.storageArea===this.storage){if(Bs("SharedClientState","EVENT",e.key,e.newValue),e.key===this.ar)return void Us("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Hs.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.lr.test(e.key)){if(null==e.newValue){const t=this.vr(e.key);return this.Vr(t,null)}{const t=this.Sr(e.key,e.newValue);if(t)return this.Vr(t.clientId,t)}}else if(this.dr.test(e.key)){if(null!==e.newValue){const t=this.Dr(e.key,e.newValue);if(t)return this.Cr(t)}}else if(this._r.test(e.key)){if(null!==e.newValue){const t=this.Nr(e.key,e.newValue);if(t)return this.kr(t)}}else if(e.key===this.wr){if(null!==e.newValue){const t=this.yr(e.newValue);if(t)return this.pr(t)}}else if(e.key===this.hr){const t=function(t){let e=Kr.at;if(null!=t)try{const n=JSON.parse(t);js("number"==typeof n),e=n}catch(t){Us("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==Kr.at&&this.sequenceNumberHandler(t)}else if(e.key===this.mr){const t=this.Mr(e.newValue);await Promise.all(t.map((t=>this.syncEngine.Or(t))))}}else this.cr.push(e)}))}}get Ar(){return this.ur.get(this.sr)}gr(){this.setItem(this.ar,this.Ar.tr())}Tr(t,e,n){const s=new Vh(this.currentUser,t,e,n),r=Mh(this.persistenceKey,this.currentUser,t);this.setItem(r,s.tr())}Er(t){const e=Mh(this.persistenceKey,this.currentUser,t);this.removeItem(e)}br(t){const e={clientId:this.sr,onlineState:t};this.storage.setItem(this.wr,JSON.stringify(e))}Rr(t,e,n){const s=Oh(this.persistenceKey,t),r=new Fh(t,e,n);this.setItem(s,r.tr())}Pr(t){const e=JSON.stringify(Array.from(t));this.setItem(this.mr,e)}vr(t){const e=this.lr.exec(t);return e?e[1]:null}Sr(t,e){const n=this.vr(t);return Ph.Zi(n,e)}Dr(t,e){const n=this.dr.exec(t),s=Number(n[1]),r=void 0!==n[2]?n[2]:null;return Vh.Zi(new Ms(r),s,e)}Nr(t,e){const n=this._r.exec(t),s=Number(n[1]);return Fh.Zi(s,e)}yr(t){return Bh.Zi(t)}Mr(t){return JSON.parse(t)}async Cr(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.Fr(t.batchId,t.state,t.error);Bs("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}kr(t){return this.syncEngine.$r(t.targetId,t.state,t.error)}Vr(t,e){const n=e?this.ur.insert(t,e):this.ur.remove(t),s=this.Ir(this.ur),r=this.Ir(n),i=[],o=[];return r.forEach((t=>{s.has(t)||i.push(t)})),s.forEach((t=>{r.has(t)||o.push(t)})),this.syncEngine.Br(i,o).then((()=>{this.ur=n}))}pr(t){this.ur.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Ir(t){let e=Ia();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class Gh{constructor(){this.Lr=new Uh,this.Ur={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.Lr.er(t),this.Ur[t]||"not-current"}updateQueryState(t,e,n){this.Ur[t]=e}removeLocalQueryTarget(t){this.Lr.nr(t)}isLocalQueryTarget(t){return this.Lr.activeTargetIds.has(t)}clearQueryState(t){delete this.Ur[t]}getAllActiveQueryTargets(){return this.Lr.activeTargetIds}isActiveQueryTarget(t){return this.Lr.activeTargetIds.has(t)}start(){return this.Lr=new Uh,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class Kh{qr(t){}shutdown(){}}class jh{constructor(){this.Kr=()=>this.Gr(),this.Qr=()=>this.jr(),this.Wr=[],this.zr()}qr(t){this.Wr.push(t)}shutdown(){window.removeEventListener("online",this.Kr),window.removeEventListener("offline",this.Qr)}zr(){window.addEventListener("online",this.Kr),window.addEventListener("offline",this.Qr)}Gr(){Bs("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.Wr)t(0)}jr(){Bs("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.Wr)t(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const $h={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class zh{constructor(t){this.Hr=t.Hr,this.Jr=t.Jr}Yr(t){this.Xr=t}Zr(t){this.eo=t}onMessage(t){this.no=t}close(){this.Jr()}send(t){this.Hr(t)}so(){this.Xr()}io(t){this.eo(t)}ro(t){this.no(t)}}class Qh extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.oo=e+"://"+t.host,this.uo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}co(t,e,n,s,r){const i=this.ao(t,e);Bs("RestConnection","Sending: ",i,n);const o={};return this.ho(o,s,r),this.lo(t,i,o,n).then((t=>(Bs("RestConnection","Received: ",t),t)),(e=>{throw qs("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e}))}fo(t,e,n,s,r,i){return this.co(t,e,n,s,r)}ho(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+Os,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}ao(t,e){const n=$h[t];return`${this.oo}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}lo(t,e,n,s){return new Promise(((r,i)=>{const o=new Rs;o.listenOnce(Ds.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case xs.NO_ERROR:const e=o.getResponseJson();Bs("Connection","XHR received:",JSON.stringify(e)),r(e);break;case xs.TIMEOUT:Bs("Connection",'RPC "'+t+'" timed out'),i(new Hs(Qs.DEADLINE_EXCEEDED,"Request time out"));break;case xs.HTTP_ERROR:const n=o.getStatus();if(Bs("Connection",'RPC "'+t+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const t=o.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(Qs).indexOf(e)>=0?e:Qs.UNKNOWN}(t.status);i(new Hs(e,t.message))}else i(new Hs(Qs.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new Hs(Qs.UNAVAILABLE,"Connection failed."));break;default:Ks()}}finally{Bs("Connection",'RPC "'+t+'" completed.')}}));const a=JSON.stringify(s);o.send(e,"POST",a,n,15)}))}_o(t,e,n){const s=[this.oo,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=new Is,i=fe(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new Ns({})),this.ho(o.initMessageHeaders,e,n),"undefined"!=typeof window&&(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(c())||"object"==typeof navigator&&"ReactNative"===navigator.product||c().indexOf("Electron/")>=0||function(){const t=c();return t.indexOf("MSIE ")>=0||t.indexOf("Trident/")>=0}()||c().indexOf("MSAppHost/")>=0||function(){const t="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0;return"object"==typeof t&&void 0!==t.id}()||(o.httpHeadersOverwriteParam="$httpHeaders");const a=s.join("");Bs("Connection","Creating WebChannel: "+a,o);const u=r.createWebChannel(a,o);let h=!1,l=!1;const d=new zh({Hr:t=>{l?Bs("Connection","Not sending because WebChannel is closed:",t):(h||(Bs("Connection","Opening WebChannel transport."),u.open(),h=!0),Bs("Connection","WebChannel sending:",t),u.send(t))},Jr:()=>u.close()}),f=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return f(u,ks.EventType.OPEN,(()=>{l||Bs("Connection","WebChannel transport opened.")})),f(u,ks.EventType.CLOSE,(()=>{l||(l=!0,Bs("Connection","WebChannel transport closed"),d.io())})),f(u,ks.EventType.ERROR,(t=>{l||(l=!0,qs("Connection","WebChannel transport errored:",t),d.io(new Hs(Qs.UNAVAILABLE,"The operation could not be completed")))})),f(u,ks.EventType.MESSAGE,(t=>{var e;if(!l){const n=t.data[0];js(!!n);const s=n,r=s.error||(null===(e=s[0])||void 0===e?void 0:e.error);if(r){Bs("Connection","WebChannel received error:",r);const t=r.status;let e=function(t){const e=sa[t];if(void 0!==e)return oa(e)}(t),n=r.message;void 0===e&&(e=Qs.INTERNAL,n="Unknown error status: "+t+" with message "+r.message),l=!0,d.io(new Hs(e,n)),u.close()}else Bs("Connection","WebChannel received:",n),d.ro(n)}})),f(i,_s.STAT_EVENT,(t=>{t.stat===As?Bs("Connection","Detected buffering proxy"):t.stat===Cs&&Bs("Connection","Detected no buffering proxy")})),setTimeout((()=>{d.so()}),0),d}}function Hh(){return"undefined"!=typeof window?window:null}function Wh(){return"undefined"!=typeof document?document:null}function Yh(t){return new Ra(t,!0)}class Xh{constructor(t,e,n=1e3,s=1.5,r=6e4){this.Hs=t,this.timerId=e,this.wo=n,this.mo=s,this.yo=r,this.po=0,this.Io=null,this.To=Date.now(),this.reset()}reset(){this.po=0}Eo(){this.po=this.yo}Ao(t){this.cancel();const e=Math.floor(this.po+this.Ro()),n=Math.max(0,Date.now()-this.To),s=Math.max(0,e-n);s>0&&Bs("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.po} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Io=this.Hs.enqueueAfterDelay(this.timerId,s,(()=>(this.To=Date.now(),t()))),this.po*=this.mo,this.po<this.wo&&(this.po=this.wo),this.po>this.yo&&(this.po=this.yo)}bo(){null!==this.Io&&(this.Io.skipDelay(),this.Io=null)}cancel(){null!==this.Io&&(this.Io.cancel(),this.Io=null)}Ro(){return(Math.random()-.5)*this.po}}class Jh{constructor(t,e,n,s,r,i,o,a){this.Hs=t,this.Po=n,this.vo=s,this.Vo=r,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.So=0,this.Do=null,this.Co=null,this.stream=null,this.xo=new Xh(t,e)}No(){return 1===this.state||5===this.state||this.ko()}ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Mo()}async stop(){this.No()&&await this.close(0)}Oo(){this.state=0,this.xo.reset()}Fo(){this.ko()&&null===this.Do&&(this.Do=this.Hs.enqueueAfterDelay(this.Po,6e4,(()=>this.$o())))}Bo(t){this.Lo(),this.stream.send(t)}async $o(){if(this.ko())return this.close(0)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}Uo(){this.Co&&(this.Co.cancel(),this.Co=null)}async close(t,e){this.Lo(),this.Uo(),this.xo.cancel(),this.So++,4!==t?this.xo.reset():e&&e.code===Qs.RESOURCE_EXHAUSTED?(Us(e.toString()),Us("Using maximum backoff delay to prevent overloading the backend."),this.xo.Eo()):e&&e.code===Qs.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.qo(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Zr(e)}qo(){}auth(){this.state=1;const t=this.Ko(this.So),e=this.So;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.So===e&&this.Go(t,n)}),(e=>{t((()=>{const t=new Hs(Qs.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Qo(t)}))}))}Go(t,e){const n=this.Ko(this.So);this.stream=this.jo(t,e),this.stream.Yr((()=>{n((()=>(this.state=2,this.Co=this.Hs.enqueueAfterDelay(this.vo,1e4,(()=>(this.ko()&&(this.state=3),Promise.resolve()))),this.listener.Yr())))})),this.stream.Zr((t=>{n((()=>this.Qo(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}Mo(){this.state=5,this.xo.Ao((async()=>{this.state=0,this.start()}))}Qo(t){return Bs("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Ko(t){return e=>{this.Hs.enqueueAndForget((()=>this.So===t?e():(Bs("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Zh extends Jh{constructor(t,e,n,s,r,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,s,i),this.It=r}jo(t,e){return this.Vo._o("Listen",t,e)}onMessage(t){this.xo.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const s=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:Ks()}(e.targetChange.targetChangeType||"NO_CHANGE"),r=e.targetChange.targetIds||[],i=function(t,e){return t.gt?(js(void 0===e||"string"==typeof e),ei.fromBase64String(e||"")):(js(void 0===e||e instanceof Uint8Array),ei.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?Qs.UNKNOWN:oa(t.code);return new Hs(e,t.message||"")}(o);n=new xa(s,r,i,a||null)}else if("documentChange"in e){e.documentChange;const s=e.documentChange;s.document,s.document.name,s.document.updateTime;const r=Ua(t,s.document.name),i=Va(s.document.updateTime),o=new Oi({mapValue:{fields:s.document.fields}}),a=Fi.newFoundDocument(r,i,o),u=s.targetIds||[],c=s.removedTargetIds||[];n=new Ta(u,c,a.key,a)}else if("documentDelete"in e){e.documentDelete;const s=e.documentDelete;s.document;const r=Ua(t,s.document),i=s.readTime?Va(s.readTime):lr.min(),o=Fi.newNoDocument(r,i),a=s.removedTargetIds||[];n=new Ta([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const s=e.documentRemove;s.document;const r=Ua(t,s.document),i=s.removedTargetIds||[];n=new Ta([],i,r,null)}else{if(!("filter"in e))return Ks();{e.filter;const t=e.filter;t.targetId;const s=t.count||0,r=new na(s),i=t.targetId;n=new Sa(i,r)}}return n}(this.It,t),n=function(t){if(!("targetChange"in t))return lr.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?lr.min():e.readTime?Va(e.readTime):lr.min()}(t);return this.listener.Wo(e,n)}zo(t){const e={};e.database=Ka(this.It),e.addTarget=function(t,e){let n;const s=e.target;return n=Gi(s)?{documents:Wa(t,s)}:{query:Ya(t,s)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=Ma(t,e.resumeToken):e.snapshotVersion.compareTo(lr.min())>0&&(n.readTime=La(t,e.snapshotVersion.toTimestamp())),n}(this.It,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Ks()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.It,t);n&&(e.labels=n),this.Bo(e)}Ho(t){const e={};e.database=Ka(this.It),e.removeTarget=t,this.Bo(e)}}class tl extends Jh{constructor(t,e,n,s,r,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s,i),this.It=r,this.Jo=!1}get Yo(){return this.Jo}start(){this.Jo=!1,this.lastStreamToken=void 0,super.start()}qo(){this.Jo&&this.Xo([])}jo(t,e){return this.Vo._o("Write",t,e)}onMessage(t){if(js(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Jo){this.xo.reset();const e=function(t,e){return t&&t.length>0?(js(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?Va(t.updateTime):Va(e);return n.isEqual(lr.min())&&(n=Va(e)),new Uo(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=Va(t.commitTime);return this.listener.Zo(n,e)}return js(!t.writeResults||0===t.writeResults.length),this.Jo=!0,this.listener.tu()}eu(){const t={};t.database=Ka(this.It),this.Bo(t)}Xo(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Qa(this.It,t)))};this.Bo(e)}}class el extends class{}{constructor(t,e,n,s){super(),this.authCredentials=t,this.appCheckCredentials=e,this.Vo=n,this.It=s,this.nu=!1}su(){if(this.nu)throw new Hs(Qs.FAILED_PRECONDITION,"The client has already been terminated.")}co(t,e,n){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.Vo.co(t,e,n,s,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Qs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Hs(Qs.UNKNOWN,t.toString())}))}fo(t,e,n,s){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,i])=>this.Vo.fo(t,e,n,r,i,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Qs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Hs(Qs.UNKNOWN,t.toString())}))}terminate(){this.nu=!0}}class nl{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.iu=0,this.ru=null,this.ou=!0}uu(){0===this.iu&&(this.cu("Unknown"),this.ru=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.ru=null,this.au("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve()))))}hu(t){"Online"===this.state?this.cu("Unknown"):(this.iu++,this.iu>=1&&(this.lu(),this.au(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.cu("Offline")))}set(t){this.lu(),this.iu=0,"Online"===t&&(this.ou=!1),this.cu(t)}cu(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}au(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ou?(Us(e),this.ou=!1):Bs("OnlineStateTracker",e)}lu(){null!==this.ru&&(this.ru.cancel(),this.ru=null)}}class sl{constructor(t,e,n,s,r){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.fu=[],this.du=new Map,this._u=new Set,this.wu=[],this.mu=r,this.mu.qr((t=>{n.enqueueAndForget((async()=>{dl(this)&&(Bs("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=zs(t);e._u.add(4),await il(e),e.gu.set("Unknown"),e._u.delete(4),await rl(e)}(this))}))})),this.gu=new nl(n,s)}}async function rl(t){if(dl(t))for(const e of t.wu)await e(!0)}async function il(t){for(const e of t.wu)await e(!1)}function ol(t,e){const n=zs(t);n.du.has(e.targetId)||(n.du.set(e.targetId,e),ll(n)?hl(n):Nl(n).ko()&&ul(n,e))}function al(t,e){const n=zs(t),s=Nl(n);n.du.delete(e),s.ko()&&cl(n,e),0===n.du.size&&(s.ko()?s.Fo():dl(n)&&n.gu.set("Unknown"))}function ul(t,e){t.yu.Ot(e.targetId),Nl(t).zo(e)}function cl(t,e){t.yu.Ot(e),Nl(t).Ho(e)}function hl(t){t.yu=new _a({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),se:e=>t.du.get(e)||null}),Nl(t).start(),t.gu.uu()}function ll(t){return dl(t)&&!Nl(t).No()&&t.du.size>0}function dl(t){return 0===zs(t)._u.size}function fl(t){t.yu=void 0}async function ml(t){t.du.forEach(((e,n)=>{ul(t,e)}))}async function gl(t,e){fl(t),ll(t)?(t.gu.hu(e),hl(t)):t.gu.set("Unknown")}async function pl(t,e,n){if(t.gu.set("Online"),e instanceof xa&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const s of e.targetIds)t.du.has(s)&&(await t.remoteSyncer.rejectListen(s,n),t.du.delete(s),t.yu.removeTarget(s))}(t,e)}catch(n){Bs("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await yl(t,n)}else if(e instanceof Ta?t.yu.Gt(e):e instanceof Sa?t.yu.Yt(e):t.yu.Wt(e),!n.isEqual(lr.min()))try{const e=await Th(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.yu.te(e);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const r=t.du.get(s);r&&t.du.set(s,r.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t.du.get(e);if(!n)return;t.du.set(e,n.withResumeToken(ei.EMPTY_BYTE_STRING,n.snapshotVersion)),cl(t,e);const s=new Bu(n.target,e,1,n.sequenceNumber);ul(t,s)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){Bs("RemoteStore","Failed to raise snapshot:",e),await yl(t,e)}}async function yl(t,e,n){if(!Vr(e))throw e;t._u.add(1),await il(t),t.gu.set("Offline"),n||(n=()=>Th(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{Bs("RemoteStore","Retrying IndexedDB access"),await n(),t._u.delete(1),await rl(t)}))}function wl(t,e){return e().catch((n=>yl(t,n,e)))}async function vl(t){const e=zs(t),n=kl(e);let s=e.fu.length>0?e.fu[e.fu.length-1].batchId:-1;for(;Il(e);)try{const t=await xh(e.localStore,s);if(null===t){0===e.fu.length&&n.Fo();break}s=t.batchId,bl(e,t)}catch(t){await yl(e,t)}El(e)&&Tl(e)}function Il(t){return dl(t)&&t.fu.length<10}function bl(t,e){t.fu.push(e);const n=kl(t);n.ko()&&n.Yo&&n.Xo(e.mutations)}function El(t){return dl(t)&&!kl(t).No()&&t.fu.length>0}function Tl(t){kl(t).start()}async function Sl(t){kl(t).eu()}async function xl(t){const e=kl(t);for(const n of t.fu)e.Xo(n.mutations)}async function Dl(t,e,n){const s=t.fu.shift(),r=Fu.from(s,e,n);await wl(t,(()=>t.remoteSyncer.applySuccessfulWrite(r))),await vl(t)}async function _l(t,e){e&&kl(t).Yo&&await async function(t,e){if(ia(n=e.code)&&n!==Qs.ABORTED){const n=t.fu.shift();kl(t).Oo(),await wl(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await vl(t)}var n}(t,e),El(t)&&Tl(t)}async function Al(t,e){const n=zs(t);n.asyncQueue.verifyOperationInProgress(),Bs("RemoteStore","RemoteStore received new credentials");const s=dl(n);n._u.add(3),await il(n),s&&n.gu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n._u.delete(3),await rl(n)}async function Cl(t,e){const n=zs(t);e?(n._u.delete(2),await rl(n)):e||(n._u.add(2),await il(n),n.gu.set("Unknown"))}function Nl(t){return t.pu||(t.pu=function(t,e,n){const s=zs(t);return s.su(),new Zh(e,s.Vo,s.authCredentials,s.appCheckCredentials,s.It,n)}(t.datastore,t.asyncQueue,{Yr:ml.bind(null,t),Zr:gl.bind(null,t),Wo:pl.bind(null,t)}),t.wu.push((async e=>{e?(t.pu.Oo(),ll(t)?hl(t):t.gu.set("Unknown")):(await t.pu.stop(),fl(t))}))),t.pu}function kl(t){return t.Iu||(t.Iu=function(t,e,n){const s=zs(t);return s.su(),new tl(e,s.Vo,s.authCredentials,s.appCheckCredentials,s.It,n)}(t.datastore,t.asyncQueue,{Yr:Sl.bind(null,t),Zr:_l.bind(null,t),tu:xl.bind(null,t),Zo:Dl.bind(null,t)}),t.wu.push((async e=>{e?(t.Iu.Oo(),await vl(t)):(await t.Iu.stop(),t.fu.length>0&&(Bs("RemoteStore",`Stopping write stream with ${t.fu.length} pending writes`),t.fu=[]))}))),t.Iu}class Rl{constructor(t,e,n,s,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=s,this.removalCallback=r,this.deferred=new Ws,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,s,r){const i=Date.now()+n,o=new Rl(t,e,i,s,r);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Hs(Qs.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Ll(t,e){if(Us("AsyncQueue",`${e}: ${t}`),Vr(t))return new Hs(Qs.UNAVAILABLE,`${e}: ${t}`);throw t}class Ml{constructor(t){this.comparator=t?(e,n)=>t(e,n)||pr.comparator(e.key,n.key):(t,e)=>pr.comparator(t.key,e.key),this.keyedMap=la(),this.sortedSet=new Qr(this.comparator)}static emptySet(t){return new Ml(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof Ml))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(!t.isEqual(s))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new Ml;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class Ol{constructor(){this.Tu=new Qr(pr.comparator)}track(t){const e=t.doc.key,n=this.Tu.get(e);n?0!==t.type&&3===n.type?this.Tu=this.Tu.insert(e,t):3===t.type&&1!==n.type?this.Tu=this.Tu.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Tu=this.Tu.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Tu=this.Tu.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Tu=this.Tu.remove(e):1===t.type&&2===n.type?this.Tu=this.Tu.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Tu=this.Tu.insert(e,{type:2,doc:t.doc}):Ks():this.Tu=this.Tu.insert(e,t)}Eu(){const t=[];return this.Tu.inorderTraversal(((e,n)=>{t.push(n)})),t}}class Vl{constructor(t,e,n,s,r,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=r,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,s){const r=[];return e.forEach((t=>{r.push({type:0,doc:t})})),new Vl(t,e,Ml.emptySet(e),r,n,s,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&yo(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class Fl{constructor(){this.Au=void 0,this.listeners=[]}}class Pl{constructor(){this.queries=new aa((t=>wo(t)),yo),this.onlineState="Unknown",this.Ru=new Set}}async function Bl(t,e){const n=zs(t),s=e.query;let r=!1,i=n.queries.get(s);if(i||(r=!0,i=new Fl),r)try{i.Au=await n.onListen(s)}catch(t){const n=Ll(t,`Initialization of query '${vo(e.query)}' failed`);return void e.onError(n)}n.queries.set(s,i),i.listeners.push(e),e.bu(n.onlineState),i.Au&&e.Pu(i.Au)&&Kl(n)}async function Ul(t,e){const n=zs(t),s=e.query;let r=!1;const i=n.queries.get(s);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),r=0===i.listeners.length)}if(r)return n.queries.delete(s),n.onUnlisten(s)}function ql(t,e){const n=zs(t);let s=!1;for(const t of e){const e=t.query,r=n.queries.get(e);if(r){for(const e of r.listeners)e.Pu(t)&&(s=!0);r.Au=t}}s&&Kl(n)}function Gl(t,e,n){const s=zs(t),r=s.queries.get(e);if(r)for(const t of r.listeners)t.onError(n);s.queries.delete(e)}function Kl(t){t.Ru.forEach((t=>{t.next()}))}class jl{constructor(t,e,n){this.query=t,this.vu=e,this.Vu=!1,this.Su=null,this.onlineState="Unknown",this.options=n||{}}Pu(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new Vl(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.Vu?this.Du(t)&&(this.vu.next(t),e=!0):this.Cu(t,this.onlineState)&&(this.xu(t),e=!0),this.Su=t,e}onError(t){this.vu.error(t)}bu(t){this.onlineState=t;let e=!1;return this.Su&&!this.Vu&&this.Cu(this.Su,t)&&(this.xu(this.Su),e=!0),e}Cu(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return!(this.options.Nu&&n||t.docs.isEmpty()&&"Offline"!==e)}Du(t){if(t.docChanges.length>0)return!0;const e=this.Su&&this.Su.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}xu(t){t=Vl.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.Vu=!0,this.vu.next(t)}}class $l{constructor(t,e){this.payload=t,this.byteLength=e}ku(){return"metadata"in this.payload}}class zl{constructor(t){this.It=t}Ji(t){return Ua(this.It,t)}Yi(t){return t.metadata.exists?za(this.It,t.document,!1):Fi.newNoDocument(this.Ji(t.metadata.name),this.Xi(t.metadata.readTime))}Xi(t){return Va(t)}}class Ql{constructor(t,e,n){this.Mu=t,this.localStore=e,this.It=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Hl(t)}Ou(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.payload.namedQuery)this.queries.push(t.payload.namedQuery);else if(t.payload.documentMetadata){this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e;const n=fr.fromString(t.payload.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}Fu(t){const e=new Map,n=new zl(this.It);for(const s of t)if(s.metadata.queries){const t=n.Ji(s.metadata.name);for(const n of s.metadata.queries){const s=(e.get(n)||wa()).add(t);e.set(n,s)}}return e}async complete(){const t=await async function(t,e,n,s){const r=zs(t);let i=wa(),o=ca();for(const t of n){const n=e.Ji(t.metadata.name);t.document&&(i=i.add(n));const s=e.Yi(t);s.setReadTime(e.Xi(t.metadata.readTime)),o=o.insert(n,s)}const a=r.Gi.newChangeBuffer({trackRemovals:!0}),u=await Dh(r,function(t){return go(uo(fr.fromString(`__bundle__/docs/${t}`)))}(s));return r.persistence.runTransaction("Apply bundle documents","readwrite",(t=>Sh(t,a,o).next((e=>(a.apply(t),e))).next((e=>r.Cs.removeMatchingKeysForTargetId(t,u.targetId).next((()=>r.Cs.addMatchingKeys(t,i,u.targetId))).next((()=>r.localDocuments.getLocalViewOfDocuments(t,e.Wi,e.zi))).next((()=>e.Wi))))))}(this.localStore,new zl(this.It),this.documents,this.Mu.id),e=this.Fu(this.documents);for(const t of this.queries)await Rh(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",{progress:this.progress,$u:this.collectionGroups,Bu:t}}}function Hl(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class Wl{constructor(t){this.key=t}}class Yl{constructor(t){this.key=t}}class Xl{constructor(t,e){this.query=t,this.Lu=e,this.Uu=null,this.current=!1,this.qu=wa(),this.mutatedKeys=wa(),this.Ku=Eo(t),this.Gu=new Ml(this.Ku)}get Qu(){return this.Lu}ju(t,e){const n=e?e.Wu:new Ol,s=e?e.Gu:this.Gu;let r=e?e.mutatedKeys:this.mutatedKeys,i=s,o=!1;const a="F"===this.query.limitType&&s.size===this.query.limit?s.last():null,u="L"===this.query.limitType&&s.size===this.query.limit?s.first():null;if(t.inorderTraversal(((t,e)=>{const c=s.get(t),h=Io(this.query,e)?e:null,l=!!c&&this.mutatedKeys.has(c.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;c&&h?c.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.zu(c,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.Ku(h,a)>0||u&&this.Ku(h,u)<0)&&(o=!0)):!c&&h?(n.track({type:0,doc:h}),f=!0):c&&!h&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(h?(i=i.add(h),r=d?r.add(t):r.delete(t)):(i=i.delete(t),r=r.delete(t)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const t="F"===this.query.limitType?i.last():i.first();i=i.delete(t.key),r=r.delete(t.key),n.track({type:1,doc:t})}return{Gu:i,Wu:n,$i:o,mutatedKeys:r}}zu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const s=this.Gu;this.Gu=t.Gu,this.mutatedKeys=t.mutatedKeys;const r=t.Wu.Eu();r.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ks()}};return n(t)-n(e)}(t.type,e.type)||this.Ku(t.doc,e.doc))),this.Hu(n);const i=e?this.Ju():[],o=0===this.qu.size&&this.current?1:0,a=o!==this.Uu;return this.Uu=o,0!==r.length||a?{snapshot:new Vl(this.query,t.Gu,s,r,t.mutatedKeys,0===o,a,!1),Yu:i}:{Yu:i}}bu(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Gu:this.Gu,Wu:new Ol,mutatedKeys:this.mutatedKeys,$i:!1},!1)):{Yu:[]}}Xu(t){return!this.Lu.has(t)&&!!this.Gu.has(t)&&!this.Gu.get(t).hasLocalMutations}Hu(t){t&&(t.addedDocuments.forEach((t=>this.Lu=this.Lu.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.Lu=this.Lu.delete(t))),this.current=t.current)}Ju(){if(!this.current)return[];const t=this.qu;this.qu=wa(),this.Gu.forEach((t=>{this.Xu(t.key)&&(this.qu=this.qu.add(t.key))}));const e=[];return t.forEach((t=>{this.qu.has(t)||e.push(new Yl(t))})),this.qu.forEach((n=>{t.has(n)||e.push(new Wl(n))})),e}Zu(t){this.Lu=t.Hi,this.qu=wa();const e=this.ju(t.documents);return this.applyChanges(e,!0)}tc(){return Vl.fromInitialDocuments(this.query,this.Gu,this.mutatedKeys,0===this.Uu)}}class Jl{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class Zl{constructor(t){this.key=t,this.ec=!1}}class td{constructor(t,e,n,s,r,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=s,this.currentUser=r,this.maxConcurrentLimboResolutions=i,this.nc={},this.sc=new aa((t=>wo(t)),yo),this.ic=new Map,this.rc=new Set,this.oc=new Qr(pr.comparator),this.uc=new Map,this.cc=new nh,this.ac={},this.hc=new Map,this.lc=Rc.vn(),this.onlineState="Unknown",this.fc=void 0}get isPrimaryClient(){return!0===this.fc}}async function ed(t,e){const n=_d(t);let s,r;const i=n.sc.get(e);if(i)s=i.targetId,n.sharedClientState.addLocalQueryTarget(s),r=i.view.tc();else{const t=await Dh(n.localStore,go(e));n.isPrimaryClient&&ol(n.remoteStore,t);const i=n.sharedClientState.addLocalQueryTarget(t.targetId);s=t.targetId,r=await nd(n,e,s,"current"===i)}return r}async function nd(t,e,n,s){t.dc=(e,n,s)=>async function(t,e,n,s){let r=e.view.ju(n);r.$i&&(r=await Ah(t.localStore,e.query,!1).then((({documents:t})=>e.view.ju(t,r))));const i=s&&s.targetChanges.get(e.targetId),o=e.view.applyChanges(r,t.isPrimaryClient,i);return fd(t,e.targetId,o.Yu),o.snapshot}(t,e,n,s);const r=await Ah(t.localStore,e,!0),i=new Xl(e,r.Hi),o=i.ju(r.documents),a=Ea.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==t.onlineState),u=i.applyChanges(o,t.isPrimaryClient,a);fd(t,n,u.Yu);const c=new Jl(e,n,i);return t.sc.set(e,c),t.ic.has(n)?t.ic.get(n).push(e):t.ic.set(n,[e]),u.snapshot}async function sd(t,e){const n=zs(t),s=n.sc.get(e),r=n.ic.get(s.targetId);if(r.length>1)return n.ic.set(s.targetId,r.filter((t=>!yo(t,e)))),void n.sc.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await _h(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),al(n.remoteStore,s.targetId),ld(n,s.targetId)})).catch(Nr)):(ld(n,s.targetId),await _h(n.localStore,s.targetId,!0))}async function rd(t,e){const n=zs(t);try{const t=await function(t,e){const n=zs(t),s=e.snapshotVersion;let r=n.Ui;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.Gi.newChangeBuffer({trackRemovals:!0});r=n.Ui;const o=[];e.targetChanges.forEach(((i,a)=>{const u=r.get(a);if(!u)return;o.push(n.Cs.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.Cs.addMatchingKeys(t,i.addedDocuments,a))));let c=u.withSequenceNumber(t.currentSequenceNumber);e.targetMismatches.has(a)?c=c.withResumeToken(ei.EMPTY_BYTE_STRING,lr.min()).withLastLimboFreeSnapshotVersion(lr.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,s)),r=r.insert(a,c),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Cs.updateTargetData(t,c))}));let a=ca(),u=wa();if(e.documentUpdates.forEach((s=>{e.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,s))})),o.push(Sh(t,i,e.documentUpdates).next((t=>{a=t.Wi,u=t.zi}))),!s.isEqual(lr.min())){const e=n.Cs.getLastRemoteSnapshotVersion(t).next((e=>n.Cs.setTargetsMetadata(t,t.currentSequenceNumber,s)));o.push(e)}return kr.waitFor(o).next((()=>i.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,a,u))).next((()=>a))})).then((t=>(n.Ui=r,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const s=n.uc.get(e);s&&(js(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?s.ec=!0:t.modifiedDocuments.size>0?js(s.ec):t.removedDocuments.size>0&&(js(s.ec),s.ec=!1))})),await pd(n,t,e)}catch(t){await Nr(t)}}function id(t,e,n){const s=zs(t);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const t=[];s.sc.forEach(((n,s)=>{const r=s.view.bu(e);r.snapshot&&t.push(r.snapshot)})),function(t,e){const n=zs(t);n.onlineState=e;let s=!1;n.queries.forEach(((t,n)=>{for(const t of n.listeners)t.bu(e)&&(s=!0)})),s&&Kl(n)}(s.eventManager,e),t.length&&s.nc.Wo(t),s.onlineState=e,s.isPrimaryClient&&s.sharedClientState.setOnlineState(e)}}async function od(t,e,n){const s=zs(t);s.sharedClientState.updateQueryState(e,"rejected",n);const r=s.uc.get(e),i=r&&r.key;if(i){let t=new Qr(pr.comparator);t=t.insert(i,Fi.newNoDocument(i,lr.min()));const n=wa().add(i),r=new ba(lr.min(),new Map,new Yr(ar),t,n);await rd(s,r),s.oc=s.oc.remove(i),s.uc.delete(e),gd(s)}else await _h(s.localStore,e,!1).then((()=>ld(s,e,n))).catch(Nr)}async function ad(t,e){const n=zs(t),s=e.batch.batchId;try{const t=await function(t,e){const n=zs(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const s=e.batch.keys(),r=n.Gi.newChangeBuffer({trackRemovals:!0});return function(t,e,n,s){const r=n.batch,i=r.keys();let o=kr.resolve();return i.forEach((t=>{o=o.next((()=>s.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);js(null!==i),e.version.compareTo(i)<0&&(r.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),s.addEntry(e)))}))})),o.next((()=>t.mutationQueue.removeMutationBatch(e,r)))}(n,t,e,r).next((()=>r.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,s,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=wa();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,s)))}))}(n.localStore,e);hd(n,s,null),cd(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await pd(n,t)}catch(t){await Nr(t)}}async function ud(t,e,n){const s=zs(t);try{const t=await function(t,e){const n=zs(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let s;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(js(null!==e),s=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,s,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,s))).next((()=>n.localDocuments.getDocuments(t,s)))}))}(s.localStore,e);hd(s,e,n),cd(s,e),s.sharedClientState.updateMutationState(e,"rejected",n),await pd(s,t)}catch(n){await Nr(n)}}function cd(t,e){(t.hc.get(e)||[]).forEach((t=>{t.resolve()})),t.hc.delete(e)}function hd(t,e,n){const s=zs(t);let r=s.ac[s.currentUser.toKey()];if(r){const t=r.get(e);t&&(n?t.reject(n):t.resolve(),r=r.remove(e)),s.ac[s.currentUser.toKey()]=r}}function ld(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const s of t.ic.get(e))t.sc.delete(s),n&&t.nc._c(s,n);t.ic.delete(e),t.isPrimaryClient&&t.cc.ls(e).forEach((e=>{t.cc.containsKey(e)||dd(t,e)}))}function dd(t,e){t.rc.delete(e.path.canonicalString());const n=t.oc.get(e);null!==n&&(al(t.remoteStore,n),t.oc=t.oc.remove(e),t.uc.delete(n),gd(t))}function fd(t,e,n){for(const s of n)s instanceof Wl?(t.cc.addReference(s.key,e),md(t,s)):s instanceof Yl?(Bs("SyncEngine","Document no longer in limbo: "+s.key),t.cc.removeReference(s.key,e),t.cc.containsKey(s.key)||dd(t,s.key)):Ks()}function md(t,e){const n=e.key,s=n.path.canonicalString();t.oc.get(n)||t.rc.has(s)||(Bs("SyncEngine","New document in limbo: "+n),t.rc.add(s),gd(t))}function gd(t){for(;t.rc.size>0&&t.oc.size<t.maxConcurrentLimboResolutions;){const e=t.rc.values().next().value;t.rc.delete(e);const n=new pr(fr.fromString(e)),s=t.lc.next();t.uc.set(s,new Zl(n)),t.oc=t.oc.insert(n,s),ol(t.remoteStore,new Bu(go(uo(n.path)),s,2,Kr.at))}}async function pd(t,e,n){const s=zs(t),r=[],i=[],o=[];s.sc.isEmpty()||(s.sc.forEach(((t,a)=>{o.push(s.dc(a,e,n).then((t=>{if(t){s.isPrimaryClient&&s.sharedClientState.updateQueryState(a.targetId,t.fromCache?"not-current":"current"),r.push(t);const e=wh.Ci(a.targetId,t);i.push(e)}})))})),await Promise.all(o),s.nc.Wo(r),await async function(t,e){const n=zs(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>kr.forEach(e,(e=>kr.forEach(e.Si,(s=>n.persistence.referenceDelegate.addReference(t,e.targetId,s))).next((()=>kr.forEach(e.Di,(s=>n.persistence.referenceDelegate.removeReference(t,e.targetId,s)))))))))}catch(t){if(!Vr(t))throw t;Bs("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.Ui.get(e),s=t.snapshotVersion,r=t.withLastLimboFreeSnapshotVersion(s);n.Ui=n.Ui.insert(e,r)}}}(s.localStore,i))}async function yd(t,e){const n=zs(t);if(!n.currentUser.isEqual(e)){Bs("SyncEngine","User change. New user:",e.toKey());const t=await Eh(n.localStore,e);n.currentUser=e,function(t,e){t.hc.forEach((t=>{t.forEach((t=>{t.reject(new Hs(Qs.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.hc.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await pd(n,t.ji)}}function wd(t,e){const n=zs(t),s=n.uc.get(e);if(s&&s.ec)return wa().add(s.key);{let t=wa();const s=n.ic.get(e);if(!s)return t;for(const e of s){const s=n.sc.get(e);t=t.unionWith(s.view.Qu)}return t}}async function vd(t,e){const n=zs(t),s=await Ah(n.localStore,e.query,!0),r=e.view.Zu(s);return n.isPrimaryClient&&fd(n,e.targetId,r.Yu),r}async function Id(t,e){const n=zs(t);return Nh(n.localStore,e).then((t=>pd(n,t)))}async function bd(t,e,n,s){const r=zs(t),i=await function(t,e){const n=zs(t),s=zs(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>s.Tn(t,e).next((e=>e?n.localDocuments.getDocuments(t,e):kr.resolve(null)))))}(r.localStore,e);null!==i?("pending"===n?await vl(r.remoteStore):"acknowledged"===n||"rejected"===n?(hd(r,e,s||null),cd(r,e),function(t,e){zs(zs(t).mutationQueue).An(e)}(r.localStore,e)):Ks(),await pd(r,i)):Bs("SyncEngine","Cannot apply mutation batch with id: "+e)}async function Ed(t,e,n){const s=zs(t),r=[],i=[];for(const t of e){let e;const n=s.ic.get(t);if(n&&0!==n.length){e=await Dh(s.localStore,go(n[0]));for(const t of n){const e=s.sc.get(t),n=await vd(s,e);n.snapshot&&i.push(n.snapshot)}}else{const n=await Ch(s.localStore,t);e=await Dh(s.localStore,n),await nd(s,Td(n),t,!1)}r.push(e)}return s.nc.Wo(i),r}function Td(t){return ao(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function Sd(t){const e=zs(t);return zs(zs(e.localStore).persistence).vi()}async function xd(t,e,n,s){const r=zs(t);if(r.fc)return void Bs("SyncEngine","Ignoring unexpected query state notification.");const i=r.ic.get(e);if(i&&i.length>0)switch(n){case"current":case"not-current":{const t=await Nh(r.localStore,bo(i[0])),s=ba.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await pd(r,t,s);break}case"rejected":await _h(r.localStore,e,!0),ld(r,e,s);break;default:Ks()}}async function Dd(t,e,n){const s=_d(t);if(s.fc){for(const t of e){if(s.ic.has(t)){Bs("SyncEngine","Adding an already active target "+t);continue}const e=await Ch(s.localStore,t),n=await Dh(s.localStore,e);await nd(s,Td(e),n.targetId,!1),ol(s.remoteStore,n)}for(const t of n)s.ic.has(t)&&await _h(s.localStore,t,!1).then((()=>{al(s.remoteStore,t),ld(s,t)})).catch(Nr)}}function _d(t){const e=zs(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=rd.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=wd.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=od.bind(null,e),e.nc.Wo=ql.bind(null,e.eventManager),e.nc._c=Gl.bind(null,e.eventManager),e}function Ad(t){const e=zs(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=ad.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=ud.bind(null,e),e}class Cd{constructor(){this.synchronizeTabs=!1}async initialize(t){this.It=Yh(t.databaseInfo.databaseId),this.sharedClientState=this.mc(t),this.persistence=this.gc(t),await this.persistence.start(),this.localStore=this.yc(t),this.gcScheduler=this.Ic(t,this.localStore),this.indexBackfillerScheduler=this.Tc(t,this.localStore)}Ic(t,e){return null}Tc(t,e){return null}yc(t){return bh(this.persistence,new vh,t.initialUser,this.It)}gc(t){return new uh(hh.Bs,this.It)}mc(t){return new Gh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Nd extends Cd{constructor(t,e,n){super(),this.Ec=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.Ec.initialize(this,t),await Ad(this.Ec.syncEngine),await vl(this.Ec.remoteStore),await this.persistence.li((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}yc(t){return bh(this.persistence,new vh,t.initialUser,this.It)}Ic(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new Bc(n,t.asyncQueue,e)}Tc(t,e){const n=new Gr(e,this.persistence);return new qr(t.asyncQueue,n)}gc(t){const e=yh(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Sc.withCacheSize(this.cacheSizeBytes):Sc.DEFAULT;return new mh(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Hh(),Wh(),this.It,this.sharedClientState,!!this.forceOwnership)}mc(t){return new Gh}}class kd extends Nd{constructor(t,e){super(t,e,!1),this.Ec=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.Ec.syncEngine;this.sharedClientState instanceof qh&&(this.sharedClientState.syncEngine={Fr:bd.bind(null,e),$r:xd.bind(null,e),Br:Dd.bind(null,e),vi:Sd.bind(null,e),Or:Id.bind(null,e)},await this.sharedClientState.start()),await this.persistence.li((async t=>{await async function(t,e){const n=zs(t);if(_d(n),Ad(n),!0===e&&!0!==n.fc){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await Ed(n,t.toArray());n.fc=!0,await Cl(n.remoteStore,!0);for(const t of e)ol(n.remoteStore,t)}else if(!1===e&&!1!==n.fc){const t=[];let e=Promise.resolve();n.ic.forEach(((s,r)=>{n.sharedClientState.isLocalQueryTarget(r)?t.push(r):e=e.then((()=>(ld(n,r),_h(n.localStore,r,!0)))),al(n.remoteStore,r)})),await e,await Ed(n,t),function(t){const e=zs(t);e.uc.forEach(((t,n)=>{al(e.remoteStore,n)})),e.cc.fs(),e.uc=new Map,e.oc=new Qr(pr.comparator)}(n),n.fc=!1,await Cl(n.remoteStore,!1)}}(this.Ec.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start():t||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(t&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():t||this.indexBackfillerScheduler.stop())}))}mc(t){const e=Hh();if(!qh.C(e))throw new Hs(Qs.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=yh(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new qh(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class Rd{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>id(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=yd.bind(null,this.syncEngine),await Cl(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new Pl}createDatastore(t){const e=Yh(t.databaseInfo.databaseId),n=(s=t.databaseInfo,new Qh(s));var s;return function(t,e,n,s){return new el(t,e,n,s)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,s=t.asyncQueue,r=t=>id(this.syncEngine,t,0),i=jh.C()?new jh:new Kh,new sl(e,n,s,r,i);var e,n,s,r,i}createSyncEngine(t,e){return function(t,e,n,s,r,i,o){const a=new td(t,e,n,s,r,i);return o&&(a.fc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=zs(t);Bs("RemoteStore","RemoteStore shutting down."),e._u.add(5),await il(e),e.mu.shutdown(),e.gu.set("Unknown")}(this.remoteStore)}}function Ld(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const s={value:t.slice(n,n+e),done:!1};return n+=e,s}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class Md{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Ac(this.observer.next,t)}error(t){this.observer.error?this.Ac(this.observer.error,t):Us("Uncaught Error in snapshot listener:",t)}Rc(){this.muted=!0}Ac(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class Od{constructor(t,e){this.bc=t,this.It=e,this.metadata=new Ws,this.buffer=new Uint8Array,this.Pc=new TextDecoder("utf-8"),this.vc().then((t=>{t&&t.ku()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))}),(t=>this.metadata.reject(t)))}close(){return this.bc.cancel()}async getMetadata(){return this.metadata.promise}async wc(){return await this.getMetadata(),this.vc()}async vc(){const t=await this.Vc();if(null===t)return null;const e=this.Pc.decode(t),n=Number(e);isNaN(n)&&this.Sc(`length string (${e}) is not valid number`);const s=await this.Dc(n);return new $l(JSON.parse(s),t.length+n)}Cc(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async Vc(){for(;this.Cc()<0&&!await this.xc(););if(0===this.buffer.length)return null;const t=this.Cc();t<0&&this.Sc("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async Dc(t){for(;this.buffer.length<t;)await this.xc()&&this.Sc("Reached the end of bundle when more is expected.");const e=this.Pc.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}Sc(t){throw this.bc.cancel(),new Error(`Invalid bundle format: ${t}`)}async xc(){const t=await this.bc.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class Vd{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new Hs(Qs.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=zs(t),s=Ka(n.It)+"/documents",r={documents:e.map((t=>Ba(n.It,t)))},i=await n.fo("BatchGetDocuments",s,r,e.length),o=new Map;i.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){js(!!e.found),e.found.name,e.found.updateTime;const n=Ua(t,e.found.name),s=Va(e.found.updateTime),r=new Oi({mapValue:{fields:e.found.fields}});return Fi.newFoundDocument(n,s,r)}(t,e):"missing"in e?function(t,e){js(!!e.missing),js(!!e.readTime);const n=Ua(t,e.missing),s=Va(e.readTime);return Fi.newNoDocument(n,s)}(t,e):Ks()}(n.It,t);o.set(e.key.toString(),e)}));const a=[];return e.forEach((t=>{const e=o.get(t.toString());js(!!e),a.push(e)})),a}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new ta(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=pr.fromPath(e);this.mutations.push(new ea(n,this.precondition(n)))})),await async function(t,e){const n=zs(t),s=Ka(n.It)+"/documents",r={writes:e.map((t=>Qa(n.It,t)))};await n.co("Commit",s,r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Ks();e=lr.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Hs(Qs.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?qo.updateTime(e):qo.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(lr.min()))throw new Hs(Qs.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return qo.updateTime(e)}return qo.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class Fd{constructor(t,e,n,s,r){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=s,this.deferred=r,this.Nc=n.maxAttempts,this.xo=new Xh(this.asyncQueue,"transaction_retry")}run(){this.Nc-=1,this.kc()}kc(){this.xo.Ao((async()=>{const t=new Vd(this.datastore),e=this.Mc(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.Oc(t)}))))})).catch((t=>{this.Oc(t)}))}))}Mc(t){try{const e=this.updateFunction(t);return!li(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}Oc(t){this.Nc>0&&this.Fc(t)?(this.Nc-=1,this.asyncQueue.enqueueAndForget((()=>(this.kc(),Promise.resolve())))):this.deferred.reject(t)}Fc(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!ia(e)}return!1}}class Pd{constructor(t,e,n,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=s,this.user=Ms.UNAUTHENTICATED,this.clientId=or.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{Bs("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(Bs("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Hs(Qs.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new Ws;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=Ll(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function Bd(t,e){t.asyncQueue.verifyOperationInProgress(),Bs("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let s=n.initialUser;t.setCredentialChangeListener((async t=>{s.isEqual(t)||(await Eh(e.localStore,t),s=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t.offlineComponents=e}async function Ud(t,e){t.asyncQueue.verifyOperationInProgress();const n=await qd(t);Bs("FirestoreClient","Initializing OnlineComponentProvider");const s=await t.getConfiguration();await e.initialize(n,s),t.setCredentialChangeListener((t=>Al(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>Al(e.remoteStore,n))),t.onlineComponents=e}async function qd(t){return t.offlineComponents||(Bs("FirestoreClient","Using default OfflineComponentProvider"),await Bd(t,new Cd)),t.offlineComponents}async function Gd(t){return t.onlineComponents||(Bs("FirestoreClient","Using default OnlineComponentProvider"),await Ud(t,new Rd)),t.onlineComponents}function Kd(t){return qd(t).then((t=>t.persistence))}function jd(t){return qd(t).then((t=>t.localStore))}function $d(t){return Gd(t).then((t=>t.remoteStore))}function zd(t){return Gd(t).then((t=>t.syncEngine))}async function Qd(t){const e=await Gd(t),n=e.eventManager;return n.onListen=ed.bind(null,e.syncEngine),n.onUnlisten=sd.bind(null,e.syncEngine),n}function Hd(t,e,n={}){const s=new Ws;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new Md({next:i=>{e.enqueueAndForget((()=>Ul(t,o)));const a=i.docs.has(n);!a&&i.fromCache?r.reject(new Hs(Qs.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&s&&"server"===s.source?r.reject(new Hs(Qs.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):r.resolve(i)},error:t=>r.reject(t)}),o=new jl(uo(n.path),i,{includeMetadataChanges:!0,Nu:!0});return Bl(t,o)}(await Qd(t),t.asyncQueue,e,n,s))),s.promise}function Wd(t,e,n={}){const s=new Ws;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new Md({next:n=>{e.enqueueAndForget((()=>Ul(t,o))),n.fromCache&&"server"===s.source?r.reject(new Hs(Qs.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:t=>r.reject(t)}),o=new jl(n,i,{includeMetadataChanges:!0,Nu:!0});return Bl(t,o)}(await Qd(t),t.asyncQueue,e,n,s))),s.promise}function Yd(t,e,n,s){const r=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new Od(t,e)}(function(t,e){if(t instanceof Uint8Array)return Ld(t,e);if(t instanceof ArrayBuffer)return Ld(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Yh(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const s=zs(t);(async function(t,e,n){try{const s=await e.getMetadata();if(await function(t,e){const n=zs(t),s=Va(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.Ns.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(s)>=0))}(t.localStore,s))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(s)),Promise.resolve(new Set);n._updateProgress(Hl(s));const r=new Ql(s,t.localStore,e.It);let i=await e.wc();for(;i;){const t=await r.Ou(i);t&&n._updateProgress(t),i=await e.wc()}const o=await r.complete();return await pd(t,o.Bu,void 0),await function(t,e){const n=zs(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.Ns.saveBundleMetadata(t,e)))}(t.localStore,s),n._completeWith(o.progress),Promise.resolve(o.$u)}catch(t){return qs("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(s,e,n).then((t=>{s.sharedClientState.notifyBundleLoaded(t)}))}(await zd(t),r,s)}))}const Xd=new Map;function Jd(t,e,n){if(!n)throw new Hs(Qs.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Zd(t,e,n,s){if(!0===e&&!0===s)throw new Hs(Qs.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function tf(t){if(!pr.isDocumentKey(t))throw new Hs(Qs.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function ef(t){if(pr.isDocumentKey(t))throw new Hs(Qs.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function nf(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":Ks()}function sf(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new Hs(Qs.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=nf(t);throw new Hs(Qs.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function rf(t,e){if(e<=0)throw new Hs(Qs.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class of{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new Hs(Qs.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Hs(Qs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Zd("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class af{constructor(t,e,n){this._authCredentials=e,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new of({}),this._settingsFrozen=!1,t instanceof hi?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Hs(Qs.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new hi(t.options.projectId)}(t))}get app(){if(!this._app)throw new Hs(Qs.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Hs(Qs.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new of(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new Xs;switch(t.type){case"gapi":const e=t.client;return new er(e,t.sessionIndex||"0",t.iamToken||null,t.authTokenFactory||null);case"provider":return t.client;default:throw new Hs(Qs.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Xd.get(t);e&&(Bs("ComponentProvider","Removing Datastore"),Xd.delete(t),e.terminate())}(this),Promise.resolve()}}function uf(t,e,n,s={}){var r;const i=(t=sf(t,af))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&qs("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${n}`,ssl:!1})),s.mockUserToken){let e,n;if("string"==typeof s.mockUserToken)e=s.mockUserToken,n=Ms.MOCK_USER;else{e=function(t,e){if(t.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const n=e||"demo-project",s=t.iat||0,r=t.sub||t.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:s,exp:s+3600,auth_time:s,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},t);return[u(JSON.stringify({alg:"none",type:"JWT"})),u(JSON.stringify(i)),""].join(".")}(s.mockUserToken,null===(r=t._app)||void 0===r?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new Hs(Qs.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new Ms(i)}t._authCredentials=new Js(new Ys(e,n))}}class cf{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new lf(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new cf(this.firestore,t,this._key)}}class hf{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new hf(this.firestore,t,this._query)}}class lf extends hf{constructor(t,e,n){super(t,e,uo(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new cf(this.firestore,null,new pr(t))}withConverter(t){return new lf(this.firestore,t,this._path)}}function df(t,e,...n){if(t=p(t),Jd("collection","path",e),t instanceof af){const s=fr.fromString(e,...n);return ef(s),new lf(t,null,s)}{if(!(t instanceof cf||t instanceof lf))throw new Hs(Qs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(fr.fromString(e,...n));return ef(s),new lf(t.firestore,null,s)}}function ff(t,e){if(t=sf(t,af),Jd("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new Hs(Qs.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new hf(t,null,function(t){return new oo(fr.emptyPath(),t)}(e))}function mf(t,e,...n){if(t=p(t),1===arguments.length&&(e=or.R()),Jd("doc","path",e),t instanceof af){const s=fr.fromString(e,...n);return tf(s),new cf(t,null,new pr(s))}{if(!(t instanceof cf||t instanceof lf))throw new Hs(Qs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(fr.fromString(e,...n));return tf(s),new cf(t.firestore,t instanceof lf?t.converter:null,new pr(s))}}function gf(t,e){return t=p(t),e=p(e),(t instanceof cf||t instanceof lf)&&(e instanceof cf||e instanceof lf)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function pf(t,e){return t=p(t),e=p(e),t instanceof hf&&e instanceof hf&&t.firestore===e.firestore&&yo(t._query,e._query)&&t.converter===e.converter}class yf{constructor(){this.$c=Promise.resolve(),this.Bc=[],this.Lc=!1,this.Uc=[],this.qc=null,this.Kc=!1,this.Gc=!1,this.Qc=[],this.xo=new Xh(this,"async_queue_retry"),this.jc=()=>{const t=Wh();t&&Bs("AsyncQueue","Visibility state changed to "+t.visibilityState),this.xo.bo()};const t=Wh();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.jc)}get isShuttingDown(){return this.Lc}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Wc(),this.zc(t)}enterRestrictedMode(t){if(!this.Lc){this.Lc=!0,this.Gc=t||!1;const e=Wh();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.jc)}}enqueue(t){if(this.Wc(),this.Lc)return new Promise((()=>{}));const e=new Ws;return this.zc((()=>this.Lc&&this.Gc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.Bc.push(t),this.Hc())))}async Hc(){if(0!==this.Bc.length){try{await this.Bc[0](),this.Bc.shift(),this.xo.reset()}catch(t){if(!Vr(t))throw t;Bs("AsyncQueue","Operation failed with retryable error: "+t)}this.Bc.length>0&&this.xo.Ao((()=>this.Hc()))}}zc(t){const e=this.$c.then((()=>(this.Kc=!0,t().catch((t=>{this.qc=t,this.Kc=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw Us("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.Kc=!1,t))))));return this.$c=e,e}enqueueAfterDelay(t,e,n){this.Wc(),this.Qc.indexOf(t)>-1&&(e=0);const s=Rl.createAndSchedule(this,t,e,n,(t=>this.Jc(t)));return this.Uc.push(s),s}Wc(){this.qc&&Ks()}verifyOperationInProgress(){}async Yc(){let t;do{t=this.$c,await t}while(t!==this.$c)}Xc(t){for(const e of this.Uc)if(e.timerId===t)return!0;return!1}Zc(t){return this.Yc().then((()=>{this.Uc.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.Uc)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Yc()}))}ta(t){this.Qc.push(t)}Jc(t){const e=this.Uc.indexOf(t);this.Uc.splice(e,1)}}function wf(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return!0;return!1}(t)}class vf{constructor(){this._progressObserver={},this._taskCompletionResolver=new Ws,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const If=-1;class bf extends af{constructor(t,e,n){super(t,e,n),this.type="firestore",this._queue=new yf,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||xf(this),this._firestoreClient.terminate()}}function Ef(t,e){const s=n(t,"firestore");if(s.isInitialized()){const t=s.getImmediate();if(m(s.getOptions(),e))return t;throw new Hs(Qs.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Hs(Qs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return s.initialize({options:e})}function Tf(t=s()){return n(t,"firestore").getImmediate()}function Sf(t){return t._firestoreClient||xf(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function xf(t){var e;const n=t._freezeSettings(),s=function(t,e,n,s){return new ci(t,e,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new Pd(t._authCredentials,t._appCheckCredentials,t._queue,s)}function Df(t,e){Vf(t=sf(t,bf));const n=Sf(t),s=t._freezeSettings(),r=new Rd;return Af(n,r,new Nd(r,s.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function _f(t){Vf(t=sf(t,bf));const e=Sf(t),n=t._freezeSettings(),s=new Rd;return Af(e,s,new kd(s,n.cacheSizeBytes))}function Af(t,e,n){const s=new Ws;return t.asyncQueue.enqueue((async()=>{try{await Bd(t,n),await Ud(t,e),s.resolve()}catch(t){const e=t;if(!function(t){return"FirebaseError"===t.name?t.code===Qs.FAILED_PRECONDITION||t.code===Qs.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)}(e))throw e;qs("Error enabling offline persistence. Falling back to persistence disabled: "+e),s.reject(e)}})).then((()=>s.promise))}function Cf(t){if(t._initialized&&!t._terminated)throw new Hs(Qs.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Ws;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!Lr.C())return Promise.resolve();const e=t+"main";await Lr.delete(e)}(yh(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function Nf(t){return function(t){const e=new Ws;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=zs(t);dl(n.remoteStore)||Bs("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=zs(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const s=n.hc.get(t)||[];s.push(e),n.hc.set(t,s)}catch(t){const n=Ll(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await zd(t),e))),e.promise}(Sf(t=sf(t,bf)))}function kf(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Kd(t),n=await $d(t);return e.setNetworkEnabled(!0),function(t){const e=zs(t);return e._u.delete(0),rl(e)}(n)}))}(Sf(t=sf(t,bf)))}function Rf(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Kd(t),n=await $d(t);return e.setNetworkEnabled(!1),async function(t){const e=zs(t);e._u.add(0),await il(e),e.gu.set("Offline")}(n)}))}(Sf(t=sf(t,bf)))}function Lf(t){return r(t.app,"firestore"),t._delete()}function Mf(t,e){const n=Sf(t=sf(t,bf)),s=new vf;return Yd(n,t._databaseId,e,s),s}function Of(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=zs(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.Ns.getNamedQuery(t,e)))}(await jd(t),e)))}(Sf(t=sf(t,bf)),e).then((e=>e?new hf(t,null,e.query):null))}function Vf(t){if(t._initialized||t._terminated)throw new Hs(Qs.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Ff{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Hs(Qs.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new gr(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function Pf(){return new Ff("__name__")}class Bf{constructor(t){this._byteString=t}static fromBase64String(t){try{return new Bf(ei.fromBase64String(t))}catch(t){throw new Hs(Qs.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new Bf(ei.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class Uf{constructor(t){this._methodName=t}}class qf{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new Hs(Qs.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Hs(Qs.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return ar(this._lat,t._lat)||ar(this._long,t._long)}}const Gf=/^__.*__$/;class Kf{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Yo(t,this.data,this.fieldMask,e,this.fieldTransforms):new Wo(t,this.data,e,this.fieldTransforms)}}class jf{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Yo(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function $f(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Ks()}}class zf{constructor(t,e,n,s,r,i){this.settings=t,this.databaseId=e,this.It=n,this.ignoreUndefinedProperties=s,void 0===r&&this.ea(),this.fieldTransforms=r||[],this.fieldMask=i||[]}get path(){return this.settings.path}get na(){return this.settings.na}sa(t){return new zf(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.It,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ia(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.sa({path:n,ra:!1});return s.oa(t),s}ua(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.sa({path:n,ra:!1});return s.ea(),s}ca(t){return this.sa({path:void 0,ra:!0})}aa(t){return dm(t,this.settings.methodName,this.settings.ha||!1,this.path,this.settings.la)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}ea(){if(this.path)for(let t=0;t<this.path.length;t++)this.oa(this.path.get(t))}oa(t){if(0===t.length)throw this.aa("Document fields must not be empty");if($f(this.na)&&Gf.test(t))throw this.aa('Document fields cannot begin and end with "__"')}}class Qf{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.It=n||Yh(t)}fa(t,e,n,s=!1){return new zf({na:t,methodName:e,la:n,path:gr.emptyPath(),ra:!1,ha:s},this.databaseId,this.It,this.ignoreUndefinedProperties)}}function Hf(t){const e=t._freezeSettings(),n=Yh(t._databaseId);return new Qf(t._databaseId,!!e.ignoreUndefinedProperties,n)}function Wf(t,e,n,s,r,i={}){const o=t.fa(i.merge||i.mergeFields?2:0,e,n,r);um("Data must be an object, but it was:",o,s);const a=om(s,o);let u,c;if(i.merge)u=new Zr(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const s of i.mergeFields){const r=cm(e,s,n);if(!o.contains(r))throw new Hs(Qs.INVALID_ARGUMENT,`Field '${r}' is specified in your field mask but missing from your input data.`);fm(t,r)||t.push(r)}u=new Zr(t),c=o.fieldTransforms.filter((t=>u.covers(t.field)))}else u=null,c=o.fieldTransforms;return new Kf(new Oi(a),u,c)}class Yf extends Uf{_toFieldTransform(t){if(2!==t.na)throw 1===t.na?t.aa(`${this._methodName}() can only appear at the top level of your update data`):t.aa(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Yf}}function Xf(t,e,n){return new zf({na:3,la:e.settings.la,methodName:t._methodName,ra:n},e.databaseId,e.It,e.ignoreUndefinedProperties)}class Jf extends Uf{_toFieldTransform(t){return new Bo(t.path,new ko)}isEqual(t){return t instanceof Jf}}class Zf extends Uf{constructor(t,e){super(t),this.da=e}_toFieldTransform(t){const e=Xf(this,t,!0),n=this.da.map((t=>im(t,e))),s=new Ro(n);return new Bo(t.path,s)}isEqual(t){return this===t}}class tm extends Uf{constructor(t,e){super(t),this.da=e}_toFieldTransform(t){const e=Xf(this,t,!0),n=this.da.map((t=>im(t,e))),s=new Mo(n);return new Bo(t.path,s)}isEqual(t){return this===t}}class em extends Uf{constructor(t,e){super(t),this._a=e}_toFieldTransform(t){const e=new Vo(t.It,Do(t.It,this._a));return new Bo(t.path,e)}isEqual(t){return this===t}}function nm(t,e,n,s){const r=t.fa(1,e,n);um("Data must be an object, but it was:",r,s);const i=[],o=Oi.empty();$r(s,((t,s)=>{const a=lm(e,t,n);s=p(s);const u=r.ua(a);if(s instanceof Yf)i.push(a);else{const t=im(s,u);null!=t&&(i.push(a),o.set(a,t))}}));const a=new Zr(i);return new jf(o,a,r.fieldTransforms)}function sm(t,e,n,s,r,i){const o=t.fa(1,e,n),a=[cm(e,s,n)],u=[r];if(i.length%2!=0)throw new Hs(Qs.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)a.push(cm(e,i[t])),u.push(i[t+1]);const c=[],h=Oi.empty();for(let t=a.length-1;t>=0;--t)if(!fm(c,a[t])){const e=a[t];let n=u[t];n=p(n);const s=o.ua(e);if(n instanceof Yf)c.push(e);else{const t=im(n,s);null!=t&&(c.push(e),h.set(e,t))}}const l=new Zr(c);return new jf(h,l,o.fieldTransforms)}function rm(t,e,n,s=!1){return im(n,t.fa(s?4:3,e))}function im(t,e){if(am(t=p(t)))return um("Unsupported field value:",e,t),om(t,e);if(t instanceof Uf)return function(t,e){if(!$f(e.na))throw e.aa(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.aa(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.ra&&4!==e.na)throw e.aa("Nested arrays are not supported");return function(t,e){const n=[];let s=0;for(const r of t){let t=im(r,e.ca(s));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),s++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=p(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return Do(e.It,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=hr.fromDate(t);return{timestampValue:La(e.It,n)}}if(t instanceof hr){const n=new hr(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:La(e.It,n)}}if(t instanceof qf)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof Bf)return{bytesValue:Ma(e.It,t._byteString)};if(t instanceof cf){const n=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(n))throw e.aa(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Fa(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.aa(`Unsupported field value: ${nf(t)}`)}(t,e)}function om(t,e){const n={};return zr(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):$r(t,((t,s)=>{const r=im(s,e.ia(t));null!=r&&(n[t]=r)})),{mapValue:{fields:n}}}function am(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof hr||t instanceof qf||t instanceof Bf||t instanceof cf||t instanceof Uf)}function um(t,e,n){if(!am(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const s=nf(n);throw"an object"===s?e.aa(t+" a custom object"):e.aa(t+" "+s)}}function cm(t,e,n){if((e=p(e))instanceof Ff)return e._internalPath;if("string"==typeof e)return lm(t,e);throw dm("Field path arguments must be of type string or ",t,!1,void 0,n)}const hm=new RegExp("[~\\*/\\[\\]]");function lm(t,e,n){if(e.search(hm)>=0)throw dm(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new Ff(...e.split("."))._internalPath}catch(s){throw dm(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function dm(t,e,n,s,r){const i=s&&!s.isEmpty(),o=void 0!==r;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${s}`),o&&(u+=` in document ${r}`),u+=")"),new Hs(Qs.INVALID_ARGUMENT,a+t+u)}function fm(t,e){return t.some((t=>t.isEqual(e)))}class mm{constructor(t,e,n,s,r){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=s,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new cf(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new gm(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(pm("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class gm extends mm{data(){return super.data()}}function pm(t,e){return"string"==typeof e?lm(t,e):e instanceof Ff?e._internalPath:e._delegate._internalPath}class ym{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class wm extends mm{constructor(t,e,n,s,r,i){super(t,e,n,s,i),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new vm(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(pm("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class vm extends wm{data(t={}){return super.data(t)}}class Im{constructor(t,e,n,s){this._firestore=t,this._userDataWriter=e,this._snapshot=s,this.metadata=new ym(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new vm(this._firestore,this._userDataWriter,n.key,n,new ym(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Hs(Qs.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>({type:"added",doc:new vm(t._firestore,t._userDataWriter,n.doc.key,n.doc,new ym(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter),oldIndex:-1,newIndex:e++})))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const s=new vm(t._firestore,t._userDataWriter,e.doc.key,e.doc,new ym(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let r=-1,i=-1;return 0!==e.type&&(r=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:bm(e.type),doc:s,oldIndex:r,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function bm(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ks()}}function Em(t,e){return t instanceof wm&&e instanceof wm?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Im&&e instanceof Im&&t._firestore===e._firestore&&pf(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Tm(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new Hs(Qs.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Sm{}function xm(t,...e){for(const n of e)t=n._apply(t);return t}class Dm extends Sm{constructor(t,e,n){super(),this.wa=t,this.ma=e,this.ga=n,this.type="where"}_apply(t){const e=Hf(t.firestore),n=function(t,e,n,s,r,i,o){let a;if(r.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Hs(Qs.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){qm(o,i);const e=[];for(const n of o)e.push(Um(s,t,n));a={arrayValue:{values:e}}}else a=Um(s,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||qm(o,i),a=rm(n,"where",o,"in"===i||"not-in"===i);const u=zi.create(r,i,a);return function(t,e){if(e.dt()){const n=lo(t);if(null!==n&&!n.isEqual(e.field))throw new Hs(Qs.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${e.field.toString()}'`);const s=ho(t);null!==s&&Gm(t,e.field,s)}const n=function(t,e){for(const n of t.filters)if(e.indexOf(n.op)>=0)return n.op;return null}(t,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new Hs(Qs.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Hs(Qs.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}(t,u),u}(t._query,0,e,t.firestore._databaseId,this.wa,this.ma,this.ga);return new hf(t.firestore,t.converter,function(t,e){const n=t.filters.concat([e]);return new oo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))}}function _m(t,e,n){const s=e,r=pm("where",t);return new Dm(r,s,n)}class Am extends Sm{constructor(t,e){super(),this.wa=t,this.ya=e,this.type="orderBy"}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new Hs(Qs.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Hs(Qs.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const s=new no(e,n);return function(t,e){if(null===ho(t)){const n=lo(t);null!==n&&Gm(t,n,e.field)}}(t,s),s}(t._query,this.wa,this.ya);return new hf(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new oo(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function Cm(t,e="asc"){const n=e,s=pm("orderBy",t);return new Am(s,n)}class Nm extends Sm{constructor(t,e,n){super(),this.type=t,this.pa=e,this.Ia=n}_apply(t){return new hf(t.firestore,t.converter,po(t._query,this.pa,this.Ia))}}function km(t){return rf("limit",t),new Nm("limit",t,"F")}function Rm(t){return rf("limitToLast",t),new Nm("limitToLast",t,"L")}class Lm extends Sm{constructor(t,e,n){super(),this.type=t,this.Ta=e,this.Ea=n}_apply(t){const e=Bm(t,this.type,this.Ta,this.Ea);return new hf(t.firestore,t.converter,function(t,e){return new oo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function Mm(...t){return new Lm("startAt",t,!0)}function Om(...t){return new Lm("startAfter",t,!1)}class Vm extends Sm{constructor(t,e,n){super(),this.type=t,this.Ta=e,this.Ea=n}_apply(t){const e=Bm(t,this.type,this.Ta,this.Ea);return new hf(t.firestore,t.converter,function(t,e){return new oo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function Fm(...t){return new Vm("endBefore",t,!1)}function Pm(...t){return new Vm("endAt",t,!0)}function Bm(t,e,n,s){if(n[0]=p(n[0]),n[0]instanceof mm)return function(t,e,n,s,r){if(!s)throw new Hs(Qs.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of mo(t))if(n.field.isKeyField())i.push(Ti(e,s.key));else{const t=s.data.field(n.field);if(oi(t))throw new Hs(Qs.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Hs(Qs.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new eo(i,r)}(t._query,t.firestore._databaseId,e,n[0]._document,s);{const r=Hf(t.firestore);return function(t,e,n,s,r,i){const o=t.explicitOrderBy;if(r.length>o.length)throw new Hs(Qs.INVALID_ARGUMENT,`Too many arguments provided to ${s}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<r.length;i++){const u=r[i];if(o[i].field.isKeyField()){if("string"!=typeof u)throw new Hs(Qs.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${s}(), but got a ${typeof u}`);if(!fo(t)&&-1!==u.indexOf("/"))throw new Hs(Qs.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${s}() must be a plain document ID, but '${u}' contains a slash.`);const n=t.path.child(fr.fromString(u));if(!pr.isDocumentKey(n))throw new Hs(Qs.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${s}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const r=new pr(n);a.push(Ti(e,r))}else{const t=rm(n,s,u);a.push(t)}}return new eo(a,i)}(t._query,t.firestore._databaseId,r,e,n,s)}}function Um(t,e,n){if("string"==typeof(n=p(n))){if(""===n)throw new Hs(Qs.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!fo(e)&&-1!==n.indexOf("/"))throw new Hs(Qs.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const s=e.path.child(fr.fromString(n));if(!pr.isDocumentKey(s))throw new Hs(Qs.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${s}' is not because it has an odd number of segments (${s.length}).`);return Ti(t,new pr(s))}if(n instanceof cf)return Ti(t,n._key);throw new Hs(Qs.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${nf(n)}.`)}function qm(t,e){if(!Array.isArray(t)||0===t.length)throw new Hs(Qs.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new Hs(Qs.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function Gm(t,e,n){if(!n.isEqual(e))throw new Hs(Qs.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}const Km={maxAttempts:5};class jm{convertValue(t,e="none"){switch(pi(t)){case 0:return null;case 1:return t.booleanValue;case 2:return ri(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(ii(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Ks()}}convertObject(t,e){const n={};return $r(t.fields,((t,s)=>{n[t]=this.convertValue(s,e)})),n}convertGeoPoint(t){return new qf(ri(t.latitude),ri(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=ai(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(ui(t));default:return null}}convertTimestamp(t){const e=si(t);return new hr(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=fr.fromString(t);js(ou(n));const s=new hi(n.get(1),n.get(3)),r=new pr(n.popFirst(5));return s.isEqual(e)||Us(`Document ${r} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}function $m(t,e,n){let s;return s=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,s}class zm extends jm{constructor(t){super(),this.firestore=t}convertBytes(t){return new Bf(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new cf(this.firestore,null,e)}}class Qm{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Hf(t)}set(t,e,n){this._verifyNotCommitted();const s=Hm(t,this._firestore),r=$m(s.converter,e,n),i=Wf(this._dataReader,"WriteBatch.set",s._key,r,null!==s.converter,n);return this._mutations.push(i.toMutation(s._key,qo.none())),this}update(t,e,n,...s){this._verifyNotCommitted();const r=Hm(t,this._firestore);let i;return i="string"==typeof(e=p(e))||e instanceof Ff?sm(this._dataReader,"WriteBatch.update",r._key,e,n,s):nm(this._dataReader,"WriteBatch.update",r._key,e),this._mutations.push(i.toMutation(r._key,qo.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=Hm(t,this._firestore);return this._mutations=this._mutations.concat(new ta(e._key,qo.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Hs(Qs.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Hm(t,e){if((t=p(t)).firestore!==e)throw new Hs(Qs.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function Wm(t){t=sf(t,cf);const e=sf(t.firestore,bf);return Hd(Sf(e),t._key).then((n=>cg(e,t,n)))}class Ym extends jm{constructor(t){super(),this.firestore=t}convertBytes(t){return new Bf(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new cf(this.firestore,null,e)}}function Xm(t){t=sf(t,cf);const e=sf(t.firestore,bf),n=Sf(e),s=new Ym(e);return function(t,e){const n=new Ws;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await function(t,e){const n=zs(t);return n.persistence.runTransaction("read document","readonly",(t=>n.localDocuments.getDocument(t,e)))}(t,e);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Hs(Qs.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const s=Ll(t,`Failed to get document '${e} from cache`);n.reject(s)}}(await jd(t),e,n))),n.promise}(n,t._key).then((n=>new wm(e,s,t._key,n,new ym(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Jm(t){t=sf(t,cf);const e=sf(t.firestore,bf);return Hd(Sf(e),t._key,{source:"server"}).then((n=>cg(e,t,n)))}function Zm(t){t=sf(t,hf);const e=sf(t.firestore,bf),n=Sf(e),s=new Ym(e);return Tm(t._query),Wd(n,t._query).then((n=>new Im(e,s,t,n)))}function tg(t){t=sf(t,hf);const e=sf(t.firestore,bf),n=Sf(e),s=new Ym(e);return function(t,e){const n=new Ws;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await Ah(t,e,!0),r=new Xl(e,s.Hi),i=r.ju(s.documents),o=r.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const s=Ll(t,`Failed to execute query '${e} against cache`);n.reject(s)}}(await jd(t),e,n))),n.promise}(n,t._query).then((n=>new Im(e,s,t,n)))}function eg(t){t=sf(t,hf);const e=sf(t.firestore,bf),n=Sf(e),s=new Ym(e);return Wd(n,t._query,{source:"server"}).then((n=>new Im(e,s,t,n)))}function ng(t,e,n){t=sf(t,cf);const s=sf(t.firestore,bf),r=$m(t.converter,e,n);return ug(s,[Wf(Hf(s),"setDoc",t._key,r,null!==t.converter,n).toMutation(t._key,qo.none())])}function sg(t,e,n,...s){t=sf(t,cf);const r=sf(t.firestore,bf),i=Hf(r);let o;return o="string"==typeof(e=p(e))||e instanceof Ff?sm(i,"updateDoc",t._key,e,n,s):nm(i,"updateDoc",t._key,e),ug(r,[o.toMutation(t._key,qo.exists(!0))])}function rg(t){return ug(sf(t.firestore,bf),[new ta(t._key,qo.none())])}function ig(t,e){const n=sf(t.firestore,bf),s=mf(t),r=$m(t.converter,e);return ug(n,[Wf(Hf(t.firestore),"addDoc",s._key,r,null!==t.converter,{}).toMutation(s._key,qo.exists(!1))]).then((()=>s))}function og(t,...e){var n,s,r;t=p(t);let i={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||wf(e[o])||(i=e[o],o++);const a={includeMetadataChanges:i.includeMetadataChanges};if(wf(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(s=t.error)||void 0===s?void 0:s.bind(t),e[o+2]=null===(r=t.complete)||void 0===r?void 0:r.bind(t)}let u,c,h;if(t instanceof cf)c=sf(t.firestore,bf),h=uo(t._key.path),u={next:n=>{e[o]&&e[o](cg(c,t,n))},error:e[o+1],complete:e[o+2]};else{const n=sf(t,hf);c=sf(n.firestore,bf),h=n._query;const s=new Ym(c);u={next:t=>{e[o]&&e[o](new Im(c,s,n,t))},error:e[o+1],complete:e[o+2]},Tm(t._query)}return function(t,e,n,s){const r=new Md(s),i=new jl(e,r,n);return t.asyncQueue.enqueueAndForget((async()=>Bl(await Qd(t),i))),()=>{r.Rc(),t.asyncQueue.enqueueAndForget((async()=>Ul(await Qd(t),i)))}}(Sf(c),h,a,u)}function ag(t,e){return function(t,e){const n=new Md(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){zs(t).Ru.add(e),e.next()}(await Qd(t),n))),()=>{n.Rc(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){zs(t).Ru.delete(e)}(await Qd(t),n)))}}(Sf(t=sf(t,bf)),wf(e)?e:{next:e})}function ug(t,e){return function(t,e){const n=new Ws;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const s=Ad(t);try{const t=await function(t,e){const n=zs(t),s=hr.now(),r=e.reduce(((t,e)=>t.add(e.key)),wa());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let a=ca(),u=wa();return n.Gi.getEntries(t,r).next((t=>{a=t,a.forEach(((t,e)=>{e.isValidDocument()||(u=u.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,a))).next((r=>{i=r;const o=[];for(const t of e){const e=Qo(t,i.get(t.key).overlayedDocument);null!=e&&o.push(new Yo(t.key,e,Vi(e.value.mapValue),qo.exists(!0)))}return n.mutationQueue.addMutationBatch(t,s,o,e)})).next((e=>{o=e;const s=e.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(t,e.batchId,s)}))})).then((()=>({batchId:o.batchId,changes:da(i)})))}(s.localStore,e);s.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let s=t.ac[t.currentUser.toKey()];s||(s=new Qr(ar)),s=s.insert(e,n),t.ac[t.currentUser.toKey()]=s}(s,t.batchId,n),await pd(s,t.changes),await vl(s.remoteStore)}catch(t){const e=Ll(t,"Failed to persist write");n.reject(e)}}(await zd(t),e,n))),n.promise}(Sf(t),e)}function cg(t,e,n){const s=n.docs.get(e._key),r=new Ym(t);return new wm(t,r,e._key,s,new ym(n.hasPendingWrites,n.fromCache),e.converter)}class hg extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Hf(t)}get(t){const e=Hm(t,this._firestore),n=new zm(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return Ks();const s=t[0];if(s.isFoundDocument())return new mm(this._firestore,n,s.key,s,e.converter);if(s.isNoDocument())return new mm(this._firestore,n,e._key,null,e.converter);throw Ks()}))}set(t,e,n){const s=Hm(t,this._firestore),r=$m(s.converter,e,n),i=Wf(this._dataReader,"Transaction.set",s._key,r,null!==s.converter,n);return this._transaction.set(s._key,i),this}update(t,e,n,...s){const r=Hm(t,this._firestore);let i;return i="string"==typeof(e=p(e))||e instanceof Ff?sm(this._dataReader,"Transaction.update",r._key,e,n,s):nm(this._dataReader,"Transaction.update",r._key,e),this._transaction.update(r._key,i),this}delete(t){const e=Hm(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=Hm(t,this._firestore),n=new Ym(this._firestore);return super.get(t).then((t=>new wm(this._firestore,n,e._key,t._document,new ym(!1,!1),e.converter)))}}function lg(t,e,n){t=sf(t,bf);const s=Object.assign(Object.assign({},Km),n);return function(t){if(t.maxAttempts<1)throw new Hs(Qs.INVALID_ARGUMENT,"Max attempts must be at least 1")}(s),function(t,e,n){const s=new Ws;return t.asyncQueue.enqueueAndForget((async()=>{const r=await function(t){return Gd(t).then((t=>t.datastore))}(t);new Fd(t.asyncQueue,r,n,e,s).run()})),s.promise}(Sf(t),(n=>e(new hg(t,n))),s)}function dg(){return new Yf("deleteField")}function fg(){return new Jf("serverTimestamp")}function mg(...t){return new Zf("arrayUnion",t)}function gg(...t){return new tm("arrayRemove",t)}function pg(t){return new em("increment",t)}function yg(t){return Sf(t=sf(t,bf)),new Qm(t,(e=>ug(t,e)))}function wg(t,e){var n;const s=Sf(t=sf(t,bf));if(!(null===(n=s.offlineComponents)||void 0===n?void 0:n.indexBackfillerScheduler))return qs("Cannot enable indexes when persistence is disabled"),Promise.resolve();const r=function(t){const e="string"==typeof t?function(t){var e;try{return JSON.parse(t)}catch(t){throw new Hs(Qs.INVALID_ARGUMENT,"Failed to parse JSON: "+(null===(e=t)||void 0===e?void 0:e.message))}}(t):t,n=[];if(Array.isArray(e.indexes))for(const t of e.indexes){const e=vg(t,"collectionGroup"),s=[];if(Array.isArray(t.fields))for(const e of t.fields){const t=lm("setIndexConfiguration",vg(e,"fieldPath"));"CONTAINS"===e.arrayConfig?s.push(new br(t,2)):"ASCENDING"===e.order?s.push(new br(t,0)):"DESCENDING"===e.order&&s.push(new br(t,1))}n.push(new yr(yr.UNKNOWN_ID,e,s,Tr.empty()))}return n}(e);return jd(s).then((t=>async function(t,e){const n=zs(t),s=n.indexManager,r=[];return n.persistence.runTransaction("Configure indexes","readwrite",(t=>s.getFieldIndexes(t).next((n=>function(t,e,n,s,r){t=[...t],e=[...e],t.sort(n),e.sort(n);const i=t.length,o=e.length;let a=0,u=0;for(;a<o&&u<i;){const i=n(t[u],e[a]);i<0?r(t[u++]):i>0?s(e[a++]):(a++,u++)}for(;a<o;)s(e[a++]);for(;u<i;)r(t[u++])}(n,e,Ir,(e=>{r.push(s.addFieldIndex(t,e))}),(e=>{r.push(s.deleteFieldIndex(t,e))})))).next((()=>kr.waitFor(r)))))}(t,r)))}function vg(t,e){if("string"!=typeof t[e])throw new Hs(Qs.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}!function(n,s=!0){Os=i,t(new y("firestore",((t,{options:e})=>{const n=t.getProvider("app").getImmediate(),r=new bf(n,new Zs(t.getProvider("auth-internal")),new sr(t.getProvider("app-check-internal")));return e=Object.assign({useFetchStreams:s},e),r._setSettings(e),r}),"PUBLIC")),e(Ls,"3.4.14",n),e(Ls,"3.4.14","esm2017")}();export{jm as AbstractUserDataWriter,Bf as Bytes,If as CACHE_SIZE_UNLIMITED,lf as CollectionReference,cf as DocumentReference,wm as DocumentSnapshot,Ff as FieldPath,Uf as FieldValue,bf as Firestore,Hs as FirestoreError,qf as GeoPoint,vf as LoadBundleTask,hf as Query,Sm as QueryConstraint,vm as QueryDocumentSnapshot,Im as QuerySnapshot,ym as SnapshotMetadata,hr as Timestamp,hg as Transaction,Qm as WriteBatch,hi as _DatabaseId,pr as _DocumentKey,rr as _EmptyAppCheckTokenProvider,Xs as _EmptyAuthCredentialsProvider,gr as _FieldPath,sf as _cast,$s as _debugAssert,ti as _isBase64Available,qs as _logWarn,Zd as _validateIsNotUsedTogether,ig as addDoc,gg as arrayRemove,mg as arrayUnion,Cf as clearIndexedDbPersistence,df as collection,ff as collectionGroup,uf as connectFirestoreEmulator,rg as deleteDoc,dg as deleteField,Rf as disableNetwork,mf as doc,Pf as documentId,Df as enableIndexedDbPersistence,_f as enableMultiTabIndexedDbPersistence,kf as enableNetwork,Pm as endAt,Fm as endBefore,Sf as ensureFirestoreConfigured,ug as executeWrite,Wm as getDoc,Xm as getDocFromCache,Jm as getDocFromServer,Zm as getDocs,tg as getDocsFromCache,eg as getDocsFromServer,Tf as getFirestore,pg as increment,Ef as initializeFirestore,km as limit,Rm as limitToLast,Mf as loadBundle,Of as namedQuery,og as onSnapshot,ag as onSnapshotsInSync,Cm as orderBy,xm as query,pf as queryEqual,gf as refEqual,lg as runTransaction,fg as serverTimestamp,ng as setDoc,wg as setIndexConfiguration,Ps as setLogLevel,Em as snapshotEqual,Om as startAfter,Mm as startAt,Lf as terminate,sg as updateDoc,Nf as waitForPendingWrites,_m as where,yg as writeBatch};

//# sourceMappingURL=firebase-firestore.js.map
